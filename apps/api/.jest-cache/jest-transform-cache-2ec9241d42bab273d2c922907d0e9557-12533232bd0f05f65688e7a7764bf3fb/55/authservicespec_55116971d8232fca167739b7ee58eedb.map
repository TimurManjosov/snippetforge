{"file":"/home/runner/work/snippetforge/snippetforge/apps/api/test/unit/services/auth.service.spec.ts","mappings":"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","names":[],"sources":["/home/runner/work/snippetforge/snippetforge/apps/api/test/unit/services/auth.service.spec.ts"],"sourcesContent":["// test/unit/services/auth.service.spec. ts\n\nimport { UnauthorizedException } from '@nestjs/common';\nimport { ConfigService } from '@nestjs/config';\nimport { JwtService } from '@nestjs/jwt';\nimport { Test, TestingModule } from '@nestjs/testing';\nimport { AuthService } from '../../../src/modules/auth/auth.service';\nimport { UsersService } from '../../../src/modules/users/users.service';\nimport { createLoginDto, createRegisterDto } from '../../factories';\nimport {\n  createMockJwtService,\n  createMockSafeUser,\n  createMockUsersService,\n  type MockJwtService,\n  type MockUsersService,\n} from '../../mocks';\n\n/**\n * AuthService Unit Tests\n *\n * Testet:\n * - Registration\n * - Login\n * - Token Generation\n * - Error Handling\n */\ndescribe('AuthService', () => {\n  let service: AuthService;\n  let usersService: MockUsersService;\n  let jwtService: MockJwtService;\n\n  beforeEach(async () => {\n    usersService = createMockUsersService();\n    jwtService = createMockJwtService();\n\n    const module: TestingModule = await Test.createTestingModule({\n      providers: [\n        AuthService,\n        {\n          provide: UsersService,\n          useValue: usersService,\n        },\n        {\n          provide: JwtService,\n          useValue: jwtService,\n        },\n        {\n          provide: ConfigService,\n          useValue: {\n            get: jest.fn((key: string) => {\n              const config: Record<string, string> = {\n                JWT_SECRET: 'test-secret',\n                JWT_EXPIRES_IN: '15m',\n              };\n              return config[key];\n            }),\n          },\n        },\n      ],\n    }).compile();\n\n    service = module.get<AuthService>(AuthService);\n  });\n\n  afterEach(() => {\n    jest.clearAllMocks();\n  });\n\n  // ============================================================\n  // REGISTER\n  // ============================================================\n\n  describe('register', () => {\n    it('should register a new user and return tokens', async () => {\n      // Arrange\n      const dto = createRegisterDto();\n      const mockUser = createMockSafeUser({\n        email: dto.email,\n        username: dto.username,\n      });\n      usersService.create.mockResolvedValue(mockUser);\n\n      // Act\n      const result = await service.register(dto);\n\n      // Assert\n      expect(usersService.create).toHaveBeenCalledWith({\n        email: dto.email,\n        username: dto.username,\n        password: dto.password,\n      });\n      expect(result.user).toEqual(mockUser);\n      expect(result.tokens).toBeDefined();\n      expect(result.tokens.accessToken).toBeDefined();\n      expect(result.tokens.tokenType).toBe('Bearer');\n    });\n\n    it('should generate JWT with correct payload', async () => {\n      // Arrange\n      const dto = createRegisterDto();\n      const mockUser = createMockSafeUser({\n        id: 'user-123',\n        email: dto.email,\n        role: 'USER',\n      });\n      usersService.create.mockResolvedValue(mockUser);\n\n      // Act\n      await service.register(dto);\n\n      // Assert\n      expect(jwtService.signAsync).toHaveBeenCalledWith(\n        expect.objectContaining({\n          sub: 'user-123',\n          email: dto.email,\n          role: 'USER',\n        }),\n      );\n    });\n\n    it('should propagate ConflictException from UsersService', async () => {\n      // Arrange\n      const dto = createRegisterDto();\n      usersService.create.mockRejectedValue(\n        new Error('Email is already registered'),\n      );\n\n      // Act & Assert\n      await expect(service.register(dto)).rejects.toThrow();\n    });\n  });\n\n  // ============================================================\n  // LOGIN\n  // ============================================================\n\n  describe('login', () => {\n    it('should login user and return tokens', async () => {\n      // Arrange\n      const dto = createLoginDto();\n      const mockUser = createMockSafeUser({ email: dto.email });\n      usersService.validateCredentials.mockResolvedValue(mockUser);\n\n      // Act\n      const result = await service.login(dto);\n\n      // Assert\n      expect(usersService.validateCredentials).toHaveBeenCalledWith(\n        dto.email,\n        dto.password,\n      );\n      expect(result.user).toEqual(mockUser);\n      expect(result.tokens.accessToken).toBeDefined();\n    });\n\n    it('should throw UnauthorizedException when credentials are invalid', async () => {\n      // Arrange\n      const dto = createLoginDto();\n      usersService.validateCredentials.mockResolvedValue(null);\n\n      // Act & Assert\n      await expect(service.login(dto)).rejects.toThrow(UnauthorizedException);\n      await expect(service.login(dto)).rejects.toThrow(\n        'Invalid email or password',\n      );\n    });\n\n    it('should generate JWT with correct payload on login', async () => {\n      // Arrange\n      const dto = createLoginDto();\n      const mockUser = createMockSafeUser({\n        id: 'user-456',\n        email: dto.email,\n        role: 'ADMIN',\n      });\n      usersService.validateCredentials.mockResolvedValue(mockUser);\n\n      // Act\n      await service.login(dto);\n\n      // Assert\n      expect(jwtService.signAsync).toHaveBeenCalledWith(\n        expect.objectContaining({\n          sub: 'user-456',\n          email: dto.email,\n          role: 'ADMIN',\n        }),\n      );\n    });\n  });\n\n  // ============================================================\n  // TOKEN GENERATION\n  // ============================================================\n\n  describe('token generation', () => {\n    it('should include expiresIn in token response', async () => {\n      // Arrange\n      const dto = createRegisterDto();\n      usersService.create.mockResolvedValue(createMockSafeUser());\n\n      // Act\n      const result = await service.register(dto);\n\n      // Assert\n      expect(result.tokens.expiresIn).toBeDefined();\n      expect(typeof result.tokens.expiresIn).toBe('number');\n    });\n\n    it('should set tokenType to Bearer', async () => {\n      // Arrange\n      const dto = createLoginDto();\n      usersService.validateCredentials.mockResolvedValue(createMockSafeUser());\n\n      // Act\n      const result = await service.login(dto);\n\n      // Assert\n      expect(result.tokens.tokenType).toBe('Bearer');\n    });\n  });\n\n  // ============================================================\n  // VALIDATE USER BY ID\n  // ============================================================\n\n  describe('validateUserById', () => {\n    it('should return user when found', async () => {\n      // Arrange\n      const mockUser = createMockSafeUser();\n      usersService.findById.mockResolvedValue(mockUser);\n\n      // Act\n      const result = await service.validateUserById('user-123');\n\n      // Assert\n      expect(usersService.findById).toHaveBeenCalledWith('user-123');\n      expect(result).toEqual(mockUser);\n    });\n\n    it('should propagate NotFoundException from UsersService', async () => {\n      // Arrange\n      usersService.findById.mockRejectedValue(new Error('User not found'));\n\n      // Act & Assert\n      await expect(service.validateUserById('nonexistent')).rejects.toThrow();\n    });\n  });\n\n  // ============================================================\n  // GET CURRENT USER\n  // ============================================================\n\n  describe('getCurrentUser', () => {\n    it('should return user by id', async () => {\n      // Arrange\n      const mockUser = createMockSafeUser({ id: 'current-user-id' });\n      usersService.findById.mockResolvedValue(mockUser);\n\n      // Act\n      const result = await service.getCurrentUser('current-user-id');\n\n      // Assert\n      expect(result).toEqual(mockUser);\n    });\n  });\n});\n"],"version":3}