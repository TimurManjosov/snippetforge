{"file":"/home/runner/work/snippetforge/snippetforge/apps/api/src/shared/pipes/zod-validation.pipe.ts","mappings":";AAAA,0CAA0C;;;;;;;;;;;;AAE1C,2CAAgF;AAChF,6BAA+C;AAC/C,4CAA0C;AAE1C;;;;;;;;;;;;;;;;;;;GAmBG;AAEI,IAAM,iBAAiB,GAAvB,MAAM,iBAAiB;IACR;IAApB,YAAoB,MAAoB;QAApB,WAAM,GAAN,MAAM,CAAc;IAAG,CAAC;IAE5C;;OAEG;IACH,SAAS,CAAC,KAAc;QACtB,IAAI,CAAC;YACH,yDAAyD;YACzD,OAAO,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC;QAClC,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,IAAI,KAAK,YAAY,cAAQ,EAAE,CAAC;gBAC9B,wBAAwB;gBACxB,MAAM,eAAe,GAAG,IAAI,CAAC,eAAe,CAAC,KAAK,CAAC,CAAC;gBAEpD,wCAAwC;gBACxC,gDAAgD;gBAChD,MAAM,IAAI,4BAAmB,CAAC;oBAC5B,OAAO,EAAE,mBAAmB;oBAC5B,IAAI,EAAE,sBAAU,CAAC,gBAAgB;oBACjC,MAAM,EAAE,eAAe;iBACxB,CAAC,CAAC;YACL,CAAC;YAED,mCAAmC;YACnC,MAAM,KAAK,CAAC;QACd,CAAC;IACH,CAAC;IAED;;;;;;;;;;;;;;OAcG;IACK,eAAe,CAAC,KAAe;QACrC,MAAM,eAAe,GAA6B,EAAE,CAAC;QAErD,KAAK,MAAM,KAAK,IAAI,KAAK,CAAC,MAAM,EAAE,CAAC;YACjC,0DAA0D;YAC1D,MAAM,IAAI,GAAG,KAAK,CAAC,IAAI,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,wBAAwB;YAE7F,IAAI,CAAC,eAAe,CAAC,IAAI,CAAC,EAAE,CAAC;gBAC3B,eAAe,CAAC,IAAI,CAAC,GAAG,EAAE,CAAC;YAC7B,CAAC;YAED,eAAe,CAAC,IAAI,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC;QAC5C,CAAC;QAED,OAAO,eAAe,CAAC;IACzB,CAAC;CACF,CAAA;AA5DY,8CAAiB;4BAAjB,iBAAiB;IAD7B,IAAA,mBAAU,GAAE;;GACA,iBAAiB,CA4D7B","names":[],"sources":["/home/runner/work/snippetforge/snippetforge/apps/api/src/shared/pipes/zod-validation.pipe.ts"],"sourcesContent":["// src/shared/pipes/zod-validation.pipe.ts\n\nimport { BadRequestException, Injectable, PipeTransform } from '@nestjs/common';\nimport { ZodError, type ZodSchema } from 'zod';\nimport { ErrorCodes } from '../constants';\n\n/**\n * ZodValidationPipe - Validiert Input mit Zod Schemas\n *\n * VERWENDUNG:\n * @Post('register')\n * async register(\n *   @Body(new ZodValidationPipe(RegisterSchema)) dto: RegisterDto\n * ) {\n *   // dto ist GARANTIERT valide\n * }\n *\n * ERROR FORMAT:\n * Wirft BadRequestException mit speziellem Format,\n * das von HttpExceptionFilter erkannt wird.\n *\n * PERFORMANCE:\n * - Zod ist schnell (native JS, kein Reflection)\n * - Parse + Transform in einem Schritt\n * - Fehler werden früh erkannt (Fail Fast)\n */\n@Injectable()\nexport class ZodValidationPipe<T> implements PipeTransform<unknown, T> {\n  constructor(private schema: ZodSchema<T>) {}\n\n  /**\n   * Transform - Validiert und transformiert Input\n   */\n  transform(value: unknown): T {\n    try {\n      // Zod validiert UND transformiert (z.B. email lowercase)\n      return this.schema.parse(value);\n    } catch (error) {\n      if (error instanceof ZodError) {\n        // Formatiere Zod Errors\n        const formattedErrors = this.formatZodErrors(error);\n\n        // BadRequestException mit Custom Format\n        // HttpExceptionFilter erkennt 'errors' Property\n        throw new BadRequestException({\n          message: 'Validation failed',\n          code: ErrorCodes.VALIDATION_ERROR,\n          errors: formattedErrors,\n        });\n      }\n\n      // Unbekannter Error - weiterwerfen\n      throw error;\n    }\n  }\n\n  /**\n   * Formatiert Zod Errors in Frontend-freundliches Format\n   *\n   * INPUT (Zod Format):\n   * [\n   *   { path: ['email'], message: 'Invalid email' },\n   *   { path: ['password'], message: 'Too short' }\n   * ]\n   *\n   * OUTPUT:\n   * {\n   *   email: ['Invalid email'],\n   *   password: ['Too short']\n   * }\n   */\n  private formatZodErrors(error: ZodError): Record<string, string[]> {\n    const formattedErrors: Record<string, string[]> = {};\n\n    for (const issue of error.issues) {\n      // Path kann nested sein: ['user', 'email'] → 'user.email'\n      const path = issue.path.length > 0 ? issue.path.join('.') : '_root'; // Für root-level Errors\n\n      if (!formattedErrors[path]) {\n        formattedErrors[path] = [];\n      }\n\n      formattedErrors[path].push(issue.message);\n    }\n\n    return formattedErrors;\n  }\n}\n"],"version":3}