{"file":"/home/runner/work/snippetforge/snippetforge/apps/api/test/unit/strategies/jwt.strategy.spec.ts","mappings":";AAAA,4CAA4C;;AAE5C,2CAAuD;AACvD,2CAA+C;AAC/C,6CAAsD;AAEtD,oFAAgF;AAEhF,4EAAwE;AAExE,QAAQ,CAAC,aAAa,EAAE,GAAG,EAAE;IAC3B,IAAI,QAAqB,CAAC;IAC1B,IAAI,gBAAuC,CAAC;IAC5C,IAAI,iBAAyC,CAAC;IAE9C,MAAM,QAAQ,GAAa;QACzB,EAAE,EAAE,cAAc;QAClB,KAAK,EAAE,kBAAkB;QACzB,QAAQ,EAAE,UAAU;QACpB,IAAI,EAAE,MAAM;QACZ,SAAS,EAAE,IAAI,IAAI,EAAE;QACrB,SAAS,EAAE,IAAI,IAAI,EAAE;QACrB,GAAG,EAAE,IAAI;QACT,SAAS,EAAE,IAAI;KAChB,CAAC;IAEF,UAAU,CAAC,KAAK,IAAI,EAAE;QACpB,gBAAgB,GAAG;YACjB,QAAQ,EAAE,IAAI,CAAC,EAAE,EAAE;SACpB,CAAC;QAEF,iBAAiB,GAAG;YAClB,GAAG,EAAE,IAAI,CAAC,EAAE,CAAC,CAAC,GAAW,EAAE,EAAE;gBAC3B,IAAI,GAAG,KAAK,YAAY;oBAAE,OAAO,aAAa,CAAC;gBAC/C,OAAO,SAAS,CAAC;YACnB,CAAC,CAAC;SACH,CAAC;QAEF,MAAM,MAAM,GAAkB,MAAM,cAAI,CAAC,mBAAmB,CAAC;YAC3D,SAAS,EAAE;gBACT,0BAAW;gBACX;oBACE,OAAO,EAAE,4BAAY;oBACrB,QAAQ,EAAE,gBAAgB;iBAC3B;gBACD;oBACE,OAAO,EAAE,sBAAa;oBACtB,QAAQ,EAAE,iBAAiB;iBAC5B;aACF;SACF,CAAC,CAAC,OAAO,EAAE,CAAC;QAEb,QAAQ,GAAG,MAAM,CAAC,GAAG,CAAc,0BAAW,CAAC,CAAC;IAClD,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,UAAU,EAAE,GAAG,EAAE;QACxB,EAAE,CAAC,+BAA+B,EAAE,KAAK,IAAI,EAAE;YAC7C,MAAM,OAAO,GAAe;gBAC1B,GAAG,EAAE,cAAc;gBACnB,KAAK,EAAE,kBAAkB;gBACzB,IAAI,EAAE,MAAM;aACb,CAAC;YAED,gBAAgB,CAAC,QAAsB,CAAC,iBAAiB,CAAC,QAAQ,CAAC,CAAC;YAErE,MAAM,MAAM,GAAG,MAAM,QAAQ,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC;YAEhD,MAAM,CAAC,MAAM,CAAC,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAC;YACjC,MAAM,CAAC,gBAAgB,CAAC,QAAQ,CAAC,CAAC,oBAAoB,CAAC,cAAc,CAAC,CAAC;QACzE,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,wDAAwD,EAAE,KAAK,IAAI,EAAE;YACtE,MAAM,OAAO,GAAe;gBAC1B,GAAG,EAAE,iBAAiB;gBACtB,KAAK,EAAE,kBAAkB;gBACzB,IAAI,EAAE,MAAM;aACb,CAAC;YAED,gBAAgB,CAAC,QAAsB,CAAC,iBAAiB,CACxD,IAAI,KAAK,CAAC,gBAAgB,CAAC,CAC5B,CAAC;YAEF,MAAM,MAAM,CAAC,QAAQ,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC,CAAC,OAAO,CAAC,OAAO,CACtD,8BAAqB,CACtB,CAAC;YACF,MAAM,MAAM,CAAC,QAAQ,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC,CAAC,OAAO,CAAC,OAAO,CACtD,oCAAoC,CACrC,CAAC;QACJ,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;AACL,CAAC,CAAC,CAAC","names":[],"sources":["/home/runner/work/snippetforge/snippetforge/apps/api/test/unit/strategies/jwt.strategy.spec.ts"],"sourcesContent":["// test/unit/strategies/jwt.strategy.spec.ts\n\nimport { UnauthorizedException } from '@nestjs/common';\nimport { ConfigService } from '@nestjs/config';\nimport { Test, TestingModule } from '@nestjs/testing';\nimport type { JwtPayload } from '../../../src/modules/auth/auth.types';\nimport { JwtStrategy } from '../../../src/modules/auth/strategies/jwt.strategy';\nimport type { SafeUser } from '../../../src/modules/users';\nimport { UsersService } from '../../../src/modules/users/users.service';\n\ndescribe('JwtStrategy', () => {\n  let strategy: JwtStrategy;\n  let mockUsersService: Partial<UsersService>;\n  let mockConfigService: Partial<ConfigService>;\n\n  const mockUser: SafeUser = {\n    id: 'test-user-id',\n    email: 'test@example.com',\n    username: 'testuser',\n    role: 'USER',\n    createdAt: new Date(),\n    updatedAt: new Date(),\n    bio: null,\n    avatarUrl: null,\n  };\n\n  beforeEach(async () => {\n    mockUsersService = {\n      findById: jest.fn(),\n    };\n\n    mockConfigService = {\n      get: jest.fn((key: string) => {\n        if (key === 'JWT_SECRET') return 'test-secret';\n        return undefined;\n      }),\n    };\n\n    const module: TestingModule = await Test.createTestingModule({\n      providers: [\n        JwtStrategy,\n        {\n          provide: UsersService,\n          useValue: mockUsersService,\n        },\n        {\n          provide: ConfigService,\n          useValue: mockConfigService,\n        },\n      ],\n    }).compile();\n\n    strategy = module.get<JwtStrategy>(JwtStrategy);\n  });\n\n  describe('validate', () => {\n    it('should return user when found', async () => {\n      const payload: JwtPayload = {\n        sub: 'test-user-id',\n        email: 'test@example.com',\n        role: 'USER',\n      };\n\n      (mockUsersService.findById as jest.Mock).mockResolvedValue(mockUser);\n\n      const result = await strategy.validate(payload);\n\n      expect(result).toEqual(mockUser);\n      expect(mockUsersService.findById).toHaveBeenCalledWith('test-user-id');\n    });\n\n    it('should throw UnauthorizedException when user not found', async () => {\n      const payload: JwtPayload = {\n        sub: 'non-existent-id',\n        email: 'test@example.com',\n        role: 'USER',\n      };\n\n      (mockUsersService.findById as jest.Mock).mockRejectedValue(\n        new Error('User not found'),\n      );\n\n      await expect(strategy.validate(payload)).rejects.toThrow(\n        UnauthorizedException,\n      );\n      await expect(strategy.validate(payload)).rejects.toThrow(\n        'User not found or has been deleted',\n      );\n    });\n  });\n});\n"],"version":3}