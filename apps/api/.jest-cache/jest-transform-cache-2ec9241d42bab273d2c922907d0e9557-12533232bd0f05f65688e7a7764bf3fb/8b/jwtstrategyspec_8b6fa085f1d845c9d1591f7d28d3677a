7e172da97b0359671c60aad07cd8cc76
"use strict";
// test/unit/strategies/jwt.strategy.spec.ts
Object.defineProperty(exports, "__esModule", { value: true });
const common_1 = require("@nestjs/common");
const config_1 = require("@nestjs/config");
const testing_1 = require("@nestjs/testing");
const jwt_strategy_1 = require("../../../src/modules/auth/strategies/jwt.strategy");
const users_service_1 = require("../../../src/modules/users/users.service");
describe('JwtStrategy', () => {
    let strategy;
    let mockUsersService;
    let mockConfigService;
    const mockUser = {
        id: 'test-user-id',
        email: 'test@example.com',
        username: 'testuser',
        role: 'USER',
        createdAt: new Date(),
        updatedAt: new Date(),
        bio: null,
        avatarUrl: null,
    };
    beforeEach(async () => {
        mockUsersService = {
            findById: jest.fn(),
        };
        mockConfigService = {
            get: jest.fn((key) => {
                if (key === 'JWT_SECRET')
                    return 'test-secret';
                return undefined;
            }),
        };
        const module = await testing_1.Test.createTestingModule({
            providers: [
                jwt_strategy_1.JwtStrategy,
                {
                    provide: users_service_1.UsersService,
                    useValue: mockUsersService,
                },
                {
                    provide: config_1.ConfigService,
                    useValue: mockConfigService,
                },
            ],
        }).compile();
        strategy = module.get(jwt_strategy_1.JwtStrategy);
    });
    describe('validate', () => {
        it('should return user when found', async () => {
            const payload = {
                sub: 'test-user-id',
                email: 'test@example.com',
                role: 'USER',
            };
            mockUsersService.findById.mockResolvedValue(mockUser);
            const result = await strategy.validate(payload);
            expect(result).toEqual(mockUser);
            expect(mockUsersService.findById).toHaveBeenCalledWith('test-user-id');
        });
        it('should throw UnauthorizedException when user not found', async () => {
            const payload = {
                sub: 'non-existent-id',
                email: 'test@example.com',
                role: 'USER',
            };
            mockUsersService.findById.mockRejectedValue(new Error('User not found'));
            await expect(strategy.validate(payload)).rejects.toThrow(common_1.UnauthorizedException);
            await expect(strategy.validate(payload)).rejects.toThrow('User not found or has been deleted');
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmsvc25pcHBldGZvcmdlL3NuaXBwZXRmb3JnZS9hcHBzL2FwaS90ZXN0L3VuaXQvc3RyYXRlZ2llcy9qd3Quc3RyYXRlZ3kuc3BlYy50cyIsIm1hcHBpbmdzIjoiO0FBQUEsNENBQTRDOztBQUU1QywyQ0FBdUQ7QUFDdkQsMkNBQStDO0FBQy9DLDZDQUFzRDtBQUV0RCxvRkFBZ0Y7QUFFaEYsNEVBQXdFO0FBRXhFLFFBQVEsQ0FBQyxhQUFhLEVBQUUsR0FBRyxFQUFFO0lBQzNCLElBQUksUUFBcUIsQ0FBQztJQUMxQixJQUFJLGdCQUF1QyxDQUFDO0lBQzVDLElBQUksaUJBQXlDLENBQUM7SUFFOUMsTUFBTSxRQUFRLEdBQWE7UUFDekIsRUFBRSxFQUFFLGNBQWM7UUFDbEIsS0FBSyxFQUFFLGtCQUFrQjtRQUN6QixRQUFRLEVBQUUsVUFBVTtRQUNwQixJQUFJLEVBQUUsTUFBTTtRQUNaLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRTtRQUNyQixTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUU7UUFDckIsR0FBRyxFQUFFLElBQUk7UUFDVCxTQUFTLEVBQUUsSUFBSTtLQUNoQixDQUFDO0lBRUYsVUFBVSxDQUFDLEtBQUssSUFBSSxFQUFFO1FBQ3BCLGdCQUFnQixHQUFHO1lBQ2pCLFFBQVEsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1NBQ3BCLENBQUM7UUFFRixpQkFBaUIsR0FBRztZQUNsQixHQUFHLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEdBQVcsRUFBRSxFQUFFO2dCQUMzQixJQUFJLEdBQUcsS0FBSyxZQUFZO29CQUFFLE9BQU8sYUFBYSxDQUFDO2dCQUMvQyxPQUFPLFNBQVMsQ0FBQztZQUNuQixDQUFDLENBQUM7U0FDSCxDQUFDO1FBRUYsTUFBTSxNQUFNLEdBQWtCLE1BQU0sY0FBSSxDQUFDLG1CQUFtQixDQUFDO1lBQzNELFNBQVMsRUFBRTtnQkFDVCwwQkFBVztnQkFDWDtvQkFDRSxPQUFPLEVBQUUsNEJBQVk7b0JBQ3JCLFFBQVEsRUFBRSxnQkFBZ0I7aUJBQzNCO2dCQUNEO29CQUNFLE9BQU8sRUFBRSxzQkFBYTtvQkFDdEIsUUFBUSxFQUFFLGlCQUFpQjtpQkFDNUI7YUFDRjtTQUNGLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUViLFFBQVEsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFjLDBCQUFXLENBQUMsQ0FBQztJQUNsRCxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxVQUFVLEVBQUUsR0FBRyxFQUFFO1FBQ3hCLEVBQUUsQ0FBQywrQkFBK0IsRUFBRSxLQUFLLElBQUksRUFBRTtZQUM3QyxNQUFNLE9BQU8sR0FBZTtnQkFDMUIsR0FBRyxFQUFFLGNBQWM7Z0JBQ25CLEtBQUssRUFBRSxrQkFBa0I7Z0JBQ3pCLElBQUksRUFBRSxNQUFNO2FBQ2IsQ0FBQztZQUVELGdCQUFnQixDQUFDLFFBQXNCLENBQUMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLENBQUM7WUFFckUsTUFBTSxNQUFNLEdBQUcsTUFBTSxRQUFRLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBRWhELE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDakMsTUFBTSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxDQUFDLG9CQUFvQixDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBQ3pFLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLHdEQUF3RCxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQ3RFLE1BQU0sT0FBTyxHQUFlO2dCQUMxQixHQUFHLEVBQUUsaUJBQWlCO2dCQUN0QixLQUFLLEVBQUUsa0JBQWtCO2dCQUN6QixJQUFJLEVBQUUsTUFBTTthQUNiLENBQUM7WUFFRCxnQkFBZ0IsQ0FBQyxRQUFzQixDQUFDLGlCQUFpQixDQUN4RCxJQUFJLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxDQUM1QixDQUFDO1lBRUYsTUFBTSxNQUFNLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQ3RELDhCQUFxQixDQUN0QixDQUFDO1lBQ0YsTUFBTSxNQUFNLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQ3RELG9DQUFvQyxDQUNyQyxDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3J1bm5lci93b3JrL3NuaXBwZXRmb3JnZS9zbmlwcGV0Zm9yZ2UvYXBwcy9hcGkvdGVzdC91bml0L3N0cmF0ZWdpZXMvand0LnN0cmF0ZWd5LnNwZWMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gdGVzdC91bml0L3N0cmF0ZWdpZXMvand0LnN0cmF0ZWd5LnNwZWMudHNcblxuaW1wb3J0IHsgVW5hdXRob3JpemVkRXhjZXB0aW9uIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgQ29uZmlnU2VydmljZSB9IGZyb20gJ0BuZXN0anMvY29uZmlnJztcbmltcG9ydCB7IFRlc3QsIFRlc3RpbmdNb2R1bGUgfSBmcm9tICdAbmVzdGpzL3Rlc3RpbmcnO1xuaW1wb3J0IHR5cGUgeyBKd3RQYXlsb2FkIH0gZnJvbSAnLi4vLi4vLi4vc3JjL21vZHVsZXMvYXV0aC9hdXRoLnR5cGVzJztcbmltcG9ydCB7IEp3dFN0cmF0ZWd5IH0gZnJvbSAnLi4vLi4vLi4vc3JjL21vZHVsZXMvYXV0aC9zdHJhdGVnaWVzL2p3dC5zdHJhdGVneSc7XG5pbXBvcnQgdHlwZSB7IFNhZmVVc2VyIH0gZnJvbSAnLi4vLi4vLi4vc3JjL21vZHVsZXMvdXNlcnMnO1xuaW1wb3J0IHsgVXNlcnNTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vLi4vc3JjL21vZHVsZXMvdXNlcnMvdXNlcnMuc2VydmljZSc7XG5cbmRlc2NyaWJlKCdKd3RTdHJhdGVneScsICgpID0+IHtcbiAgbGV0IHN0cmF0ZWd5OiBKd3RTdHJhdGVneTtcbiAgbGV0IG1vY2tVc2Vyc1NlcnZpY2U6IFBhcnRpYWw8VXNlcnNTZXJ2aWNlPjtcbiAgbGV0IG1vY2tDb25maWdTZXJ2aWNlOiBQYXJ0aWFsPENvbmZpZ1NlcnZpY2U+O1xuXG4gIGNvbnN0IG1vY2tVc2VyOiBTYWZlVXNlciA9IHtcbiAgICBpZDogJ3Rlc3QtdXNlci1pZCcsXG4gICAgZW1haWw6ICd0ZXN0QGV4YW1wbGUuY29tJyxcbiAgICB1c2VybmFtZTogJ3Rlc3R1c2VyJyxcbiAgICByb2xlOiAnVVNFUicsXG4gICAgY3JlYXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgIHVwZGF0ZWRBdDogbmV3IERhdGUoKSxcbiAgICBiaW86IG51bGwsXG4gICAgYXZhdGFyVXJsOiBudWxsLFxuICB9O1xuXG4gIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xuICAgIG1vY2tVc2Vyc1NlcnZpY2UgPSB7XG4gICAgICBmaW5kQnlJZDogamVzdC5mbigpLFxuICAgIH07XG5cbiAgICBtb2NrQ29uZmlnU2VydmljZSA9IHtcbiAgICAgIGdldDogamVzdC5mbigoa2V5OiBzdHJpbmcpID0+IHtcbiAgICAgICAgaWYgKGtleSA9PT0gJ0pXVF9TRUNSRVQnKSByZXR1cm4gJ3Rlc3Qtc2VjcmV0JztcbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgIH0pLFxuICAgIH07XG5cbiAgICBjb25zdCBtb2R1bGU6IFRlc3RpbmdNb2R1bGUgPSBhd2FpdCBUZXN0LmNyZWF0ZVRlc3RpbmdNb2R1bGUoe1xuICAgICAgcHJvdmlkZXJzOiBbXG4gICAgICAgIEp3dFN0cmF0ZWd5LFxuICAgICAgICB7XG4gICAgICAgICAgcHJvdmlkZTogVXNlcnNTZXJ2aWNlLFxuICAgICAgICAgIHVzZVZhbHVlOiBtb2NrVXNlcnNTZXJ2aWNlLFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgcHJvdmlkZTogQ29uZmlnU2VydmljZSxcbiAgICAgICAgICB1c2VWYWx1ZTogbW9ja0NvbmZpZ1NlcnZpY2UsXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgIH0pLmNvbXBpbGUoKTtcblxuICAgIHN0cmF0ZWd5ID0gbW9kdWxlLmdldDxKd3RTdHJhdGVneT4oSnd0U3RyYXRlZ3kpO1xuICB9KTtcblxuICBkZXNjcmliZSgndmFsaWRhdGUnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gdXNlciB3aGVuIGZvdW5kJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcGF5bG9hZDogSnd0UGF5bG9hZCA9IHtcbiAgICAgICAgc3ViOiAndGVzdC11c2VyLWlkJyxcbiAgICAgICAgZW1haWw6ICd0ZXN0QGV4YW1wbGUuY29tJyxcbiAgICAgICAgcm9sZTogJ1VTRVInLFxuICAgICAgfTtcblxuICAgICAgKG1vY2tVc2Vyc1NlcnZpY2UuZmluZEJ5SWQgYXMgamVzdC5Nb2NrKS5tb2NrUmVzb2x2ZWRWYWx1ZShtb2NrVXNlcik7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHN0cmF0ZWd5LnZhbGlkYXRlKHBheWxvYWQpO1xuXG4gICAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKG1vY2tVc2VyKTtcbiAgICAgIGV4cGVjdChtb2NrVXNlcnNTZXJ2aWNlLmZpbmRCeUlkKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgndGVzdC11c2VyLWlkJyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHRocm93IFVuYXV0aG9yaXplZEV4Y2VwdGlvbiB3aGVuIHVzZXIgbm90IGZvdW5kJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcGF5bG9hZDogSnd0UGF5bG9hZCA9IHtcbiAgICAgICAgc3ViOiAnbm9uLWV4aXN0ZW50LWlkJyxcbiAgICAgICAgZW1haWw6ICd0ZXN0QGV4YW1wbGUuY29tJyxcbiAgICAgICAgcm9sZTogJ1VTRVInLFxuICAgICAgfTtcblxuICAgICAgKG1vY2tVc2Vyc1NlcnZpY2UuZmluZEJ5SWQgYXMgamVzdC5Nb2NrKS5tb2NrUmVqZWN0ZWRWYWx1ZShcbiAgICAgICAgbmV3IEVycm9yKCdVc2VyIG5vdCBmb3VuZCcpLFxuICAgICAgKTtcblxuICAgICAgYXdhaXQgZXhwZWN0KHN0cmF0ZWd5LnZhbGlkYXRlKHBheWxvYWQpKS5yZWplY3RzLnRvVGhyb3coXG4gICAgICAgIFVuYXV0aG9yaXplZEV4Y2VwdGlvbixcbiAgICAgICk7XG4gICAgICBhd2FpdCBleHBlY3Qoc3RyYXRlZ3kudmFsaWRhdGUocGF5bG9hZCkpLnJlamVjdHMudG9UaHJvdyhcbiAgICAgICAgJ1VzZXIgbm90IGZvdW5kIG9yIGhhcyBiZWVuIGRlbGV0ZWQnLFxuICAgICAgKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==