{"file":"/home/runner/work/snippetforge/snippetforge/apps/api/test/unit/guards/roles.guard.spec.ts","mappings":"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","names":[],"sources":["/home/runner/work/snippetforge/snippetforge/apps/api/test/unit/guards/roles.guard.spec.ts"],"sourcesContent":["// test/unit/guards/roles.guard.spec.ts\n\nimport { ExecutionContext, ForbiddenException } from '@nestjs/common';\nimport { Reflector } from '@nestjs/core';\nimport { RolesGuard } from '../../../src/modules/auth/guards/roles.guard';\nimport { createMockReflector, createMockSafeUser } from '../../mocks';\nimport { createMockExecutionContext } from '../../setup/test-utils';\n\n/**\n * RolesGuard Unit Tests\n *\n * Testet:\n * - Routes ohne @Roles() sind für alle erlaubt\n * - Routes mit @Roles() erfordern passende Rolle\n * - Fehlende Rolle führt zu ForbiddenException\n */\ndescribe('RolesGuard', () => {\n  let guard: RolesGuard;\n  let reflector: ReturnType<typeof createMockReflector>;\n\n  beforeEach(() => {\n    reflector = createMockReflector();\n    guard = new RolesGuard(reflector as unknown as Reflector);\n  });\n\n  afterEach(() => {\n    jest.clearAllMocks();\n  });\n\n  describe('canActivate', () => {\n    describe('when no roles are required', () => {\n      it('should return true for any user', () => {\n        // Arrange\n        reflector.getAllAndOverride.mockReturnValue(undefined);\n        const user = createMockSafeUser({ role: 'USER' });\n        const context = createMockExecutionContext({\n          request: { user },\n        }) as unknown as ExecutionContext;\n\n        // Act\n        const result = guard.canActivate(context);\n\n        // Assert\n        expect(result).toBe(true);\n      });\n\n      it('should return true when roles array is empty', () => {\n        // Arrange\n        reflector.getAllAndOverride.mockReturnValue([]);\n        const user = createMockSafeUser({ role: 'USER' });\n        const context = createMockExecutionContext({\n          request: { user },\n        }) as unknown as ExecutionContext;\n\n        // Act\n        const result = guard.canActivate(context);\n\n        // Assert\n        expect(result).toBe(true);\n      });\n    });\n\n    describe('when roles are required', () => {\n      it('should return true when user has required role', () => {\n        // Arrange\n        reflector.getAllAndOverride.mockReturnValue(['ADMIN']);\n        const user = createMockSafeUser({ role: 'ADMIN' });\n        const context = createMockExecutionContext({\n          request: { user },\n        }) as unknown as ExecutionContext;\n\n        // Act\n        const result = guard.canActivate(context);\n\n        // Assert\n        expect(result).toBe(true);\n      });\n\n      it('should return true when user has one of multiple allowed roles', () => {\n        // Arrange\n        reflector.getAllAndOverride.mockReturnValue(['ADMIN', 'MODERATOR']);\n        const user = createMockSafeUser({ role: 'MODERATOR' });\n        const context = createMockExecutionContext({\n          request: { user },\n        }) as unknown as ExecutionContext;\n\n        // Act\n        const result = guard.canActivate(context);\n\n        // Assert\n        expect(result).toBe(true);\n      });\n\n      it('should throw ForbiddenException when user lacks required role', () => {\n        // Arrange\n        reflector.getAllAndOverride.mockReturnValue(['ADMIN']);\n        const user = createMockSafeUser({ role: 'USER' });\n        const context = createMockExecutionContext({\n          request: { user },\n        }) as unknown as ExecutionContext;\n\n        // Act & Assert\n        expect(() => guard.canActivate(context)).toThrow(ForbiddenException);\n      });\n\n      it('should throw ForbiddenException when no user in request', () => {\n        // Arrange\n        reflector.getAllAndOverride.mockReturnValue(['ADMIN']);\n        const context = createMockExecutionContext({\n          request: { user: undefined },\n        }) as unknown as ExecutionContext;\n\n        // Act & Assert\n        expect(() => guard.canActivate(context)).toThrow(ForbiddenException);\n      });\n    });\n  });\n});\n"],"version":3}