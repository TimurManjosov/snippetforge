ad21ea9c105ccad9d0ffe6c104380f12
"use strict";
// src/modules/auth/guards/jwt-auth.guard.ts
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var JwtAuthGuard_1;
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.JwtAuthGuard = void 0;
const common_1 = require("@nestjs/common");
const core_1 = require("@nestjs/core");
const passport_1 = require("@nestjs/passport");
const public_decorator_1 = require("../decorators/public.decorator");
/**
 * JwtAuthGuard - Schützt Routes vor unauthentifizierten Zugriffen
 *
 * WIE ES FUNKTIONIERT:
 * 1. Guard wird auf Route/Controller angewendet
 * 2. canActivate() wird aufgerufen
 * 3. Prüft ob Route @Public() ist → Wenn ja, erlauben
 * 4. Wenn nicht public, delegiert an Passport JwtStrategy
 * 5. JwtStrategy validiert Token und lädt User
 * 6. Wenn erfolgreich:  request.user = User, Route wird ausgeführt
 * 7. Wenn fehlgeschlagen: 401 Unauthorized
 *
 * VERWENDUNG:
 *
 * // Auf einzelner Route
 * @UseGuards(JwtAuthGuard)
 * @Get('profile')
 * getProfile() {}
 *
 * // Global auf allen Routes (in main.ts)
 * app.useGlobalGuards(new JwtAuthGuard(reflector))
 *
 * // Route von Auth ausnehmen
 * @Public()
 * @Get('health')
 * healthCheck() {}
 */
let JwtAuthGuard = JwtAuthGuard_1 = class JwtAuthGuard extends (0, passport_1.AuthGuard)('jwt') {
    reflector;
    logger = new common_1.Logger(JwtAuthGuard_1.name);
    constructor(reflector) {
        super();
        this.reflector = reflector;
    }
    /**
     * canActivate - Entscheidet ob Request durchgelassen wird
     *
     * @param context - Execution Context (enthält Request, Handler, etc.)
     * @returns true wenn erlaubt, false/Exception wenn nicht
     */
    canActivate(context) {
        // 1. Prüfe ob Route als @Public() markiert ist
        const isPublic = this.reflector.getAllAndOverride(public_decorator_1.IS_PUBLIC_KEY, [
            context.getHandler(), // Methode (@Public() auf Methode)
            context.getClass(), // Controller (@Public() auf Controller)
        ]);
        // 2. Wenn public, sofort erlauben (keine Token-Prüfung)
        if (isPublic) {
            this.logger.debug('Public route accessed, skipping authentication');
            return true;
        }
        // 3. Wenn nicht public, Passport JWT Strategy ausführen
        return super.canActivate(context);
    }
    /**
     * handleRequest - Verarbeitet Passport-Ergebnis
     *
     * Wird nach JwtStrategy.validate() aufgerufen
     * Erlaubt uns, den Error/User zu customizen
     *
     * @param err - Error von Passport (null wenn erfolgreich)
     * @param user - User von JwtStrategy. validate() (undefined wenn fehlgeschlagen)
     * @param info - Zusätzliche Info (z.B. "jwt expired")
     * @returns User wenn erfolgreich
     * @throws UnauthorizedException wenn fehlgeschlagen
     */
    handleRequest(err, user, info) {
        // Passport Error (z.B. invalid signature)
        if (err) {
            this.logger.warn(`Authentication error: ${err.message}`);
            throw new common_1.UnauthorizedException('Authentication failed');
        }
        // Kein User (Token invalid/expired oder User nicht gefunden)
        if (!user) {
            const message = info?.message || 'Invalid or missing authentication token';
            this.logger.warn(`Authentication failed: ${message}`);
            throw new common_1.UnauthorizedException(message);
        }
        return user;
    }
};
exports.JwtAuthGuard = JwtAuthGuard;
exports.JwtAuthGuard = JwtAuthGuard = JwtAuthGuard_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof core_1.Reflector !== "undefined" && core_1.Reflector) === "function" ? _a : Object])
], JwtAuthGuard);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmsvc25pcHBldGZvcmdlL3NuaXBwZXRmb3JnZS9hcHBzL2FwaS9zcmMvbW9kdWxlcy9hdXRoL2d1YXJkcy9qd3QtYXV0aC5ndWFyZC50cyIsIm1hcHBpbmdzIjoiO0FBQUEsNENBQTRDOzs7Ozs7Ozs7Ozs7OztBQUU1QywyQ0FLd0I7QUFDeEIsdUNBQXlDO0FBQ3pDLCtDQUE2QztBQUM3QyxxRUFBK0Q7QUFFL0Q7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBMEJHO0FBRUksSUFBTSxZQUFZLG9CQUFsQixNQUFNLFlBQWEsU0FBUSxJQUFBLG9CQUFTLEVBQUMsS0FBSyxDQUFDO0lBRzVCO0lBRkgsTUFBTSxHQUFHLElBQUksZUFBTSxDQUFDLGNBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUV4RCxZQUFvQixTQUFvQjtRQUN0QyxLQUFLLEVBQUUsQ0FBQztRQURVLGNBQVMsR0FBVCxTQUFTLENBQVc7SUFFeEMsQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0gsV0FBVyxDQUFDLE9BQXlCO1FBQ25DLCtDQUErQztRQUMvQyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLGlCQUFpQixDQUFVLGdDQUFhLEVBQUU7WUFDeEUsT0FBTyxDQUFDLFVBQVUsRUFBRSxFQUFFLGtDQUFrQztZQUN4RCxPQUFPLENBQUMsUUFBUSxFQUFFLEVBQUUsd0NBQXdDO1NBQzdELENBQUMsQ0FBQztRQUVILHdEQUF3RDtRQUN4RCxJQUFJLFFBQVEsRUFBRSxDQUFDO1lBQ2IsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsZ0RBQWdELENBQUMsQ0FBQztZQUNwRSxPQUFPLElBQUksQ0FBQztRQUNkLENBQUM7UUFFRCx3REFBd0Q7UUFDeEQsT0FBTyxLQUFLLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ3BDLENBQUM7SUFFRDs7Ozs7Ozs7Ozs7T0FXRztJQUNILGFBQWEsQ0FBSSxHQUFpQixFQUFFLElBQU8sRUFBRSxJQUF1QjtRQUNsRSwwQ0FBMEM7UUFDMUMsSUFBSSxHQUFHLEVBQUUsQ0FBQztZQUNSLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLHlCQUF5QixHQUFHLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztZQUN6RCxNQUFNLElBQUksOEJBQXFCLENBQUMsdUJBQXVCLENBQUMsQ0FBQztRQUMzRCxDQUFDO1FBRUQsNkRBQTZEO1FBQzdELElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUNWLE1BQU0sT0FBTyxHQUNYLElBQUksRUFBRSxPQUFPLElBQUkseUNBQXlDLENBQUM7WUFDN0QsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsMEJBQTBCLE9BQU8sRUFBRSxDQUFDLENBQUM7WUFDdEQsTUFBTSxJQUFJLDhCQUFxQixDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzNDLENBQUM7UUFFRCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7Q0FDRixDQUFBO0FBM0RZLG9DQUFZO3VCQUFaLFlBQVk7SUFEeEIsSUFBQSxtQkFBVSxHQUFFO3lEQUlvQixnQkFBUyxvQkFBVCxnQkFBUztHQUg3QixZQUFZLENBMkR4QiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS9ydW5uZXIvd29yay9zbmlwcGV0Zm9yZ2Uvc25pcHBldGZvcmdlL2FwcHMvYXBpL3NyYy9tb2R1bGVzL2F1dGgvZ3VhcmRzL2p3dC1hdXRoLmd1YXJkLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIHNyYy9tb2R1bGVzL2F1dGgvZ3VhcmRzL2p3dC1hdXRoLmd1YXJkLnRzXG5cbmltcG9ydCB7XG4gIEV4ZWN1dGlvbkNvbnRleHQsXG4gIEluamVjdGFibGUsXG4gIExvZ2dlcixcbiAgVW5hdXRob3JpemVkRXhjZXB0aW9uLFxufSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBSZWZsZWN0b3IgfSBmcm9tICdAbmVzdGpzL2NvcmUnO1xuaW1wb3J0IHsgQXV0aEd1YXJkIH0gZnJvbSAnQG5lc3Rqcy9wYXNzcG9ydCc7XG5pbXBvcnQgeyBJU19QVUJMSUNfS0VZIH0gZnJvbSAnLi4vZGVjb3JhdG9ycy9wdWJsaWMuZGVjb3JhdG9yJztcblxuLyoqXG4gKiBKd3RBdXRoR3VhcmQgLSBTY2jDvHR6dCBSb3V0ZXMgdm9yIHVuYXV0aGVudGlmaXppZXJ0ZW4gWnVncmlmZmVuXG4gKlxuICogV0lFIEVTIEZVTktUSU9OSUVSVDpcbiAqIDEuIEd1YXJkIHdpcmQgYXVmIFJvdXRlL0NvbnRyb2xsZXIgYW5nZXdlbmRldFxuICogMi4gY2FuQWN0aXZhdGUoKSB3aXJkIGF1ZmdlcnVmZW5cbiAqIDMuIFByw7xmdCBvYiBSb3V0ZSBAUHVibGljKCkgaXN0IOKGkiBXZW5uIGphLCBlcmxhdWJlblxuICogNC4gV2VubiBuaWNodCBwdWJsaWMsIGRlbGVnaWVydCBhbiBQYXNzcG9ydCBKd3RTdHJhdGVneVxuICogNS4gSnd0U3RyYXRlZ3kgdmFsaWRpZXJ0IFRva2VuIHVuZCBsw6RkdCBVc2VyXG4gKiA2LiBXZW5uIGVyZm9sZ3JlaWNoOiAgcmVxdWVzdC51c2VyID0gVXNlciwgUm91dGUgd2lyZCBhdXNnZWbDvGhydFxuICogNy4gV2VubiBmZWhsZ2VzY2hsYWdlbjogNDAxIFVuYXV0aG9yaXplZFxuICpcbiAqIFZFUldFTkRVTkc6XG4gKlxuICogLy8gQXVmIGVpbnplbG5lciBSb3V0ZVxuICogQFVzZUd1YXJkcyhKd3RBdXRoR3VhcmQpXG4gKiBAR2V0KCdwcm9maWxlJylcbiAqIGdldFByb2ZpbGUoKSB7fVxuICpcbiAqIC8vIEdsb2JhbCBhdWYgYWxsZW4gUm91dGVzIChpbiBtYWluLnRzKVxuICogYXBwLnVzZUdsb2JhbEd1YXJkcyhuZXcgSnd0QXV0aEd1YXJkKHJlZmxlY3RvcikpXG4gKlxuICogLy8gUm91dGUgdm9uIEF1dGggYXVzbmVobWVuXG4gKiBAUHVibGljKClcbiAqIEBHZXQoJ2hlYWx0aCcpXG4gKiBoZWFsdGhDaGVjaygpIHt9XG4gKi9cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBKd3RBdXRoR3VhcmQgZXh0ZW5kcyBBdXRoR3VhcmQoJ2p3dCcpIHtcbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXIgPSBuZXcgTG9nZ2VyKEp3dEF1dGhHdWFyZC5uYW1lKTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlZmxlY3RvcjogUmVmbGVjdG9yKSB7XG4gICAgc3VwZXIoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBjYW5BY3RpdmF0ZSAtIEVudHNjaGVpZGV0IG9iIFJlcXVlc3QgZHVyY2hnZWxhc3NlbiB3aXJkXG4gICAqXG4gICAqIEBwYXJhbSBjb250ZXh0IC0gRXhlY3V0aW9uIENvbnRleHQgKGVudGjDpGx0IFJlcXVlc3QsIEhhbmRsZXIsIGV0Yy4pXG4gICAqIEByZXR1cm5zIHRydWUgd2VubiBlcmxhdWJ0LCBmYWxzZS9FeGNlcHRpb24gd2VubiBuaWNodFxuICAgKi9cbiAgY2FuQWN0aXZhdGUoY29udGV4dDogRXhlY3V0aW9uQ29udGV4dCkge1xuICAgIC8vIDEuIFByw7xmZSBvYiBSb3V0ZSBhbHMgQFB1YmxpYygpIG1hcmtpZXJ0IGlzdFxuICAgIGNvbnN0IGlzUHVibGljID0gdGhpcy5yZWZsZWN0b3IuZ2V0QWxsQW5kT3ZlcnJpZGU8Ym9vbGVhbj4oSVNfUFVCTElDX0tFWSwgW1xuICAgICAgY29udGV4dC5nZXRIYW5kbGVyKCksIC8vIE1ldGhvZGUgKEBQdWJsaWMoKSBhdWYgTWV0aG9kZSlcbiAgICAgIGNvbnRleHQuZ2V0Q2xhc3MoKSwgLy8gQ29udHJvbGxlciAoQFB1YmxpYygpIGF1ZiBDb250cm9sbGVyKVxuICAgIF0pO1xuXG4gICAgLy8gMi4gV2VubiBwdWJsaWMsIHNvZm9ydCBlcmxhdWJlbiAoa2VpbmUgVG9rZW4tUHLDvGZ1bmcpXG4gICAgaWYgKGlzUHVibGljKSB7XG4gICAgICB0aGlzLmxvZ2dlci5kZWJ1ZygnUHVibGljIHJvdXRlIGFjY2Vzc2VkLCBza2lwcGluZyBhdXRoZW50aWNhdGlvbicpO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgLy8gMy4gV2VubiBuaWNodCBwdWJsaWMsIFBhc3Nwb3J0IEpXVCBTdHJhdGVneSBhdXNmw7xocmVuXG4gICAgcmV0dXJuIHN1cGVyLmNhbkFjdGl2YXRlKGNvbnRleHQpO1xuICB9XG5cbiAgLyoqXG4gICAqIGhhbmRsZVJlcXVlc3QgLSBWZXJhcmJlaXRldCBQYXNzcG9ydC1FcmdlYm5pc1xuICAgKlxuICAgKiBXaXJkIG5hY2ggSnd0U3RyYXRlZ3kudmFsaWRhdGUoKSBhdWZnZXJ1ZmVuXG4gICAqIEVybGF1YnQgdW5zLCBkZW4gRXJyb3IvVXNlciB6dSBjdXN0b21pemVuXG4gICAqXG4gICAqIEBwYXJhbSBlcnIgLSBFcnJvciB2b24gUGFzc3BvcnQgKG51bGwgd2VubiBlcmZvbGdyZWljaClcbiAgICogQHBhcmFtIHVzZXIgLSBVc2VyIHZvbiBKd3RTdHJhdGVneS4gdmFsaWRhdGUoKSAodW5kZWZpbmVkIHdlbm4gZmVobGdlc2NobGFnZW4pXG4gICAqIEBwYXJhbSBpbmZvIC0gWnVzw6R0emxpY2hlIEluZm8gKHouQi4gXCJqd3QgZXhwaXJlZFwiKVxuICAgKiBAcmV0dXJucyBVc2VyIHdlbm4gZXJmb2xncmVpY2hcbiAgICogQHRocm93cyBVbmF1dGhvcml6ZWRFeGNlcHRpb24gd2VubiBmZWhsZ2VzY2hsYWdlblxuICAgKi9cbiAgaGFuZGxlUmVxdWVzdDxUPihlcnI6IEVycm9yIHwgbnVsbCwgdXNlcjogVCwgaW5mbzogRXJyb3IgfCB1bmRlZmluZWQpOiBUIHtcbiAgICAvLyBQYXNzcG9ydCBFcnJvciAoei5CLiBpbnZhbGlkIHNpZ25hdHVyZSlcbiAgICBpZiAoZXJyKSB7XG4gICAgICB0aGlzLmxvZ2dlci53YXJuKGBBdXRoZW50aWNhdGlvbiBlcnJvcjogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgIHRocm93IG5ldyBVbmF1dGhvcml6ZWRFeGNlcHRpb24oJ0F1dGhlbnRpY2F0aW9uIGZhaWxlZCcpO1xuICAgIH1cblxuICAgIC8vIEtlaW4gVXNlciAoVG9rZW4gaW52YWxpZC9leHBpcmVkIG9kZXIgVXNlciBuaWNodCBnZWZ1bmRlbilcbiAgICBpZiAoIXVzZXIpIHtcbiAgICAgIGNvbnN0IG1lc3NhZ2UgPVxuICAgICAgICBpbmZvPy5tZXNzYWdlIHx8ICdJbnZhbGlkIG9yIG1pc3NpbmcgYXV0aGVudGljYXRpb24gdG9rZW4nO1xuICAgICAgdGhpcy5sb2dnZXIud2FybihgQXV0aGVudGljYXRpb24gZmFpbGVkOiAke21lc3NhZ2V9YCk7XG4gICAgICB0aHJvdyBuZXcgVW5hdXRob3JpemVkRXhjZXB0aW9uKG1lc3NhZ2UpO1xuICAgIH1cblxuICAgIHJldHVybiB1c2VyO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=