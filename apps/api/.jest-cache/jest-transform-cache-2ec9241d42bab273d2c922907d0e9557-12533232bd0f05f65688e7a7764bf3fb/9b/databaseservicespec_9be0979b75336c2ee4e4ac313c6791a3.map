{"file":"/home/runner/work/snippetforge/snippetforge/apps/api/test/unit/services/database.service.spec.ts","mappings":";AAAA,sDAAsD;AACtD,4DAA4D;AAC5D,+DAA+D;AAC/D,wDAAwD;AACxD,8CAA8C;;AAE9C,2CAA+C;AAC/C,6CAAsD;AACtD,oFAAgF;AAEhF,QAAQ,CAAC,iBAAiB,EAAE,GAAG,EAAE;IAC/B,IAAI,OAAwB,CAAC;IAC7B,IAAI,iBAAyC,CAAC;IAC9C,IAAI,UAAe,CAAC;IAEpB,UAAU,CAAC,KAAK,IAAI,EAAE;QAMpB,4BAA4B;QAC5B,IAAI,CAAC,IAAI,CAAC,UAAU,EAAE,GAAG,EAAE;YACzB,OAAO,IAAI,CAAC,EAAE,CAAC,GAAG,EAAE,CAAC,UAAU,CAAC,CAAC;QACnC,CAAC,CAAC,CAAC;QARH,UAAU,GAAG;YACX,GAAG,EAAE,IAAI,CAAC,EAAE,EAAE,CAAC,iBAAiB,CAAC,SAAS,CAAC;YAC3C,MAAM,EAAE,IAAI,CAAC,EAAE,EAAE,CAAC,iBAAiB,CAAC,EAAE,CAAC;SACxC,CAAC;QAOF,iBAAiB,GAAG;YAClB,GAAG,EAAE,IAAI,CAAC,EAAE,CAAC,CAAC,GAAW,EAAE,EAAE;gBAC3B,IAAI,GAAG,KAAK,cAAc;oBACxB,OAAO,4CAA4C,CAAC;gBACtD,IAAI,GAAG,KAAK,UAAU;oBAAE,OAAO,MAAM,CAAC;gBACtC,OAAO,SAAS,CAAC;YACnB,CAAC,CAAC;SACH,CAAC;QAEF,MAAM,MAAM,GAAkB,MAAM,cAAI,CAAC,mBAAmB,CAAC;YAC3D,SAAS,EAAE;gBACT,kCAAe;gBACf;oBACE,OAAO,EAAE,sBAAa;oBACtB,QAAQ,EAAE,iBAAiB;iBAC5B;aACF;SACF,CAAC,CAAC,OAAO,EAAE,CAAC;QAEb,OAAO,GAAG,MAAM,CAAC,GAAG,CAAkB,kCAAe,CAAC,CAAC;IACzD,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,iBAAiB,EAAE,GAAG,EAAE;QAC/B,EAAE,CAAC,kCAAkC,EAAE,KAAK,IAAI,EAAE;YAChD,gBAAgB;YACf,OAAe,CAAC,MAAM,GAAG,UAAU,CAAC;YAErC,MAAM,OAAO,CAAC,eAAe,EAAE,CAAC;YAEhC,MAAM,CAAC,UAAU,CAAC,GAAG,CAAC,CAAC,gBAAgB,EAAE,CAAC;QAC5C,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,yCAAyC,EAAE,KAAK,IAAI,EAAE;YACtD,OAAe,CAAC,MAAM,GAAG,IAAI,CAAC;YAE/B,MAAM,MAAM,CAAC,OAAO,CAAC,eAAe,EAAE,CAAC,CAAC,QAAQ,CAAC,GAAG,CAAC,OAAO,EAAE,CAAC;QACjE,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,gBAAgB,EAAE,GAAG,EAAE;QAC9B,EAAE,CAAC,kDAAkD,EAAE,GAAG,EAAE;YAC1D,MAAM,CAAC,GAAG,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC,OAAO,CAAC,0BAA0B,CAAC,CAAC;QACpE,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,YAAY,EAAE,GAAG,EAAE;QAC1B,EAAE,CAAC,wBAAwB,EAAE,KAAK,IAAI,EAAE;YACrC,OAAe,CAAC,MAAM,GAAG,UAAU,CAAC;YACrC,UAAU,CAAC,MAAM,CAAC,iBAAiB,CAAC,CAAC,EAAE,MAAM,EAAE,SAAS,EAAE,CAAC,CAAC,CAAC;YAE7D,MAAM,MAAM,GAAG,MAAM,OAAO,CAAC,UAAU,CAAC,UAAU,CAAC,CAAC;YAEpD,MAAM,CAAC,MAAM,CAAC,CAAC,OAAO,CAAC,CAAC,EAAE,MAAM,EAAE,SAAS,EAAE,CAAC,CAAC,CAAC;YAChD,MAAM,CAAC,UAAU,CAAC,MAAM,CAAC,CAAC,oBAAoB,CAAC,UAAU,CAAC,CAAC;QAC7D,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;AACL,CAAC,CAAC,CAAC","names":[],"sources":["/home/runner/work/snippetforge/snippetforge/apps/api/test/unit/services/database.service.spec.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-unsafe-call */\n/* eslint-disable @typescript-eslint/no-unsafe-assignment */\n/* eslint-disable @typescript-eslint/no-unsafe-member-access */\n/* eslint-disable @typescript-eslint/no-unsafe-return */\n// test/unit/services/database.service.spec.ts\n\nimport { ConfigService } from '@nestjs/config';\nimport { Test, TestingModule } from '@nestjs/testing';\nimport { DatabaseService } from '../../../src/shared/database/database.service';\n\ndescribe('DatabaseService', () => {\n  let service: DatabaseService;\n  let mockConfigService: Partial<ConfigService>;\n  let mockClient: any;\n\n  beforeEach(async () => {\n    mockClient = {\n      end: jest.fn().mockResolvedValue(undefined),\n      unsafe: jest.fn().mockResolvedValue([]),\n    };\n\n    // Mock postgres constructor\n    jest.mock('postgres', () => {\n      return jest.fn(() => mockClient);\n    });\n\n    mockConfigService = {\n      get: jest.fn((key: string) => {\n        if (key === 'DATABASE_URL')\n          return 'postgresql://test:test@localhost:5432/test';\n        if (key === 'NODE_ENV') return 'test';\n        return undefined;\n      }),\n    };\n\n    const module: TestingModule = await Test.createTestingModule({\n      providers: [\n        DatabaseService,\n        {\n          provide: ConfigService,\n          useValue: mockConfigService,\n        },\n      ],\n    }).compile();\n\n    service = module.get<DatabaseService>(DatabaseService);\n  });\n\n  describe('onModuleDestroy', () => {\n    it('should close database connection', async () => {\n      // Set up client\n      (service as any).client = mockClient;\n\n      await service.onModuleDestroy();\n\n      expect(mockClient.end).toHaveBeenCalled();\n    });\n\n    it('should handle missing client gracefully', async () => {\n      (service as any).client = null;\n\n      await expect(service.onModuleDestroy()).resolves.not.toThrow();\n    });\n  });\n\n  describe('drizzle getter', () => {\n    it('should throw error when database not initialized', () => {\n      expect(() => service.drizzle).toThrow('Database not initialized');\n    });\n  });\n\n  describe('executeRaw', () => {\n    it('should execute raw SQL', async () => {\n      (service as any).client = mockClient;\n      mockClient.unsafe.mockResolvedValue([{ result: 'success' }]);\n\n      const result = await service.executeRaw('SELECT 1');\n\n      expect(result).toEqual([{ result: 'success' }]);\n      expect(mockClient.unsafe).toHaveBeenCalledWith('SELECT 1');\n    });\n  });\n});\n"],"version":3}