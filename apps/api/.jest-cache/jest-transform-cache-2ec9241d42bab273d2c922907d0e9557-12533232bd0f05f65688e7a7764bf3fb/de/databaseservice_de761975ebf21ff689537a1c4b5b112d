3c704cc3c76dbb454929eeede0b2aa38
"use strict";
// src/shared/database/database. service.ts
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
var DatabaseService_1;
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.DatabaseService = void 0;
const common_1 = require("@nestjs/common");
const config_1 = require("@nestjs/config");
const postgres_js_1 = require("drizzle-orm/postgres-js");
const postgres_1 = __importDefault(require("postgres"));
const schema = __importStar(require("../../lib/db/schema"));
/**
 * DatabaseService - Zentrale Datenbankverbindung fÃ¼r die gesamte Anwendung
 *
 * Verantwortlichkeiten:
 * - Connection Pool Management
 * - Lifecycle (Connect on Start, Disconnect on Shutdown)
 * - Health Checks
 * - Drizzle Client Bereitstellung
 *
 * Warum als Service und nicht als Modul-Export?
 * - Dependency Injection ermÃ¶glicht einfaches Mocking in Tests
 * - Lifecycle Hooks fÃ¼r sauberes Cleanup
 * - Zentrale Konfiguration an einer Stelle
 */
let DatabaseService = DatabaseService_1 = class DatabaseService {
    configService;
    logger = new common_1.Logger(DatabaseService_1.name);
    client;
    _drizzle;
    constructor(configService) {
        this.configService = configService;
    }
    /**
     * Getter fÃ¼r den Drizzle Client
     * Wird von Repositories verwendet fÃ¼r Type-Safe Queries
     */
    get drizzle() {
        if (!this._drizzle) {
            throw new Error('Database not initialized.  Call onModuleInit first.');
        }
        return this._drizzle;
    }
    /**
     * Lifecycle Hook:  Wird automatisch beim App-Start aufgerufen
     * Etabliert Datenbankverbindung mit Connection Pool
     */
    async onModuleInit() {
        const databaseUrl = this.configService.get('DATABASE_URL');
        if (!databaseUrl) {
            this.logger.error('DATABASE_URL is not defined in environment variables');
            throw new Error('DATABASE_URL is required');
        }
        this.logger.log('ðŸ”Œ Initializing database connection...');
        try {
            // PostgreSQL Client mit Connection Pool
            // Warum diese Einstellungen?
            // - max:  10 = Maximal 10 gleichzeitige Verbindungen (verhindert DB-Ãœberlastung)
            // - idle_timeout: 20 = Ungenutzte Verbindungen nach 20s schlieÃŸen (Resource-Freigabe)
            // - connect_timeout: 10 = Max 10s warten auf Connection (Fail Fast)
            this.client = (0, postgres_1.default)(databaseUrl, {
                max: 10,
                idle_timeout: 20,
                connect_timeout: 10,
                // SSL fÃ¼r Production (auskommentiert fÃ¼r lokale Entwicklung)
                // ssl: process.env.NODE_ENV === 'production' ? 'require' : false,
            });
            // Drizzle ORM Wrapper
            // Schema wird mitgegeben fÃ¼r Type-Safe Queries
            this._drizzle = (0, postgres_js_1.drizzle)(this.client, {
                schema,
                logger: this.configService.get('NODE_ENV') === 'development',
            });
            // Connection Test
            await this.healthCheck();
            this.logger.log('âœ… Database connection established successfully');
        }
        catch (error) {
            this.logger.error('âŒ Failed to connect to database', error);
            throw error;
        }
    }
    /**
     * Lifecycle Hook: Wird automatisch beim App-Shutdown aufgerufen
     * SchlieÃŸt alle Datenbankverbindungen sauber
     */
    async onModuleDestroy() {
        this.logger.log('ðŸ”Œ Closing database connection...');
        if (this.client) {
            await this.client.end();
            this.logger.log('âœ… Database connection closed');
        }
    }
    /**
     * Health Check fÃ¼r Monitoring/Readiness Probes
     * Wird auch beim Startup verwendet um Connection zu verifizieren
     *
     * @returns true wenn DB erreichbar, wirft Error wenn nicht
     */
    async healthCheck() {
        try {
            // Simple Query um Connection zu testen
            await this.client `SELECT 1 as health_check`;
            return true;
        }
        catch (error) {
            this.logger.error('Database health check failed', error);
            throw new Error('Database is not reachable');
        }
    }
    /**
     * FÃ¼hrt Raw SQL aus (fÃ¼r komplexe Queries, Migrations)
     * ACHTUNG: Nur verwenden wenn Drizzle Query Builder nicht ausreicht
     *
     * @param sql - Raw SQL String
     * @returns Query Result
     */
    async executeRaw(sql) {
        return this.client.unsafe(sql);
    }
};
exports.DatabaseService = DatabaseService;
exports.DatabaseService = DatabaseService = DatabaseService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof config_1.ConfigService !== "undefined" && config_1.ConfigService) === "function" ? _a : Object])
], DatabaseService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmsvc25pcHBldGZvcmdlL3NuaXBwZXRmb3JnZS9hcHBzL2FwaS9zcmMvc2hhcmVkL2RhdGFiYXNlL2RhdGFiYXNlLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6IjtBQUFBLDJDQUEyQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFFM0MsMkNBS3dCO0FBQ3hCLDJDQUErQztBQUMvQyx5REFBc0U7QUFDdEUsd0RBQWdDO0FBQ2hDLDREQUE4QztBQUU5Qzs7Ozs7Ozs7Ozs7OztHQWFHO0FBRUksSUFBTSxlQUFlLHVCQUFyQixNQUFNLGVBQWU7SUFLRztJQUpaLE1BQU0sR0FBRyxJQUFJLGVBQU0sQ0FBQyxpQkFBZSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ25ELE1BQU0sQ0FBZTtJQUNyQixRQUFRLENBQW9DO0lBRXBELFlBQTZCLGFBQTRCO1FBQTVCLGtCQUFhLEdBQWIsYUFBYSxDQUFlO0lBQUcsQ0FBQztJQUU3RDs7O09BR0c7SUFDSCxJQUFJLE9BQU87UUFDVCxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQ25CLE1BQU0sSUFBSSxLQUFLLENBQUMscURBQXFELENBQUMsQ0FBQztRQUN6RSxDQUFDO1FBQ0QsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDO0lBQ3ZCLENBQUM7SUFFRDs7O09BR0c7SUFDSCxLQUFLLENBQUMsWUFBWTtRQUNoQixNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBUyxjQUFjLENBQUMsQ0FBQztRQUVuRSxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDakIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsc0RBQXNELENBQUMsQ0FBQztZQUMxRSxNQUFNLElBQUksS0FBSyxDQUFDLDBCQUEwQixDQUFDLENBQUM7UUFDOUMsQ0FBQztRQUVELElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLHdDQUF3QyxDQUFDLENBQUM7UUFFMUQsSUFBSSxDQUFDO1lBQ0gsd0NBQXdDO1lBQ3hDLDZCQUE2QjtZQUM3QixpRkFBaUY7WUFDakYsc0ZBQXNGO1lBQ3RGLG9FQUFvRTtZQUNwRSxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUEsa0JBQVEsRUFBQyxXQUFXLEVBQUU7Z0JBQ2xDLEdBQUcsRUFBRSxFQUFFO2dCQUNQLFlBQVksRUFBRSxFQUFFO2dCQUNoQixlQUFlLEVBQUUsRUFBRTtnQkFDbkIsNkRBQTZEO2dCQUM3RCxrRUFBa0U7YUFDbkUsQ0FBQyxDQUFDO1lBRUgsc0JBQXNCO1lBQ3RCLCtDQUErQztZQUMvQyxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUEscUJBQU8sRUFBQyxJQUFJLENBQUMsTUFBTSxFQUFFO2dCQUNuQyxNQUFNO2dCQUNOLE1BQU0sRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsS0FBSyxhQUFhO2FBQzdELENBQUMsQ0FBQztZQUVILGtCQUFrQjtZQUNsQixNQUFNLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUN6QixJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxnREFBZ0QsQ0FBQyxDQUFDO1FBQ3BFLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsaUNBQWlDLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDNUQsTUFBTSxLQUFLLENBQUM7UUFDZCxDQUFDO0lBQ0gsQ0FBQztJQUVEOzs7T0FHRztJQUNILEtBQUssQ0FBQyxlQUFlO1FBQ25CLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLG1DQUFtQyxDQUFDLENBQUM7UUFFckQsSUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDaEIsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBQ3hCLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLDhCQUE4QixDQUFDLENBQUM7UUFDbEQsQ0FBQztJQUNILENBQUM7SUFFRDs7Ozs7T0FLRztJQUNILEtBQUssQ0FBQyxXQUFXO1FBQ2YsSUFBSSxDQUFDO1lBQ0gsdUNBQXVDO1lBQ3ZDLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQSwwQkFBMEIsQ0FBQztZQUM1QyxPQUFPLElBQUksQ0FBQztRQUNkLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsOEJBQThCLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDekQsTUFBTSxJQUFJLEtBQUssQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO1FBQy9DLENBQUM7SUFDSCxDQUFDO0lBRUQ7Ozs7OztPQU1HO0lBQ0gsS0FBSyxDQUFDLFVBQVUsQ0FBSSxHQUFXO1FBQzdCLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFpQixDQUFDO0lBQ2pELENBQUM7Q0FDRixDQUFBO0FBdEdZLDBDQUFlOzBCQUFmLGVBQWU7SUFEM0IsSUFBQSxtQkFBVSxHQUFFO3lEQU1pQyxzQkFBYSxvQkFBYixzQkFBYTtHQUw5QyxlQUFlLENBc0czQiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS9ydW5uZXIvd29yay9zbmlwcGV0Zm9yZ2Uvc25pcHBldGZvcmdlL2FwcHMvYXBpL3NyYy9zaGFyZWQvZGF0YWJhc2UvZGF0YWJhc2Uuc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBzcmMvc2hhcmVkL2RhdGFiYXNlL2RhdGFiYXNlLiBzZXJ2aWNlLnRzXG5cbmltcG9ydCB7XG4gIEluamVjdGFibGUsXG4gIExvZ2dlcixcbiAgT25Nb2R1bGVEZXN0cm95LFxuICBPbk1vZHVsZUluaXQsXG59IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IENvbmZpZ1NlcnZpY2UgfSBmcm9tICdAbmVzdGpzL2NvbmZpZyc7XG5pbXBvcnQgeyBkcml6emxlLCBQb3N0Z3Jlc0pzRGF0YWJhc2UgfSBmcm9tICdkcml6emxlLW9ybS9wb3N0Z3Jlcy1qcyc7XG5pbXBvcnQgcG9zdGdyZXMgZnJvbSAncG9zdGdyZXMnO1xuaW1wb3J0ICogYXMgc2NoZW1hIGZyb20gJy4uLy4uL2xpYi9kYi9zY2hlbWEnO1xuXG4vKipcbiAqIERhdGFiYXNlU2VydmljZSAtIFplbnRyYWxlIERhdGVuYmFua3ZlcmJpbmR1bmcgZsO8ciBkaWUgZ2VzYW10ZSBBbndlbmR1bmdcbiAqXG4gKiBWZXJhbnR3b3J0bGljaGtlaXRlbjpcbiAqIC0gQ29ubmVjdGlvbiBQb29sIE1hbmFnZW1lbnRcbiAqIC0gTGlmZWN5Y2xlIChDb25uZWN0IG9uIFN0YXJ0LCBEaXNjb25uZWN0IG9uIFNodXRkb3duKVxuICogLSBIZWFsdGggQ2hlY2tzXG4gKiAtIERyaXp6bGUgQ2xpZW50IEJlcmVpdHN0ZWxsdW5nXG4gKlxuICogV2FydW0gYWxzIFNlcnZpY2UgdW5kIG5pY2h0IGFscyBNb2R1bC1FeHBvcnQ/XG4gKiAtIERlcGVuZGVuY3kgSW5qZWN0aW9uIGVybcO2Z2xpY2h0IGVpbmZhY2hlcyBNb2NraW5nIGluIFRlc3RzXG4gKiAtIExpZmVjeWNsZSBIb29rcyBmw7xyIHNhdWJlcmVzIENsZWFudXBcbiAqIC0gWmVudHJhbGUgS29uZmlndXJhdGlvbiBhbiBlaW5lciBTdGVsbGVcbiAqL1xuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIERhdGFiYXNlU2VydmljZSBpbXBsZW1lbnRzIE9uTW9kdWxlSW5pdCwgT25Nb2R1bGVEZXN0cm95IHtcbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXIgPSBuZXcgTG9nZ2VyKERhdGFiYXNlU2VydmljZS5uYW1lKTtcbiAgcHJpdmF0ZSBjbGllbnQ6IHBvc3RncmVzLlNxbDtcbiAgcHJpdmF0ZSBfZHJpenpsZTogUG9zdGdyZXNKc0RhdGFiYXNlPHR5cGVvZiBzY2hlbWE+O1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgY29uZmlnU2VydmljZTogQ29uZmlnU2VydmljZSkge31cblxuICAvKipcbiAgICogR2V0dGVyIGbDvHIgZGVuIERyaXp6bGUgQ2xpZW50XG4gICAqIFdpcmQgdm9uIFJlcG9zaXRvcmllcyB2ZXJ3ZW5kZXQgZsO8ciBUeXBlLVNhZmUgUXVlcmllc1xuICAgKi9cbiAgZ2V0IGRyaXp6bGUoKTogUG9zdGdyZXNKc0RhdGFiYXNlPHR5cGVvZiBzY2hlbWE+IHtcbiAgICBpZiAoIXRoaXMuX2RyaXp6bGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignRGF0YWJhc2Ugbm90IGluaXRpYWxpemVkLiAgQ2FsbCBvbk1vZHVsZUluaXQgZmlyc3QuJyk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLl9kcml6emxlO1xuICB9XG5cbiAgLyoqXG4gICAqIExpZmVjeWNsZSBIb29rOiAgV2lyZCBhdXRvbWF0aXNjaCBiZWltIEFwcC1TdGFydCBhdWZnZXJ1ZmVuXG4gICAqIEV0YWJsaWVydCBEYXRlbmJhbmt2ZXJiaW5kdW5nIG1pdCBDb25uZWN0aW9uIFBvb2xcbiAgICovXG4gIGFzeW5jIG9uTW9kdWxlSW5pdCgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBkYXRhYmFzZVVybCA9IHRoaXMuY29uZmlnU2VydmljZS5nZXQ8c3RyaW5nPignREFUQUJBU0VfVVJMJyk7XG5cbiAgICBpZiAoIWRhdGFiYXNlVXJsKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcignREFUQUJBU0VfVVJMIGlzIG5vdCBkZWZpbmVkIGluIGVudmlyb25tZW50IHZhcmlhYmxlcycpO1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdEQVRBQkFTRV9VUkwgaXMgcmVxdWlyZWQnKTtcbiAgICB9XG5cbiAgICB0aGlzLmxvZ2dlci5sb2coJ/CflIwgSW5pdGlhbGl6aW5nIGRhdGFiYXNlIGNvbm5lY3Rpb24uLi4nKTtcblxuICAgIHRyeSB7XG4gICAgICAvLyBQb3N0Z3JlU1FMIENsaWVudCBtaXQgQ29ubmVjdGlvbiBQb29sXG4gICAgICAvLyBXYXJ1bSBkaWVzZSBFaW5zdGVsbHVuZ2VuP1xuICAgICAgLy8gLSBtYXg6ICAxMCA9IE1heGltYWwgMTAgZ2xlaWNoemVpdGlnZSBWZXJiaW5kdW5nZW4gKHZlcmhpbmRlcnQgREItw5xiZXJsYXN0dW5nKVxuICAgICAgLy8gLSBpZGxlX3RpbWVvdXQ6IDIwID0gVW5nZW51dHp0ZSBWZXJiaW5kdW5nZW4gbmFjaCAyMHMgc2NobGllw59lbiAoUmVzb3VyY2UtRnJlaWdhYmUpXG4gICAgICAvLyAtIGNvbm5lY3RfdGltZW91dDogMTAgPSBNYXggMTBzIHdhcnRlbiBhdWYgQ29ubmVjdGlvbiAoRmFpbCBGYXN0KVxuICAgICAgdGhpcy5jbGllbnQgPSBwb3N0Z3JlcyhkYXRhYmFzZVVybCwge1xuICAgICAgICBtYXg6IDEwLFxuICAgICAgICBpZGxlX3RpbWVvdXQ6IDIwLFxuICAgICAgICBjb25uZWN0X3RpbWVvdXQ6IDEwLFxuICAgICAgICAvLyBTU0wgZsO8ciBQcm9kdWN0aW9uIChhdXNrb21tZW50aWVydCBmw7xyIGxva2FsZSBFbnR3aWNrbHVuZylcbiAgICAgICAgLy8gc3NsOiBwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ3Byb2R1Y3Rpb24nID8gJ3JlcXVpcmUnIDogZmFsc2UsXG4gICAgICB9KTtcblxuICAgICAgLy8gRHJpenpsZSBPUk0gV3JhcHBlclxuICAgICAgLy8gU2NoZW1hIHdpcmQgbWl0Z2VnZWJlbiBmw7xyIFR5cGUtU2FmZSBRdWVyaWVzXG4gICAgICB0aGlzLl9kcml6emxlID0gZHJpenpsZSh0aGlzLmNsaWVudCwge1xuICAgICAgICBzY2hlbWEsXG4gICAgICAgIGxvZ2dlcjogdGhpcy5jb25maWdTZXJ2aWNlLmdldCgnTk9ERV9FTlYnKSA9PT0gJ2RldmVsb3BtZW50JyxcbiAgICAgIH0pO1xuXG4gICAgICAvLyBDb25uZWN0aW9uIFRlc3RcbiAgICAgIGF3YWl0IHRoaXMuaGVhbHRoQ2hlY2soKTtcbiAgICAgIHRoaXMubG9nZ2VyLmxvZygn4pyFIERhdGFiYXNlIGNvbm5lY3Rpb24gZXN0YWJsaXNoZWQgc3VjY2Vzc2Z1bGx5Jyk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKCfinYwgRmFpbGVkIHRvIGNvbm5lY3QgdG8gZGF0YWJhc2UnLCBlcnJvcik7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogTGlmZWN5Y2xlIEhvb2s6IFdpcmQgYXV0b21hdGlzY2ggYmVpbSBBcHAtU2h1dGRvd24gYXVmZ2VydWZlblxuICAgKiBTY2hsaWXDn3QgYWxsZSBEYXRlbmJhbmt2ZXJiaW5kdW5nZW4gc2F1YmVyXG4gICAqL1xuICBhc3luYyBvbk1vZHVsZURlc3Ryb3koKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdGhpcy5sb2dnZXIubG9nKCfwn5SMIENsb3NpbmcgZGF0YWJhc2UgY29ubmVjdGlvbi4uLicpO1xuXG4gICAgaWYgKHRoaXMuY2xpZW50KSB7XG4gICAgICBhd2FpdCB0aGlzLmNsaWVudC5lbmQoKTtcbiAgICAgIHRoaXMubG9nZ2VyLmxvZygn4pyFIERhdGFiYXNlIGNvbm5lY3Rpb24gY2xvc2VkJyk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEhlYWx0aCBDaGVjayBmw7xyIE1vbml0b3JpbmcvUmVhZGluZXNzIFByb2Jlc1xuICAgKiBXaXJkIGF1Y2ggYmVpbSBTdGFydHVwIHZlcndlbmRldCB1bSBDb25uZWN0aW9uIHp1IHZlcmlmaXppZXJlblxuICAgKlxuICAgKiBAcmV0dXJucyB0cnVlIHdlbm4gREIgZXJyZWljaGJhciwgd2lyZnQgRXJyb3Igd2VubiBuaWNodFxuICAgKi9cbiAgYXN5bmMgaGVhbHRoQ2hlY2soKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIFNpbXBsZSBRdWVyeSB1bSBDb25uZWN0aW9uIHp1IHRlc3RlblxuICAgICAgYXdhaXQgdGhpcy5jbGllbnRgU0VMRUNUIDEgYXMgaGVhbHRoX2NoZWNrYDtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcignRGF0YWJhc2UgaGVhbHRoIGNoZWNrIGZhaWxlZCcsIGVycm9yKTtcbiAgICAgIHRocm93IG5ldyBFcnJvcignRGF0YWJhc2UgaXMgbm90IHJlYWNoYWJsZScpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBGw7xocnQgUmF3IFNRTCBhdXMgKGbDvHIga29tcGxleGUgUXVlcmllcywgTWlncmF0aW9ucylcbiAgICogQUNIVFVORzogTnVyIHZlcndlbmRlbiB3ZW5uIERyaXp6bGUgUXVlcnkgQnVpbGRlciBuaWNodCBhdXNyZWljaHRcbiAgICpcbiAgICogQHBhcmFtIHNxbCAtIFJhdyBTUUwgU3RyaW5nXG4gICAqIEByZXR1cm5zIFF1ZXJ5IFJlc3VsdFxuICAgKi9cbiAgYXN5bmMgZXhlY3V0ZVJhdzxUPihzcWw6IHN0cmluZyk6IFByb21pc2U8VFtdPiB7XG4gICAgcmV0dXJuIHRoaXMuY2xpZW50LnVuc2FmZShzcWwpIGFzIFByb21pc2U8VFtdPjtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9