{"file":"/home/runner/work/snippetforge/snippetforge/apps/api/src/shared/database/database.service.ts","mappings":"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","names":[],"sources":["/home/runner/work/snippetforge/snippetforge/apps/api/src/shared/database/database.service.ts"],"sourcesContent":["// src/shared/database/database. service.ts\n\nimport {\n  Injectable,\n  Logger,\n  OnModuleDestroy,\n  OnModuleInit,\n} from '@nestjs/common';\nimport { ConfigService } from '@nestjs/config';\nimport { drizzle, PostgresJsDatabase } from 'drizzle-orm/postgres-js';\nimport postgres from 'postgres';\nimport * as schema from '../../lib/db/schema';\n\n/**\n * DatabaseService - Zentrale Datenbankverbindung f√ºr die gesamte Anwendung\n *\n * Verantwortlichkeiten:\n * - Connection Pool Management\n * - Lifecycle (Connect on Start, Disconnect on Shutdown)\n * - Health Checks\n * - Drizzle Client Bereitstellung\n *\n * Warum als Service und nicht als Modul-Export?\n * - Dependency Injection erm√∂glicht einfaches Mocking in Tests\n * - Lifecycle Hooks f√ºr sauberes Cleanup\n * - Zentrale Konfiguration an einer Stelle\n */\n@Injectable()\nexport class DatabaseService implements OnModuleInit, OnModuleDestroy {\n  private readonly logger = new Logger(DatabaseService.name);\n  private client: postgres.Sql;\n  private _drizzle: PostgresJsDatabase<typeof schema>;\n\n  constructor(private readonly configService: ConfigService) {}\n\n  /**\n   * Getter f√ºr den Drizzle Client\n   * Wird von Repositories verwendet f√ºr Type-Safe Queries\n   */\n  get drizzle(): PostgresJsDatabase<typeof schema> {\n    if (!this._drizzle) {\n      throw new Error('Database not initialized.  Call onModuleInit first.');\n    }\n    return this._drizzle;\n  }\n\n  /**\n   * Lifecycle Hook:  Wird automatisch beim App-Start aufgerufen\n   * Etabliert Datenbankverbindung mit Connection Pool\n   */\n  async onModuleInit(): Promise<void> {\n    const databaseUrl = this.configService.get<string>('DATABASE_URL');\n\n    if (!databaseUrl) {\n      this.logger.error('DATABASE_URL is not defined in environment variables');\n      throw new Error('DATABASE_URL is required');\n    }\n\n    this.logger.log('üîå Initializing database connection...');\n\n    try {\n      // PostgreSQL Client mit Connection Pool\n      // Warum diese Einstellungen?\n      // - max:  10 = Maximal 10 gleichzeitige Verbindungen (verhindert DB-√úberlastung)\n      // - idle_timeout: 20 = Ungenutzte Verbindungen nach 20s schlie√üen (Resource-Freigabe)\n      // - connect_timeout: 10 = Max 10s warten auf Connection (Fail Fast)\n      this.client = postgres(databaseUrl, {\n        max: 10,\n        idle_timeout: 20,\n        connect_timeout: 10,\n        // SSL f√ºr Production (auskommentiert f√ºr lokale Entwicklung)\n        // ssl: process.env.NODE_ENV === 'production' ? 'require' : false,\n      });\n\n      // Drizzle ORM Wrapper\n      // Schema wird mitgegeben f√ºr Type-Safe Queries\n      this._drizzle = drizzle(this.client, {\n        schema,\n        logger: this.configService.get('NODE_ENV') === 'development',\n      });\n\n      // Connection Test\n      await this.healthCheck();\n      this.logger.log('‚úÖ Database connection established successfully');\n    } catch (error) {\n      this.logger.error('‚ùå Failed to connect to database', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Lifecycle Hook: Wird automatisch beim App-Shutdown aufgerufen\n   * Schlie√üt alle Datenbankverbindungen sauber\n   */\n  async onModuleDestroy(): Promise<void> {\n    this.logger.log('üîå Closing database connection...');\n\n    if (this.client) {\n      await this.client.end();\n      this.logger.log('‚úÖ Database connection closed');\n    }\n  }\n\n  /**\n   * Health Check f√ºr Monitoring/Readiness Probes\n   * Wird auch beim Startup verwendet um Connection zu verifizieren\n   *\n   * @returns true wenn DB erreichbar, wirft Error wenn nicht\n   */\n  async healthCheck(): Promise<boolean> {\n    try {\n      // Simple Query um Connection zu testen\n      await this.client`SELECT 1 as health_check`;\n      return true;\n    } catch (error) {\n      this.logger.error('Database health check failed', error);\n      throw new Error('Database is not reachable');\n    }\n  }\n\n  /**\n   * F√ºhrt Raw SQL aus (f√ºr komplexe Queries, Migrations)\n   * ACHTUNG: Nur verwenden wenn Drizzle Query Builder nicht ausreicht\n   *\n   * @param sql - Raw SQL String\n   * @returns Query Result\n   */\n  async executeRaw<T>(sql: string): Promise<T[]> {\n    return this.client.unsafe(sql) as Promise<T[]>;\n  }\n}\n"],"version":3}