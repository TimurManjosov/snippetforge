{"file":"/home/runner/work/snippetforge/snippetforge/apps/api/src/modules/snippets/snippets.service.ts","mappings":"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","names":[],"sources":["/home/runner/work/snippetforge/snippetforge/apps/api/src/modules/snippets/snippets.service.ts"],"sourcesContent":["// src/modules/snippets/snippets.service.ts\n\nimport {\n  BadRequestException,\n  ForbiddenException,\n  Injectable,\n  Logger,\n  NotFoundException,\n} from '@nestjs/common';\nimport { SnippetsRepository } from './snippets.repository';\nimport {\n  type PaginatedSnippetPreviews,\n  type PaginatedSnippets,\n  type Snippet,\n  type SnippetFilters,\n  type SnippetSortOptions,\n  type SnippetStats,\n  DEFAULT_SORT,\n} from './snippets.types';\n\n/**\n * SnippetsService - Business Logic Layer für Snippets\n *\n * VERANTWORTLICHKEITEN (Single Responsibility):\n * - Business Logic (Ownership, Validation, Public/Private)\n * - Orchestrierung mehrerer Repository Calls\n * - Error Handling (NotFoundException, ForbiddenException)\n * - Input Validation (zusätzlich zu Zod)\n *\n * CLEAN CODE REGEL #3: Service orchestrates, Repository executes\n * - Service entscheidet WAS gemacht wird (Business Rules)\n * - Repository entscheidet WIE es gemacht wird (SQL Queries)\n *\n * BUSINESS RULES:\n * 1. User kann nur eigene Snippets bearbeiten/löschen (außer ADMIN)\n * 2. Private Snippets sind nur für Owner sichtbar\n * 3. Public Snippets sind für alle sichtbar\n * 4. Code darf nicht leer sein (zusätzlich zu Zod)\n * 5. Title max 200 Zeichen\n * 6. Code max 50,000 Zeichen\n */\n@Injectable()\nexport class SnippetsService {\n  private readonly logger = new Logger(SnippetsService.name);\n\n  constructor(private readonly repository: SnippetsRepository) {}\n\n  // ============================================================\n  // CREATE\n  // ============================================================\n\n  /**\n   * Erstellt neuen Snippet\n   *\n   * BUSINESS RULES:\n   * - Snippet gehört immer dem Creator (userId)\n   * - Code darf nicht leer sein\n   * - Default: isPublic = true\n   *\n   * @param userId - Owner des Snippets\n   * @param dto - Snippet-Daten aus Request Body\n   * @returns Erstellter Snippet\n   * @throws BadRequestException bei ungültigen Daten\n   */\n  async create(\n    userId: string,\n    dto: {\n      title: string;\n      description?: string;\n      code: string;\n      language: string;\n      isPublic?: boolean;\n    },\n  ): Promise<Snippet> {\n    this.logger.debug(`Creating snippet for user: ${userId}`);\n\n    // Business Validation\n    this.validateSnippetData(dto);\n\n    // Repository Call\n    const snippet = await this.repository.create({\n      ...dto,\n      userId,\n      isPublic: dto.isPublic ?? true, // Default: public\n    });\n\n    this.logger.log(`Snippet created: ${snippet.id} by user: ${userId}`);\n    return snippet;\n  }\n\n  // ============================================================\n  // READ - SINGLE\n  // ============================================================\n\n  /**\n   * Findet Snippet anhand der ID\n   *\n   * BUSINESS RULES:\n   * - Public Snippets: Jeder kann sehen\n   * - Private Snippets: Nur Owner kann sehen (oder ADMIN)\n   *\n   * @param id - Snippet UUID\n   * @param currentUserId - Aktueller User (optional für Public Snippets)\n   * @returns Snippet\n   * @throws NotFoundException wenn nicht gefunden\n   * @throws ForbiddenException wenn kein Zugriff\n   */\n  async findById(id: string, currentUserId?: string): Promise<Snippet> {\n    this.logger.debug(`Finding snippet: ${id}`);\n\n    const snippet = await this.repository.findById(id);\n\n    if (!snippet) {\n      throw new NotFoundException(`Snippet with ID ${id} not found`);\n    }\n\n    // Access Control: Private Snippets nur für Owner\n    if (!snippet.isPublic && snippet.userId !== currentUserId) {\n      throw new ForbiddenException('You do not have access to this snippet');\n    }\n\n    return snippet;\n  }\n\n  /**\n   * Findet Snippet und erhöht View Count\n   *\n   * Verwendet für Snippet-Detail-Seite\n   *\n   * @param id - Snippet UUID\n   * @param currentUserId - Aktueller User (optional)\n   * @returns Snippet mit erhöhtem View Count\n   */\n  async findByIdAndIncrementViews(\n    id: string,\n    currentUserId?: string,\n  ): Promise<Snippet> {\n    const snippet = await this.findById(id, currentUserId);\n\n    // View Count erhöhen (Fire-and-Forget, kein await)\n    // Fehler beim Increment sollen Snippet-Anzeige nicht blockieren\n    this.repository.incrementViewCount(id).catch((error) => {\n      this.logger.warn(\n        `Failed to increment view count for snippet ${id}:`,\n        error,\n      );\n    });\n\n    return snippet;\n  }\n\n  // ============================================================\n  // READ - LISTS\n  // ============================================================\n\n  /**\n   * Findet alle Snippets eines Users\n   *\n   * VERWENDUNG: \"Meine Snippets\" Seite\n   *\n   * @param userId - User UUID\n   * @param limit - Max Anzahl (default 20)\n   * @returns Liste von Snippets (public + private)\n   */\n  async findUserSnippets(userId: string, limit = 20): Promise<Snippet[]> {\n    this.logger.debug(`Finding snippets for user: ${userId}`);\n    return this.repository.findByUserId(userId, limit);\n  }\n\n  /**\n   * Findet öffentliche Snippets (paginated)\n   *\n   * VERWENDUNG: Explore-Seite, Homepage\n   * PERFORMANCE: Nutzt Pagination\n   *\n   * @param page - Seite (1-indexed, default 1)\n   * @param limit - Items pro Seite (default 20, max 100)\n   * @returns Paginated Snippets\n   */\n  async findPublicSnippets(page = 1, limit = 20): Promise<PaginatedSnippets> {\n    this.logger.debug(`Finding public snippets (page: ${page})`);\n\n    // Enforce limits (Performance Regel #2)\n    const safePage = Math.max(1, page);\n    const safeLimit = Math.min(Math.max(1, limit), 100);\n\n    return this.repository.findPublic(safePage, safeLimit);\n  }\n\n  /**\n   * Findet öffentliche Snippet-Previews (OHNE Code)\n   *\n   * VERWENDUNG: Listen-Ansichten (Explore, Search Results)\n   * PERFORMANCE REGEL #3: Select only needed columns\n   * Spart ~50KB pro Snippet bei Listen!\n   *\n   * @param page - Seite\n   * @param limit - Items pro Seite\n   * @returns Paginated Previews\n   */\n  async findPublicPreviews(\n    page = 1,\n    limit = 20,\n  ): Promise<PaginatedSnippetPreviews> {\n    this.logger.debug(`Finding public snippet previews (page: ${page})`);\n\n    const safePage = Math.max(1, page);\n    const safeLimit = Math.min(Math.max(1, limit), 100);\n\n    return this.repository.findPublicPreviews(safePage, safeLimit);\n  }\n\n  /**\n   * Sucht Snippets mit Filtern\n   *\n   * VERWENDUNG: Search-Seite, Filter-UI\n   *\n   * @param filters - Filter-Optionen\n   * @param sort - Sortier-Optionen\n   * @param page - Seite\n   * @param limit - Items pro Seite\n   * @returns Paginated Snippets\n   */\n  async search(\n    filters: SnippetFilters = {},\n    sort: SnippetSortOptions = DEFAULT_SORT,\n    page = 1,\n    limit = 20,\n  ): Promise<PaginatedSnippets> {\n    this.logger.debug('Searching snippets', { filters, sort });\n\n    const safePage = Math.max(1, page);\n    const safeLimit = Math.min(Math.max(1, limit), 100);\n\n    return this.repository.findWithFilters(filters, sort, safePage, safeLimit);\n  }\n\n  /**\n   * Findet Snippets nach Programmiersprache\n   *\n   * @param language - Programmiersprache (z.B. \"typescript\")\n   * @param limit - Max Anzahl\n   * @returns Liste von Snippets\n   */\n  async findByLanguage(language: string, limit = 20): Promise<Snippet[]> {\n    this.logger.debug(`Finding snippets by language: ${language}`);\n    return this.repository.findByLanguage(language, limit);\n  }\n\n  // ============================================================\n  // UPDATE\n  // ============================================================\n\n  /**\n   * Aktualisiert Snippet\n   *\n   * BUSINESS RULES:\n   * - Nur Owner kann eigene Snippets bearbeiten (außer ADMIN)\n   * - Validierung der neuen Daten\n   *\n   * @param id - Snippet UUID\n   * @param userId - User der Update macht\n   * @param userRole - Rolle des Users (für Admin-Check)\n   * @param dto - Zu aktualisierende Felder\n   * @returns Aktualisierter Snippet\n   * @throws NotFoundException wenn nicht gefunden\n   * @throws ForbiddenException wenn kein Owner\n   */\n  async update(\n    id: string,\n    userId: string,\n    userRole: string,\n    dto: {\n      title?: string;\n      description?: string;\n      code?: string;\n      language?: string;\n      isPublic?: boolean;\n    },\n  ): Promise<Snippet> {\n    this.logger.debug(`Updating snippet: ${id} by user: ${userId}`);\n\n    // 1. Snippet holen und Ownership prüfen\n    const snippet = await this.repository.findById(id);\n\n    if (!snippet) {\n      throw new NotFoundException(`Snippet with ID ${id} not found`);\n    }\n\n    // BUSINESS RULE: Nur Owner oder ADMIN\n    if (snippet.userId !== userId && userRole !== 'ADMIN') {\n      throw new ForbiddenException('You can only modify your own snippets');\n    }\n\n    // 2. Validierung der neuen Daten\n    if (dto.title !== undefined || dto.code !== undefined) {\n      this.validateSnippetData({\n        title: dto.title ?? snippet.title,\n        code: dto.code ?? snippet.code,\n        language: dto.language ?? snippet.language,\n      });\n    }\n\n    // 3. Update durchführen\n    const updated = await this.repository.update(id, dto);\n\n    if (!updated) {\n      // Sollte nicht passieren (wir haben gerade geprüft dass es existiert)\n      throw new NotFoundException(`Snippet with ID ${id} not found`);\n    }\n\n    this.logger.log(`Snippet updated: ${id}`);\n    return updated;\n  }\n\n  /**\n   * Toggelt Public/Private Status\n   *\n   * VERWENDUNG: \"Make Private\" / \"Make Public\" Button\n   *\n   * @param id - Snippet UUID\n   * @param userId - User der Toggle macht\n   * @param userRole - Rolle des Users\n   * @returns Aktualisierter Snippet\n   */\n  async togglePublic(\n    id: string,\n    userId: string,\n    userRole: string,\n  ): Promise<Snippet> {\n    this.logger.debug(`Toggling public status for snippet: ${id}`);\n\n    const snippet = await this.repository.findById(id);\n\n    if (!snippet) {\n      throw new NotFoundException(`Snippet with ID ${id} not found`);\n    }\n\n    if (snippet.userId !== userId && userRole !== 'ADMIN') {\n      throw new ForbiddenException('You can only modify your own snippets');\n    }\n\n    const updated = await this.repository.update(id, {\n      isPublic: !snippet.isPublic,\n    });\n\n    if (!updated) {\n      throw new NotFoundException(`Snippet with ID ${id} not found`);\n    }\n\n    this.logger.log(\n      `Snippet ${id} is now ${updated.isPublic ? 'public' : 'private'}`,\n    );\n    return updated;\n  }\n\n  // ============================================================\n  // DELETE\n  // ============================================================\n\n  /**\n   * Löscht Snippet\n   *\n   * BUSINESS RULES:\n   * - Nur Owner kann eigene Snippets löschen (außer ADMIN)\n   *\n   * @param id - Snippet UUID\n   * @param userId - User der Delete macht\n   * @param userRole - Rolle des Users\n   * @throws NotFoundException wenn nicht gefunden\n   * @throws ForbiddenException wenn kein Owner\n   */\n  async delete(id: string, userId: string, userRole: string): Promise<void> {\n    this.logger.debug(`Deleting snippet: ${id} by user: ${userId}`);\n\n    // 1. Snippet holen und Ownership prüfen\n    const snippet = await this.repository.findById(id);\n\n    if (!snippet) {\n      throw new NotFoundException(`Snippet with ID ${id} not found`);\n    }\n\n    // BUSINESS RULE: Nur Owner oder ADMIN\n    if (snippet.userId !== userId && userRole !== 'ADMIN') {\n      throw new ForbiddenException('You can only delete your own snippets');\n    }\n\n    // 2. Delete durchführen\n    const deleted = await this.repository.delete(id);\n\n    if (!deleted) {\n      // Sollte nicht passieren\n      throw new NotFoundException(`Snippet with ID ${id} not found`);\n    }\n\n    this.logger.log(`Snippet deleted: ${id}`);\n  }\n\n  // ============================================================\n  // STATISTICS\n  // ============================================================\n\n  /**\n   * Holt Snippet-Statistiken für einen User\n   *\n   * VERWENDUNG: User-Dashboard\n   *\n   * @param userId - User UUID\n   * @returns Snippet Statistics\n   */\n  async getUserStats(userId: string): Promise<SnippetStats> {\n    this.logger.debug(`Getting snippet stats for user: ${userId}`);\n    return this.repository.getUserStats(userId);\n  }\n\n  /**\n   * Zählt Snippets eines Users\n   *\n   * @param userId - User UUID\n   * @returns Anzahl der Snippets\n   */\n  async countUserSnippets(userId: string): Promise<number> {\n    return this.repository.countByUserId(userId);\n  }\n\n  /**\n   * Holt Sprachen-Statistiken\n   *\n   * @param userId - Optional: Nur für einen User\n   * @returns Language Stats\n   */\n  async getLanguageStats(userId?: string) {\n    this.logger.debug(\n      `Getting language stats${userId ? ` for user: ${userId}` : ''}`,\n    );\n    return this.repository.getLanguageStats(userId);\n  }\n\n  // ============================================================\n  // PRIVATE HELPERS\n  // ============================================================\n\n  /**\n   * Validiert Snippet-Daten (Business Rules)\n   *\n   * WICHTIG: Zod validiert bereits Format (z.B. min/max length)\n   * Diese Methode prüft zusätzliche Business Rules\n   *\n   * @param data - Snippet-Daten\n   * @throws BadRequestException bei ungültigen Daten\n   */\n  private validateSnippetData(data: {\n    title?: string;\n    code?: string;\n    language?: string;\n  }): void {\n    // Code darf nicht nur Whitespace sein\n    if (data.code !== undefined) {\n      const trimmedCode = data.code.trim();\n      if (trimmedCode.length === 0) {\n        throw new BadRequestException(\n          'Code cannot be empty or contain only whitespace',\n        );\n      }\n\n      // Code max 50,000 Zeichen (Business Rule)\n      if (trimmedCode.length > 50000) {\n        throw new BadRequestException(\n          'Code exceeds maximum length of 50,000 characters',\n        );\n      }\n    }\n\n    // Title darf nicht nur Whitespace sein\n    if (data.title !== undefined) {\n      const trimmedTitle = data.title.trim();\n      if (trimmedTitle.length === 0) {\n        throw new BadRequestException(\n          'Title cannot be empty or contain only whitespace',\n        );\n      }\n\n      // Title max 200 Zeichen (Business Rule)\n      if (trimmedTitle.length > 200) {\n        throw new BadRequestException(\n          'Title exceeds maximum length of 200 characters',\n        );\n      }\n    }\n\n    // Language darf nicht leer sein\n    if (data.language !== undefined) {\n      const trimmedLanguage = data.language.trim();\n      if (trimmedLanguage.length === 0) {\n        throw new BadRequestException('Language cannot be empty');\n      }\n    }\n  }\n}\n"],"version":3}