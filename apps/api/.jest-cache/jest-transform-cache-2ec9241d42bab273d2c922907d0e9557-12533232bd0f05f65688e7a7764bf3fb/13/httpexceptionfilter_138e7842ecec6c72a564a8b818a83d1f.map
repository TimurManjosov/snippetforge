{"file":"/home/runner/work/snippetforge/snippetforge/apps/api/src/shared/filters/http-exception.filter.ts","mappings":"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","names":[],"sources":["/home/runner/work/snippetforge/snippetforge/apps/api/src/shared/filters/http-exception.filter.ts"],"sourcesContent":["// src/shared/filters/http-exception.filter.ts\n\nimport {\n  ArgumentsHost,\n  Catch,\n  ExceptionFilter,\n  HttpException,\n  HttpStatus,\n  Logger,\n} from '@nestjs/common';\nimport { Request, Response } from 'express';\nimport {\n  ErrorCodes,\n  HttpStatusToErrorCode,\n  type ErrorCode,\n} from '../constants';\nimport { createErrorResponse, type ErrorDetails } from '../types';\n\n/**\n * HttpExceptionFilter - Fängt alle HttpExceptions und formatiert sie einheitlich\n *\n * WAS ES FÄNGT:\n * - BadRequestException (400)\n * - UnauthorizedException (401)\n * - ForbiddenException (403)\n * - NotFoundException (404)\n * - ConflictException (409)\n * - Alle anderen HttpExceptions\n *\n * WAS ES NICHT FÄNGT:\n * - TypeError, ReferenceError, etc. (→ AllExceptionsFilter)\n * - Errors die keine HttpException sind\n *\n * PERFORMANCE OPTIMIERUNGEN:\n * - Minimale Object-Erstellung\n * - Keine synchronen Operationen blockieren\n * - Logging ist non-blocking\n *\n * SECURITY:\n * - Keine Stack Traces in Response\n * - Sensitive Daten werden gefiltert\n * - Einheitliche Error Messages (keine Information Leakage)\n */\n@Catch(HttpException)\nexport class HttpExceptionFilter implements ExceptionFilter {\n  private readonly logger = new Logger(HttpExceptionFilter.name);\n\n  /**\n   * Catch - Hauptmethode die von NestJS aufgerufen wird\n   *\n   * @param exception - Die gefangene HttpException\n   * @param host - ArgumentsHost für Zugriff auf Request/Response\n   */\n  catch(exception: HttpException, host: ArgumentsHost): void {\n    const ctx = host.switchToHttp();\n    const response = ctx.getResponse<Response>();\n    const request = ctx.getRequest<Request>();\n\n    const status = exception.getStatus();\n    const exceptionResponse = exception.getResponse();\n\n    // Error Details extrahieren\n    const { message, code, details } = this.extractErrorInfo(\n      exceptionResponse,\n      status,\n    );\n\n    // Error Response erstellen\n    const errorResponse = createErrorResponse({\n      code,\n      message,\n      statusCode: status,\n      path: request.url,\n      method: request.method,\n      details,\n      requestId: this.extractRequestId(request),\n    });\n\n    // Logging\n    this.logError(exception, request, status, code);\n\n    // Response senden\n    response.status(status).json(errorResponse);\n  }\n\n  /**\n   * Extrahiert Error-Informationen aus der Exception Response\n   *\n   * NestJS Exceptions können verschiedene Formate haben:\n   * - String: \"Not found\"\n   * - Object: { message: \"Not found\", error: \"Not Found\" }\n   * - Object mit Array: { message: [\"error1\", \"error2\"] }\n   * - Custom Object: { message: \"...\", code: \"CUSTOM_CODE\", errors: {...} }\n   *\n   * Diese Methode normalisiert alle Formate.\n   */\n  private extractErrorInfo(\n    response: string | object,\n    status: number,\n  ): { message: string; code: ErrorCode; details?: ErrorDetails } {\n    // Default Values\n    let message = 'An error occurred';\n    let code: ErrorCode =\n      HttpStatusToErrorCode[status] || ErrorCodes.SERVER_ERROR;\n    let details: ErrorDetails | undefined;\n\n    // String Response\n    if (typeof response === 'string') {\n      message = response;\n      code = this.inferErrorCode(message, status, code);\n      return { message, code, details };\n    }\n\n    // Object Response\n    if (typeof response === 'object' && response !== null) {\n      const res = response as Record<string, unknown>;\n\n      // Message extrahieren\n      if (typeof res.message === 'string') {\n        message = res.message;\n      } else if (Array.isArray(res.message)) {\n        // Array von Messages (z.B. class-validator)\n        message = (res.message[0] as string) || 'Validation failed';\n\n        // Alle Messages als Details speichern\n        if (res.message.length > 1) {\n          details = { context: { messages: res.message } };\n        }\n      }\n\n      // Custom Error Code\n      if (typeof res.code === 'string') {\n        code = res.code as ErrorCode;\n      }\n\n      // Zod Validation Errors (von ZodValidationPipe)\n      if (res.errors && typeof res.errors === 'object') {\n        details = { fields: res.errors as Record<string, string[]> };\n      }\n\n      // Spezifische Codes basierend auf Message\n      code = this.inferErrorCode(message, status, code);\n    }\n\n    return { message, code, details };\n  }\n\n  /**\n   * Inferiert spezifischen Error Code basierend auf Message\n   *\n   * WARUM?\n   * - Viele NestJS Exceptions haben keinen Code\n   * - Wir wollen spezifische Codes für Frontend\n   * - Ermöglicht besseres Error Handling\n   */\n  private inferErrorCode(\n    message: string,\n    status: number,\n    defaultCode: ErrorCode,\n  ): ErrorCode {\n    const lowerMessage = message.toLowerCase();\n\n    // Authentication Errors\n    if (status === HttpStatus.UNAUTHORIZED) {\n      if (lowerMessage.includes('expired')) {\n        return ErrorCodes.AUTH_TOKEN_EXPIRED;\n      }\n      if (\n        lowerMessage.includes('missing') ||\n        lowerMessage.includes('no token')\n      ) {\n        return ErrorCodes.AUTH_TOKEN_MISSING;\n      }\n      if (\n        lowerMessage.includes('invalid credentials') ||\n        lowerMessage.includes('email or password')\n      ) {\n        return ErrorCodes.AUTH_INVALID_CREDENTIALS;\n      }\n      return ErrorCodes.AUTH_TOKEN_INVALID;\n    }\n\n    // Authorization Errors\n    if (status === HttpStatus.FORBIDDEN) {\n      if (lowerMessage.includes('role')) {\n        return ErrorCodes.AUTH_INSUFFICIENT_ROLE;\n      }\n      return ErrorCodes.AUTH_ACCESS_DENIED;\n    }\n\n    // Conflict Errors\n    if (status === HttpStatus.CONFLICT) {\n      if (lowerMessage.includes('email')) {\n        return ErrorCodes.USER_EMAIL_EXISTS;\n      }\n      if (lowerMessage.includes('username')) {\n        return ErrorCodes.USER_USERNAME_EXISTS;\n      }\n    }\n\n    // Not Found Errors\n    if (status === HttpStatus.NOT_FOUND) {\n      if (lowerMessage.includes('user')) {\n        return ErrorCodes.USER_NOT_FOUND;\n      }\n    }\n\n    return defaultCode;\n  }\n\n  /**\n   * Extrahiert Request ID für Tracing\n   *\n   * Request ID kann kommen von:\n   * - X-Request-ID Header (gesetzt von Load Balancer/Gateway)\n   * - Custom Middleware\n   */\n  private extractRequestId(request: Request): string | undefined {\n    return (\n      (request.headers['x-request-id'] as string) ||\n      (request.headers['x-correlation-id'] as string) ||\n      undefined\n    );\n  }\n\n  /**\n   * Logging mit unterschiedlichen Levels je nach Error-Typ\n   *\n   * LOGGING STRATEGY:\n   * - 4xx (Client Errors): warn Level (User-Fehler)\n   * - 5xx (Server Errors): error Level (Unsere Fehler)\n   *\n   * FORMAT:\n   * [METHOD] /path - STATUS CODE: message\n   */\n  private logError(\n    exception: HttpException,\n    request: Request,\n    status: number,\n    code: string,\n  ): void {\n    const { method, url, ip } = request;\n    const message = exception.message;\n    const userAgent = request.headers['user-agent'] || 'unknown';\n\n    // Log Context für strukturiertes Logging\n    const logContext = {\n      method,\n      url,\n      status,\n      code,\n      ip,\n      userAgent: userAgent.substring(0, 100), // Truncate für Performance\n    };\n\n    // Log Level basierend auf Status\n    if (status >= 500) {\n      // Server Errors: Immer mit Stack Trace loggen\n      this.logger.error(\n        `[${method}] ${url} - ${status} ${code}: ${message}`,\n        exception.stack,\n        JSON.stringify(logContext),\n      );\n    } else if (status === 401 || status === 403) {\n      // Auth Errors: Security-relevant, warn Level\n      this.logger.warn(\n        `[${method}] ${url} - ${status} ${code}: ${message}`,\n        JSON.stringify(logContext),\n      );\n    } else if (status >= 400) {\n      // Client Errors: Debug Level (zu viel Noise bei warn)\n      this.logger.debug(\n        `[${method}] ${url} - ${status} ${code}: ${message}`,\n        JSON.stringify(logContext),\n      );\n    }\n  }\n}\n"],"version":3}