840b6639687d4ae1b516fca3526a61d0
"use strict";
// test/unit/pipes/zod-validation.pipe.spec.ts
Object.defineProperty(exports, "__esModule", { value: true });
const common_1 = require("@nestjs/common");
const zod_1 = require("zod");
const zod_validation_pipe_1 = require("../../../src/shared/pipes/zod-validation.pipe");
/**
 * ZodValidationPipe Unit Tests
 *
 * Testet:
 * - Valide Daten werden transformiert
 * - Invalide Daten werfen BadRequestException
 * - Error-Format ist korrekt
 */
describe('ZodValidationPipe', () => {
    // Test Schema
    const TestSchema = zod_1.z.object({
        email: zod_1.z.string().email('Invalid email format'),
        name: zod_1.z.string().min(2, 'Name must be at least 2 characters'),
        age: zod_1.z.number().min(0, 'Age must be positive').optional(),
    });
    let pipe;
    beforeEach(() => {
        pipe = new zod_validation_pipe_1.ZodValidationPipe(TestSchema);
    });
    describe('transform', () => {
        describe('with valid data', () => {
            it('should return parsed data when all fields are valid', () => {
                // Arrange
                const input = {
                    email: 'test@example.com',
                    name: 'John',
                    age: 25,
                };
                // Act
                const result = pipe.transform(input);
                // Assert
                expect(result).toEqual(input);
            });
            it('should return parsed data with optional fields omitted', () => {
                // Arrange
                const input = {
                    email: 'test@example.com',
                    name: 'John',
                };
                // Act
                const result = pipe.transform(input);
                // Assert
                expect(result).toEqual(input);
                expect(result).not.toHaveProperty('age');
            });
            it('should transform data (e.g., trim strings) if schema defines transformations', () => {
                // Arrange
                const schemaWithTransform = zod_1.z.object({
                    email: zod_1.z
                        .string()
                        .email()
                        .transform((v) => v.toLowerCase()),
                });
                const pipeWithTransform = new zod_validation_pipe_1.ZodValidationPipe(schemaWithTransform);
                const input = { email: 'TEST@EXAMPLE.COM' };
                // Act
                const result = pipeWithTransform.transform(input);
                // Assert
                expect(result.email).toBe('test@example.com');
            });
        });
        describe('with invalid data', () => {
            it('should throw BadRequestException for invalid email', () => {
                // Arrange
                const input = {
                    email: 'not-an-email',
                    name: 'John',
                };
                // Act & Assert
                expect(() => pipe.transform(input)).toThrow(common_1.BadRequestException);
            });
            it('should throw BadRequestException for too short name', () => {
                // Arrange
                const input = {
                    email: 'test@example.com',
                    name: 'J', // too short
                };
                // Act & Assert
                expect(() => pipe.transform(input)).toThrow(common_1.BadRequestException);
            });
            it('should include field-specific errors in exception', () => {
                // Arrange
                const input = {
                    email: 'invalid',
                    name: 'J',
                };
                // Act & Assert
                try {
                    pipe.transform(input);
                    fail('Should have thrown');
                }
                catch (error) {
                    expect(error).toBeInstanceOf(common_1.BadRequestException);
                    const response = error.getResponse();
                    expect(response.errors).toHaveProperty('email');
                    expect(response.errors).toHaveProperty('name');
                }
            });
            it('should include error code in exception', () => {
                // Arrange
                const input = { email: 'invalid', name: 'J' };
                // Act & Assert
                try {
                    pipe.transform(input);
                    fail('Should have thrown');
                }
                catch (error) {
                    const response = error.getResponse();
                    expect(response.code).toBe('VALIDATION_ERROR');
                }
            });
            it('should handle missing required fields', () => {
                // Arrange
                const input = {}; // missing email and name
                // Act & Assert
                expect(() => pipe.transform(input)).toThrow(common_1.BadRequestException);
            });
            it('should handle wrong types', () => {
                // Arrange
                const input = {
                    email: 123, // should be string
                    name: 'John',
                };
                // Act & Assert
                expect(() => pipe.transform(input)).toThrow(common_1.BadRequestException);
            });
        });
        describe('error message formatting', () => {
            it('should format nested path errors correctly', () => {
                // Arrange
                const nestedSchema = zod_1.z.object({
                    user: zod_1.z.object({
                        email: zod_1.z.string().email(),
                    }),
                });
                const nestedPipe = new zod_validation_pipe_1.ZodValidationPipe(nestedSchema);
                const input = { user: { email: 'invalid' } };
                // Act & Assert
                try {
                    nestedPipe.transform(input);
                    fail('Should have thrown');
                }
                catch (error) {
                    const response = error.getResponse();
                    expect(response.errors['user.email']).toBeDefined();
                    expect(response.errors['user.email']).toContain('Invalid email address');
                }
            });
            it('should rethrow non-ZodError errors', () => {
                // Arrange - Create a schema that throws a non-ZodError
                const errorSchema = zod_1.z.string().transform(() => {
                    throw new Error('Custom transform error');
                });
                const errorPipe = new zod_validation_pipe_1.ZodValidationPipe(errorSchema);
                // Act & Assert
                expect(() => errorPipe.transform('test')).toThrow('Custom transform error');
            });
            it('should map root-level issues to _root path', () => {
                // Arrange
                const rootSchema = zod_1.z.object({}).superRefine((_, ctx) => {
                    ctx.addIssue({
                        code: zod_1.z.ZodIssueCode.custom,
                        message: 'Root level error',
                        path: [],
                    });
                });
                const rootPipe = new zod_validation_pipe_1.ZodValidationPipe(rootSchema);
                // Act & Assert
                try {
                    rootPipe.transform({});
                    fail('Should have thrown');
                }
                catch (error) {
                    const response = error.getResponse();
                    expect(response.errors._root).toContain('Root level error');
                }
            });
            it('should aggregate multiple issues for the same field', () => {
                // Arrange
                const multiIssueSchema = zod_1.z.object({
                    code: zod_1.z
                        .string()
                        .min(5, 'Too short')
                        .regex(/^\d+$/, 'Must be numeric'),
                });
                const multiIssuePipe = new zod_validation_pipe_1.ZodValidationPipe(multiIssueSchema);
                // Act & Assert
                try {
                    multiIssuePipe.transform({ code: 'ABC' });
                    fail('Should have thrown');
                }
                catch (error) {
                    const response = error.getResponse();
                    expect(response.errors.code).toEqual([
                        'Too short',
                        'Must be numeric',
                    ]);
                }
            });
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmsvc25pcHBldGZvcmdlL3NuaXBwZXRmb3JnZS9hcHBzL2FwaS90ZXN0L3VuaXQvcGlwZXMvem9kLXZhbGlkYXRpb24ucGlwZS5zcGVjLnRzIiwibWFwcGluZ3MiOiI7QUFBQSw4Q0FBOEM7O0FBRTlDLDJDQUFxRDtBQUNyRCw2QkFBd0I7QUFDeEIsdUZBQWtGO0FBRWxGOzs7Ozs7O0dBT0c7QUFDSCxRQUFRLENBQUMsbUJBQW1CLEVBQUUsR0FBRyxFQUFFO0lBQ2pDLGNBQWM7SUFDZCxNQUFNLFVBQVUsR0FBRyxPQUFDLENBQUMsTUFBTSxDQUFDO1FBQzFCLEtBQUssRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsS0FBSyxDQUFDLHNCQUFzQixDQUFDO1FBQy9DLElBQUksRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxvQ0FBb0MsQ0FBQztRQUM3RCxHQUFHLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsc0JBQXNCLENBQUMsQ0FBQyxRQUFRLEVBQUU7S0FDMUQsQ0FBQyxDQUFDO0lBRUgsSUFBSSxJQUFtRCxDQUFDO0lBRXhELFVBQVUsQ0FBQyxHQUFHLEVBQUU7UUFDZCxJQUFJLEdBQUcsSUFBSSx1Q0FBaUIsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUMzQyxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxXQUFXLEVBQUUsR0FBRyxFQUFFO1FBQ3pCLFFBQVEsQ0FBQyxpQkFBaUIsRUFBRSxHQUFHLEVBQUU7WUFDL0IsRUFBRSxDQUFDLHFEQUFxRCxFQUFFLEdBQUcsRUFBRTtnQkFDN0QsVUFBVTtnQkFDVixNQUFNLEtBQUssR0FBRztvQkFDWixLQUFLLEVBQUUsa0JBQWtCO29CQUN6QixJQUFJLEVBQUUsTUFBTTtvQkFDWixHQUFHLEVBQUUsRUFBRTtpQkFDUixDQUFDO2dCQUVGLE1BQU07Z0JBQ04sTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLFNBQVMs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Q0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvcnVubmVyL3dvcmsvc25pcHBldGZvcmdlL3NuaXBwZXRmb3JnZS9hcHBzL2FwaS90ZXN0L3VuaXQvcGlwZXMvem9kLXZhbGlkYXRpb24ucGlwZS5zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIHRlc3QvdW5pdC9waXBlcy96b2QtdmFsaWRhdGlvbi5waXBlLnNwZWMudHNcblxuaW1wb3J0IHsgQmFkUmVxdWVzdEV4Y2VwdGlvbiB9IGZyb20gJ0BuZXN0anMvY29tbW9uJztcbmltcG9ydCB7IHogfSBmcm9tICd6b2QnO1xuaW1wb3J0IHsgWm9kVmFsaWRhdGlvblBpcGUgfSBmcm9tICcuLi8uLi8uLi9zcmMvc2hhcmVkL3BpcGVzL3pvZC12YWxpZGF0aW9uLnBpcGUnO1xuXG4vKipcbiAqIFpvZFZhbGlkYXRpb25QaXBlIFVuaXQgVGVzdHNcbiAqXG4gKiBUZXN0ZXQ6XG4gKiAtIFZhbGlkZSBEYXRlbiB3ZXJkZW4gdHJhbnNmb3JtaWVydFxuICogLSBJbnZhbGlkZSBEYXRlbiB3ZXJmZW4gQmFkUmVxdWVzdEV4Y2VwdGlvblxuICogLSBFcnJvci1Gb3JtYXQgaXN0IGtvcnJla3RcbiAqL1xuZGVzY3JpYmUoJ1pvZFZhbGlkYXRpb25QaXBlJywgKCkgPT4ge1xuICAvLyBUZXN0IFNjaGVtYVxuICBjb25zdCBUZXN0U2NoZW1hID0gei5vYmplY3Qoe1xuICAgIGVtYWlsOiB6LnN0cmluZygpLmVtYWlsKCdJbnZhbGlkIGVtYWlsIGZvcm1hdCcpLFxuICAgIG5hbWU6IHouc3RyaW5nKCkubWluKDIsICdOYW1lIG11c3QgYmUgYXQgbGVhc3QgMiBjaGFyYWN0ZXJzJyksXG4gICAgYWdlOiB6Lm51bWJlcigpLm1pbigwLCAnQWdlIG11c3QgYmUgcG9zaXRpdmUnKS5vcHRpb25hbCgpLFxuICB9KTtcblxuICBsZXQgcGlwZTogWm9kVmFsaWRhdGlvblBpcGU8ei5pbmZlcjx0eXBlb2YgVGVzdFNjaGVtYT4+O1xuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIHBpcGUgPSBuZXcgWm9kVmFsaWRhdGlvblBpcGUoVGVzdFNjaGVtYSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCd0cmFuc2Zvcm0nLCAoKSA9PiB7XG4gICAgZGVzY3JpYmUoJ3dpdGggdmFsaWQgZGF0YScsICgpID0+IHtcbiAgICAgIGl0KCdzaG91bGQgcmV0dXJuIHBhcnNlZCBkYXRhIHdoZW4gYWxsIGZpZWxkcyBhcmUgdmFsaWQnLCAoKSA9PiB7XG4gICAgICAgIC8vIEFycmFuZ2VcbiAgICAgICAgY29uc3QgaW5wdXQgPSB7XG4gICAgICAgICAgZW1haWw6ICd0ZXN0QGV4YW1wbGUuY29tJyxcbiAgICAgICAgICBuYW1lOiAnSm9obicsXG4gICAgICAgICAgYWdlOiAyNSxcbiAgICAgICAgfTtcblxuICAgICAgICAvLyBBY3RcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gcGlwZS50cmFuc2Zvcm0oaW5wdXQpO1xuXG4gICAgICAgIC8vIEFzc2VydFxuICAgICAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKGlucHV0KTtcbiAgICAgIH0pO1xuXG4gICAgICBpdCgnc2hvdWxkIHJldHVybiBwYXJzZWQgZGF0YSB3aXRoIG9wdGlvbmFsIGZpZWxkcyBvbWl0dGVkJywgKCkgPT4ge1xuICAgICAgICAvLyBBcnJhbmdlXG4gICAgICAgIGNvbnN0IGlucHV0ID0ge1xuICAgICAgICAgIGVtYWlsOiAndGVzdEBleGFtcGxlLmNvbScsXG4gICAgICAgICAgbmFtZTogJ0pvaG4nLFxuICAgICAgICB9O1xuXG4gICAgICAgIC8vIEFjdFxuICAgICAgICBjb25zdCByZXN1bHQgPSBwaXBlLnRyYW5zZm9ybShpbnB1dCk7XG5cbiAgICAgICAgLy8gQXNzZXJ0XG4gICAgICAgIGV4cGVjdChyZXN1bHQpLnRvRXF1YWwoaW5wdXQpO1xuICAgICAgICBleHBlY3QocmVzdWx0KS5ub3QudG9IYXZlUHJvcGVydHkoJ2FnZScpO1xuICAgICAgfSk7XG5cbiAgICAgIGl0KCdzaG91bGQgdHJhbnNmb3JtIGRhdGEgKGUuZy4sIHRyaW0gc3RyaW5ncykgaWYgc2NoZW1hIGRlZmluZXMgdHJhbnNmb3JtYXRpb25zJywgKCkgPT4ge1xuICAgICAgICAvLyBBcnJhbmdlXG4gICAgICAgIGNvbnN0IHNjaGVtYVdpdGhUcmFuc2Zvcm0gPSB6Lm9iamVjdCh7XG4gICAgICAgICAgZW1haWw6IHpcbiAgICAgICAgICAgIC5zdHJpbmcoKVxuICAgICAgICAgICAgLmVtYWlsKClcbiAgICAgICAgICAgIC50cmFuc2Zvcm0oKHYpID0+IHYudG9Mb3dlckNhc2UoKSksXG4gICAgICAgIH0pO1xuICAgICAgICBjb25zdCBwaXBlV2l0aFRyYW5zZm9ybSA9IG5ldyBab2RWYWxpZGF0aW9uUGlwZShzY2hlbWFXaXRoVHJhbnNmb3JtKTtcbiAgICAgICAgY29uc3QgaW5wdXQgPSB7IGVtYWlsOiAnVEVTVEBFWEFNUExFLkNPTScgfTtcblxuICAgICAgICAvLyBBY3RcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gcGlwZVdpdGhUcmFuc2Zvcm0udHJhbnNmb3JtKGlucHV0KTtcblxuICAgICAgICAvLyBBc3NlcnRcbiAgICAgICAgZXhwZWN0KHJlc3VsdC5lbWFpbCkudG9CZSgndGVzdEBleGFtcGxlLmNvbScpO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBkZXNjcmliZSgnd2l0aCBpbnZhbGlkIGRhdGEnLCAoKSA9PiB7XG4gICAgICBpdCgnc2hvdWxkIHRocm93IEJhZFJlcXVlc3RFeGNlcHRpb24gZm9yIGludmFsaWQgZW1haWwnLCAoKSA9PiB7XG4gICAgICAgIC8vIEFycmFuZ2VcbiAgICAgICAgY29uc3QgaW5wdXQgPSB7XG4gICAgICAgICAgZW1haWw6ICdub3QtYW4tZW1haWwnLFxuICAgICAgICAgIG5hbWU6ICdKb2huJyxcbiAgICAgICAgfTtcblxuICAgICAgICAvLyBBY3QgJiBBc3NlcnRcbiAgICAgICAgZXhwZWN0KCgpID0+IHBpcGUudHJhbnNmb3JtKGlucHV0KSkudG9UaHJvdyhCYWRSZXF1ZXN0RXhjZXB0aW9uKTtcbiAgICAgIH0pO1xuXG4gICAgICBpdCgnc2hvdWxkIHRocm93IEJhZFJlcXVlc3RFeGNlcHRpb24gZm9yIHRvbyBzaG9ydCBuYW1lJywgKCkgPT4ge1xuICAgICAgICAvLyBBcnJhbmdlXG4gICAgICAgIGNvbnN0IGlucHV0ID0ge1xuICAgICAgICAgIGVtYWlsOiAndGVzdEBleGFtcGxlLmNvbScsXG4gICAgICAgICAgbmFtZTogJ0onLCAvLyB0b28gc2hvcnRcbiAgICAgICAgfTtcblxuICAgICAgICAvLyBBY3QgJiBBc3NlcnRcbiAgICAgICAgZXhwZWN0KCgpID0+IHBpcGUudHJhbnNmb3JtKGlucHV0KSkudG9UaHJvdyhCYWRSZXF1ZXN0RXhjZXB0aW9uKTtcbiAgICAgIH0pO1xuXG4gICAgICBpdCgnc2hvdWxkIGluY2x1ZGUgZmllbGQtc3BlY2lmaWMgZXJyb3JzIGluIGV4Y2VwdGlvbicsICgpID0+IHtcbiAgICAgICAgLy8gQXJyYW5nZVxuICAgICAgICBjb25zdCBpbnB1dCA9IHtcbiAgICAgICAgICBlbWFpbDogJ2ludmFsaWQnLFxuICAgICAgICAgIG5hbWU6ICdKJyxcbiAgICAgICAgfTtcblxuICAgICAgICAvLyBBY3QgJiBBc3NlcnRcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBwaXBlLnRyYW5zZm9ybShpbnB1dCk7XG4gICAgICAgICAgZmFpbCgnU2hvdWxkIGhhdmUgdGhyb3duJyk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgZXhwZWN0KGVycm9yKS50b0JlSW5zdGFuY2VPZihCYWRSZXF1ZXN0RXhjZXB0aW9uKTtcbiAgICAgICAgICBjb25zdCByZXNwb25zZSA9IChlcnJvciBhcyBCYWRSZXF1ZXN0RXhjZXB0aW9uKS5nZXRSZXNwb25zZSgpIGFzIHtcbiAgICAgICAgICAgIGVycm9yczogUmVjb3JkPHN0cmluZywgc3RyaW5nW10+O1xuICAgICAgICAgIH07XG4gICAgICAgICAgZXhwZWN0KHJlc3BvbnNlLmVycm9ycykudG9IYXZlUHJvcGVydHkoJ2VtYWlsJyk7XG4gICAgICAgICAgZXhwZWN0KHJlc3BvbnNlLmVycm9ycykudG9IYXZlUHJvcGVydHkoJ25hbWUnKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIGl0KCdzaG91bGQgaW5jbHVkZSBlcnJvciBjb2RlIGluIGV4Y2VwdGlvbicsICgpID0+IHtcbiAgICAgICAgLy8gQXJyYW5nZVxuICAgICAgICBjb25zdCBpbnB1dCA9IHsgZW1haWw6ICdpbnZhbGlkJywgbmFtZTogJ0onIH07XG5cbiAgICAgICAgLy8gQWN0ICYgQXNzZXJ0XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgcGlwZS50cmFuc2Zvcm0oaW5wdXQpO1xuICAgICAgICAgIGZhaWwoJ1Nob3VsZCBoYXZlIHRocm93bicpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gKGVycm9yIGFzIEJhZFJlcXVlc3RFeGNlcHRpb24pLmdldFJlc3BvbnNlKCkgYXMge1xuICAgICAgICAgICAgY29kZTogc3RyaW5nO1xuICAgICAgICAgIH07XG4gICAgICAgICAgZXhwZWN0KHJlc3BvbnNlLmNvZGUpLnRvQmUoJ1ZBTElEQVRJT05fRVJST1InKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIGl0KCdzaG91bGQgaGFuZGxlIG1pc3NpbmcgcmVxdWlyZWQgZmllbGRzJywgKCkgPT4ge1xuICAgICAgICAvLyBBcnJhbmdlXG4gICAgICAgIGNvbnN0IGlucHV0ID0ge307IC8vIG1pc3NpbmcgZW1haWwgYW5kIG5hbWVcblxuICAgICAgICAvLyBBY3QgJiBBc3NlcnRcbiAgICAgICAgZXhwZWN0KCgpID0+IHBpcGUudHJhbnNmb3JtKGlucHV0KSkudG9UaHJvdyhCYWRSZXF1ZXN0RXhjZXB0aW9uKTtcbiAgICAgIH0pO1xuXG4gICAgICBpdCgnc2hvdWxkIGhhbmRsZSB3cm9uZyB0eXBlcycsICgpID0+IHtcbiAgICAgICAgLy8gQXJyYW5nZVxuICAgICAgICBjb25zdCBpbnB1dCA9IHtcbiAgICAgICAgICBlbWFpbDogMTIzLCAvLyBzaG91bGQgYmUgc3RyaW5nXG4gICAgICAgICAgbmFtZTogJ0pvaG4nLFxuICAgICAgICB9O1xuXG4gICAgICAgIC8vIEFjdCAmIEFzc2VydFxuICAgICAgICBleHBlY3QoKCkgPT4gcGlwZS50cmFuc2Zvcm0oaW5wdXQpKS50b1Rocm93KEJhZFJlcXVlc3RFeGNlcHRpb24pO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBkZXNjcmliZSgnZXJyb3IgbWVzc2FnZSBmb3JtYXR0aW5nJywgKCkgPT4ge1xuICAgICAgaXQoJ3Nob3VsZCBmb3JtYXQgbmVzdGVkIHBhdGggZXJyb3JzIGNvcnJlY3RseScsICgpID0+IHtcbiAgICAgICAgLy8gQXJyYW5nZVxuICAgICAgICBjb25zdCBuZXN0ZWRTY2hlbWEgPSB6Lm9iamVjdCh7XG4gICAgICAgICAgdXNlcjogei5vYmplY3Qoe1xuICAgICAgICAgICAgZW1haWw6IHouc3RyaW5nKCkuZW1haWwoKSxcbiAgICAgICAgICB9KSxcbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IG5lc3RlZFBpcGUgPSBuZXcgWm9kVmFsaWRhdGlvblBpcGUobmVzdGVkU2NoZW1hKTtcbiAgICAgICAgY29uc3QgaW5wdXQgPSB7IHVzZXI6IHsgZW1haWw6ICdpbnZhbGlkJyB9IH07XG5cbiAgICAgICAgLy8gQWN0ICYgQXNzZXJ0XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgbmVzdGVkUGlwZS50cmFuc2Zvcm0oaW5wdXQpO1xuICAgICAgICAgIGZhaWwoJ1Nob3VsZCBoYXZlIHRocm93bicpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gKGVycm9yIGFzIEJhZFJlcXVlc3RFeGNlcHRpb24pLmdldFJlc3BvbnNlKCkgYXMge1xuICAgICAgICAgICAgZXJyb3JzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmdbXT47XG4gICAgICAgICAgfTtcbiAgICAgICAgICBleHBlY3QocmVzcG9uc2UuZXJyb3JzWyd1c2VyLmVtYWlsJ10pLnRvQmVEZWZpbmVkKCk7XG4gICAgICAgICAgZXhwZWN0KHJlc3BvbnNlLmVycm9yc1sndXNlci5lbWFpbCddKS50b0NvbnRhaW4oXG4gICAgICAgICAgICAnSW52YWxpZCBlbWFpbCBhZGRyZXNzJyxcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgICAgaXQoJ3Nob3VsZCByZXRocm93IG5vbi1ab2RFcnJvciBlcnJvcnMnLCAoKSA9PiB7XG4gICAgICAgIC8vIEFycmFuZ2UgLSBDcmVhdGUgYSBzY2hlbWEgdGhhdCB0aHJvd3MgYSBub24tWm9kRXJyb3JcbiAgICAgICAgY29uc3QgZXJyb3JTY2hlbWEgPSB6LnN0cmluZygpLnRyYW5zZm9ybSgoKSA9PiB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDdXN0b20gdHJhbnNmb3JtIGVycm9yJyk7XG4gICAgICAgIH0pO1xuICAgICAgICBjb25zdCBlcnJvclBpcGUgPSBuZXcgWm9kVmFsaWRhdGlvblBpcGUoZXJyb3JTY2hlbWEpO1xuXG4gICAgICAgIC8vIEFjdCAmIEFzc2VydFxuICAgICAgICBleHBlY3QoKCkgPT4gZXJyb3JQaXBlLnRyYW5zZm9ybSgndGVzdCcpKS50b1Rocm93KFxuICAgICAgICAgICdDdXN0b20gdHJhbnNmb3JtIGVycm9yJyxcbiAgICAgICAgKTtcbiAgICAgIH0pO1xuXG4gICAgICBpdCgnc2hvdWxkIG1hcCByb290LWxldmVsIGlzc3VlcyB0byBfcm9vdCBwYXRoJywgKCkgPT4ge1xuICAgICAgICAvLyBBcnJhbmdlXG4gICAgICAgIGNvbnN0IHJvb3RTY2hlbWEgPSB6Lm9iamVjdCh7fSkuc3VwZXJSZWZpbmUoKF8sIGN0eCkgPT4ge1xuICAgICAgICAgIGN0eC5hZGRJc3N1ZSh7XG4gICAgICAgICAgICBjb2RlOiB6LlpvZElzc3VlQ29kZS5jdXN0b20sXG4gICAgICAgICAgICBtZXNzYWdlOiAnUm9vdCBsZXZlbCBlcnJvcicsXG4gICAgICAgICAgICBwYXRoOiBbXSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IHJvb3RQaXBlID0gbmV3IFpvZFZhbGlkYXRpb25QaXBlKHJvb3RTY2hlbWEpO1xuXG4gICAgICAgIC8vIEFjdCAmIEFzc2VydFxuICAgICAgICB0cnkge1xuICAgICAgICAgIHJvb3RQaXBlLnRyYW5zZm9ybSh7fSk7XG4gICAgICAgICAgZmFpbCgnU2hvdWxkIGhhdmUgdGhyb3duJyk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSAoZXJyb3IgYXMgQmFkUmVxdWVzdEV4Y2VwdGlvbikuZ2V0UmVzcG9uc2UoKSBhcyB7XG4gICAgICAgICAgICBlcnJvcnM6IFJlY29yZDxzdHJpbmcsIHN0cmluZ1tdPjtcbiAgICAgICAgICB9O1xuICAgICAgICAgIGV4cGVjdChyZXNwb25zZS5lcnJvcnMuX3Jvb3QpLnRvQ29udGFpbignUm9vdCBsZXZlbCBlcnJvcicpO1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgICAgaXQoJ3Nob3VsZCBhZ2dyZWdhdGUgbXVsdGlwbGUgaXNzdWVzIGZvciB0aGUgc2FtZSBmaWVsZCcsICgpID0+IHtcbiAgICAgICAgLy8gQXJyYW5nZVxuICAgICAgICBjb25zdCBtdWx0aUlzc3VlU2NoZW1hID0gei5vYmplY3Qoe1xuICAgICAgICAgIGNvZGU6IHpcbiAgICAgICAgICAgIC5zdHJpbmcoKVxuICAgICAgICAgICAgLm1pbig1LCAnVG9vIHNob3J0JylcbiAgICAgICAgICAgIC5yZWdleCgvXlxcZCskLywgJ011c3QgYmUgbnVtZXJpYycpLFxuICAgICAgICB9KTtcbiAgICAgICAgY29uc3QgbXVsdGlJc3N1ZVBpcGUgPSBuZXcgWm9kVmFsaWRhdGlvblBpcGUobXVsdGlJc3N1ZVNjaGVtYSk7XG5cbiAgICAgICAgLy8gQWN0ICYgQXNzZXJ0XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgbXVsdGlJc3N1ZVBpcGUudHJhbnNmb3JtKHsgY29kZTogJ0FCQycgfSk7XG4gICAgICAgICAgZmFpbCgnU2hvdWxkIGhhdmUgdGhyb3duJyk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSAoZXJyb3IgYXMgQmFkUmVxdWVzdEV4Y2VwdGlvbikuZ2V0UmVzcG9uc2UoKSBhcyB7XG4gICAgICAgICAgICBlcnJvcnM6IFJlY29yZDxzdHJpbmcsIHN0cmluZ1tdPjtcbiAgICAgICAgICB9O1xuICAgICAgICAgIGV4cGVjdChyZXNwb25zZS5lcnJvcnMuY29kZSkudG9FcXVhbChbXG4gICAgICAgICAgICAnVG9vIHNob3J0JyxcbiAgICAgICAgICAgICdNdXN0IGJlIG51bWVyaWMnLFxuICAgICAgICAgIF0pO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==