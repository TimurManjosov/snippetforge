{"file":"/home/runner/work/snippetforge/snippetforge/apps/api/test/unit/pipes/zod-validation.pipe.spec.ts","mappings":"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","names":[],"sources":["/home/runner/work/snippetforge/snippetforge/apps/api/test/unit/pipes/zod-validation.pipe.spec.ts"],"sourcesContent":["// test/unit/pipes/zod-validation.pipe.spec.ts\n\nimport { BadRequestException } from '@nestjs/common';\nimport { z } from 'zod';\nimport { ZodValidationPipe } from '../../../src/shared/pipes/zod-validation.pipe';\n\n/**\n * ZodValidationPipe Unit Tests\n *\n * Testet:\n * - Valide Daten werden transformiert\n * - Invalide Daten werfen BadRequestException\n * - Error-Format ist korrekt\n */\ndescribe('ZodValidationPipe', () => {\n  // Test Schema\n  const TestSchema = z.object({\n    email: z.string().email('Invalid email format'),\n    name: z.string().min(2, 'Name must be at least 2 characters'),\n    age: z.number().min(0, 'Age must be positive').optional(),\n  });\n\n  let pipe: ZodValidationPipe<z.infer<typeof TestSchema>>;\n\n  beforeEach(() => {\n    pipe = new ZodValidationPipe(TestSchema);\n  });\n\n  describe('transform', () => {\n    describe('with valid data', () => {\n      it('should return parsed data when all fields are valid', () => {\n        // Arrange\n        const input = {\n          email: 'test@example.com',\n          name: 'John',\n          age: 25,\n        };\n\n        // Act\n        const result = pipe.transform(input);\n\n        // Assert\n        expect(result).toEqual(input);\n      });\n\n      it('should return parsed data with optional fields omitted', () => {\n        // Arrange\n        const input = {\n          email: 'test@example.com',\n          name: 'John',\n        };\n\n        // Act\n        const result = pipe.transform(input);\n\n        // Assert\n        expect(result).toEqual(input);\n        expect(result).not.toHaveProperty('age');\n      });\n\n      it('should transform data (e.g., trim strings) if schema defines transformations', () => {\n        // Arrange\n        const schemaWithTransform = z.object({\n          email: z\n            .string()\n            .email()\n            .transform((v) => v.toLowerCase()),\n        });\n        const pipeWithTransform = new ZodValidationPipe(schemaWithTransform);\n        const input = { email: 'TEST@EXAMPLE.COM' };\n\n        // Act\n        const result = pipeWithTransform.transform(input);\n\n        // Assert\n        expect(result.email).toBe('test@example.com');\n      });\n    });\n\n    describe('with invalid data', () => {\n      it('should throw BadRequestException for invalid email', () => {\n        // Arrange\n        const input = {\n          email: 'not-an-email',\n          name: 'John',\n        };\n\n        // Act & Assert\n        expect(() => pipe.transform(input)).toThrow(BadRequestException);\n      });\n\n      it('should throw BadRequestException for too short name', () => {\n        // Arrange\n        const input = {\n          email: 'test@example.com',\n          name: 'J', // too short\n        };\n\n        // Act & Assert\n        expect(() => pipe.transform(input)).toThrow(BadRequestException);\n      });\n\n      it('should include field-specific errors in exception', () => {\n        // Arrange\n        const input = {\n          email: 'invalid',\n          name: 'J',\n        };\n\n        // Act & Assert\n        try {\n          pipe.transform(input);\n          fail('Should have thrown');\n        } catch (error) {\n          expect(error).toBeInstanceOf(BadRequestException);\n          const response = (error as BadRequestException).getResponse() as {\n            errors: Record<string, string[]>;\n          };\n          expect(response.errors).toHaveProperty('email');\n          expect(response.errors).toHaveProperty('name');\n        }\n      });\n\n      it('should include error code in exception', () => {\n        // Arrange\n        const input = { email: 'invalid', name: 'J' };\n\n        // Act & Assert\n        try {\n          pipe.transform(input);\n          fail('Should have thrown');\n        } catch (error) {\n          const response = (error as BadRequestException).getResponse() as {\n            code: string;\n          };\n          expect(response.code).toBe('VALIDATION_ERROR');\n        }\n      });\n\n      it('should handle missing required fields', () => {\n        // Arrange\n        const input = {}; // missing email and name\n\n        // Act & Assert\n        expect(() => pipe.transform(input)).toThrow(BadRequestException);\n      });\n\n      it('should handle wrong types', () => {\n        // Arrange\n        const input = {\n          email: 123, // should be string\n          name: 'John',\n        };\n\n        // Act & Assert\n        expect(() => pipe.transform(input)).toThrow(BadRequestException);\n      });\n    });\n\n    describe('error message formatting', () => {\n      it('should format nested path errors correctly', () => {\n        // Arrange\n        const nestedSchema = z.object({\n          user: z.object({\n            email: z.string().email(),\n          }),\n        });\n        const nestedPipe = new ZodValidationPipe(nestedSchema);\n        const input = { user: { email: 'invalid' } };\n\n        // Act & Assert\n        try {\n          nestedPipe.transform(input);\n          fail('Should have thrown');\n        } catch (error) {\n          const response = (error as BadRequestException).getResponse() as {\n            errors: Record<string, string[]>;\n          };\n          expect(response.errors['user.email']).toBeDefined();\n          expect(response.errors['user.email']).toContain(\n            'Invalid email address',\n          );\n        }\n      });\n\n      it('should rethrow non-ZodError errors', () => {\n        // Arrange - Create a schema that throws a non-ZodError\n        const errorSchema = z.string().transform(() => {\n          throw new Error('Custom transform error');\n        });\n        const errorPipe = new ZodValidationPipe(errorSchema);\n\n        // Act & Assert\n        expect(() => errorPipe.transform('test')).toThrow(\n          'Custom transform error',\n        );\n      });\n\n      it('should map root-level issues to _root path', () => {\n        // Arrange\n        const rootSchema = z.object({}).superRefine((_, ctx) => {\n          ctx.addIssue({\n            code: z.ZodIssueCode.custom,\n            message: 'Root level error',\n            path: [],\n          });\n        });\n        const rootPipe = new ZodValidationPipe(rootSchema);\n\n        // Act & Assert\n        try {\n          rootPipe.transform({});\n          fail('Should have thrown');\n        } catch (error) {\n          const response = (error as BadRequestException).getResponse() as {\n            errors: Record<string, string[]>;\n          };\n          expect(response.errors._root).toContain('Root level error');\n        }\n      });\n\n      it('should aggregate multiple issues for the same field', () => {\n        // Arrange\n        const multiIssueSchema = z.object({\n          code: z\n            .string()\n            .min(5, 'Too short')\n            .regex(/^\\d+$/, 'Must be numeric'),\n        });\n        const multiIssuePipe = new ZodValidationPipe(multiIssueSchema);\n\n        // Act & Assert\n        try {\n          multiIssuePipe.transform({ code: 'ABC' });\n          fail('Should have thrown');\n        } catch (error) {\n          const response = (error as BadRequestException).getResponse() as {\n            errors: Record<string, string[]>;\n          };\n          expect(response.errors.code).toEqual([\n            'Too short',\n            'Must be numeric',\n          ]);\n        }\n      });\n    });\n  });\n});\n"],"version":3}