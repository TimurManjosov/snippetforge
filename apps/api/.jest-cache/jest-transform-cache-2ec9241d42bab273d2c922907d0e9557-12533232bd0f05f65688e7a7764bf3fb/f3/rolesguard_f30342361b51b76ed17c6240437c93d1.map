{"file":"/home/runner/work/snippetforge/snippetforge/apps/api/src/modules/auth/guards/roles.guard.ts","mappings":";AAAA,yCAAyC;;;;;;;;;;;;;;AAEzC,2CAMwB;AACxB,uCAAyC;AAGzC,mEAA0D;AAE1D;;;;;;;;;;;;;;;;;;;;;;;GAuBG;AAEI,IAAM,UAAU,kBAAhB,MAAM,UAAU;IAGD;IAFH,MAAM,GAAG,IAAI,eAAM,CAAC,YAAU,CAAC,IAAI,CAAC,CAAC;IAEtD,YAAoB,SAAoB;QAApB,cAAS,GAAT,SAAS,CAAW;IAAG,CAAC;IAE5C;;;;;;OAMG;IACH,WAAW,CAAC,OAAyB;QACnC,+CAA+C;QAC/C,MAAM,aAAa,GAAG,IAAI,CAAC,SAAS,CAAC,iBAAiB,CACpD,2BAAS,EACT,CAAC,OAAO,CAAC,UAAU,EAAE,EAAE,OAAO,CAAC,QAAQ,EAAE,CAAC,CAC3C,CAAC;QAEF,gDAAgD;QAChD,IAAI,CAAC,aAAa,IAAI,aAAa,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;YACjD,OAAO,IAAI,CAAC;QACd,CAAC;QAED,4DAA4D;QAC5D,MAAM,OAAO,GAAG,OAAO,CAAC,YAAY,EAAE,CAAC,UAAU,EAAW,CAAC;QAC7D,MAAM,IAAI,GAAG,OAAO,CAAC,IAA4B,CAAC;QAElD,wEAAwE;QACxE,IAAI,CAAC,IAAI,EAAE,CAAC;YACV,IAAI,CAAC,MAAM,CAAC,KAAK,CACf,6DAA6D,CAC9D,CAAC;YACF,MAAM,IAAI,2BAAkB,CAAC,yBAAyB,CAAC,CAAC;QAC1D,CAAC;QAED,iDAAiD;QACjD,MAAM,OAAO,GAAG,aAAa,CAAC,QAAQ,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAElD,IAAI,CAAC,OAAO,EAAE,CAAC;YACb,IAAI,CAAC,MAAM,CAAC,IAAI,CACd,uBAAuB,IAAI,CAAC,EAAE,cAAc,IAAI,CAAC,IAAI,GAAG;gBACtD,mCAAmC,aAAa,CAAC,IAAI,CAAC,MAAM,CAAC,EAAE,CAClE,CAAC;YACF,MAAM,IAAI,2BAAkB,CAC1B,iCAAiC,aAAa,CAAC,IAAI,CAAC,MAAM,CAAC,EAAE,CAC9D,CAAC;QACJ,CAAC;QAED,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,wBAAwB,IAAI,CAAC,EAAE,cAAc,IAAI,CAAC,IAAI,EAAE,CAAC,CAAC;QAC5E,OAAO,IAAI,CAAC;IACd,CAAC;CACF,CAAA;AApDY,gCAAU;qBAAV,UAAU;IADtB,IAAA,mBAAU,GAAE;yDAIoB,gBAAS,oBAAT,gBAAS;GAH7B,UAAU,CAoDtB","names":[],"sources":["/home/runner/work/snippetforge/snippetforge/apps/api/src/modules/auth/guards/roles.guard.ts"],"sourcesContent":["// src/modules/auth/guards/roles.guard.ts\n\nimport {\n  CanActivate,\n  ExecutionContext,\n  ForbiddenException,\n  Injectable,\n  Logger,\n} from '@nestjs/common';\nimport { Reflector } from '@nestjs/core';\nimport { Request } from 'express';\nimport { type SafeUser } from '../../users';\nimport { ROLES_KEY } from '../decorators/roles.decorator';\n\n/**\n * RolesGuard - Role-Based Access Control (RBAC)\n *\n * WIE ES FUNKTIONIERT:\n * 1. Route ist mit @Roles('ADMIN', 'MODERATOR') dekoriert\n * 2. User ist bereits authentifiziert (JwtAuthGuard lief vorher)\n * 3. RolesGuard prüft ob user.role in erlaubten Rollen ist\n * 4. Wenn ja: Route wird ausgeführt\n * 5. Wenn nein: 403 Forbidden\n *\n * WICHTIG: RolesGuard muss NACH JwtAuthGuard kommen!\n * @UseGuards(JwtAuthGuard, RolesGuard) ← Richtige Reihenfolge\n *\n * VERWENDUNG:\n * @Roles('ADMIN')\n * @UseGuards(JwtAuthGuard, RolesGuard)\n * @Delete('users/:id')\n * deleteUser() {}\n *\n * @Roles('ADMIN', 'MODERATOR')  // Einer von beiden reicht\n * @UseGuards(JwtAuthGuard, RolesGuard)\n * @Put('posts/:id/moderate')\n * moderatePost() {}\n */\n@Injectable()\nexport class RolesGuard implements CanActivate {\n  private readonly logger = new Logger(RolesGuard.name);\n\n  constructor(private reflector: Reflector) {}\n\n  /**\n   * canActivate - Prüft ob User die erforderliche Rolle hat\n   *\n   * @param context - Execution Context\n   * @returns true wenn erlaubt\n   * @throws ForbiddenException wenn Rolle nicht ausreicht\n   */\n  canActivate(context: ExecutionContext): boolean {\n    // 1. Hole erlaubte Rollen von Route/Controller\n    const requiredRoles = this.reflector.getAllAndOverride<string[]>(\n      ROLES_KEY,\n      [context.getHandler(), context.getClass()],\n    );\n\n    // 2. Wenn keine Rollen definiert, alle erlauben\n    if (!requiredRoles || requiredRoles.length === 0) {\n      return true;\n    }\n\n    // 3. Hole User aus Request (wurde von JwtAuthGuard gesetzt)\n    const request = context.switchToHttp().getRequest<Request>();\n    const user = request.user as SafeUser | undefined;\n\n    // 4. Defensive Check: User sollte existieren (JwtAuthGuard lief vorher)\n    if (!user) {\n      this.logger.error(\n        'RolesGuard: No user found in request. JwtAuthGuard missing?',\n      );\n      throw new ForbiddenException('Authentication required');\n    }\n\n    // 5. Prüfe ob User-Rolle in erlaubten Rollen ist\n    const hasRole = requiredRoles.includes(user.role);\n\n    if (!hasRole) {\n      this.logger.warn(\n        `Access denied: User ${user.id} with role ${user.role} ` +\n          `tried to access route requiring ${requiredRoles.join(' or ')}`,\n      );\n      throw new ForbiddenException(\n        `Access denied. Required role: ${requiredRoles.join(' or ')}`,\n      );\n    }\n\n    this.logger.debug(`Access granted: User ${user.id} with role ${user.role}`);\n    return true;\n  }\n}\n"],"version":3}