7554251da14b752077dc82c8a43c9e4e
"use strict";
/* eslint-disable @typescript-eslint/no-unsafe-member-access */
/* eslint-disable @typescript-eslint/no-unsafe-assignment */
// test/unit/filters/all-exceptions. filter.spec.ts
Object.defineProperty(exports, "__esModule", { value: true });
const common_1 = require("@nestjs/common");
const constants_1 = require("../../../src/shared/constants");
const all_exceptions_filter_1 = require("../../../src/shared/filters/all-exceptions.filter");
const test_utils_1 = require("../../setup/test-utils");
/**
 * AllExceptionsFilter Unit Tests
 *
 * Testet:
 * - Unbekannte Errors werden gefangen
 * - Sensitive Daten werden gefiltert
 * - Response Format ist korrekt
 */
describe('AllExceptionsFilter', () => {
    let filter;
    let mockResponse;
    let mockRequest;
    const originalEnv = process.env.NODE_ENV;
    beforeEach(() => {
        filter = new all_exceptions_filter_1.AllExceptionsFilter();
        mockResponse = (0, test_utils_1.createMockResponse)();
        mockRequest = (0, test_utils_1.createMockRequest)();
    });
    afterEach(() => {
        jest.clearAllMocks();
        process.env.NODE_ENV = originalEnv;
    });
    describe('catch', () => {
        describe('response format', () => {
            it('should return 500 for unknown errors', () => {
                // Arrange
                const exception = new Error('Something went wrong');
                const host = (0, test_utils_1.createMockArgumentsHost)(mockRequest, mockResponse);
                // Act
                filter.catch(exception, host);
                // Assert
                expect(mockResponse.status).toHaveBeenCalledWith(common_1.HttpStatus.INTERNAL_SERVER_ERROR);
            });
            it('should return standardized error response', () => {
                // Arrange
                const exception = new Error('Database connection failed');
                const host = (0, test_utils_1.createMockArgumentsHost)(mockRequest, mockResponse);
                // Act
                filter.catch(exception, host);
                // Assert
                expect(mockResponse.json).toHaveBeenCalledWith(expect.objectContaining({
                    success: false,
                    error: expect.objectContaining({
                        code: expect.any(String),
                        message: expect.any(String),
                        statusCode: 500,
                    }),
                    meta: expect.objectContaining({
                        path: mockRequest.url,
                        method: mockRequest.method,
                        timestamp: expect.any(String),
                    }),
                }));
            });
            it('should handle HttpExceptions with matching status', () => {
                // Arrange
                const exception = new common_1.HttpException('Http path', common_1.HttpStatus.BAD_REQUEST);
                const host = (0, test_utils_1.createMockArgumentsHost)(mockRequest, mockResponse);
                // Act
                filter.catch(exception, host);
                // Assert
                expect(mockResponse.status).toHaveBeenCalledWith(common_1.HttpStatus.BAD_REQUEST);
                expect(mockResponse.json).toHaveBeenCalledWith(expect.objectContaining({
                    error: expect.objectContaining({
                        code: constants_1.ErrorCodes.SERVER_ERROR,
                        message: 'Http path',
                        statusCode: common_1.HttpStatus.BAD_REQUEST,
                    }),
                }));
            });
            it('should propagate correlation ids into the meta block', () => {
                // Arrange
                const requestWithCorrelation = (0, test_utils_1.createMockRequest)({
                    headers: { 'x-correlation-id': 'corr-123' },
                });
                const exception = new Error('Correlation test');
                const host = (0, test_utils_1.createMockArgumentsHost)(requestWithCorrelation, mockResponse);
                // Act
                filter.catch(exception, host);
                // Assert
                const jsonCall = mockResponse.json.mock.calls[0][0];
                expect(jsonCall.meta.requestId).toBe('corr-123');
            });
        });
        describe('error type identification', () => {
            it('should identify JWT errors as AUTH_TOKEN_INVALID', () => {
                // Arrange
                const exception = new Error('invalid signature');
                exception.name = 'JsonWebTokenError';
                const host = (0, test_utils_1.createMockArgumentsHost)(mockRequest, mockResponse);
                // Act
                filter.catch(exception, host);
                // Assert
                expect(mockResponse.json).toHaveBeenCalledWith(expect.objectContaining({
                    error: expect.objectContaining({
                        code: constants_1.ErrorCodes.AUTH_TOKEN_INVALID,
                    }),
                }));
            });
            it('should identify expired JWT as AUTH_TOKEN_EXPIRED', () => {
                // Arrange
                const exception = new Error('jwt expired');
                exception.name = 'TokenExpiredError';
                const host = (0, test_utils_1.createMockArgumentsHost)(mockRequest, mockResponse);
                // Act
                filter.catch(exception, host);
                // Assert
                expect(mockResponse.json).toHaveBeenCalledWith(expect.objectContaining({
                    error: expect.objectContaining({
                        code: constants_1.ErrorCodes.AUTH_TOKEN_EXPIRED,
                    }),
                }));
            });
            it('should identify database errors', () => {
                // Arrange
                const exception = new Error('ECONNREFUSED database connection');
                const host = (0, test_utils_1.createMockArgumentsHost)(mockRequest, mockResponse);
                // Act
                filter.catch(exception, host);
                // Assert
                expect(mockResponse.json).toHaveBeenCalledWith(expect.objectContaining({
                    error: expect.objectContaining({
                        code: constants_1.ErrorCodes.SERVER_DATABASE_ERROR,
                    }),
                }));
            });
        });
        describe('message sanitization', () => {
            describe('in production', () => {
                beforeEach(() => {
                    process.env.NODE_ENV = 'production';
                    // Filter neu erstellen mit production env
                    filter = new all_exceptions_filter_1.AllExceptionsFilter();
                });
                it('should not expose internal error messages', () => {
                    // Arrange
                    const exception = new Error('Database password:  secret123');
                    const host = (0, test_utils_1.createMockArgumentsHost)(mockRequest, mockResponse);
                    // Act
                    filter.catch(exception, host);
                    // Assert
                    expect(mockResponse.json).toHaveBeenCalledWith(expect.objectContaining({
                        error: expect.objectContaining({
                            message: expect.not.stringContaining('secret123'),
                        }),
                    }));
                });
                it('should return generic message in production', () => {
                    // Arrange
                    const exception = new Error('Internal implementation details');
                    const host = (0, test_utils_1.createMockArgumentsHost)(mockRequest, mockResponse);
                    // Act
                    filter.catch(exception, host);
                    // Assert
                    expect(mockResponse.json).toHaveBeenCalledWith(expect.objectContaining({
                        error: expect.objectContaining({
                            message: 'An unexpected error occurred. Please try again later.',
                        }),
                    }));
                });
            });
            describe('in development', () => {
                beforeEach(() => {
                    process.env.NODE_ENV = 'development';
                    filter = new all_exceptions_filter_1.AllExceptionsFilter();
                });
                it('should include sanitized error message', () => {
                    // Arrange
                    const exception = new Error('Something went wrong');
                    const host = (0, test_utils_1.createMockArgumentsHost)(mockRequest, mockResponse);
                    // Act
                    filter.catch(exception, host);
                    // Assert
                    expect(mockResponse.json).toHaveBeenCalledWith(expect.objectContaining({
                        error: expect.objectContaining({
                            message: expect.any(String),
                        }),
                    }));
                });
                it('should redact file paths from error message', () => {
                    // Arrange
                    const exception = new Error('Error at C:\\Users\\dev\\project\\src\\file.ts: 123');
                    const host = (0, test_utils_1.createMockArgumentsHost)(mockRequest, mockResponse);
                    // Act
                    filter.catch(exception, host);
                    // Assert
                    const jsonCall = mockResponse.json.mock.calls[0][0];
                    expect(jsonCall.error.message).not.toContain('C:\\Users');
                });
            });
        });
        describe('non-Error exceptions', () => {
            it('should handle string throws', () => {
                // Arrange
                const exception = 'Something went wrong';
                const host = (0, test_utils_1.createMockArgumentsHost)(mockRequest, mockResponse);
                // Act
                filter.catch(exception, host);
                // Assert
                expect(mockResponse.status).toHaveBeenCalledWith(500);
                expect(mockResponse.json).toHaveBeenCalled();
            });
            it('should handle object throws', () => {
                // Arrange
                const exception = { error: 'Custom error object' };
                const host = (0, test_utils_1.createMockArgumentsHost)(mockRequest, mockResponse);
                // Act
                filter.catch(exception, host);
                // Assert
                expect(mockResponse.status).toHaveBeenCalledWith(500);
            });
            it('should handle null/undefined throws', () => {
                // Arrange
                const host = (0, test_utils_1.createMockArgumentsHost)(mockRequest, mockResponse);
                // Act
                filter.catch(null, host);
                // Assert
                expect(mockResponse.status).toHaveBeenCalledWith(500);
            });
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmsvc25pcHBldGZvcmdlL3NuaXBwZXRmb3JnZS9hcHBzL2FwaS90ZXN0L3VuaXQvZmlsdGVycy9hbGwtZXhjZXB0aW9ucy5maWx0ZXIuc3BlYy50cyIsIm1hcHBpbmdzIjoiO0FBQUEsK0RBQStEO0FBQy9ELDREQUE0RDtBQUM1RCxtREFBbUQ7O0FBRW5ELDJDQUEyRDtBQUMzRCw2REFBMkQ7QUFDM0QsNkZBQXdGO0FBQ3hGLHVEQUlnQztBQUVoQzs7Ozs7OztHQU9HO0FBQ0gsUUFBUSxDQUFDLHFCQUFxQixFQUFFLEdBQUcsRUFBRTtJQUNuQyxJQUFJLE1BQTJCLENBQUM7SUFDaEMsSUFBSSxZQUFtRCxDQUFDO0lBQ3hELElBQUksV0FBaUQsQ0FBQztJQUN0RCxNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQztJQUV6QyxVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2QsTUFBTSxHQUFHLElBQUksMkNBQW1CLEVBQUUsQ0FBQztRQUNuQyxZQUFZLEdBQUcsSUFBQSwrQkFBa0IsR0FBRSxDQUFDO1FBQ3BDLFdBQVcsR0FBRyxJQUFBLDhCQUFpQixHQUFFLENBQUM7SUFDcEMsQ0FBQyxDQUFDLENBQUM7SUFFSCxTQUFTLENBQUMsR0FBRyxFQUFFO1FBQ2IsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQ3JCLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxHQUFHLFdBQVcsQ0FBQztJQUNyQyxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFO1FBQ3JCLFFBQVEsQ0FBQyxpQkFBaUIsRUFBRSxHQUFHLEVBQUU7WUFDL0IsRUFBRSxDQUFDLHNDQUFzQyxFQUFFLEdBQUcsRUFBRTtnQkFDOUMsVUFBVTtnQkFDVixNQUFNLFNBQVMsR0FBRyxJQUFJLEtBQUssQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO2dCQUNwRCxNQUFNLElBQUksR0FBRyxJQUFBLG9DQUF1QixFQUFDLFdBQVcsRUFBRSxZQUFZLENB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LElBQUEsb0NBQXVCLEVBQUMsV0FBVyxFQUFFLFlBQVksQ0FBQyxDQUFDO2dCQUVoRSxNQUFNO2dCQUNOLE1BQU0sQ0FBQyxLQUFLLENBQUMsU0FBUyxFQUFFLElBQVcsQ0FBQyxDQUFDO2dCQUVyQyxTQUFTO2dCQUNULE1BQU0sQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUMsb0JBQW9CLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDeEQsQ0FBQyxDQUFDLENBQUM7WUFFSCxFQUFFLENBQUMscUNBQXFDLEVBQUUsR0FBRyxFQUFFO2dCQUM3QyxVQUFVO2dCQUNWLE1BQU0sSUFBSSxHQUFHLElBQUEsb0NBQXVCLEVBQUMsV0FBVyxFQUFFLFlBQVksQ0FBQyxDQUFDO2dCQUVoRSxNQUFNO2dCQUNOLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLElBQVcsQ0FBQyxDQUFDO2dCQUVoQyxTQUFTO2dCQUNULE1BQU0sQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUMsb0JBQW9CLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDeEQsQ0FBQyxDQUFDLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvcnVubmVyL3dvcmsvc25pcHBldGZvcmdlL3NuaXBwZXRmb3JnZS9hcHBzL2FwaS90ZXN0L3VuaXQvZmlsdGVycy9hbGwtZXhjZXB0aW9ucy5maWx0ZXIuc3BlYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdW5zYWZlLW1lbWJlci1hY2Nlc3MgKi9cbi8qIGVzbGludC1kaXNhYmxlIEB0eXBlc2NyaXB0LWVzbGludC9uby11bnNhZmUtYXNzaWdubWVudCAqL1xuLy8gdGVzdC91bml0L2ZpbHRlcnMvYWxsLWV4Y2VwdGlvbnMuIGZpbHRlci5zcGVjLnRzXG5cbmltcG9ydCB7IEh0dHBFeGNlcHRpb24sIEh0dHBTdGF0dXMgfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBFcnJvckNvZGVzIH0gZnJvbSAnLi4vLi4vLi4vc3JjL3NoYXJlZC9jb25zdGFudHMnO1xuaW1wb3J0IHsgQWxsRXhjZXB0aW9uc0ZpbHRlciB9IGZyb20gJy4uLy4uLy4uL3NyYy9zaGFyZWQvZmlsdGVycy9hbGwtZXhjZXB0aW9ucy5maWx0ZXInO1xuaW1wb3J0IHtcbiAgY3JlYXRlTW9ja0FyZ3VtZW50c0hvc3QsXG4gIGNyZWF0ZU1vY2tSZXF1ZXN0LFxuICBjcmVhdGVNb2NrUmVzcG9uc2UsXG59IGZyb20gJy4uLy4uL3NldHVwL3Rlc3QtdXRpbHMnO1xuXG4vKipcbiAqIEFsbEV4Y2VwdGlvbnNGaWx0ZXIgVW5pdCBUZXN0c1xuICpcbiAqIFRlc3RldDpcbiAqIC0gVW5iZWthbm50ZSBFcnJvcnMgd2VyZGVuIGdlZmFuZ2VuXG4gKiAtIFNlbnNpdGl2ZSBEYXRlbiB3ZXJkZW4gZ2VmaWx0ZXJ0XG4gKiAtIFJlc3BvbnNlIEZvcm1hdCBpc3Qga29ycmVrdFxuICovXG5kZXNjcmliZSgnQWxsRXhjZXB0aW9uc0ZpbHRlcicsICgpID0+IHtcbiAgbGV0IGZpbHRlcjogQWxsRXhjZXB0aW9uc0ZpbHRlcjtcbiAgbGV0IG1vY2tSZXNwb25zZTogUmV0dXJuVHlwZTx0eXBlb2YgY3JlYXRlTW9ja1Jlc3BvbnNlPjtcbiAgbGV0IG1vY2tSZXF1ZXN0OiBSZXR1cm5UeXBlPHR5cGVvZiBjcmVhdGVNb2NrUmVxdWVzdD47XG4gIGNvbnN0IG9yaWdpbmFsRW52ID0gcHJvY2Vzcy5lbnYuTk9ERV9FTlY7XG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgZmlsdGVyID0gbmV3IEFsbEV4Y2VwdGlvbnNGaWx0ZXIoKTtcbiAgICBtb2NrUmVzcG9uc2UgPSBjcmVhdGVNb2NrUmVzcG9uc2UoKTtcbiAgICBtb2NrUmVxdWVzdCA9IGNyZWF0ZU1vY2tSZXF1ZXN0KCk7XG4gIH0pO1xuXG4gIGFmdGVyRWFjaCgoKSA9PiB7XG4gICAgamVzdC5jbGVhckFsbE1vY2tzKCk7XG4gICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgPSBvcmlnaW5hbEVudjtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2NhdGNoJywgKCkgPT4ge1xuICAgIGRlc2NyaWJlKCdyZXNwb25zZSBmb3JtYXQnLCAoKSA9PiB7XG4gICAgICBpdCgnc2hvdWxkIHJldHVybiA1MDAgZm9yIHVua25vd24gZXJyb3JzJywgKCkgPT4ge1xuICAgICAgICAvLyBBcnJhbmdlXG4gICAgICAgIGNvbnN0IGV4Y2VwdGlvbiA9IG5ldyBFcnJvcignU29tZXRoaW5nIHdlbnQgd3JvbmcnKTtcbiAgICAgICAgY29uc3QgaG9zdCA9IGNyZWF0ZU1vY2tBcmd1bWVudHNIb3N0KG1vY2tSZXF1ZXN0LCBtb2NrUmVzcG9uc2UpO1xuXG4gICAgICAgIC8vIEFjdFxuICAgICAgICBmaWx0ZXIuY2F0Y2goZXhjZXB0aW9uLCBob3N0IGFzIGFueSk7XG5cbiAgICAgICAgLy8gQXNzZXJ0XG4gICAgICAgIGV4cGVjdChtb2NrUmVzcG9uc2Uuc3RhdHVzKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgICBIdHRwU3RhdHVzLklOVEVSTkFMX1NFUlZFUl9FUlJPUixcbiAgICAgICAgKTtcbiAgICAgIH0pO1xuXG4gICAgICBpdCgnc2hvdWxkIHJldHVybiBzdGFuZGFyZGl6ZWQgZXJyb3IgcmVzcG9uc2UnLCAoKSA9PiB7XG4gICAgICAgIC8vIEFycmFuZ2VcbiAgICAgICAgY29uc3QgZXhjZXB0aW9uID0gbmV3IEVycm9yKCdEYXRhYmFzZSBjb25uZWN0aW9uIGZhaWxlZCcpO1xuICAgICAgICBjb25zdCBob3N0ID0gY3JlYXRlTW9ja0FyZ3VtZW50c0hvc3QobW9ja1JlcXVlc3QsIG1vY2tSZXNwb25zZSk7XG5cbiAgICAgICAgLy8gQWN0XG4gICAgICAgIGZpbHRlci5jYXRjaChleGNlcHRpb24sIGhvc3QgYXMgYW55KTtcblxuICAgICAgICAvLyBBc3NlcnRcbiAgICAgICAgZXhwZWN0KG1vY2tSZXNwb25zZS5qc29uKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICAgIGVycm9yOiBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgICAgIGNvZGU6IGV4cGVjdC5hbnkoU3RyaW5nKSxcbiAgICAgICAgICAgICAgbWVzc2FnZTogZXhwZWN0LmFueShTdHJpbmcpLFxuICAgICAgICAgICAgICBzdGF0dXNDb2RlOiA1MDAsXG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIG1ldGE6IGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICAgICAgcGF0aDogbW9ja1JlcXVlc3QudXJsLFxuICAgICAgICAgICAgICBtZXRob2Q6IG1vY2tSZXF1ZXN0Lm1ldGhvZCxcbiAgICAgICAgICAgICAgdGltZXN0YW1wOiBleHBlY3QuYW55KFN0cmluZyksXG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICB9KSxcbiAgICAgICAgKTtcbiAgICAgIH0pO1xuXG4gICAgICBpdCgnc2hvdWxkIGhhbmRsZSBIdHRwRXhjZXB0aW9ucyB3aXRoIG1hdGNoaW5nIHN0YXR1cycsICgpID0+IHtcbiAgICAgICAgLy8gQXJyYW5nZVxuICAgICAgICBjb25zdCBleGNlcHRpb24gPSBuZXcgSHR0cEV4Y2VwdGlvbihcbiAgICAgICAgICAnSHR0cCBwYXRoJyxcbiAgICAgICAgICBIdHRwU3RhdHVzLkJBRF9SRVFVRVNULFxuICAgICAgICApO1xuICAgICAgICBjb25zdCBob3N0ID0gY3JlYXRlTW9ja0FyZ3VtZW50c0hvc3QobW9ja1JlcXVlc3QsIG1vY2tSZXNwb25zZSk7XG5cbiAgICAgICAgLy8gQWN0XG4gICAgICAgIGZpbHRlci5jYXRjaChleGNlcHRpb24sIGhvc3QgYXMgYW55KTtcblxuICAgICAgICAvLyBBc3NlcnRcbiAgICAgICAgZXhwZWN0KG1vY2tSZXNwb25zZS5zdGF0dXMpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICAgIEh0dHBTdGF0dXMuQkFEX1JFUVVFU1QsXG4gICAgICAgICk7XG4gICAgICAgIGV4cGVjdChtb2NrUmVzcG9uc2UuanNvbikudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgICAgZXJyb3I6IGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICAgICAgY29kZTogRXJyb3JDb2Rlcy5TRVJWRVJfRVJST1IsXG4gICAgICAgICAgICAgIG1lc3NhZ2U6ICdIdHRwIHBhdGgnLFxuICAgICAgICAgICAgICBzdGF0dXNDb2RlOiBIdHRwU3RhdHVzLkJBRF9SRVFVRVNULFxuICAgICAgICAgICAgfSksXG4gICAgICAgICAgfSksXG4gICAgICAgICk7XG4gICAgICB9KTtcblxuICAgICAgaXQoJ3Nob3VsZCBwcm9wYWdhdGUgY29ycmVsYXRpb24gaWRzIGludG8gdGhlIG1ldGEgYmxvY2snLCAoKSA9PiB7XG4gICAgICAgIC8vIEFycmFuZ2VcbiAgICAgICAgY29uc3QgcmVxdWVzdFdpdGhDb3JyZWxhdGlvbiA9IGNyZWF0ZU1vY2tSZXF1ZXN0KHtcbiAgICAgICAgICBoZWFkZXJzOiB7ICd4LWNvcnJlbGF0aW9uLWlkJzogJ2NvcnItMTIzJyB9LFxuICAgICAgICB9KTtcbiAgICAgICAgY29uc3QgZXhjZXB0aW9uID0gbmV3IEVycm9yKCdDb3JyZWxhdGlvbiB0ZXN0Jyk7XG4gICAgICAgIGNvbnN0IGhvc3QgPSBjcmVhdGVNb2NrQXJndW1lbnRzSG9zdChcbiAgICAgICAgICByZXF1ZXN0V2l0aENvcnJlbGF0aW9uLFxuICAgICAgICAgIG1vY2tSZXNwb25zZSxcbiAgICAgICAgKTtcblxuICAgICAgICAvLyBBY3RcbiAgICAgICAgZmlsdGVyLmNhdGNoKGV4Y2VwdGlvbiwgaG9zdCBhcyBhbnkpO1xuXG4gICAgICAgIC8vIEFzc2VydFxuICAgICAgICBjb25zdCBqc29uQ2FsbCA9IG1vY2tSZXNwb25zZS5qc29uLm1vY2suY2FsbHNbMF1bMF07XG4gICAgICAgIGV4cGVjdChqc29uQ2FsbC5tZXRhLnJlcXVlc3RJZCkudG9CZSgnY29yci0xMjMnKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgZGVzY3JpYmUoJ2Vycm9yIHR5cGUgaWRlbnRpZmljYXRpb24nLCAoKSA9PiB7XG4gICAgICBpdCgnc2hvdWxkIGlkZW50aWZ5IEpXVCBlcnJvcnMgYXMgQVVUSF9UT0tFTl9JTlZBTElEJywgKCkgPT4ge1xuICAgICAgICAvLyBBcnJhbmdlXG4gICAgICAgIGNvbnN0IGV4Y2VwdGlvbiA9IG5ldyBFcnJvcignaW52YWxpZCBzaWduYXR1cmUnKTtcbiAgICAgICAgZXhjZXB0aW9uLm5hbWUgPSAnSnNvbldlYlRva2VuRXJyb3InO1xuICAgICAgICBjb25zdCBob3N0ID0gY3JlYXRlTW9ja0FyZ3VtZW50c0hvc3QobW9ja1JlcXVlc3QsIG1vY2tSZXNwb25zZSk7XG5cbiAgICAgICAgLy8gQWN0XG4gICAgICAgIGZpbHRlci5jYXRjaChleGNlcHRpb24sIGhvc3QgYXMgYW55KTtcblxuICAgICAgICAvLyBBc3NlcnRcbiAgICAgICAgZXhwZWN0KG1vY2tSZXNwb25zZS5qc29uKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgICBlcnJvcjogZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgICAgICBjb2RlOiBFcnJvckNvZGVzLkFVVEhfVE9LRU5fSU5WQUxJRCxcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgIH0pLFxuICAgICAgICApO1xuICAgICAgfSk7XG5cbiAgICAgIGl0KCdzaG91bGQgaWRlbnRpZnkgZXhwaXJlZCBKV1QgYXMgQVVUSF9UT0tFTl9FWFBJUkVEJywgKCkgPT4ge1xuICAgICAgICAvLyBBcnJhbmdlXG4gICAgICAgIGNvbnN0IGV4Y2VwdGlvbiA9IG5ldyBFcnJvcignand0IGV4cGlyZWQnKTtcbiAgICAgICAgZXhjZXB0aW9uLm5hbWUgPSAnVG9rZW5FeHBpcmVkRXJyb3InO1xuICAgICAgICBjb25zdCBob3N0ID0gY3JlYXRlTW9ja0FyZ3VtZW50c0hvc3QobW9ja1JlcXVlc3QsIG1vY2tSZXNwb25zZSk7XG5cbiAgICAgICAgLy8gQWN0XG4gICAgICAgIGZpbHRlci5jYXRjaChleGNlcHRpb24sIGhvc3QgYXMgYW55KTtcblxuICAgICAgICAvLyBBc3NlcnRcbiAgICAgICAgZXhwZWN0KG1vY2tSZXNwb25zZS5qc29uKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgICBlcnJvcjogZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgICAgICBjb2RlOiBFcnJvckNvZGVzLkFVVEhfVE9LRU5fRVhQSVJFRCxcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgIH0pLFxuICAgICAgICApO1xuICAgICAgfSk7XG5cbiAgICAgIGl0KCdzaG91bGQgaWRlbnRpZnkgZGF0YWJhc2UgZXJyb3JzJywgKCkgPT4ge1xuICAgICAgICAvLyBBcnJhbmdlXG4gICAgICAgIGNvbnN0IGV4Y2VwdGlvbiA9IG5ldyBFcnJvcignRUNPTk5SRUZVU0VEIGRhdGFiYXNlIGNvbm5lY3Rpb24nKTtcbiAgICAgICAgY29uc3QgaG9zdCA9IGNyZWF0ZU1vY2tBcmd1bWVudHNIb3N0KG1vY2tSZXF1ZXN0LCBtb2NrUmVzcG9uc2UpO1xuXG4gICAgICAgIC8vIEFjdFxuICAgICAgICBmaWx0ZXIuY2F0Y2goZXhjZXB0aW9uLCBob3N0IGFzIGFueSk7XG5cbiAgICAgICAgLy8gQXNzZXJ0XG4gICAgICAgIGV4cGVjdChtb2NrUmVzcG9uc2UuanNvbikudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgICAgZXJyb3I6IGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICAgICAgY29kZTogRXJyb3JDb2Rlcy5TRVJWRVJfREFUQUJBU0VfRVJST1IsXG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICB9KSxcbiAgICAgICAgKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgZGVzY3JpYmUoJ21lc3NhZ2Ugc2FuaXRpemF0aW9uJywgKCkgPT4ge1xuICAgICAgZGVzY3JpYmUoJ2luIHByb2R1Y3Rpb24nLCAoKSA9PiB7XG4gICAgICAgIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgICAgICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WID0gJ3Byb2R1Y3Rpb24nO1xuICAgICAgICAgIC8vIEZpbHRlciBuZXUgZXJzdGVsbGVuIG1pdCBwcm9kdWN0aW9uIGVudlxuICAgICAgICAgIGZpbHRlciA9IG5ldyBBbGxFeGNlcHRpb25zRmlsdGVyKCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGl0KCdzaG91bGQgbm90IGV4cG9zZSBpbnRlcm5hbCBlcnJvciBtZXNzYWdlcycsICgpID0+IHtcbiAgICAgICAgICAvLyBBcnJhbmdlXG4gICAgICAgICAgY29uc3QgZXhjZXB0aW9uID0gbmV3IEVycm9yKCdEYXRhYmFzZSBwYXNzd29yZDogIHNlY3JldDEyMycpO1xuICAgICAgICAgIGNvbnN0IGhvc3QgPSBjcmVhdGVNb2NrQXJndW1lbnRzSG9zdChtb2NrUmVxdWVzdCwgbW9ja1Jlc3BvbnNlKTtcblxuICAgICAgICAgIC8vIEFjdFxuICAgICAgICAgIGZpbHRlci5jYXRjaChleGNlcHRpb24sIGhvc3QgYXMgYW55KTtcblxuICAgICAgICAgIC8vIEFzc2VydFxuICAgICAgICAgIGV4cGVjdChtb2NrUmVzcG9uc2UuanNvbikudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgICAgIGVycm9yOiBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgICAgICAgbWVzc2FnZTogZXhwZWN0Lm5vdC5zdHJpbmdDb250YWluaW5nKCdzZWNyZXQxMjMnKSxcbiAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICApO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgnc2hvdWxkIHJldHVybiBnZW5lcmljIG1lc3NhZ2UgaW4gcHJvZHVjdGlvbicsICgpID0+IHtcbiAgICAgICAgICAvLyBBcnJhbmdlXG4gICAgICAgICAgY29uc3QgZXhjZXB0aW9uID0gbmV3IEVycm9yKCdJbnRlcm5hbCBpbXBsZW1lbnRhdGlvbiBkZXRhaWxzJyk7XG4gICAgICAgICAgY29uc3QgaG9zdCA9IGNyZWF0ZU1vY2tBcmd1bWVudHNIb3N0KG1vY2tSZXF1ZXN0LCBtb2NrUmVzcG9uc2UpO1xuXG4gICAgICAgICAgLy8gQWN0XG4gICAgICAgICAgZmlsdGVyLmNhdGNoKGV4Y2VwdGlvbiwgaG9zdCBhcyBhbnkpO1xuXG4gICAgICAgICAgLy8gQXNzZXJ0XG4gICAgICAgICAgZXhwZWN0KG1vY2tSZXNwb25zZS5qc29uKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICAgICAgZXJyb3I6IGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICAgICAgICBtZXNzYWdlOlxuICAgICAgICAgICAgICAgICAgJ0FuIHVuZXhwZWN0ZWQgZXJyb3Igb2NjdXJyZWQuIFBsZWFzZSB0cnkgYWdhaW4gbGF0ZXIuJyxcbiAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICApO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuXG4gICAgICBkZXNjcmliZSgnaW4gZGV2ZWxvcG1lbnQnLCAoKSA9PiB7XG4gICAgICAgIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgICAgICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WID0gJ2RldmVsb3BtZW50JztcbiAgICAgICAgICBmaWx0ZXIgPSBuZXcgQWxsRXhjZXB0aW9uc0ZpbHRlcigpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgnc2hvdWxkIGluY2x1ZGUgc2FuaXRpemVkIGVycm9yIG1lc3NhZ2UnLCAoKSA9PiB7XG4gICAgICAgICAgLy8gQXJyYW5nZVxuICAgICAgICAgIGNvbnN0IGV4Y2VwdGlvbiA9IG5ldyBFcnJvcignU29tZXRoaW5nIHdlbnQgd3JvbmcnKTtcbiAgICAgICAgICBjb25zdCBob3N0ID0gY3JlYXRlTW9ja0FyZ3VtZW50c0hvc3QobW9ja1JlcXVlc3QsIG1vY2tSZXNwb25zZSk7XG5cbiAgICAgICAgICAvLyBBY3RcbiAgICAgICAgICBmaWx0ZXIuY2F0Y2goZXhjZXB0aW9uLCBob3N0IGFzIGFueSk7XG5cbiAgICAgICAgICAvLyBBc3NlcnRcbiAgICAgICAgICBleHBlY3QobW9ja1Jlc3BvbnNlLmpzb24pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgICAgICBlcnJvcjogZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGV4cGVjdC5hbnkoU3RyaW5nKSxcbiAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICApO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgnc2hvdWxkIHJlZGFjdCBmaWxlIHBhdGhzIGZyb20gZXJyb3IgbWVzc2FnZScsICgpID0+IHtcbiAgICAgICAgICAvLyBBcnJhbmdlXG4gICAgICAgICAgY29uc3QgZXhjZXB0aW9uID0gbmV3IEVycm9yKFxuICAgICAgICAgICAgJ0Vycm9yIGF0IEM6XFxcXFVzZXJzXFxcXGRldlxcXFxwcm9qZWN0XFxcXHNyY1xcXFxmaWxlLnRzOiAxMjMnLFxuICAgICAgICAgICk7XG4gICAgICAgICAgY29uc3QgaG9zdCA9IGNyZWF0ZU1vY2tBcmd1bWVudHNIb3N0KG1vY2tSZXF1ZXN0LCBtb2NrUmVzcG9uc2UpO1xuXG4gICAgICAgICAgLy8gQWN0XG4gICAgICAgICAgZmlsdGVyLmNhdGNoKGV4Y2VwdGlvbiwgaG9zdCBhcyBhbnkpO1xuXG4gICAgICAgICAgLy8gQXNzZXJ0XG4gICAgICAgICAgY29uc3QganNvbkNhbGwgPSBtb2NrUmVzcG9uc2UuanNvbi5tb2NrLmNhbGxzWzBdWzBdO1xuICAgICAgICAgIGV4cGVjdChqc29uQ2FsbC5lcnJvci5tZXNzYWdlKS5ub3QudG9Db250YWluKCdDOlxcXFxVc2VycycpO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgZGVzY3JpYmUoJ25vbi1FcnJvciBleGNlcHRpb25zJywgKCkgPT4ge1xuICAgICAgaXQoJ3Nob3VsZCBoYW5kbGUgc3RyaW5nIHRocm93cycsICgpID0+IHtcbiAgICAgICAgLy8gQXJyYW5nZVxuICAgICAgICBjb25zdCBleGNlcHRpb24gPSAnU29tZXRoaW5nIHdlbnQgd3JvbmcnO1xuICAgICAgICBjb25zdCBob3N0ID0gY3JlYXRlTW9ja0FyZ3VtZW50c0hvc3QobW9ja1JlcXVlc3QsIG1vY2tSZXNwb25zZSk7XG5cbiAgICAgICAgLy8gQWN0XG4gICAgICAgIGZpbHRlci5jYXRjaChleGNlcHRpb24sIGhvc3QgYXMgYW55KTtcblxuICAgICAgICAvLyBBc3NlcnRcbiAgICAgICAgZXhwZWN0KG1vY2tSZXNwb25zZS5zdGF0dXMpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKDUwMCk7XG4gICAgICAgIGV4cGVjdChtb2NrUmVzcG9uc2UuanNvbikudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgICAgfSk7XG5cbiAgICAgIGl0KCdzaG91bGQgaGFuZGxlIG9iamVjdCB0aHJvd3MnLCAoKSA9PiB7XG4gICAgICAgIC8vIEFycmFuZ2VcbiAgICAgICAgY29uc3QgZXhjZXB0aW9uID0geyBlcnJvcjogJ0N1c3RvbSBlcnJvciBvYmplY3QnIH07XG4gICAgICAgIGNvbnN0IGhvc3QgPSBjcmVhdGVNb2NrQXJndW1lbnRzSG9zdChtb2NrUmVxdWVzdCwgbW9ja1Jlc3BvbnNlKTtcblxuICAgICAgICAvLyBBY3RcbiAgICAgICAgZmlsdGVyLmNhdGNoKGV4Y2VwdGlvbiwgaG9zdCBhcyBhbnkpO1xuXG4gICAgICAgIC8vIEFzc2VydFxuICAgICAgICBleHBlY3QobW9ja1Jlc3BvbnNlLnN0YXR1cykudG9IYXZlQmVlbkNhbGxlZFdpdGgoNTAwKTtcbiAgICAgIH0pO1xuXG4gICAgICBpdCgnc2hvdWxkIGhhbmRsZSBudWxsL3VuZGVmaW5lZCB0aHJvd3MnLCAoKSA9PiB7XG4gICAgICAgIC8vIEFycmFuZ2VcbiAgICAgICAgY29uc3QgaG9zdCA9IGNyZWF0ZU1vY2tBcmd1bWVudHNIb3N0KG1vY2tSZXF1ZXN0LCBtb2NrUmVzcG9uc2UpO1xuXG4gICAgICAgIC8vIEFjdFxuICAgICAgICBmaWx0ZXIuY2F0Y2gobnVsbCwgaG9zdCBhcyBhbnkpO1xuXG4gICAgICAgIC8vIEFzc2VydFxuICAgICAgICBleHBlY3QobW9ja1Jlc3BvbnNlLnN0YXR1cykudG9IYXZlQmVlbkNhbGxlZFdpdGgoNTAwKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9