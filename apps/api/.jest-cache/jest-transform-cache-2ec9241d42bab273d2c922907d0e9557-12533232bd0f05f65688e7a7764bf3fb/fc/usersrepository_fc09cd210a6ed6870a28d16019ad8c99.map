{"file":"/home/runner/work/snippetforge/snippetforge/apps/api/src/modules/users/users.repository.ts","mappings":"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","names":[],"sources":["/home/runner/work/snippetforge/snippetforge/apps/api/src/modules/users/users.repository.ts"],"sourcesContent":["// src/modules/users/users.repository.ts\n\nimport { Injectable, Logger } from '@nestjs/common';\nimport { eq, or } from 'drizzle-orm';\nimport { users, type NewUser, type User } from '../../lib/db/schema';\nimport { DatabaseService } from '../../shared/database';\n\n/**\n * UsersRepository - Data Access Layer für User-Entity\n *\n * VERANTWORTLICHKEITEN (Single Responsibility):\n * - Alle Datenbank-Queries für Users\n * - Keine Business Logic (kein Hashing, keine Validation)\n * - Keine HTTP-Concerns (keine Exceptions werfen)\n *\n * WARUM Repository Pattern?\n * 1. Testbarkeit: Repository kann gemockt werden\n * 2. Austauschbarkeit: DB-Wechsel betrifft nur Repository\n * 3. Klarheit: Service enthält nur Business Logic\n *\n * RETURN VALUES:\n * - Gefunden: User-Objekt\n * - Nicht gefunden: null (NICHT undefined!)\n * - Fehler: Exception wird geworfen (DB-Errors)\n */\n@Injectable()\nexport class UsersRepository {\n  private readonly logger = new Logger(UsersRepository.name);\n\n  constructor(private readonly db: DatabaseService) {}\n\n  /**\n   * Findet User anhand der ID\n   *\n   * @param id - UUID des Users\n   * @returns User oder null wenn nicht gefunden\n   */\n  async findById(id: string): Promise<User | null> {\n    this.logger.debug(`Finding user by ID: ${id}`);\n\n    const result = await this.db.drizzle.query.users.findFirst({\n      where: eq(users.id, id),\n    });\n\n    return result ?? null;\n  }\n\n  /**\n   * Findet User anhand der Email\n   * Verwendet für Login und Email-Uniqueness-Check\n   *\n   * @param email - Email-Adresse (case-insensitive durch DB)\n   * @returns User oder null wenn nicht gefunden\n   */\n  async findByEmail(email: string): Promise<User | null> {\n    this.logger.debug(`Finding user by email: ${email}`);\n\n    const result = await this.db.drizzle.query.users.findFirst({\n      where: eq(users.email, email.toLowerCase()),\n    });\n\n    return result ?? null;\n  }\n\n  /**\n   * Findet User anhand des Usernamens\n   * Verwendet für Username-Uniqueness-Check\n   *\n   * @param username - Username (case-sensitive)\n   * @returns User oder null wenn nicht gefunden\n   */\n  async findByUsername(username: string): Promise<User | null> {\n    this.logger.debug(`Finding user by username: ${username}`);\n\n    const result = await this.db.drizzle.query.users.findFirst({\n      where: eq(users.username, username),\n    });\n\n    return result ?? null;\n  }\n\n  /**\n   * Prüft ob Email ODER Username bereits existieren\n   * Verwendet bei Registration um Duplikate zu verhindern\n   *\n   * @param email - Email zu prüfen\n   * @param username - Username zu prüfen\n   * @returns User wenn einer existiert, sonst null\n   */\n  async findByEmailOrUsername(\n    email: string,\n    username: string,\n  ): Promise<User | null> {\n    this.logger.debug(\n      `Checking if email or username exists: ${email}, ${username}`,\n    );\n\n    const result = await this.db.drizzle.query.users.findFirst({\n      where: or(\n        eq(users.email, email.toLowerCase()),\n        eq(users.username, username),\n      ),\n    });\n\n    return result ?? null;\n  }\n\n  /**\n   * Erstellt neuen User in der Datenbank\n   *\n   * WICHTIG:\n   * - data.passwordHash muss BEREITS gehasht sein!\n   * - Email wird automatisch lowercase gespeichert\n   *\n   * @param data - User-Daten (mit passwordHash, NICHT password!)\n   * @returns Erstellter User\n   * @throws Bei Constraint-Violation (Duplicate Email/Username)\n   */\n  async create(data: NewUser): Promise<User> {\n    this.logger.debug(`Creating new user: ${data.email}`);\n\n    const [newUser] = await this.db.drizzle\n      .insert(users)\n      .values({\n        ...data,\n        email: data.email.toLowerCase(), // Normalisierung\n      })\n      .returning();\n\n    this.logger.log(`User created successfully: ${newUser.id}`);\n    return newUser;\n  }\n\n  /**\n   * Aktualisiert User-Daten\n   *\n   * @param id - UUID des Users\n   * @param data - Zu aktualisierende Felder\n   * @returns Aktualisierter User oder null wenn nicht gefunden\n   */\n  async update(id: string, data: Partial<NewUser>): Promise<User | null> {\n    this.logger.debug(`Updating user: ${id}`);\n\n    const [updatedUser] = await this.db.drizzle\n      .update(users)\n      .set({\n        ...data,\n        updatedAt: new Date(), // Timestamp aktualisieren\n      })\n      .where(eq(users.id, id))\n      .returning();\n\n    if (!updatedUser) {\n      this.logger.warn(`User not found for update: ${id}`);\n      return null;\n    }\n\n    this.logger.log(`User updated successfully: ${id}`);\n    return updatedUser;\n  }\n\n  /**\n   * Aktualisiert nur das Passwort eines Users\n   * Separatiert von update() für Klarheit und Audit-Logging\n   *\n   * @param id - UUID des Users\n   * @param passwordHash - Neuer Password Hash (BEREITS gehasht!)\n   * @returns true wenn erfolgreich, false wenn User nicht gefunden\n   */\n  async updatePassword(id: string, passwordHash: string): Promise<boolean> {\n    this.logger.debug(`Updating password for user: ${id}`);\n\n    const result = await this.db.drizzle\n      .update(users)\n      .set({\n        passwordHash,\n        updatedAt: new Date(),\n      })\n      .where(eq(users.id, id))\n      .returning({ id: users.id });\n\n    if (result.length === 0) {\n      this.logger.warn(`User not found for password update: ${id}`);\n      return false;\n    }\n\n    this.logger.log(`Password updated successfully for user: ${id}`);\n    return true;\n  }\n\n  /**\n   * Löscht User (Hard Delete)\n   *\n   * WARNUNG: In Production besser Soft Delete verwenden!\n   * (isDeleted Flag statt echtem Löschen)\n   *\n   * @param id - UUID des Users\n   * @returns true wenn gelöscht, false wenn nicht gefunden\n   */\n  async delete(id: string): Promise<boolean> {\n    this.logger.debug(`Deleting user: ${id}`);\n\n    const result = await this.db.drizzle\n      .delete(users)\n      .where(eq(users.id, id))\n      .returning({ id: users.id });\n\n    if (result.length === 0) {\n      this.logger.warn(`User not found for deletion: ${id}`);\n      return false;\n    }\n\n    this.logger.log(`User deleted successfully: ${id}`);\n    return true;\n  }\n\n  /**\n   * Zählt alle User (für Admin-Dashboard)\n   *\n   * @returns Anzahl der User\n   */\n  async count(): Promise<number> {\n    const result = await this.db.drizzle\n      .select({ count: users.id })\n      .from(users);\n\n    // Drizzle gibt Array zurück, wir brauchen Länge\n    return result.length;\n  }\n}\n"],"version":3}