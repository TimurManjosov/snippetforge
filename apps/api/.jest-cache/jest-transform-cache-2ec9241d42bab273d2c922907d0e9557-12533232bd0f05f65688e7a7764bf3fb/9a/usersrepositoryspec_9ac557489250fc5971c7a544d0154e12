604b203ad4f1e434e21ec91860a94578
"use strict";
/* eslint-disable @typescript-eslint/unbound-method */
/* eslint-disable @typescript-eslint/no-unsafe-assignment */
// test/unit/repositories/users.repository.spec.ts
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const users_repository_1 = require("../../../src/modules/users/users.repository");
const database_1 = require("../../../src/shared/database");
describe('UsersRepository', () => {
    let repository;
    let mockDbService;
    const mockUser = {
        id: 'test-id-123',
        email: 'test@example.com',
        username: 'testuser',
        passwordHash: 'hashed-password',
        role: 'USER',
        createdAt: new Date(),
        updatedAt: new Date(),
        bio: null,
        avatarUrl: null,
    };
    beforeEach(async () => {
        mockDbService = {
            drizzle: {
                query: {
                    users: {
                        findFirst: jest.fn(),
                    },
                },
                insert: jest.fn().mockReturnValue({
                    values: jest.fn().mockReturnValue({
                        returning: jest.fn(),
                    }),
                }),
                update: jest.fn().mockReturnValue({
                    set: jest.fn().mockReturnValue({
                        where: jest.fn().mockReturnValue({
                            returning: jest.fn(),
                        }),
                    }),
                }),
                delete: jest.fn().mockReturnValue({
                    where: jest.fn().mockReturnValue({
                        returning: jest.fn(),
                    }),
                }),
                select: jest.fn().mockReturnValue({
                    from: jest.fn(),
                }),
            },
        };
        const module = await testing_1.Test.createTestingModule({
            providers: [
                users_repository_1.UsersRepository,
                {
                    provide: database_1.DatabaseService,
                    useValue: mockDbService,
                },
            ],
        }).compile();
        repository = module.get(users_repository_1.UsersRepository);
    });
    describe('findById', () => {
        it('should find user by ID', async () => {
            mockDbService.drizzle.query.users.findFirst.mockResolvedValue(mockUser);
            const result = await repository.findById('test-id-123');
            expect(result).toEqual(mockUser);
        });
        it('should return null when user not found', async () => {
            mockDbService.drizzle.query.users.findFirst.mockResolvedValue(undefined);
            const result = await repository.findById('non-existent-id');
            expect(result).toBeNull();
        });
    });
    describe('findByEmail', () => {
        it('should find user by email', async () => {
            mockDbService.drizzle.query.users.findFirst.mockResolvedValue(mockUser);
            const result = await repository.findByEmail('test@example.com');
            expect(result).toEqual(mockUser);
        });
        it('should return null when email not found', async () => {
            mockDbService.drizzle.query.users.findFirst.mockResolvedValue(undefined);
            const result = await repository.findByEmail('nonexistent@example.com');
            expect(result).toBeNull();
        });
    });
    describe('findByUsername', () => {
        it('should find user by username', async () => {
            mockDbService.drizzle.query.users.findFirst.mockResolvedValue(mockUser);
            const result = await repository.findByUsername('testuser');
            expect(result).toEqual(mockUser);
        });
        it('should return null when username not found', async () => {
            mockDbService.drizzle.query.users.findFirst.mockResolvedValue(undefined);
            const result = await repository.findByUsername('nonexistent');
            expect(result).toBeNull();
        });
    });
    describe('findByEmailOrUsername', () => {
        it('should find user by email or username', async () => {
            mockDbService.drizzle.query.users.findFirst.mockResolvedValue(mockUser);
            const result = await repository.findByEmailOrUsername('test@example.com', 'testuser');
            expect(result).toEqual(mockUser);
        });
        it('should return null when neither exists', async () => {
            mockDbService.drizzle.query.users.findFirst.mockResolvedValue(undefined);
            const result = await repository.findByEmailOrUsername('new@example.com', 'newuser');
            expect(result).toBeNull();
        });
    });
    describe('create', () => {
        it('should create new user', async () => {
            const newUserData = {
                email: 'new@example.com',
                username: 'newuser',
                passwordHash: 'hashed',
                role: 'USER',
            };
            const insertMock = mockDbService.drizzle.insert;
            const valuesMock = jest.fn().mockReturnValue({
                returning: jest.fn().mockResolvedValue([mockUser]),
            });
            insertMock.mockReturnValue({
                values: valuesMock,
            });
            const result = await repository.create(newUserData);
            expect(result).toEqual(mockUser);
            expect(valuesMock).toHaveBeenCalledWith(expect.objectContaining({
                email: 'new@example.com',
            }));
        });
    });
    describe('update', () => {
        it('should update user successfully', async () => {
            const updateData = { username: 'updateduser' };
            const updateMock = mockDbService.drizzle.update;
            const setMock = jest.fn().mockReturnValue({
                where: jest.fn().mockReturnValue({
                    returning: jest
                        .fn()
                        .mockResolvedValue([{ ...mockUser, ...updateData }]),
                }),
            });
            updateMock.mockReturnValue({
                set: setMock,
            });
            const result = await repository.update('test-id-123', updateData);
            expect(result).toBeDefined();
            expect(result?.username).toBe('updateduser');
        });
        it('should return null when user not found', async () => {
            const updateMock = mockDbService.drizzle.update;
            const setMock = jest.fn().mockReturnValue({
                where: jest.fn().mockReturnValue({
                    returning: jest.fn().mockResolvedValue([]),
                }),
            });
            updateMock.mockReturnValue({
                set: setMock,
            });
            const result = await repository.update('non-existent-id', {
                username: 'test',
            });
            expect(result).toBeNull();
        });
    });
    describe('updatePassword', () => {
        it('should update password successfully', async () => {
            const updateMock = mockDbService.drizzle.update;
            const setMock = jest.fn().mockReturnValue({
                where: jest.fn().mockReturnValue({
                    returning: jest.fn().mockResolvedValue([{ id: 'test-id-123' }]),
                }),
            });
            updateMock.mockReturnValue({
                set: setMock,
            });
            const result = await repository.updatePassword('test-id-123', 'new-hash');
            expect(result).toBe(true);
        });
        it('should return false when user not found', async () => {
            const updateMock = mockDbService.drizzle.update;
            const setMock = jest.fn().mockReturnValue({
                where: jest.fn().mockReturnValue({
                    returning: jest.fn().mockResolvedValue([]),
                }),
            });
            updateMock.mockReturnValue({
                set: setMock,
            });
            const result = await repository.updatePassword('non-existent-id', 'new-hash');
            expect(result).toBe(false);
        });
    });
    describe('delete', () => {
        it('should delete user successfully', async () => {
            const deleteMock = mockDbService.drizzle.delete;
            deleteMock.mockReturnValue({
                where: jest.fn().mockReturnValue({
                    returning: jest.fn().mockResolvedValue([{ id: 'test-id-123' }]),
                }),
            });
            const result = await repository.delete('test-id-123');
            expect(result).toBe(true);
        });
        it('should return false when user not found', async () => {
            const deleteMock = mockDbService.drizzle.delete;
            deleteMock.mockReturnValue({
                where: jest.fn().mockReturnValue({
                    returning: jest.fn().mockResolvedValue([]),
                }),
            });
            const result = await repository.delete('non-existent-id');
            expect(result).toBe(false);
        });
    });
    describe('count', () => {
        it('should return count of users', async () => {
            const selectMock = mockDbService.drizzle.select;
            selectMock.mockReturnValue({
                from: jest
                    .fn()
                    .mockResolvedValue([
                    { count: 'user1' },
                    { count: 'user2' },
                    { count: 'user3' },
                ]),
            });
            const result = await repository.count();
            expect(result).toBe(3);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmsvc25pcHBldGZvcmdlL3NuaXBwZXRmb3JnZS9hcHBzL2FwaS90ZXN0L3VuaXQvcmVwb3NpdG9yaWVzL3VzZXJzLnJlcG9zaXRvcnkuc3BlYy50cyIsIm1hcHBpbmdzIjoiO0FBQUEsc0RBQXNEO0FBQ3RELDREQUE0RDtBQUM1RCxrREFBa0Q7O0FBRWxELDZDQUFzRDtBQUV0RCxrRkFBOEU7QUFDOUUsMkRBQStEO0FBRS9ELFFBQVEsQ0FBQyxpQkFBaUIsRUFBRSxHQUFHLEVBQUU7SUFDL0IsSUFBSSxVQUEyQixDQUFDO0lBQ2hDLElBQUksYUFBdUMsQ0FBQztJQUU1QyxNQUFNLFFBQVEsR0FBUztRQUNyQixFQUFFLEVBQUUsYUFBYTtRQUNqQixLQUFLLEVBQUUsa0JBQWtCO1FBQ3pCLFFBQVEsRUFBRSxVQUFVO1FBQ3BCLFlBQVksRUFBRSxpQkFBaUI7UUFDL0IsSUFBSSxFQUFFLE1BQU07UUFDWixTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUU7UUFDckIsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFO1FBQ3JCLEdBQUcsRUFBRSxJQUFJO1FBQ1QsU0FBUyxFQUFFLElBQUk7S0FDaEIsQ0FBQztJQUVGLFVBQVUsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNwQixhQUFhLEdBQUc7WUFDZCxPQUFPLEVBQUU7Z0JBQ1AsS0FBSyxFQUFFO29CQUNMLEtBQUssRUFBRTt3QkFDTCxTQUFTLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtxQkFDckI7aUJBQ0Y7Z0JBQ0QsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxlQUFlLENBQUM7b0JBQ2hDLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsZUFBZSxDQUFDO3dCQUNoQyxTQUFTLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtxQkFDckIsQ0FBQztpQkFDSCxDQUFDO2dCQUNGLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsZUFBZSxDQUFDO29CQUNoQyxHQUFHLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGVBQWUsQ0FBQzt3QkFDN0IsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxlQUFlLENBQUM7NEJBQy9CLFNBQVMsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO3lCQUNyQixDQUFDO3FCQUNILENBQUM7aUJBQ0gsQ0FBQztnQkFDRixNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGVBQWUsQ0FBQztvQkFDaEMsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxlQUFlLENBQUM7d0JBQy9CLFNBQVMsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO3FCQUNyQixDQUFDO2lCQUNILENBQUM7Z0JBQ0YsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxlQUFlLENBQUM7b0JBQ2hDLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO2lCQUNoQixDQUFDO2FBQ0k7U0FDVCxDQUFDO1FBRUYsTUFBTSxNQUFNLEdBQWtCLE1BQU0sY0FBSSxDQUFDLG1CQUFtQixDQUFDO1lBQzNELFNBQVMsRUFBRTtnQkFDVCxrQ0FBZTtnQkFDZjtvQkFDRSxPQUFPLEVBQUUsMEJBQWU7b0JBQ3hCLFFBQVEsRUFBRSxhQUFhO2lCQUN4QjthQUNGO1NBQ0YsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBRWIsVUFBVSxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQWtCLGtDQUFlLENBQUMsQ0FBQztJQUM1RCxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxVQUFVLEVBQUUsR0FBRyxFQUFFO1FBQ3hCLEVBQUUsQ0FBQyx3QkFBd0IsRUFBRSxLQUFLLElBQUksRUFBRTtZQUVwQyxhQUFhLENBQUMsT0FBUSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsU0FDcEMsQ0FBQyxpQkFBaUIsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUU5QixNQUFNLE1BQU0sR0FBRyxNQUFNLFVBQVUsQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLENBQUM7WUFFeEQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNuQyxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyx3Q0FBd0MsRUFBRSxLQUFLLElBQUksRUFBRTtZQUVwRCxhQUFhLENBQUMsT0FBUSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsU0FDcEMsQ0FBQyxpQkFBaUIsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUUvQixNQUFNLE1BQU0sR0FBRyxNQUFNLFVBQVUsQ0FBQyxRQUFRLENBQUMsaUJBQWlCLENBQUMsQ0FBQztZQUU1RCxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDNUIsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxhQUFhLEVBQUUsR0FBRyxFQUFFO1FBQzNCLEVBQUUsQ0FBQywyQkFBMkIsRUFBRSxLQUFLLElBQUksRUFBRTtZQUV2QyxhQUFhLENBQUMsT0FBUSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsU0FDcEMsQ0FBQyxpQkFBaUIsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUU5QixNQUFNLE1BQU0sR0FBRyxNQUFNLFVBQVUsQ0FBQyxXQUFXLENBQUMsa0JBQWtCLENBQUMsQ0FBQztZQUVoRSxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ25DLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLHlDQUF5QyxFQUFFLEtBQUssSUFBSSxFQUFFO1lBRXJELGFBQWEsQ0FBQyxPQUFRLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxTQUNwQyxDQUFDLGlCQUFpQixDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBRS9CLE1BQU0sTUFBTSxHQUFHLE1BQU0sVUFBVSxDQUFDLFdBQVcsQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDO1lBRXZFLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUM1QixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLGdCQUFnQixFQUFFLEdBQUcsRUFBRTtRQUM5QixFQUFFLENBQUMsOEJBQThCLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFFMUMsYUFBYSxDQUFDLE9BQVEsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLFNBQ3BDLENBQUMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLENBQUM7WUFFOUIsTUFBTSxNQUFNLEdBQUcsTUFBTSxVQUFVLENBQUMsY0FBYyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBRTNELE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDbkMsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsNENBQTRDLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFFeEQsYUFBYSxDQUFDLE9BQVEsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLFNBQ3BDLENBQUMsaUJBQWlCLENBQUMsU0FBUyxDQUFDLENBQUM7WUFFL0IsTUFBTSxNQUFNLEdBQUcsTUFBTSxVQUFVLENBQUMsY0FBYyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1lBRTlELE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUM1QixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLHVCQUF1QixFQUFFLEdBQUcsRUFBRTtRQUNyQyxFQUFFLENBQUMsdUNBQXVDLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFFbkQsYUFBYSxDQUFDLE9BQVEsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLFNBQ3BDLENBQUMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLENBQUM7WUFFOUIsTUFBTSxNQUFNLEdBQUcsTUFBTSxVQUFVLENBQUMscUJBQXFCLENBQ25ELGtCQUFrQixFQUNsQixVQUFVLENBQ1gsQ0FBQztZQUVGLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDbkMsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsd0NBQXdDLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFFcEQsYUFBYSxDQUFDLE9BQVEsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLFNBQ3BDLENBQUMsaUJBQWlCLENBQUMsU0FBUyxDQUFDLENBQUM7WUFFL0IsTUFBTSxNQUFNLEdBQUcsTUFBTSxVQUFVLENBQUMscUJBQXFCLENBQ25ELGlCQUFpQixFQUNqQixTQUFTLENBQ1YsQ0FBQztZQUVGLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUM1QixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLFFBQVEsRUFBRSxHQUFHLEVBQUU7UUFDdEIsRUFBRSxDQUFDLHdCQUF3QixFQUFFLEtBQUssSUFBSSxFQUFFO1lBQ3RDLE1BQU0sV0FBVyxHQUFZO2dCQUMzQixLQUFLLEVBQUUsaUJBQWlCO2dCQUN4QixRQUFRLEVBQUUsU0FBUztnQkFDbkIsWUFBWSxFQUFFLFFBQVE7Z0JBQ3RCLElBQUksRUFBRSxNQUFNO2FBQ2IsQ0FBQztZQUVGLE1BQU0sVUFBVSxHQUFHLGFBQWEsQ0FBQyxPQUFRLENBQUMsTUFBbUIsQ0FBQztZQUM5RCxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsZUFBZSxDQUFDO2dCQUMzQyxTQUFTLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGlCQUFpQixDQUFDLENBQUMsUUFBUSxDQUFDLENBQUM7YUFDbkQsQ0FBQyxDQUFDO1lBQ0gsVUFBVSxDQUFDLGVBQWUsQ0FBQztnQkFDekIsTUFBTSxFQUFFLFVBQVU7YUFDbkIsQ0FBQyxDQUFDO1lBRUgsTUFBTSxNQUFNLEdBQUcsTUFBTSxVQUFVLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBRXBELE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDakMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLG9CQUFvQixDQUNyQyxNQUFNLENBQUMsZ0JBQWdCLENBQUM7Z0JBQ3RCLEtBQUssRUFBRSxpQkFBaUI7YUFDekIsQ0FBQyxDQUNILENBQUM7UUFDSixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLFFBQVEsRUFBRSxHQUFHLEVBQUU7UUFDdEIsRUFBRSxDQUFDLGlDQUFpQyxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQy9DLE1BQU0sVUFBVSxHQUFHLEVBQUUsUUFBUSxFQUFFLGFBQWEsRUFBRSxDQUFDO1lBRS9DLE1BQU0sVUFBVSxHQUFHLGFBQWEsQ0FBQyxPQUFRLENBQUMsTUFBbUIsQ0FBQztZQUM5RCxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsZUFBZSxDQUFDO2dCQUN4QyxLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGVBQWUsQ0FBQztvQkFDL0IsU0FBUyxFQUFFLElBQUk7eUJBQ1osRUFBRSxFQUFFO3lCQUNKLGlCQUFpQixDQUFDLENBQUMsRUFBRSxHQUFHLFFBQVEsRUFBRSxHQUFHLFVBQVUsRUFBRSxDQUFDLENBQUM7aUJBQ3ZELENBQUM7YUFDSCxDQUFDLENBQUM7WUFDSCxVQUFVLENBQUMsZUFBZSxDQUFDO2dCQUN6QixHQUFHLEVBQUUsT0FBTzthQUNiLENBQUMsQ0FBQztZQUVILE1BQU0sTUFBTSxHQUFHLE1BQU0sVUFBVSxDQUFDLE1BQU0sQ0FBQyxhQUFhLEVBQUUsVUFBVSxDQUFDLENBQUM7WUFFbEUsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQzdCLE1BQU0sQ0FBQyxNQUFNLEVBQUUsUUFBUSxDQUFDLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQy9DLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLHdDQUF3QyxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQ3RELE1BQU0sVUFBVSxHQUFHLGFBQWEsQ0FBQyxPQUFRLENBQUMsTUFBbUIsQ0FBQztZQUM5RCxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsZUFBZSxDQUFDO2dCQUN4QyxLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGVBQWUsQ0FBQztvQkFDL0IsU0FBUyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLENBQUM7aUJBQzNDLENBQUM7YUFDSCxDQUFDLENBQUM7WUFDSCxVQUFVLENBQUMsZUFBZSxDQUFDO2dCQUN6QixHQUFHLEVBQUUsT0FBTzthQUNiLENBQUMsQ0FBQztZQUVILE1BQU0sTUFBTSxHQUFHLE1BQU0sVUFBVSxDQUFDLE1BQU0sQ0FBQyxpQkFBaUIsRUFBRTtnQkFDeEQsUUFBUSxFQUFFLE1BQU07YUFDakIsQ0FBQyxDQUFDO1lBRUgsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQzVCLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsZ0JBQWdCLEVBQUUsR0FBRyxFQUFFO1FBQzlCLEVBQUUsQ0FBQyxxQ0FBcUMsRUFBRSxLQUFLLElBQUksRUFBRTtZQUNuRCxNQUFNLFVBQVUsR0FBRyxhQUFhLENBQUMsT0FBUSxDQUFDLE1BQW1CLENBQUM7WUFDOUQsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGVBQWUsQ0FBQztnQkFDeEMsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxlQUFlLENBQUM7b0JBQy9CLFNBQVMsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxhQUFhLEVBQUUsQ0FBQyxDQUFDO2lCQUNoRSxDQUFDO2FBQ0gsQ0FBQyxDQUFDO1lBQ0gsVUFBVSxDQUFDLGVBQWUsQ0FBQztnQkFDekIsR0FBRyxFQUFFLE9BQU87YUFDYixDQUFDLENBQUM7WUFFSCxNQUFNLE1BQU0sR0FBRyxNQUFNLFVBQVUsQ0FBQyxjQUFjLENBQUMsYUFBYSxFQUFFLFVBQVUsQ0FBQyxDQUFDO1lBRTFFLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDNUIsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMseUNBQXlDLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDdkQsTUFBTSxVQUFVLEdBQUcsYUFBYSxDQUFDLE9BQVEsQ0FBQyxNQUFtQixDQUFDO1lBQzlELE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxlQUFlLENBQUM7Z0JBQ3hDLEtBQUssRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsZUFBZSxDQUFDO29CQUMvQixTQUFTLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGlCQUFpQixDQUFDLEVBQUUsQ0FBQztpQkFDM0MsQ0FBQzthQUNILENBQUMsQ0FBQztZQUNILFVBQVUsQ0FBQyxlQUFlLENBQUM7Z0JBQ3pCLEdBQUcsRUFBRSxPQUFPO2FBQ2IsQ0FBQyxDQUFDO1lBRUgsTUFBTSxNQUFNLEdBQUcsTUFBTSxVQUFVLENBQUMsY0FBYyxDQUM1QyxpQkFBaUIsRUFDakIsVUFBVSxDQUNYLENBQUM7WUFFRixNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzdCLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsUUFBUSxFQUFFLEdBQUcsRUFBRTtRQUN0QixFQUFFLENBQUMsaUNBQWlDLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDL0MsTUFBTSxVQUFVLEdBQUcsYUFBYSxDQUFDLE9BQVEsQ0FBQyxNQUFtQixDQUFDO1lBQzlELFVBQVUsQ0FBQyxlQUFlLENBQUM7Z0JBQ3pCLEtBQUssRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsZUFBZSxDQUFDO29CQUMvQixTQUFTLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGlCQUFpQixDQUFDLENBQUMsRUFBRSxFQUFFLEVBQUUsYUFBYSxFQUFFLENBQUMsQ0FBQztpQkFDaEUsQ0FBQzthQUNILENBQUMsQ0FBQztZQUVILE1BQU0sTUFBTSxHQUFHLE1BQU0sVUFBVSxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQztZQUV0RCxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzVCLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLHlDQUF5QyxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQ3ZELE1BQU0sVUFBVSxHQUFHLGFBQWEsQ0FBQyxPQUFRLENBQUMsTUFBbUIsQ0FBQztZQUM5RCxVQUFVLENBQUMsZUFBZSxDQUFDO2dCQUN6QixLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGVBQWUsQ0FBQztvQkFDL0IsU0FBUyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLENBQUM7aUJBQzNDLENBQUM7YUFDSCxDQUFDLENBQUM7WUFFSCxNQUFNLE1BQU0sR0FBRyxNQUFNLFVBQVUsQ0FBQyxNQUFNLENBQUMsaUJBQWlCLENBQUMsQ0FBQztZQUUxRCxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzdCLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsT0FBTyxFQUFFLEdBQUcsRUFBRTtRQUNyQixFQUFFLENBQUMsOEJBQThCLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDNUMsTUFBTSxVQUFVLEdBQUcsYUFBYSxDQUFDLE9BQVEsQ0FBQyxNQUFtQixDQUFDO1lBQzlELFVBQVUsQ0FBQyxlQUFlLENBQUM7Z0JBQ3pCLElBQUksRUFBRSxJQUFJO3FCQUNQLEVBQUUsRUFBRTtxQkFDSixpQkFBaUIsQ0FBQztvQkFDakIsRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFO29CQUNsQixFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUU7b0JBQ2xCLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRTtpQkFDbkIsQ0FBQzthQUNMLENBQUMsQ0FBQztZQUVILE1BQU0sTUFBTSxHQUFHLE1BQU0sVUFBVSxDQUFDLEtBQUssRUFBRSxDQUFDO1lBRXhDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDekIsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3J1bm5lci93b3JrL3NuaXBwZXRmb3JnZS9zbmlwcGV0Zm9yZ2UvYXBwcy9hcGkvdGVzdC91bml0L3JlcG9zaXRvcmllcy91c2Vycy5yZXBvc2l0b3J5LnNwZWMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgQHR5cGVzY3JpcHQtZXNsaW50L3VuYm91bmQtbWV0aG9kICovXG4vKiBlc2xpbnQtZGlzYWJsZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdW5zYWZlLWFzc2lnbm1lbnQgKi9cbi8vIHRlc3QvdW5pdC9yZXBvc2l0b3JpZXMvdXNlcnMucmVwb3NpdG9yeS5zcGVjLnRzXG5cbmltcG9ydCB7IFRlc3QsIFRlc3RpbmdNb2R1bGUgfSBmcm9tICdAbmVzdGpzL3Rlc3RpbmcnO1xuaW1wb3J0IHR5cGUgeyBOZXdVc2VyLCBVc2VyIH0gZnJvbSAnLi4vLi4vLi4vc3JjL2xpYi9kYi9zY2hlbWEnO1xuaW1wb3J0IHsgVXNlcnNSZXBvc2l0b3J5IH0gZnJvbSAnLi4vLi4vLi4vc3JjL21vZHVsZXMvdXNlcnMvdXNlcnMucmVwb3NpdG9yeSc7XG5pbXBvcnQgeyBEYXRhYmFzZVNlcnZpY2UgfSBmcm9tICcuLi8uLi8uLi9zcmMvc2hhcmVkL2RhdGFiYXNlJztcblxuZGVzY3JpYmUoJ1VzZXJzUmVwb3NpdG9yeScsICgpID0+IHtcbiAgbGV0IHJlcG9zaXRvcnk6IFVzZXJzUmVwb3NpdG9yeTtcbiAgbGV0IG1vY2tEYlNlcnZpY2U6IFBhcnRpYWw8RGF0YWJhc2VTZXJ2aWNlPjtcblxuICBjb25zdCBtb2NrVXNlcjogVXNlciA9IHtcbiAgICBpZDogJ3Rlc3QtaWQtMTIzJyxcbiAgICBlbWFpbDogJ3Rlc3RAZXhhbXBsZS5jb20nLFxuICAgIHVzZXJuYW1lOiAndGVzdHVzZXInLFxuICAgIHBhc3N3b3JkSGFzaDogJ2hhc2hlZC1wYXNzd29yZCcsXG4gICAgcm9sZTogJ1VTRVInLFxuICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoKSxcbiAgICB1cGRhdGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgYmlvOiBudWxsLFxuICAgIGF2YXRhclVybDogbnVsbCxcbiAgfTtcblxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICBtb2NrRGJTZXJ2aWNlID0ge1xuICAgICAgZHJpenpsZToge1xuICAgICAgICBxdWVyeToge1xuICAgICAgICAgIHVzZXJzOiB7XG4gICAgICAgICAgICBmaW5kRmlyc3Q6IGplc3QuZm4oKSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBpbnNlcnQ6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoe1xuICAgICAgICAgIHZhbHVlczogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7XG4gICAgICAgICAgICByZXR1cm5pbmc6IGplc3QuZm4oKSxcbiAgICAgICAgICB9KSxcbiAgICAgICAgfSksXG4gICAgICAgIHVwZGF0ZTogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7XG4gICAgICAgICAgc2V0OiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHtcbiAgICAgICAgICAgIHdoZXJlOiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHtcbiAgICAgICAgICAgICAgcmV0dXJuaW5nOiBqZXN0LmZuKCksXG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICB9KSxcbiAgICAgICAgfSksXG4gICAgICAgIGRlbGV0ZTogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7XG4gICAgICAgICAgd2hlcmU6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoe1xuICAgICAgICAgICAgcmV0dXJuaW5nOiBqZXN0LmZuKCksXG4gICAgICAgICAgfSksXG4gICAgICAgIH0pLFxuICAgICAgICBzZWxlY3Q6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoe1xuICAgICAgICAgIGZyb206IGplc3QuZm4oKSxcbiAgICAgICAgfSksXG4gICAgICB9IGFzIGFueSxcbiAgICB9O1xuXG4gICAgY29uc3QgbW9kdWxlOiBUZXN0aW5nTW9kdWxlID0gYXdhaXQgVGVzdC5jcmVhdGVUZXN0aW5nTW9kdWxlKHtcbiAgICAgIHByb3ZpZGVyczogW1xuICAgICAgICBVc2Vyc1JlcG9zaXRvcnksXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiBEYXRhYmFzZVNlcnZpY2UsXG4gICAgICAgICAgdXNlVmFsdWU6IG1vY2tEYlNlcnZpY2UsXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgIH0pLmNvbXBpbGUoKTtcblxuICAgIHJlcG9zaXRvcnkgPSBtb2R1bGUuZ2V0PFVzZXJzUmVwb3NpdG9yeT4oVXNlcnNSZXBvc2l0b3J5KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2ZpbmRCeUlkJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgZmluZCB1c2VyIGJ5IElEJywgYXN5bmMgKCkgPT4ge1xuICAgICAgKFxuICAgICAgICBtb2NrRGJTZXJ2aWNlLmRyaXp6bGUhLnF1ZXJ5LnVzZXJzLmZpbmRGaXJzdCBhcyBqZXN0Lk1vY2tcbiAgICAgICkubW9ja1Jlc29sdmVkVmFsdWUobW9ja1VzZXIpO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCByZXBvc2l0b3J5LmZpbmRCeUlkKCd0ZXN0LWlkLTEyMycpO1xuXG4gICAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKG1vY2tVc2VyKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIG51bGwgd2hlbiB1c2VyIG5vdCBmb3VuZCcsIGFzeW5jICgpID0+IHtcbiAgICAgIChcbiAgICAgICAgbW9ja0RiU2VydmljZS5kcml6emxlIS5xdWVyeS51c2Vycy5maW5kRmlyc3QgYXMgamVzdC5Nb2NrXG4gICAgICApLm1vY2tSZXNvbHZlZFZhbHVlKHVuZGVmaW5lZCk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJlcG9zaXRvcnkuZmluZEJ5SWQoJ25vbi1leGlzdGVudC1pZCcpO1xuXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlTnVsbCgpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnZmluZEJ5RW1haWwnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBmaW5kIHVzZXIgYnkgZW1haWwnLCBhc3luYyAoKSA9PiB7XG4gICAgICAoXG4gICAgICAgIG1vY2tEYlNlcnZpY2UuZHJpenpsZSEucXVlcnkudXNlcnMuZmluZEZpcnN0IGFzIGplc3QuTW9ja1xuICAgICAgKS5tb2NrUmVzb2x2ZWRWYWx1ZShtb2NrVXNlcik7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJlcG9zaXRvcnkuZmluZEJ5RW1haWwoJ3Rlc3RAZXhhbXBsZS5jb20nKTtcblxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbChtb2NrVXNlcik7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJldHVybiBudWxsIHdoZW4gZW1haWwgbm90IGZvdW5kJywgYXN5bmMgKCkgPT4ge1xuICAgICAgKFxuICAgICAgICBtb2NrRGJTZXJ2aWNlLmRyaXp6bGUhLnF1ZXJ5LnVzZXJzLmZpbmRGaXJzdCBhcyBqZXN0Lk1vY2tcbiAgICAgICkubW9ja1Jlc29sdmVkVmFsdWUodW5kZWZpbmVkKTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcmVwb3NpdG9yeS5maW5kQnlFbWFpbCgnbm9uZXhpc3RlbnRAZXhhbXBsZS5jb20nKTtcblxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZU51bGwoKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2ZpbmRCeVVzZXJuYW1lJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgZmluZCB1c2VyIGJ5IHVzZXJuYW1lJywgYXN5bmMgKCkgPT4ge1xuICAgICAgKFxuICAgICAgICBtb2NrRGJTZXJ2aWNlLmRyaXp6bGUhLnF1ZXJ5LnVzZXJzLmZpbmRGaXJzdCBhcyBqZXN0Lk1vY2tcbiAgICAgICkubW9ja1Jlc29sdmVkVmFsdWUobW9ja1VzZXIpO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCByZXBvc2l0b3J5LmZpbmRCeVVzZXJuYW1lKCd0ZXN0dXNlcicpO1xuXG4gICAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKG1vY2tVc2VyKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIG51bGwgd2hlbiB1c2VybmFtZSBub3QgZm91bmQnLCBhc3luYyAoKSA9PiB7XG4gICAgICAoXG4gICAgICAgIG1vY2tEYlNlcnZpY2UuZHJpenpsZSEucXVlcnkudXNlcnMuZmluZEZpcnN0IGFzIGplc3QuTW9ja1xuICAgICAgKS5tb2NrUmVzb2x2ZWRWYWx1ZSh1bmRlZmluZWQpO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCByZXBvc2l0b3J5LmZpbmRCeVVzZXJuYW1lKCdub25leGlzdGVudCcpO1xuXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlTnVsbCgpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnZmluZEJ5RW1haWxPclVzZXJuYW1lJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgZmluZCB1c2VyIGJ5IGVtYWlsIG9yIHVzZXJuYW1lJywgYXN5bmMgKCkgPT4ge1xuICAgICAgKFxuICAgICAgICBtb2NrRGJTZXJ2aWNlLmRyaXp6bGUhLnF1ZXJ5LnVzZXJzLmZpbmRGaXJzdCBhcyBqZXN0Lk1vY2tcbiAgICAgICkubW9ja1Jlc29sdmVkVmFsdWUobW9ja1VzZXIpO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCByZXBvc2l0b3J5LmZpbmRCeUVtYWlsT3JVc2VybmFtZShcbiAgICAgICAgJ3Rlc3RAZXhhbXBsZS5jb20nLFxuICAgICAgICAndGVzdHVzZXInLFxuICAgICAgKTtcblxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbChtb2NrVXNlcik7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJldHVybiBudWxsIHdoZW4gbmVpdGhlciBleGlzdHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICAoXG4gICAgICAgIG1vY2tEYlNlcnZpY2UuZHJpenpsZSEucXVlcnkudXNlcnMuZmluZEZpcnN0IGFzIGplc3QuTW9ja1xuICAgICAgKS5tb2NrUmVzb2x2ZWRWYWx1ZSh1bmRlZmluZWQpO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCByZXBvc2l0b3J5LmZpbmRCeUVtYWlsT3JVc2VybmFtZShcbiAgICAgICAgJ25ld0BleGFtcGxlLmNvbScsXG4gICAgICAgICduZXd1c2VyJyxcbiAgICAgICk7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmVOdWxsKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdjcmVhdGUnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBjcmVhdGUgbmV3IHVzZXInLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBuZXdVc2VyRGF0YTogTmV3VXNlciA9IHtcbiAgICAgICAgZW1haWw6ICduZXdAZXhhbXBsZS5jb20nLFxuICAgICAgICB1c2VybmFtZTogJ25ld3VzZXInLFxuICAgICAgICBwYXNzd29yZEhhc2g6ICdoYXNoZWQnLFxuICAgICAgICByb2xlOiAnVVNFUicsXG4gICAgICB9O1xuXG4gICAgICBjb25zdCBpbnNlcnRNb2NrID0gbW9ja0RiU2VydmljZS5kcml6emxlIS5pbnNlcnQgYXMgamVzdC5Nb2NrO1xuICAgICAgY29uc3QgdmFsdWVzTW9jayA9IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoe1xuICAgICAgICByZXR1cm5pbmc6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZShbbW9ja1VzZXJdKSxcbiAgICAgIH0pO1xuICAgICAgaW5zZXJ0TW9jay5tb2NrUmV0dXJuVmFsdWUoe1xuICAgICAgICB2YWx1ZXM6IHZhbHVlc01vY2ssXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcmVwb3NpdG9yeS5jcmVhdGUobmV3VXNlckRhdGEpO1xuXG4gICAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKG1vY2tVc2VyKTtcbiAgICAgIGV4cGVjdCh2YWx1ZXNNb2NrKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIGVtYWlsOiAnbmV3QGV4YW1wbGUuY29tJyxcbiAgICAgICAgfSksXG4gICAgICApO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgndXBkYXRlJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgdXBkYXRlIHVzZXIgc3VjY2Vzc2Z1bGx5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgdXBkYXRlRGF0YSA9IHsgdXNlcm5hbWU6ICd1cGRhdGVkdXNlcicgfTtcblxuICAgICAgY29uc3QgdXBkYXRlTW9jayA9IG1vY2tEYlNlcnZpY2UuZHJpenpsZSEudXBkYXRlIGFzIGplc3QuTW9jaztcbiAgICAgIGNvbnN0IHNldE1vY2sgPSBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHtcbiAgICAgICAgd2hlcmU6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoe1xuICAgICAgICAgIHJldHVybmluZzogamVzdFxuICAgICAgICAgICAgLmZuKClcbiAgICAgICAgICAgIC5tb2NrUmVzb2x2ZWRWYWx1ZShbeyAuLi5tb2NrVXNlciwgLi4udXBkYXRlRGF0YSB9XSksXG4gICAgICAgIH0pLFxuICAgICAgfSk7XG4gICAgICB1cGRhdGVNb2NrLm1vY2tSZXR1cm5WYWx1ZSh7XG4gICAgICAgIHNldDogc2V0TW9jayxcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCByZXBvc2l0b3J5LnVwZGF0ZSgndGVzdC1pZC0xMjMnLCB1cGRhdGVEYXRhKTtcblxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChyZXN1bHQ/LnVzZXJuYW1lKS50b0JlKCd1cGRhdGVkdXNlcicpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gbnVsbCB3aGVuIHVzZXIgbm90IGZvdW5kJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgdXBkYXRlTW9jayA9IG1vY2tEYlNlcnZpY2UuZHJpenpsZSEudXBkYXRlIGFzIGplc3QuTW9jaztcbiAgICAgIGNvbnN0IHNldE1vY2sgPSBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHtcbiAgICAgICAgd2hlcmU6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoe1xuICAgICAgICAgIHJldHVybmluZzogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKFtdKSxcbiAgICAgICAgfSksXG4gICAgICB9KTtcbiAgICAgIHVwZGF0ZU1vY2subW9ja1JldHVyblZhbHVlKHtcbiAgICAgICAgc2V0OiBzZXRNb2NrLFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJlcG9zaXRvcnkudXBkYXRlKCdub24tZXhpc3RlbnQtaWQnLCB7XG4gICAgICAgIHVzZXJuYW1lOiAndGVzdCcsXG4gICAgICB9KTtcblxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZU51bGwoKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ3VwZGF0ZVBhc3N3b3JkJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgdXBkYXRlIHBhc3N3b3JkIHN1Y2Nlc3NmdWxseScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHVwZGF0ZU1vY2sgPSBtb2NrRGJTZXJ2aWNlLmRyaXp6bGUhLnVwZGF0ZSBhcyBqZXN0Lk1vY2s7XG4gICAgICBjb25zdCBzZXRNb2NrID0gamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7XG4gICAgICAgIHdoZXJlOiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHtcbiAgICAgICAgICByZXR1cm5pbmc6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZShbeyBpZDogJ3Rlc3QtaWQtMTIzJyB9XSksXG4gICAgICAgIH0pLFxuICAgICAgfSk7XG4gICAgICB1cGRhdGVNb2NrLm1vY2tSZXR1cm5WYWx1ZSh7XG4gICAgICAgIHNldDogc2V0TW9jayxcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCByZXBvc2l0b3J5LnVwZGF0ZVBhc3N3b3JkKCd0ZXN0LWlkLTEyMycsICduZXctaGFzaCcpO1xuXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlKHRydWUpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gZmFsc2Ugd2hlbiB1c2VyIG5vdCBmb3VuZCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHVwZGF0ZU1vY2sgPSBtb2NrRGJTZXJ2aWNlLmRyaXp6bGUhLnVwZGF0ZSBhcyBqZXN0Lk1vY2s7XG4gICAgICBjb25zdCBzZXRNb2NrID0gamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7XG4gICAgICAgIHdoZXJlOiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHtcbiAgICAgICAgICByZXR1cm5pbmc6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZShbXSksXG4gICAgICAgIH0pLFxuICAgICAgfSk7XG4gICAgICB1cGRhdGVNb2NrLm1vY2tSZXR1cm5WYWx1ZSh7XG4gICAgICAgIHNldDogc2V0TW9jayxcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCByZXBvc2l0b3J5LnVwZGF0ZVBhc3N3b3JkKFxuICAgICAgICAnbm9uLWV4aXN0ZW50LWlkJyxcbiAgICAgICAgJ25ldy1oYXNoJyxcbiAgICAgICk7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmUoZmFsc2UpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnZGVsZXRlJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgZGVsZXRlIHVzZXIgc3VjY2Vzc2Z1bGx5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgZGVsZXRlTW9jayA9IG1vY2tEYlNlcnZpY2UuZHJpenpsZSEuZGVsZXRlIGFzIGplc3QuTW9jaztcbiAgICAgIGRlbGV0ZU1vY2subW9ja1JldHVyblZhbHVlKHtcbiAgICAgICAgd2hlcmU6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoe1xuICAgICAgICAgIHJldHVybmluZzogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKFt7IGlkOiAndGVzdC1pZC0xMjMnIH1dKSxcbiAgICAgICAgfSksXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcmVwb3NpdG9yeS5kZWxldGUoJ3Rlc3QtaWQtMTIzJyk7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmUodHJ1ZSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJldHVybiBmYWxzZSB3aGVuIHVzZXIgbm90IGZvdW5kJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgZGVsZXRlTW9jayA9IG1vY2tEYlNlcnZpY2UuZHJpenpsZSEuZGVsZXRlIGFzIGplc3QuTW9jaztcbiAgICAgIGRlbGV0ZU1vY2subW9ja1JldHVyblZhbHVlKHtcbiAgICAgICAgd2hlcmU6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoe1xuICAgICAgICAgIHJldHVybmluZzogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKFtdKSxcbiAgICAgICAgfSksXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcmVwb3NpdG9yeS5kZWxldGUoJ25vbi1leGlzdGVudC1pZCcpO1xuXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlKGZhbHNlKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2NvdW50JywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgcmV0dXJuIGNvdW50IG9mIHVzZXJzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3Qgc2VsZWN0TW9jayA9IG1vY2tEYlNlcnZpY2UuZHJpenpsZSEuc2VsZWN0IGFzIGplc3QuTW9jaztcbiAgICAgIHNlbGVjdE1vY2subW9ja1JldHVyblZhbHVlKHtcbiAgICAgICAgZnJvbTogamVzdFxuICAgICAgICAgIC5mbigpXG4gICAgICAgICAgLm1vY2tSZXNvbHZlZFZhbHVlKFtcbiAgICAgICAgICAgIHsgY291bnQ6ICd1c2VyMScgfSxcbiAgICAgICAgICAgIHsgY291bnQ6ICd1c2VyMicgfSxcbiAgICAgICAgICAgIHsgY291bnQ6ICd1c2VyMycgfSxcbiAgICAgICAgICBdKSxcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCByZXBvc2l0b3J5LmNvdW50KCk7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmUoMyk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXSwidmVyc2lvbiI6M30=