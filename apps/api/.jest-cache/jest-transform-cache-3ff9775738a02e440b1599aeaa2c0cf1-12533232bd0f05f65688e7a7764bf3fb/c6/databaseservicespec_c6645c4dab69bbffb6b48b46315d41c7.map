{"file":"C:\\Users\\timur\\Programming\\Projects\\snippetforge\\apps\\api\\test\\unit\\services\\database.service.spec.ts","mappings":";AAAA,sDAAsD;AACtD,4DAA4D;AAC5D,+DAA+D;AAC/D,wDAAwD;AACxD,8CAA8C;;AAE9C,2CAA+C;AAC/C,6CAAsD;AACtD,oFAAgF;AAEhF,QAAQ,CAAC,iBAAiB,EAAE,GAAG,EAAE;IAC/B,IAAI,OAAwB,CAAC;IAC7B,IAAI,iBAAyC,CAAC;IAC9C,IAAI,UAAe,CAAC;IAEpB,UAAU,CAAC,KAAK,IAAI,EAAE;QAMpB,4BAA4B;QAC5B,IAAI,CAAC,IAAI,CAAC,UAAU,EAAE,GAAG,EAAE;YACzB,OAAO,IAAI,CAAC,EAAE,CAAC,GAAG,EAAE,CAAC,UAAU,CAAC,CAAC;QACnC,CAAC,CAAC,CAAC;QARH,UAAU,GAAG;YACX,GAAG,EAAE,IAAI,CAAC,EAAE,EAAE,CAAC,iBAAiB,CAAC,SAAS,CAAC;YAC3C,MAAM,EAAE,IAAI,CAAC,EAAE,EAAE,CAAC,iBAAiB,CAAC,EAAE,CAAC;SACxC,CAAC;QAOF,iBAAiB,GAAG;YAClB,GAAG,EAAE,IAAI,CAAC,EAAE,CAAC,CAAC,GAAW,EAAE,EAAE;gBAC3B,IAAI,GAAG,KAAK,cAAc;oBACxB,OAAO,4CAA4C,CAAC;gBACtD,IAAI,GAAG,KAAK,UAAU;oBAAE,OAAO,MAAM,CAAC;gBACtC,OAAO,SAAS,CAAC;YACnB,CAAC,CAAC;SACH,CAAC;QAEF,MAAM,MAAM,GAAkB,MAAM,cAAI,CAAC,mBAAmB,CAAC;YAC3D,SAAS,EAAE;gBACT,kCAAe;gBACf;oBACE,OAAO,EAAE,sBAAa;oBACtB,QAAQ,EAAE,iBAAiB;iBAC5B;aACF;SACF,CAAC,CAAC,OAAO,EAAE,CAAC;QAEb,OAAO,GAAG,MAAM,CAAC,GAAG,CAAkB,kCAAe,CAAC,CAAC;IACzD,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,iBAAiB,EAAE,GAAG,EAAE;QAC/B,EAAE,CAAC,kCAAkC,EAAE,KAAK,IAAI,EAAE;YAChD,gBAAgB;YACf,OAAe,CAAC,MAAM,GAAG,UAAU,CAAC;YAErC,MAAM,OAAO,CAAC,eAAe,EAAE,CAAC;YAEhC,MAAM,CAAC,UAAU,CAAC,GAAG,CAAC,CAAC,gBAAgB,EAAE,CAAC;QAC5C,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,yCAAyC,EAAE,KAAK,IAAI,EAAE;YACtD,OAAe,CAAC,MAAM,GAAG,IAAI,CAAC;YAE/B,MAAM,MAAM,CAAC,OAAO,CAAC,eAAe,EAAE,CAAC,CAAC,QAAQ,CAAC,GAAG,CAAC,OAAO,EAAE,CAAC;QACjE,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,gBAAgB,EAAE,GAAG,EAAE;QAC9B,EAAE,CAAC,kDAAkD,EAAE,GAAG,EAAE;YAC1D,MAAM,CAAC,GAAG,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC,OAAO,CAAC,0BAA0B,CAAC,CAAC;QACpE,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,YAAY,EAAE,GAAG,EAAE;QAC1B,EAAE,CAAC,wBAAwB,EAAE,KAAK,IAAI,EAAE;YACrC,OAAe,CAAC,MAAM,GAAG,UAAU,CAAC;YACrC,UAAU,CAAC,MAAM,CAAC,iBAAiB,CAAC,CAAC,EAAE,MAAM,EAAE,SAAS,EAAE,CAAC,CAAC,CAAC;YAE7D,MAAM,MAAM,GAAG,MAAM,OAAO,CAAC,UAAU,CAAC,UAAU,CAAC,CAAC;YAEpD,MAAM,CAAC,MAAM,CAAC,CAAC,OAAO,CAAC,CAAC,EAAE,MAAM,EAAE,SAAS,EAAE,CAAC,CAAC,CAAC;YAChD,MAAM,CAAC,UAAU,CAAC,MAAM,CAAC,CAAC,oBAAoB,CAAC,UAAU,CAAC,CAAC;QAC7D,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;AACL,CAAC,CAAC,CAAC","names":[],"sources":["C:\\Users\\timur\\Programming\\Projects\\snippetforge\\apps\\api\\test\\unit\\services\\database.service.spec.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-unsafe-call */\r\n/* eslint-disable @typescript-eslint/no-unsafe-assignment */\r\n/* eslint-disable @typescript-eslint/no-unsafe-member-access */\r\n/* eslint-disable @typescript-eslint/no-unsafe-return */\r\n// test/unit/services/database.service.spec.ts\r\n\r\nimport { ConfigService } from '@nestjs/config';\r\nimport { Test, TestingModule } from '@nestjs/testing';\r\nimport { DatabaseService } from '../../../src/shared/database/database.service';\r\n\r\ndescribe('DatabaseService', () => {\r\n  let service: DatabaseService;\r\n  let mockConfigService: Partial<ConfigService>;\r\n  let mockClient: any;\r\n\r\n  beforeEach(async () => {\r\n    mockClient = {\r\n      end: jest.fn().mockResolvedValue(undefined),\r\n      unsafe: jest.fn().mockResolvedValue([]),\r\n    };\r\n\r\n    // Mock postgres constructor\r\n    jest.mock('postgres', () => {\r\n      return jest.fn(() => mockClient);\r\n    });\r\n\r\n    mockConfigService = {\r\n      get: jest.fn((key: string) => {\r\n        if (key === 'DATABASE_URL')\r\n          return 'postgresql://test:test@localhost:5432/test';\r\n        if (key === 'NODE_ENV') return 'test';\r\n        return undefined;\r\n      }),\r\n    };\r\n\r\n    const module: TestingModule = await Test.createTestingModule({\r\n      providers: [\r\n        DatabaseService,\r\n        {\r\n          provide: ConfigService,\r\n          useValue: mockConfigService,\r\n        },\r\n      ],\r\n    }).compile();\r\n\r\n    service = module.get<DatabaseService>(DatabaseService);\r\n  });\r\n\r\n  describe('onModuleDestroy', () => {\r\n    it('should close database connection', async () => {\r\n      // Set up client\r\n      (service as any).client = mockClient;\r\n\r\n      await service.onModuleDestroy();\r\n\r\n      expect(mockClient.end).toHaveBeenCalled();\r\n    });\r\n\r\n    it('should handle missing client gracefully', async () => {\r\n      (service as any).client = null;\r\n\r\n      await expect(service.onModuleDestroy()).resolves.not.toThrow();\r\n    });\r\n  });\r\n\r\n  describe('drizzle getter', () => {\r\n    it('should throw error when database not initialized', () => {\r\n      expect(() => service.drizzle).toThrow('Database not initialized');\r\n    });\r\n  });\r\n\r\n  describe('executeRaw', () => {\r\n    it('should execute raw SQL', async () => {\r\n      (service as any).client = mockClient;\r\n      mockClient.unsafe.mockResolvedValue([{ result: 'success' }]);\r\n\r\n      const result = await service.executeRaw('SELECT 1');\r\n\r\n      expect(result).toEqual([{ result: 'success' }]);\r\n      expect(mockClient.unsafe).toHaveBeenCalledWith('SELECT 1');\r\n    });\r\n  });\r\n});\r\n"],"version":3}