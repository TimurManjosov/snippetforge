{"file":"C:\\Users\\timur\\Programming\\Projects\\snippetforge\\apps\\api\\test\\unit\\services\\auth.service.spec.ts","mappings":"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","names":[],"sources":["C:\\Users\\timur\\Programming\\Projects\\snippetforge\\apps\\api\\test\\unit\\services\\auth.service.spec.ts"],"sourcesContent":["// test/unit/services/auth.service.spec. ts\r\n\r\nimport { UnauthorizedException } from '@nestjs/common';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport { JwtService } from '@nestjs/jwt';\r\nimport { Test, TestingModule } from '@nestjs/testing';\r\nimport { AuthService } from '../../../src/modules/auth/auth.service';\r\nimport { UsersService } from '../../../src/modules/users/users.service';\r\nimport { createLoginDto, createRegisterDto } from '../../factories';\r\nimport {\r\n  createMockJwtService,\r\n  createMockSafeUser,\r\n  createMockUsersService,\r\n  type MockJwtService,\r\n  type MockUsersService,\r\n} from '../../mocks';\r\n\r\n/**\r\n * AuthService Unit Tests\r\n *\r\n * Testet:\r\n * - Registration\r\n * - Login\r\n * - Token Generation\r\n * - Error Handling\r\n */\r\ndescribe('AuthService', () => {\r\n  let service: AuthService;\r\n  let usersService: MockUsersService;\r\n  let jwtService: MockJwtService;\r\n\r\n  beforeEach(async () => {\r\n    usersService = createMockUsersService();\r\n    jwtService = createMockJwtService();\r\n\r\n    const module: TestingModule = await Test.createTestingModule({\r\n      providers: [\r\n        AuthService,\r\n        {\r\n          provide: UsersService,\r\n          useValue: usersService,\r\n        },\r\n        {\r\n          provide: JwtService,\r\n          useValue: jwtService,\r\n        },\r\n        {\r\n          provide: ConfigService,\r\n          useValue: {\r\n            get: jest.fn((key: string) => {\r\n              const config: Record<string, string> = {\r\n                JWT_SECRET: 'test-secret',\r\n                JWT_EXPIRES_IN: '15m',\r\n              };\r\n              return config[key];\r\n            }),\r\n          },\r\n        },\r\n      ],\r\n    }).compile();\r\n\r\n    service = module.get<AuthService>(AuthService);\r\n  });\r\n\r\n  afterEach(() => {\r\n    jest.clearAllMocks();\r\n  });\r\n\r\n  // ============================================================\r\n  // REGISTER\r\n  // ============================================================\r\n\r\n  describe('register', () => {\r\n    it('should register a new user and return tokens', async () => {\r\n      // Arrange\r\n      const dto = createRegisterDto();\r\n      const mockUser = createMockSafeUser({\r\n        email: dto.email,\r\n        username: dto.username,\r\n      });\r\n      usersService.create.mockResolvedValue(mockUser);\r\n\r\n      // Act\r\n      const result = await service.register(dto);\r\n\r\n      // Assert\r\n      expect(usersService.create).toHaveBeenCalledWith({\r\n        email: dto.email,\r\n        username: dto.username,\r\n        password: dto.password,\r\n      });\r\n      expect(result.user).toEqual(mockUser);\r\n      expect(result.tokens).toBeDefined();\r\n      expect(result.tokens.accessToken).toBeDefined();\r\n      expect(result.tokens.tokenType).toBe('Bearer');\r\n    });\r\n\r\n    it('should generate JWT with correct payload', async () => {\r\n      // Arrange\r\n      const dto = createRegisterDto();\r\n      const mockUser = createMockSafeUser({\r\n        id: 'user-123',\r\n        email: dto.email,\r\n        role: 'USER',\r\n      });\r\n      usersService.create.mockResolvedValue(mockUser);\r\n\r\n      // Act\r\n      await service.register(dto);\r\n\r\n      // Assert\r\n      expect(jwtService.signAsync).toHaveBeenCalledWith(\r\n        expect.objectContaining({\r\n          sub: 'user-123',\r\n          email: dto.email,\r\n          role: 'USER',\r\n        }),\r\n      );\r\n    });\r\n\r\n    it('should propagate ConflictException from UsersService', async () => {\r\n      // Arrange\r\n      const dto = createRegisterDto();\r\n      usersService.create.mockRejectedValue(\r\n        new Error('Email is already registered'),\r\n      );\r\n\r\n      // Act & Assert\r\n      await expect(service.register(dto)).rejects.toThrow();\r\n    });\r\n  });\r\n\r\n  // ============================================================\r\n  // LOGIN\r\n  // ============================================================\r\n\r\n  describe('login', () => {\r\n    it('should login user and return tokens', async () => {\r\n      // Arrange\r\n      const dto = createLoginDto();\r\n      const mockUser = createMockSafeUser({ email: dto.email });\r\n      usersService.validateCredentials.mockResolvedValue(mockUser);\r\n\r\n      // Act\r\n      const result = await service.login(dto);\r\n\r\n      // Assert\r\n      expect(usersService.validateCredentials).toHaveBeenCalledWith(\r\n        dto.email,\r\n        dto.password,\r\n      );\r\n      expect(result.user).toEqual(mockUser);\r\n      expect(result.tokens.accessToken).toBeDefined();\r\n    });\r\n\r\n    it('should throw UnauthorizedException when credentials are invalid', async () => {\r\n      // Arrange\r\n      const dto = createLoginDto();\r\n      usersService.validateCredentials.mockResolvedValue(null);\r\n\r\n      // Act & Assert\r\n      await expect(service.login(dto)).rejects.toThrow(UnauthorizedException);\r\n      await expect(service.login(dto)).rejects.toThrow(\r\n        'Invalid email or password',\r\n      );\r\n    });\r\n\r\n    it('should generate JWT with correct payload on login', async () => {\r\n      // Arrange\r\n      const dto = createLoginDto();\r\n      const mockUser = createMockSafeUser({\r\n        id: 'user-456',\r\n        email: dto.email,\r\n        role: 'ADMIN',\r\n      });\r\n      usersService.validateCredentials.mockResolvedValue(mockUser);\r\n\r\n      // Act\r\n      await service.login(dto);\r\n\r\n      // Assert\r\n      expect(jwtService.signAsync).toHaveBeenCalledWith(\r\n        expect.objectContaining({\r\n          sub: 'user-456',\r\n          email: dto.email,\r\n          role: 'ADMIN',\r\n        }),\r\n      );\r\n    });\r\n  });\r\n\r\n  // ============================================================\r\n  // TOKEN GENERATION\r\n  // ============================================================\r\n\r\n  describe('token generation', () => {\r\n    it('should include expiresIn in token response', async () => {\r\n      // Arrange\r\n      const dto = createRegisterDto();\r\n      usersService.create.mockResolvedValue(createMockSafeUser());\r\n\r\n      // Act\r\n      const result = await service.register(dto);\r\n\r\n      // Assert\r\n      expect(result.tokens.expiresIn).toBeDefined();\r\n      expect(typeof result.tokens.expiresIn).toBe('number');\r\n    });\r\n\r\n    it('should set tokenType to Bearer', async () => {\r\n      // Arrange\r\n      const dto = createLoginDto();\r\n      usersService.validateCredentials.mockResolvedValue(createMockSafeUser());\r\n\r\n      // Act\r\n      const result = await service.login(dto);\r\n\r\n      // Assert\r\n      expect(result.tokens.tokenType).toBe('Bearer');\r\n    });\r\n  });\r\n\r\n  // ============================================================\r\n  // VALIDATE USER BY ID\r\n  // ============================================================\r\n\r\n  describe('validateUserById', () => {\r\n    it('should return user when found', async () => {\r\n      // Arrange\r\n      const mockUser = createMockSafeUser();\r\n      usersService.findById.mockResolvedValue(mockUser);\r\n\r\n      // Act\r\n      const result = await service.validateUserById('user-123');\r\n\r\n      // Assert\r\n      expect(usersService.findById).toHaveBeenCalledWith('user-123');\r\n      expect(result).toEqual(mockUser);\r\n    });\r\n\r\n    it('should propagate NotFoundException from UsersService', async () => {\r\n      // Arrange\r\n      usersService.findById.mockRejectedValue(new Error('User not found'));\r\n\r\n      // Act & Assert\r\n      await expect(service.validateUserById('nonexistent')).rejects.toThrow();\r\n    });\r\n  });\r\n\r\n  // ============================================================\r\n  // GET CURRENT USER\r\n  // ============================================================\r\n\r\n  describe('getCurrentUser', () => {\r\n    it('should return user by id', async () => {\r\n      // Arrange\r\n      const mockUser = createMockSafeUser({ id: 'current-user-id' });\r\n      usersService.findById.mockResolvedValue(mockUser);\r\n\r\n      // Act\r\n      const result = await service.getCurrentUser('current-user-id');\r\n\r\n      // Assert\r\n      expect(result).toEqual(mockUser);\r\n    });\r\n  });\r\n});\r\n"],"version":3}