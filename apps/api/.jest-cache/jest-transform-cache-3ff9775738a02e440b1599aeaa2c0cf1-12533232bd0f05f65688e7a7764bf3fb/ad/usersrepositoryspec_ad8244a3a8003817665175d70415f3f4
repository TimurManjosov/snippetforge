b83948c78589fbba6bac318cacd65e36
"use strict";
/* eslint-disable @typescript-eslint/unbound-method */
/* eslint-disable @typescript-eslint/no-unsafe-assignment */
// test/unit/repositories/users.repository.spec.ts
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const users_repository_1 = require("../../../src/modules/users/users.repository");
const database_1 = require("../../../src/shared/database");
describe('UsersRepository', () => {
    let repository;
    let mockDbService;
    const mockUser = {
        id: 'test-id-123',
        email: 'test@example.com',
        username: 'testuser',
        passwordHash: 'hashed-password',
        role: 'USER',
        createdAt: new Date(),
        updatedAt: new Date(),
        bio: null,
        avatarUrl: null,
    };
    beforeEach(async () => {
        mockDbService = {
            drizzle: {
                query: {
                    users: {
                        findFirst: jest.fn(),
                    },
                },
                insert: jest.fn().mockReturnValue({
                    values: jest.fn().mockReturnValue({
                        returning: jest.fn(),
                    }),
                }),
                update: jest.fn().mockReturnValue({
                    set: jest.fn().mockReturnValue({
                        where: jest.fn().mockReturnValue({
                            returning: jest.fn(),
                        }),
                    }),
                }),
                delete: jest.fn().mockReturnValue({
                    where: jest.fn().mockReturnValue({
                        returning: jest.fn(),
                    }),
                }),
                select: jest.fn().mockReturnValue({
                    from: jest.fn(),
                }),
            },
        };
        const module = await testing_1.Test.createTestingModule({
            providers: [
                users_repository_1.UsersRepository,
                {
                    provide: database_1.DatabaseService,
                    useValue: mockDbService,
                },
            ],
        }).compile();
        repository = module.get(users_repository_1.UsersRepository);
    });
    describe('findById', () => {
        it('should find user by ID', async () => {
            mockDbService.drizzle.query.users.findFirst.mockResolvedValue(mockUser);
            const result = await repository.findById('test-id-123');
            expect(result).toEqual(mockUser);
        });
        it('should return null when user not found', async () => {
            mockDbService.drizzle.query.users.findFirst.mockResolvedValue(undefined);
            const result = await repository.findById('non-existent-id');
            expect(result).toBeNull();
        });
    });
    describe('findByEmail', () => {
        it('should find user by email', async () => {
            mockDbService.drizzle.query.users.findFirst.mockResolvedValue(mockUser);
            const result = await repository.findByEmail('test@example.com');
            expect(result).toEqual(mockUser);
        });
        it('should return null when email not found', async () => {
            mockDbService.drizzle.query.users.findFirst.mockResolvedValue(undefined);
            const result = await repository.findByEmail('nonexistent@example.com');
            expect(result).toBeNull();
        });
    });
    describe('findByUsername', () => {
        it('should find user by username', async () => {
            mockDbService.drizzle.query.users.findFirst.mockResolvedValue(mockUser);
            const result = await repository.findByUsername('testuser');
            expect(result).toEqual(mockUser);
        });
        it('should return null when username not found', async () => {
            mockDbService.drizzle.query.users.findFirst.mockResolvedValue(undefined);
            const result = await repository.findByUsername('nonexistent');
            expect(result).toBeNull();
        });
    });
    describe('findByEmailOrUsername', () => {
        it('should find user by email or username', async () => {
            mockDbService.drizzle.query.users.findFirst.mockResolvedValue(mockUser);
            const result = await repository.findByEmailOrUsername('test@example.com', 'testuser');
            expect(result).toEqual(mockUser);
        });
        it('should return null when neither exists', async () => {
            mockDbService.drizzle.query.users.findFirst.mockResolvedValue(undefined);
            const result = await repository.findByEmailOrUsername('new@example.com', 'newuser');
            expect(result).toBeNull();
        });
    });
    describe('create', () => {
        it('should create new user', async () => {
            const newUserData = {
                email: 'new@example.com',
                username: 'newuser',
                passwordHash: 'hashed',
                role: 'USER',
            };
            const insertMock = mockDbService.drizzle.insert;
            const valuesMock = jest.fn().mockReturnValue({
                returning: jest.fn().mockResolvedValue([mockUser]),
            });
            insertMock.mockReturnValue({
                values: valuesMock,
            });
            const result = await repository.create(newUserData);
            expect(result).toEqual(mockUser);
            expect(valuesMock).toHaveBeenCalledWith(expect.objectContaining({
                email: 'new@example.com',
            }));
        });
    });
    describe('update', () => {
        it('should update user successfully', async () => {
            const updateData = { username: 'updateduser' };
            const updateMock = mockDbService.drizzle.update;
            const setMock = jest.fn().mockReturnValue({
                where: jest.fn().mockReturnValue({
                    returning: jest
                        .fn()
                        .mockResolvedValue([{ ...mockUser, ...updateData }]),
                }),
            });
            updateMock.mockReturnValue({
                set: setMock,
            });
            const result = await repository.update('test-id-123', updateData);
            expect(result).toBeDefined();
            expect(result?.username).toBe('updateduser');
        });
        it('should return null when user not found', async () => {
            const updateMock = mockDbService.drizzle.update;
            const setMock = jest.fn().mockReturnValue({
                where: jest.fn().mockReturnValue({
                    returning: jest.fn().mockResolvedValue([]),
                }),
            });
            updateMock.mockReturnValue({
                set: setMock,
            });
            const result = await repository.update('non-existent-id', {
                username: 'test',
            });
            expect(result).toBeNull();
        });
    });
    describe('updatePassword', () => {
        it('should update password successfully', async () => {
            const updateMock = mockDbService.drizzle.update;
            const setMock = jest.fn().mockReturnValue({
                where: jest.fn().mockReturnValue({
                    returning: jest.fn().mockResolvedValue([{ id: 'test-id-123' }]),
                }),
            });
            updateMock.mockReturnValue({
                set: setMock,
            });
            const result = await repository.updatePassword('test-id-123', 'new-hash');
            expect(result).toBe(true);
        });
        it('should return false when user not found', async () => {
            const updateMock = mockDbService.drizzle.update;
            const setMock = jest.fn().mockReturnValue({
                where: jest.fn().mockReturnValue({
                    returning: jest.fn().mockResolvedValue([]),
                }),
            });
            updateMock.mockReturnValue({
                set: setMock,
            });
            const result = await repository.updatePassword('non-existent-id', 'new-hash');
            expect(result).toBe(false);
        });
    });
    describe('delete', () => {
        it('should delete user successfully', async () => {
            const deleteMock = mockDbService.drizzle.delete;
            deleteMock.mockReturnValue({
                where: jest.fn().mockReturnValue({
                    returning: jest.fn().mockResolvedValue([{ id: 'test-id-123' }]),
                }),
            });
            const result = await repository.delete('test-id-123');
            expect(result).toBe(true);
        });
        it('should return false when user not found', async () => {
            const deleteMock = mockDbService.drizzle.delete;
            deleteMock.mockReturnValue({
                where: jest.fn().mockReturnValue({
                    returning: jest.fn().mockResolvedValue([]),
                }),
            });
            const result = await repository.delete('non-existent-id');
            expect(result).toBe(false);
        });
    });
    describe('count', () => {
        it('should return count of users', async () => {
            const selectMock = mockDbService.drizzle.select;
            selectMock.mockReturnValue({
                from: jest
                    .fn()
                    .mockResolvedValue([
                    { count: 'user1' },
                    { count: 'user2' },
                    { count: 'user3' },
                ]),
            });
            const result = await repository.count();
            expect(result).toBe(3);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aW11clxcUHJvZ3JhbW1pbmdcXFByb2plY3RzXFxzbmlwcGV0Zm9yZ2VcXGFwcHNcXGFwaVxcdGVzdFxcdW5pdFxccmVwb3NpdG9yaWVzXFx1c2Vycy5yZXBvc2l0b3J5LnNwZWMudHMiLCJtYXBwaW5ncyI6IjtBQUFBLHNEQUFzRDtBQUN0RCw0REFBNEQ7QUFDNUQsa0RBQWtEOztBQUVsRCw2Q0FBc0Q7QUFFdEQsa0ZBQThFO0FBQzlFLDJEQUErRDtBQUUvRCxRQUFRLENBQUMsaUJBQWlCLEVBQUUsR0FBRyxFQUFFO0lBQy9CLElBQUksVUFBMkIsQ0FBQztJQUNoQyxJQUFJLGFBQXVDLENBQUM7SUFFNUMsTUFBTSxRQUFRLEdBQVM7UUFDckIsRUFBRSxFQUFFLGFBQWE7UUFDakIsS0FBSyxFQUFFLGtCQUFrQjtRQUN6QixRQUFRLEVBQUUsVUFBVTtRQUNwQixZQUFZLEVBQUUsaUJBQWlCO1FBQy9CLElBQUksRUFBRSxNQUFNO1FBQ1osU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFO1FBQ3JCLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRTtRQUNyQixHQUFHLEVBQUUsSUFBSTtRQUNULFNBQVMsRUFBRSxJQUFJO0tBQ2hCLENBQUM7SUFFRixVQUFVLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDcEIsYUFBYSxHQUFHO1lBQ2QsT0FBTyxFQUFFO2dCQUNQLEtBQUssRUFBRTtvQkFDTCxLQUFLLEVBQUU7d0JBQ0wsU0FBUyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7cUJBQ3JCO2lCQUNGO2dCQUNELE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsZUFBZSxDQUFDO29CQUNoQyxNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGVBQWUsQ0FBQzt3QkFDaEMsU0FBUyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7cUJBQ3JCLENBQUM7aUJBQ0gsQ0FBQztnQkFDRixNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGVBQWUsQ0FBQztv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RUFBRTtvQkFDbEIsRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFO29CQUNsQixFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUU7aUJBQ25CLENBQUM7YUFDTCxDQUFDLENBQUM7WUFFSCxNQUFNLE1BQU0sR0FBRyxNQUFNLFVBQVUsQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUV4QyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3pCLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXHRpbXVyXFxQcm9ncmFtbWluZ1xcUHJvamVjdHNcXHNuaXBwZXRmb3JnZVxcYXBwc1xcYXBpXFx0ZXN0XFx1bml0XFxyZXBvc2l0b3JpZXNcXHVzZXJzLnJlcG9zaXRvcnkuc3BlYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSBAdHlwZXNjcmlwdC1lc2xpbnQvdW5ib3VuZC1tZXRob2QgKi9cclxuLyogZXNsaW50LWRpc2FibGUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXVuc2FmZS1hc3NpZ25tZW50ICovXHJcbi8vIHRlc3QvdW5pdC9yZXBvc2l0b3JpZXMvdXNlcnMucmVwb3NpdG9yeS5zcGVjLnRzXHJcblxyXG5pbXBvcnQgeyBUZXN0LCBUZXN0aW5nTW9kdWxlIH0gZnJvbSAnQG5lc3Rqcy90ZXN0aW5nJztcclxuaW1wb3J0IHR5cGUgeyBOZXdVc2VyLCBVc2VyIH0gZnJvbSAnLi4vLi4vLi4vc3JjL2xpYi9kYi9zY2hlbWEnO1xyXG5pbXBvcnQgeyBVc2Vyc1JlcG9zaXRvcnkgfSBmcm9tICcuLi8uLi8uLi9zcmMvbW9kdWxlcy91c2Vycy91c2Vycy5yZXBvc2l0b3J5JztcclxuaW1wb3J0IHsgRGF0YWJhc2VTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vLi4vc3JjL3NoYXJlZC9kYXRhYmFzZSc7XHJcblxyXG5kZXNjcmliZSgnVXNlcnNSZXBvc2l0b3J5JywgKCkgPT4ge1xyXG4gIGxldCByZXBvc2l0b3J5OiBVc2Vyc1JlcG9zaXRvcnk7XHJcbiAgbGV0IG1vY2tEYlNlcnZpY2U6IFBhcnRpYWw8RGF0YWJhc2VTZXJ2aWNlPjtcclxuXHJcbiAgY29uc3QgbW9ja1VzZXI6IFVzZXIgPSB7XHJcbiAgICBpZDogJ3Rlc3QtaWQtMTIzJyxcclxuICAgIGVtYWlsOiAndGVzdEBleGFtcGxlLmNvbScsXHJcbiAgICB1c2VybmFtZTogJ3Rlc3R1c2VyJyxcclxuICAgIHBhc3N3b3JkSGFzaDogJ2hhc2hlZC1wYXNzd29yZCcsXHJcbiAgICByb2xlOiAnVVNFUicsXHJcbiAgICBjcmVhdGVkQXQ6IG5ldyBEYXRlKCksXHJcbiAgICB1cGRhdGVkQXQ6IG5ldyBEYXRlKCksXHJcbiAgICBiaW86IG51bGwsXHJcbiAgICBhdmF0YXJVcmw6IG51bGwsXHJcbiAgfTtcclxuXHJcbiAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiB7XHJcbiAgICBtb2NrRGJTZXJ2aWNlID0ge1xyXG4gICAgICBkcml6emxlOiB7XHJcbiAgICAgICAgcXVlcnk6IHtcclxuICAgICAgICAgIHVzZXJzOiB7XHJcbiAgICAgICAgICAgIGZpbmRGaXJzdDogamVzdC5mbigpLFxyXG4gICAgICAgICAgfSxcclxuICAgICAgICB9LFxyXG4gICAgICAgIGluc2VydDogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7XHJcbiAgICAgICAgICB2YWx1ZXM6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoe1xyXG4gICAgICAgICAgICByZXR1cm5pbmc6IGplc3QuZm4oKSxcclxuICAgICAgICAgIH0pLFxyXG4gICAgICAgIH0pLFxyXG4gICAgICAgIHVwZGF0ZTogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7XHJcbiAgICAgICAgICBzZXQ6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoe1xyXG4gICAgICAgICAgICB3aGVyZTogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7XHJcbiAgICAgICAgICAgICAgcmV0dXJuaW5nOiBqZXN0LmZuKCksXHJcbiAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgfSksXHJcbiAgICAgICAgfSksXHJcbiAgICAgICAgZGVsZXRlOiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHtcclxuICAgICAgICAgIHdoZXJlOiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHtcclxuICAgICAgICAgICAgcmV0dXJuaW5nOiBqZXN0LmZuKCksXHJcbiAgICAgICAgICB9KSxcclxuICAgICAgICB9KSxcclxuICAgICAgICBzZWxlY3Q6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoe1xyXG4gICAgICAgICAgZnJvbTogamVzdC5mbigpLFxyXG4gICAgICAgIH0pLFxyXG4gICAgICB9IGFzIGFueSxcclxuICAgIH07XHJcblxyXG4gICAgY29uc3QgbW9kdWxlOiBUZXN0aW5nTW9kdWxlID0gYXdhaXQgVGVzdC5jcmVhdGVUZXN0aW5nTW9kdWxlKHtcclxuICAgICAgcHJvdmlkZXJzOiBbXHJcbiAgICAgICAgVXNlcnNSZXBvc2l0b3J5LFxyXG4gICAgICAgIHtcclxuICAgICAgICAgIHByb3ZpZGU6IERhdGFiYXNlU2VydmljZSxcclxuICAgICAgICAgIHVzZVZhbHVlOiBtb2NrRGJTZXJ2aWNlLFxyXG4gICAgICAgIH0sXHJcbiAgICAgIF0sXHJcbiAgICB9KS5jb21waWxlKCk7XHJcblxyXG4gICAgcmVwb3NpdG9yeSA9IG1vZHVsZS5nZXQ8VXNlcnNSZXBvc2l0b3J5PihVc2Vyc1JlcG9zaXRvcnkpO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnZmluZEJ5SWQnLCAoKSA9PiB7XHJcbiAgICBpdCgnc2hvdWxkIGZpbmQgdXNlciBieSBJRCcsIGFzeW5jICgpID0+IHtcclxuICAgICAgKFxyXG4gICAgICAgIG1vY2tEYlNlcnZpY2UuZHJpenpsZSEucXVlcnkudXNlcnMuZmluZEZpcnN0IGFzIGplc3QuTW9ja1xyXG4gICAgICApLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tVc2VyKTtcclxuXHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJlcG9zaXRvcnkuZmluZEJ5SWQoJ3Rlc3QtaWQtMTIzJyk7XHJcblxyXG4gICAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKG1vY2tVc2VyKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdzaG91bGQgcmV0dXJuIG51bGwgd2hlbiB1c2VyIG5vdCBmb3VuZCcsIGFzeW5jICgpID0+IHtcclxuICAgICAgKFxyXG4gICAgICAgIG1vY2tEYlNlcnZpY2UuZHJpenpsZSEucXVlcnkudXNlcnMuZmluZEZpcnN0IGFzIGplc3QuTW9ja1xyXG4gICAgICApLm1vY2tSZXNvbHZlZFZhbHVlKHVuZGVmaW5lZCk7XHJcblxyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCByZXBvc2l0b3J5LmZpbmRCeUlkKCdub24tZXhpc3RlbnQtaWQnKTtcclxuXHJcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmVOdWxsKCk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ2ZpbmRCeUVtYWlsJywgKCkgPT4ge1xyXG4gICAgaXQoJ3Nob3VsZCBmaW5kIHVzZXIgYnkgZW1haWwnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIChcclxuICAgICAgICBtb2NrRGJTZXJ2aWNlLmRyaXp6bGUhLnF1ZXJ5LnVzZXJzLmZpbmRGaXJzdCBhcyBqZXN0Lk1vY2tcclxuICAgICAgKS5tb2NrUmVzb2x2ZWRWYWx1ZShtb2NrVXNlcik7XHJcblxyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCByZXBvc2l0b3J5LmZpbmRCeUVtYWlsKCd0ZXN0QGV4YW1wbGUuY29tJyk7XHJcblxyXG4gICAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKG1vY2tVc2VyKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdzaG91bGQgcmV0dXJuIG51bGwgd2hlbiBlbWFpbCBub3QgZm91bmQnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIChcclxuICAgICAgICBtb2NrRGJTZXJ2aWNlLmRyaXp6bGUhLnF1ZXJ5LnVzZXJzLmZpbmRGaXJzdCBhcyBqZXN0Lk1vY2tcclxuICAgICAgKS5tb2NrUmVzb2x2ZWRWYWx1ZSh1bmRlZmluZWQpO1xyXG5cclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcmVwb3NpdG9yeS5maW5kQnlFbWFpbCgnbm9uZXhpc3RlbnRAZXhhbXBsZS5jb20nKTtcclxuXHJcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmVOdWxsKCk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ2ZpbmRCeVVzZXJuYW1lJywgKCkgPT4ge1xyXG4gICAgaXQoJ3Nob3VsZCBmaW5kIHVzZXIgYnkgdXNlcm5hbWUnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIChcclxuICAgICAgICBtb2NrRGJTZXJ2aWNlLmRyaXp6bGUhLnF1ZXJ5LnVzZXJzLmZpbmRGaXJzdCBhcyBqZXN0Lk1vY2tcclxuICAgICAgKS5tb2NrUmVzb2x2ZWRWYWx1ZShtb2NrVXNlcik7XHJcblxyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCByZXBvc2l0b3J5LmZpbmRCeVVzZXJuYW1lKCd0ZXN0dXNlcicpO1xyXG5cclxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbChtb2NrVXNlcik7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIHJldHVybiBudWxsIHdoZW4gdXNlcm5hbWUgbm90IGZvdW5kJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAoXHJcbiAgICAgICAgbW9ja0RiU2VydmljZS5kcml6emxlIS5xdWVyeS51c2Vycy5maW5kRmlyc3QgYXMgamVzdC5Nb2NrXHJcbiAgICAgICkubW9ja1Jlc29sdmVkVmFsdWUodW5kZWZpbmVkKTtcclxuXHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJlcG9zaXRvcnkuZmluZEJ5VXNlcm5hbWUoJ25vbmV4aXN0ZW50Jyk7XHJcblxyXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlTnVsbCgpO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdmaW5kQnlFbWFpbE9yVXNlcm5hbWUnLCAoKSA9PiB7XHJcbiAgICBpdCgnc2hvdWxkIGZpbmQgdXNlciBieSBlbWFpbCBvciB1c2VybmFtZScsIGFzeW5jICgpID0+IHtcclxuICAgICAgKFxyXG4gICAgICAgIG1vY2tEYlNlcnZpY2UuZHJpenpsZSEucXVlcnkudXNlcnMuZmluZEZpcnN0IGFzIGplc3QuTW9ja1xyXG4gICAgICApLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tVc2VyKTtcclxuXHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJlcG9zaXRvcnkuZmluZEJ5RW1haWxPclVzZXJuYW1lKFxyXG4gICAgICAgICd0ZXN0QGV4YW1wbGUuY29tJyxcclxuICAgICAgICAndGVzdHVzZXInLFxyXG4gICAgICApO1xyXG5cclxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbChtb2NrVXNlcik7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIHJldHVybiBudWxsIHdoZW4gbmVpdGhlciBleGlzdHMnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIChcclxuICAgICAgICBtb2NrRGJTZXJ2aWNlLmRyaXp6bGUhLnF1ZXJ5LnVzZXJzLmZpbmRGaXJzdCBhcyBqZXN0Lk1vY2tcclxuICAgICAgKS5tb2NrUmVzb2x2ZWRWYWx1ZSh1bmRlZmluZWQpO1xyXG5cclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcmVwb3NpdG9yeS5maW5kQnlFbWFpbE9yVXNlcm5hbWUoXHJcbiAgICAgICAgJ25ld0BleGFtcGxlLmNvbScsXHJcbiAgICAgICAgJ25ld3VzZXInLFxyXG4gICAgICApO1xyXG5cclxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZU51bGwoKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnY3JlYXRlJywgKCkgPT4ge1xyXG4gICAgaXQoJ3Nob3VsZCBjcmVhdGUgbmV3IHVzZXInLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IG5ld1VzZXJEYXRhOiBOZXdVc2VyID0ge1xyXG4gICAgICAgIGVtYWlsOiAnbmV3QGV4YW1wbGUuY29tJyxcclxuICAgICAgICB1c2VybmFtZTogJ25ld3VzZXInLFxyXG4gICAgICAgIHBhc3N3b3JkSGFzaDogJ2hhc2hlZCcsXHJcbiAgICAgICAgcm9sZTogJ1VTRVInLFxyXG4gICAgICB9O1xyXG5cclxuICAgICAgY29uc3QgaW5zZXJ0TW9jayA9IG1vY2tEYlNlcnZpY2UuZHJpenpsZSEuaW5zZXJ0IGFzIGplc3QuTW9jaztcclxuICAgICAgY29uc3QgdmFsdWVzTW9jayA9IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoe1xyXG4gICAgICAgIHJldHVybmluZzogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKFttb2NrVXNlcl0pLFxyXG4gICAgICB9KTtcclxuICAgICAgaW5zZXJ0TW9jay5tb2NrUmV0dXJuVmFsdWUoe1xyXG4gICAgICAgIHZhbHVlczogdmFsdWVzTW9jayxcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCByZXBvc2l0b3J5LmNyZWF0ZShuZXdVc2VyRGF0YSk7XHJcblxyXG4gICAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKG1vY2tVc2VyKTtcclxuICAgICAgZXhwZWN0KHZhbHVlc01vY2spLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxyXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcclxuICAgICAgICAgIGVtYWlsOiAnbmV3QGV4YW1wbGUuY29tJyxcclxuICAgICAgICB9KSxcclxuICAgICAgKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgndXBkYXRlJywgKCkgPT4ge1xyXG4gICAgaXQoJ3Nob3VsZCB1cGRhdGUgdXNlciBzdWNjZXNzZnVsbHknLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHVwZGF0ZURhdGEgPSB7IHVzZXJuYW1lOiAndXBkYXRlZHVzZXInIH07XHJcblxyXG4gICAgICBjb25zdCB1cGRhdGVNb2NrID0gbW9ja0RiU2VydmljZS5kcml6emxlIS51cGRhdGUgYXMgamVzdC5Nb2NrO1xyXG4gICAgICBjb25zdCBzZXRNb2NrID0gamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7XHJcbiAgICAgICAgd2hlcmU6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoe1xyXG4gICAgICAgICAgcmV0dXJuaW5nOiBqZXN0XHJcbiAgICAgICAgICAgIC5mbigpXHJcbiAgICAgICAgICAgIC5tb2NrUmVzb2x2ZWRWYWx1ZShbeyAuLi5tb2NrVXNlciwgLi4udXBkYXRlRGF0YSB9XSksXHJcbiAgICAgICAgfSksXHJcbiAgICAgIH0pO1xyXG4gICAgICB1cGRhdGVNb2NrLm1vY2tSZXR1cm5WYWx1ZSh7XHJcbiAgICAgICAgc2V0OiBzZXRNb2NrLFxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJlcG9zaXRvcnkudXBkYXRlKCd0ZXN0LWlkLTEyMycsIHVwZGF0ZURhdGEpO1xyXG5cclxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZURlZmluZWQoKTtcclxuICAgICAgZXhwZWN0KHJlc3VsdD8udXNlcm5hbWUpLnRvQmUoJ3VwZGF0ZWR1c2VyJyk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIHJldHVybiBudWxsIHdoZW4gdXNlciBub3QgZm91bmQnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHVwZGF0ZU1vY2sgPSBtb2NrRGJTZXJ2aWNlLmRyaXp6bGUhLnVwZGF0ZSBhcyBqZXN0Lk1vY2s7XHJcbiAgICAgIGNvbnN0IHNldE1vY2sgPSBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHtcclxuICAgICAgICB3aGVyZTogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7XHJcbiAgICAgICAgICByZXR1cm5pbmc6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZShbXSksXHJcbiAgICAgICAgfSksXHJcbiAgICAgIH0pO1xyXG4gICAgICB1cGRhdGVNb2NrLm1vY2tSZXR1cm5WYWx1ZSh7XHJcbiAgICAgICAgc2V0OiBzZXRNb2NrLFxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJlcG9zaXRvcnkudXBkYXRlKCdub24tZXhpc3RlbnQtaWQnLCB7XHJcbiAgICAgICAgdXNlcm5hbWU6ICd0ZXN0JyxcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlTnVsbCgpO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCd1cGRhdGVQYXNzd29yZCcsICgpID0+IHtcclxuICAgIGl0KCdzaG91bGQgdXBkYXRlIHBhc3N3b3JkIHN1Y2Nlc3NmdWxseScsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgdXBkYXRlTW9jayA9IG1vY2tEYlNlcnZpY2UuZHJpenpsZSEudXBkYXRlIGFzIGplc3QuTW9jaztcclxuICAgICAgY29uc3Qgc2V0TW9jayA9IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoe1xyXG4gICAgICAgIHdoZXJlOiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHtcclxuICAgICAgICAgIHJldHVybmluZzogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKFt7IGlkOiAndGVzdC1pZC0xMjMnIH1dKSxcclxuICAgICAgICB9KSxcclxuICAgICAgfSk7XHJcbiAgICAgIHVwZGF0ZU1vY2subW9ja1JldHVyblZhbHVlKHtcclxuICAgICAgICBzZXQ6IHNldE1vY2ssXHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcmVwb3NpdG9yeS51cGRhdGVQYXNzd29yZCgndGVzdC1pZC0xMjMnLCAnbmV3LWhhc2gnKTtcclxuXHJcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmUodHJ1ZSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIHJldHVybiBmYWxzZSB3aGVuIHVzZXIgbm90IGZvdW5kJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCB1cGRhdGVNb2NrID0gbW9ja0RiU2VydmljZS5kcml6emxlIS51cGRhdGUgYXMgamVzdC5Nb2NrO1xyXG4gICAgICBjb25zdCBzZXRNb2NrID0gamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7XHJcbiAgICAgICAgd2hlcmU6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoe1xyXG4gICAgICAgICAgcmV0dXJuaW5nOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoW10pLFxyXG4gICAgICAgIH0pLFxyXG4gICAgICB9KTtcclxuICAgICAgdXBkYXRlTW9jay5tb2NrUmV0dXJuVmFsdWUoe1xyXG4gICAgICAgIHNldDogc2V0TW9jayxcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCByZXBvc2l0b3J5LnVwZGF0ZVBhc3N3b3JkKFxyXG4gICAgICAgICdub24tZXhpc3RlbnQtaWQnLFxyXG4gICAgICAgICduZXctaGFzaCcsXHJcbiAgICAgICk7XHJcblxyXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlKGZhbHNlKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnZGVsZXRlJywgKCkgPT4ge1xyXG4gICAgaXQoJ3Nob3VsZCBkZWxldGUgdXNlciBzdWNjZXNzZnVsbHknLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IGRlbGV0ZU1vY2sgPSBtb2NrRGJTZXJ2aWNlLmRyaXp6bGUhLmRlbGV0ZSBhcyBqZXN0Lk1vY2s7XHJcbiAgICAgIGRlbGV0ZU1vY2subW9ja1JldHVyblZhbHVlKHtcclxuICAgICAgICB3aGVyZTogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7XHJcbiAgICAgICAgICByZXR1cm5pbmc6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZShbeyBpZDogJ3Rlc3QtaWQtMTIzJyB9XSksXHJcbiAgICAgICAgfSksXHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcmVwb3NpdG9yeS5kZWxldGUoJ3Rlc3QtaWQtMTIzJyk7XHJcblxyXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlKHRydWUpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gZmFsc2Ugd2hlbiB1c2VyIG5vdCBmb3VuZCcsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgZGVsZXRlTW9jayA9IG1vY2tEYlNlcnZpY2UuZHJpenpsZSEuZGVsZXRlIGFzIGplc3QuTW9jaztcclxuICAgICAgZGVsZXRlTW9jay5tb2NrUmV0dXJuVmFsdWUoe1xyXG4gICAgICAgIHdoZXJlOiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHtcclxuICAgICAgICAgIHJldHVybmluZzogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKFtdKSxcclxuICAgICAgICB9KSxcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCByZXBvc2l0b3J5LmRlbGV0ZSgnbm9uLWV4aXN0ZW50LWlkJyk7XHJcblxyXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlKGZhbHNlKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnY291bnQnLCAoKSA9PiB7XHJcbiAgICBpdCgnc2hvdWxkIHJldHVybiBjb3VudCBvZiB1c2VycycsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3Qgc2VsZWN0TW9jayA9IG1vY2tEYlNlcnZpY2UuZHJpenpsZSEuc2VsZWN0IGFzIGplc3QuTW9jaztcclxuICAgICAgc2VsZWN0TW9jay5tb2NrUmV0dXJuVmFsdWUoe1xyXG4gICAgICAgIGZyb206IGplc3RcclxuICAgICAgICAgIC5mbigpXHJcbiAgICAgICAgICAubW9ja1Jlc29sdmVkVmFsdWUoW1xyXG4gICAgICAgICAgICB7IGNvdW50OiAndXNlcjEnIH0sXHJcbiAgICAgICAgICAgIHsgY291bnQ6ICd1c2VyMicgfSxcclxuICAgICAgICAgICAgeyBjb3VudDogJ3VzZXIzJyB9LFxyXG4gICAgICAgICAgXSksXHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcmVwb3NpdG9yeS5jb3VudCgpO1xyXG5cclxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZSgzKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG59KTtcclxuIl0sInZlcnNpb24iOjN9