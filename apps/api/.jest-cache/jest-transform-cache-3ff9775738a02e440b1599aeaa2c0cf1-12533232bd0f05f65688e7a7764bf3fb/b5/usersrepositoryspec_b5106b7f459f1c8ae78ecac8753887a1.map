{"file":"C:\\Users\\timur\\Programming\\Projects\\snippetforge\\apps\\api\\test\\unit\\repositories\\users.repository.spec.ts","mappings":"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","names":[],"sources":["C:\\Users\\timur\\Programming\\Projects\\snippetforge\\apps\\api\\test\\unit\\repositories\\users.repository.spec.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/unbound-method */\r\n/* eslint-disable @typescript-eslint/no-unsafe-assignment */\r\n// test/unit/repositories/users.repository.spec.ts\r\n\r\nimport { Test, TestingModule } from '@nestjs/testing';\r\nimport type { NewUser, User } from '../../../src/lib/db/schema';\r\nimport { UsersRepository } from '../../../src/modules/users/users.repository';\r\nimport { DatabaseService } from '../../../src/shared/database';\r\n\r\ndescribe('UsersRepository', () => {\r\n  let repository: UsersRepository;\r\n  let mockDbService: Partial<DatabaseService>;\r\n\r\n  const mockUser: User = {\r\n    id: 'test-id-123',\r\n    email: 'test@example.com',\r\n    username: 'testuser',\r\n    passwordHash: 'hashed-password',\r\n    role: 'USER',\r\n    createdAt: new Date(),\r\n    updatedAt: new Date(),\r\n    bio: null,\r\n    avatarUrl: null,\r\n  };\r\n\r\n  beforeEach(async () => {\r\n    mockDbService = {\r\n      drizzle: {\r\n        query: {\r\n          users: {\r\n            findFirst: jest.fn(),\r\n          },\r\n        },\r\n        insert: jest.fn().mockReturnValue({\r\n          values: jest.fn().mockReturnValue({\r\n            returning: jest.fn(),\r\n          }),\r\n        }),\r\n        update: jest.fn().mockReturnValue({\r\n          set: jest.fn().mockReturnValue({\r\n            where: jest.fn().mockReturnValue({\r\n              returning: jest.fn(),\r\n            }),\r\n          }),\r\n        }),\r\n        delete: jest.fn().mockReturnValue({\r\n          where: jest.fn().mockReturnValue({\r\n            returning: jest.fn(),\r\n          }),\r\n        }),\r\n        select: jest.fn().mockReturnValue({\r\n          from: jest.fn(),\r\n        }),\r\n      } as any,\r\n    };\r\n\r\n    const module: TestingModule = await Test.createTestingModule({\r\n      providers: [\r\n        UsersRepository,\r\n        {\r\n          provide: DatabaseService,\r\n          useValue: mockDbService,\r\n        },\r\n      ],\r\n    }).compile();\r\n\r\n    repository = module.get<UsersRepository>(UsersRepository);\r\n  });\r\n\r\n  describe('findById', () => {\r\n    it('should find user by ID', async () => {\r\n      (\r\n        mockDbService.drizzle!.query.users.findFirst as jest.Mock\r\n      ).mockResolvedValue(mockUser);\r\n\r\n      const result = await repository.findById('test-id-123');\r\n\r\n      expect(result).toEqual(mockUser);\r\n    });\r\n\r\n    it('should return null when user not found', async () => {\r\n      (\r\n        mockDbService.drizzle!.query.users.findFirst as jest.Mock\r\n      ).mockResolvedValue(undefined);\r\n\r\n      const result = await repository.findById('non-existent-id');\r\n\r\n      expect(result).toBeNull();\r\n    });\r\n  });\r\n\r\n  describe('findByEmail', () => {\r\n    it('should find user by email', async () => {\r\n      (\r\n        mockDbService.drizzle!.query.users.findFirst as jest.Mock\r\n      ).mockResolvedValue(mockUser);\r\n\r\n      const result = await repository.findByEmail('test@example.com');\r\n\r\n      expect(result).toEqual(mockUser);\r\n    });\r\n\r\n    it('should return null when email not found', async () => {\r\n      (\r\n        mockDbService.drizzle!.query.users.findFirst as jest.Mock\r\n      ).mockResolvedValue(undefined);\r\n\r\n      const result = await repository.findByEmail('nonexistent@example.com');\r\n\r\n      expect(result).toBeNull();\r\n    });\r\n  });\r\n\r\n  describe('findByUsername', () => {\r\n    it('should find user by username', async () => {\r\n      (\r\n        mockDbService.drizzle!.query.users.findFirst as jest.Mock\r\n      ).mockResolvedValue(mockUser);\r\n\r\n      const result = await repository.findByUsername('testuser');\r\n\r\n      expect(result).toEqual(mockUser);\r\n    });\r\n\r\n    it('should return null when username not found', async () => {\r\n      (\r\n        mockDbService.drizzle!.query.users.findFirst as jest.Mock\r\n      ).mockResolvedValue(undefined);\r\n\r\n      const result = await repository.findByUsername('nonexistent');\r\n\r\n      expect(result).toBeNull();\r\n    });\r\n  });\r\n\r\n  describe('findByEmailOrUsername', () => {\r\n    it('should find user by email or username', async () => {\r\n      (\r\n        mockDbService.drizzle!.query.users.findFirst as jest.Mock\r\n      ).mockResolvedValue(mockUser);\r\n\r\n      const result = await repository.findByEmailOrUsername(\r\n        'test@example.com',\r\n        'testuser',\r\n      );\r\n\r\n      expect(result).toEqual(mockUser);\r\n    });\r\n\r\n    it('should return null when neither exists', async () => {\r\n      (\r\n        mockDbService.drizzle!.query.users.findFirst as jest.Mock\r\n      ).mockResolvedValue(undefined);\r\n\r\n      const result = await repository.findByEmailOrUsername(\r\n        'new@example.com',\r\n        'newuser',\r\n      );\r\n\r\n      expect(result).toBeNull();\r\n    });\r\n  });\r\n\r\n  describe('create', () => {\r\n    it('should create new user', async () => {\r\n      const newUserData: NewUser = {\r\n        email: 'new@example.com',\r\n        username: 'newuser',\r\n        passwordHash: 'hashed',\r\n        role: 'USER',\r\n      };\r\n\r\n      const insertMock = mockDbService.drizzle!.insert as jest.Mock;\r\n      const valuesMock = jest.fn().mockReturnValue({\r\n        returning: jest.fn().mockResolvedValue([mockUser]),\r\n      });\r\n      insertMock.mockReturnValue({\r\n        values: valuesMock,\r\n      });\r\n\r\n      const result = await repository.create(newUserData);\r\n\r\n      expect(result).toEqual(mockUser);\r\n      expect(valuesMock).toHaveBeenCalledWith(\r\n        expect.objectContaining({\r\n          email: 'new@example.com',\r\n        }),\r\n      );\r\n    });\r\n  });\r\n\r\n  describe('update', () => {\r\n    it('should update user successfully', async () => {\r\n      const updateData = { username: 'updateduser' };\r\n\r\n      const updateMock = mockDbService.drizzle!.update as jest.Mock;\r\n      const setMock = jest.fn().mockReturnValue({\r\n        where: jest.fn().mockReturnValue({\r\n          returning: jest\r\n            .fn()\r\n            .mockResolvedValue([{ ...mockUser, ...updateData }]),\r\n        }),\r\n      });\r\n      updateMock.mockReturnValue({\r\n        set: setMock,\r\n      });\r\n\r\n      const result = await repository.update('test-id-123', updateData);\r\n\r\n      expect(result).toBeDefined();\r\n      expect(result?.username).toBe('updateduser');\r\n    });\r\n\r\n    it('should return null when user not found', async () => {\r\n      const updateMock = mockDbService.drizzle!.update as jest.Mock;\r\n      const setMock = jest.fn().mockReturnValue({\r\n        where: jest.fn().mockReturnValue({\r\n          returning: jest.fn().mockResolvedValue([]),\r\n        }),\r\n      });\r\n      updateMock.mockReturnValue({\r\n        set: setMock,\r\n      });\r\n\r\n      const result = await repository.update('non-existent-id', {\r\n        username: 'test',\r\n      });\r\n\r\n      expect(result).toBeNull();\r\n    });\r\n  });\r\n\r\n  describe('updatePassword', () => {\r\n    it('should update password successfully', async () => {\r\n      const updateMock = mockDbService.drizzle!.update as jest.Mock;\r\n      const setMock = jest.fn().mockReturnValue({\r\n        where: jest.fn().mockReturnValue({\r\n          returning: jest.fn().mockResolvedValue([{ id: 'test-id-123' }]),\r\n        }),\r\n      });\r\n      updateMock.mockReturnValue({\r\n        set: setMock,\r\n      });\r\n\r\n      const result = await repository.updatePassword('test-id-123', 'new-hash');\r\n\r\n      expect(result).toBe(true);\r\n    });\r\n\r\n    it('should return false when user not found', async () => {\r\n      const updateMock = mockDbService.drizzle!.update as jest.Mock;\r\n      const setMock = jest.fn().mockReturnValue({\r\n        where: jest.fn().mockReturnValue({\r\n          returning: jest.fn().mockResolvedValue([]),\r\n        }),\r\n      });\r\n      updateMock.mockReturnValue({\r\n        set: setMock,\r\n      });\r\n\r\n      const result = await repository.updatePassword(\r\n        'non-existent-id',\r\n        'new-hash',\r\n      );\r\n\r\n      expect(result).toBe(false);\r\n    });\r\n  });\r\n\r\n  describe('delete', () => {\r\n    it('should delete user successfully', async () => {\r\n      const deleteMock = mockDbService.drizzle!.delete as jest.Mock;\r\n      deleteMock.mockReturnValue({\r\n        where: jest.fn().mockReturnValue({\r\n          returning: jest.fn().mockResolvedValue([{ id: 'test-id-123' }]),\r\n        }),\r\n      });\r\n\r\n      const result = await repository.delete('test-id-123');\r\n\r\n      expect(result).toBe(true);\r\n    });\r\n\r\n    it('should return false when user not found', async () => {\r\n      const deleteMock = mockDbService.drizzle!.delete as jest.Mock;\r\n      deleteMock.mockReturnValue({\r\n        where: jest.fn().mockReturnValue({\r\n          returning: jest.fn().mockResolvedValue([]),\r\n        }),\r\n      });\r\n\r\n      const result = await repository.delete('non-existent-id');\r\n\r\n      expect(result).toBe(false);\r\n    });\r\n  });\r\n\r\n  describe('count', () => {\r\n    it('should return count of users', async () => {\r\n      const selectMock = mockDbService.drizzle!.select as jest.Mock;\r\n      selectMock.mockReturnValue({\r\n        from: jest\r\n          .fn()\r\n          .mockResolvedValue([\r\n            { count: 'user1' },\r\n            { count: 'user2' },\r\n            { count: 'user3' },\r\n          ]),\r\n      });\r\n\r\n      const result = await repository.count();\r\n\r\n      expect(result).toBe(3);\r\n    });\r\n  });\r\n});\r\n"],"version":3}