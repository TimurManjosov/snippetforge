ce96004a03e2c817ba7ad1a969566501
"use strict";
// test/unit/services/database.service.spec.ts
Object.defineProperty(exports, "__esModule", { value: true });
const config_1 = require("@nestjs/config");
const testing_1 = require("@nestjs/testing");
const database_service_1 = require("../../../src/shared/database/database.service");
describe('DatabaseService', () => {
    let service;
    let mockConfigService;
    let mockClient;
    beforeEach(async () => {
        // Mock postgres constructor
        jest.mock('postgres', () => {
            return jest.fn(() => mockClient);
        });
        mockClient = {
            end: jest.fn().mockResolvedValue(undefined),
            unsafe: jest.fn().mockResolvedValue([]),
        };
        mockConfigService = {
            get: jest.fn((key) => {
                if (key === 'DATABASE_URL')
                    return 'postgresql://test:test@localhost:5432/test';
                if (key === 'NODE_ENV')
                    return 'test';
                return undefined;
            }),
        };
        const module = await testing_1.Test.createTestingModule({
            providers: [
                database_service_1.DatabaseService,
                {
                    provide: config_1.ConfigService,
                    useValue: mockConfigService,
                },
            ],
        }).compile();
        service = module.get(database_service_1.DatabaseService);
    });
    describe('onModuleDestroy', () => {
        it('should close database connection', async () => {
            // Set up client
            service.client = mockClient;
            await service.onModuleDestroy();
            expect(mockClient.end).toHaveBeenCalled();
        });
        it('should handle missing client gracefully', async () => {
            service.client = null;
            await expect(service.onModuleDestroy()).resolves.not.toThrow();
        });
    });
    describe('drizzle getter', () => {
        it('should throw error when database not initialized', () => {
            expect(() => service.drizzle).toThrow('Database not initialized');
        });
    });
    describe('executeRaw', () => {
        it('should execute raw SQL', async () => {
            service.client = mockClient;
            mockClient.unsafe.mockResolvedValue([{ result: 'success' }]);
            const result = await service.executeRaw('SELECT 1');
            expect(result).toEqual([{ result: 'success' }]);
            expect(mockClient.unsafe).toHaveBeenCalledWith('SELECT 1');
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aW11clxcUHJvZ3JhbW1pbmdcXFByb2plY3RzXFxzbmlwcGV0Zm9yZ2VcXGFwcHNcXGFwaVxcdGVzdFxcdW5pdFxcc2VydmljZXNcXGRhdGFiYXNlLnNlcnZpY2Uuc3BlYy50cyIsIm1hcHBpbmdzIjoiO0FBQUEsOENBQThDOztBQUU5QywyQ0FBK0M7QUFDL0MsNkNBQXNEO0FBQ3RELG9GQUFnRjtBQUVoRixRQUFRLENBQUMsaUJBQWlCLEVBQUUsR0FBRyxFQUFFO0lBQy9CLElBQUksT0FBd0IsQ0FBQztJQUM3QixJQUFJLGlCQUF5QyxDQUFDO0lBQzlDLElBQUksVUFBZSxDQUFDO0lBRXBCLFVBQVUsQ0FBQyxLQUFLLElBQUksRUFBRTtRQU1wQiw0QkFBNEI7UUFDNUIsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsR0FBRyxFQUFFO1lBQ3pCLE9BQU8sSUFBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUNuQyxDQUFDLENBQUMsQ0FBQztRQVJILFVBQVUsR0FBRztZQUNYLEdBQUcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUMsU0FBUyxDQUFDO1lBQzNDLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUMsRUFBRSxDQUFDO1NBQ3hDLENBQUM7UUFPRixpQkFBaUIsR0FBRztZQUNsQixHQUFHLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEdBQVcsRUFBRSxFQUFFO2dCQUMzQixJQUFJLEdBQUcsS0FBSyxjQUFjO29CQUN4QixPQUFPLDRDQUE0QyxDQUFDO2dCQUN0RCxJQUFJLEdBQUcsS0FBSyxVQUFVO29CQUFFLE9BQU8sTUFBTSxDQUFDO2dCQUN0QyxPQUFPLFNBQVMsQ0FBQztZQUNuQixDQUFDLENBQUM7U0FDSCxDQUFDO1FBRUYsTUFBTSxNQUFNLEdBQWtCLE1BQU0sY0FBSSxDQUFDLG1CQUFtQixDQUFDO1lBQzNELFNBQVMsRUFBRTtnQkFDVCxrQ0FBZTtnQkFDZjtvQkFDRSxPQUFPLEVBQUUsc0JBQWE7b0JBQ3RCLFFBQVEsRUFBRSxpQkFBaUI7aUJBQzVCO2FBQ0Y7U0FDRixDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7UUFFYixPQUFPLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBa0Isa0NBQWUsQ0FBQyxDQUFDO0lBQ3pELENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLGlCQUFpQixFQUFFLEdBQUcsRUFBRTtRQUMvQixFQUFFLENBQUMsa0NBQWtDLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDaEQsZ0JBQWdCO1lBQ2YsT0FBZSxDQUFDLE1BQU0sR0FBRyxVQUFVLENBQUM7WUFFckMsTUFBTSxPQUFPLENBQUMsZUFBZSxFQUFFLENBQUM7WUFFaEMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBQzVDLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLHlDQUF5QyxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQ3RELE9BQWUsQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDO1lBRS9CLE1BQU0sTUFBTSxDQUFDLE9BQU8sQ0FBQyxlQUFlLEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDakUsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxnQkFBZ0IsRUFBRSxHQUFHLEVBQUU7UUFDOUIsRUFBRSxDQUFDLGtEQUFrRCxFQUFFLEdBQUcsRUFBRTtZQUMxRCxNQUFNLENBQUMsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLE9BQU8sQ0FBQywwQkFBMEIsQ0FBQyxDQUFDO1FBQ3BFLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsWUFBWSxFQUFFLEdBQUcsRUFBRTtRQUMxQixFQUFFLENBQUMsd0JBQXdCLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDckMsT0FBZSxDQUFDLE1BQU0sR0FBRyxVQUFVLENBQUM7WUFDckMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUU3RCxNQUFNLE1BQU0sR0FBRyxNQUFNLE9BQU8sQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLENBQUM7WUFFcEQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUNoRCxNQUFNLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDLG9CQUFvQixDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQzdELENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXHRpbXVyXFxQcm9ncmFtbWluZ1xcUHJvamVjdHNcXHNuaXBwZXRmb3JnZVxcYXBwc1xcYXBpXFx0ZXN0XFx1bml0XFxzZXJ2aWNlc1xcZGF0YWJhc2Uuc2VydmljZS5zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIHRlc3QvdW5pdC9zZXJ2aWNlcy9kYXRhYmFzZS5zZXJ2aWNlLnNwZWMudHNcclxuXHJcbmltcG9ydCB7IENvbmZpZ1NlcnZpY2UgfSBmcm9tICdAbmVzdGpzL2NvbmZpZyc7XHJcbmltcG9ydCB7IFRlc3QsIFRlc3RpbmdNb2R1bGUgfSBmcm9tICdAbmVzdGpzL3Rlc3RpbmcnO1xyXG5pbXBvcnQgeyBEYXRhYmFzZVNlcnZpY2UgfSBmcm9tICcuLi8uLi8uLi9zcmMvc2hhcmVkL2RhdGFiYXNlL2RhdGFiYXNlLnNlcnZpY2UnO1xyXG5cclxuZGVzY3JpYmUoJ0RhdGFiYXNlU2VydmljZScsICgpID0+IHtcclxuICBsZXQgc2VydmljZTogRGF0YWJhc2VTZXJ2aWNlO1xyXG4gIGxldCBtb2NrQ29uZmlnU2VydmljZTogUGFydGlhbDxDb25maWdTZXJ2aWNlPjtcclxuICBsZXQgbW9ja0NsaWVudDogYW55O1xyXG5cclxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcclxuICAgIG1vY2tDbGllbnQgPSB7XHJcbiAgICAgIGVuZDogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHVuZGVmaW5lZCksXHJcbiAgICAgIHVuc2FmZTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKFtdKSxcclxuICAgIH07XHJcblxyXG4gICAgLy8gTW9jayBwb3N0Z3JlcyBjb25zdHJ1Y3RvclxyXG4gICAgamVzdC5tb2NrKCdwb3N0Z3JlcycsICgpID0+IHtcclxuICAgICAgcmV0dXJuIGplc3QuZm4oKCkgPT4gbW9ja0NsaWVudCk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBtb2NrQ29uZmlnU2VydmljZSA9IHtcclxuICAgICAgZ2V0OiBqZXN0LmZuKChrZXk6IHN0cmluZykgPT4ge1xyXG4gICAgICAgIGlmIChrZXkgPT09ICdEQVRBQkFTRV9VUkwnKVxyXG4gICAgICAgICAgcmV0dXJuICdwb3N0Z3Jlc3FsOi8vdGVzdDp0ZXN0QGxvY2FsaG9zdDo1NDMyL3Rlc3QnO1xyXG4gICAgICAgIGlmIChrZXkgPT09ICdOT0RFX0VOVicpIHJldHVybiAndGVzdCc7XHJcbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICAgICAgfSksXHJcbiAgICB9O1xyXG5cclxuICAgIGNvbnN0IG1vZHVsZTogVGVzdGluZ01vZHVsZSA9IGF3YWl0IFRlc3QuY3JlYXRlVGVzdGluZ01vZHVsZSh7XHJcbiAgICAgIHByb3ZpZGVyczogW1xyXG4gICAgICAgIERhdGFiYXNlU2VydmljZSxcclxuICAgICAgICB7XHJcbiAgICAgICAgICBwcm92aWRlOiBDb25maWdTZXJ2aWNlLFxyXG4gICAgICAgICAgdXNlVmFsdWU6IG1vY2tDb25maWdTZXJ2aWNlLFxyXG4gICAgICAgIH0sXHJcbiAgICAgIF0sXHJcbiAgICB9KS5jb21waWxlKCk7XHJcblxyXG4gICAgc2VydmljZSA9IG1vZHVsZS5nZXQ8RGF0YWJhc2VTZXJ2aWNlPihEYXRhYmFzZVNlcnZpY2UpO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnb25Nb2R1bGVEZXN0cm95JywgKCkgPT4ge1xyXG4gICAgaXQoJ3Nob3VsZCBjbG9zZSBkYXRhYmFzZSBjb25uZWN0aW9uJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAvLyBTZXQgdXAgY2xpZW50XHJcbiAgICAgIChzZXJ2aWNlIGFzIGFueSkuY2xpZW50ID0gbW9ja0NsaWVudDtcclxuXHJcbiAgICAgIGF3YWl0IHNlcnZpY2Uub25Nb2R1bGVEZXN0cm95KCk7XHJcblxyXG4gICAgICBleHBlY3QobW9ja0NsaWVudC5lbmQpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdzaG91bGQgaGFuZGxlIG1pc3NpbmcgY2xpZW50IGdyYWNlZnVsbHknLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIChzZXJ2aWNlIGFzIGFueSkuY2xpZW50ID0gbnVsbDtcclxuXHJcbiAgICAgIGF3YWl0IGV4cGVjdChzZXJ2aWNlLm9uTW9kdWxlRGVzdHJveSgpKS5yZXNvbHZlcy5ub3QudG9UaHJvdygpO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdkcml6emxlIGdldHRlcicsICgpID0+IHtcclxuICAgIGl0KCdzaG91bGQgdGhyb3cgZXJyb3Igd2hlbiBkYXRhYmFzZSBub3QgaW5pdGlhbGl6ZWQnLCAoKSA9PiB7XHJcbiAgICAgIGV4cGVjdCgoKSA9PiBzZXJ2aWNlLmRyaXp6bGUpLnRvVGhyb3coJ0RhdGFiYXNlIG5vdCBpbml0aWFsaXplZCcpO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdleGVjdXRlUmF3JywgKCkgPT4ge1xyXG4gICAgaXQoJ3Nob3VsZCBleGVjdXRlIHJhdyBTUUwnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIChzZXJ2aWNlIGFzIGFueSkuY2xpZW50ID0gbW9ja0NsaWVudDtcclxuICAgICAgbW9ja0NsaWVudC51bnNhZmUubW9ja1Jlc29sdmVkVmFsdWUoW3sgcmVzdWx0OiAnc3VjY2VzcycgfV0pO1xyXG5cclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc2VydmljZS5leGVjdXRlUmF3KCdTRUxFQ1QgMScpO1xyXG5cclxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbChbeyByZXN1bHQ6ICdzdWNjZXNzJyB9XSk7XHJcbiAgICAgIGV4cGVjdChtb2NrQ2xpZW50LnVuc2FmZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ1NFTEVDVCAxJyk7XHJcbiAgICB9KTtcclxuICB9KTtcclxufSk7XHJcbiJdLCJ2ZXJzaW9uIjozfQ==