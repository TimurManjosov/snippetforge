{"file":"C:\\Users\\timur\\Programming\\Projects\\snippetforge\\apps\\api\\src\\modules\\users\\users.repository.ts","mappings":"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","names":[],"sources":["C:\\Users\\timur\\Programming\\Projects\\snippetforge\\apps\\api\\src\\modules\\users\\users.repository.ts"],"sourcesContent":["// src/modules/users/users.repository.ts\r\n\r\nimport { Injectable, Logger } from '@nestjs/common';\r\nimport { eq, or } from 'drizzle-orm';\r\nimport { users, type NewUser, type User } from '../../lib/db/schema';\r\nimport { DatabaseService } from '../../shared/database';\r\n\r\n/**\r\n * UsersRepository - Data Access Layer für User-Entity\r\n *\r\n * VERANTWORTLICHKEITEN (Single Responsibility):\r\n * - Alle Datenbank-Queries für Users\r\n * - Keine Business Logic (kein Hashing, keine Validation)\r\n * - Keine HTTP-Concerns (keine Exceptions werfen)\r\n *\r\n * WARUM Repository Pattern?\r\n * 1. Testbarkeit: Repository kann gemockt werden\r\n * 2. Austauschbarkeit: DB-Wechsel betrifft nur Repository\r\n * 3. Klarheit: Service enthält nur Business Logic\r\n *\r\n * RETURN VALUES:\r\n * - Gefunden: User-Objekt\r\n * - Nicht gefunden: null (NICHT undefined!)\r\n * - Fehler: Exception wird geworfen (DB-Errors)\r\n */\r\n@Injectable()\r\nexport class UsersRepository {\r\n  private readonly logger = new Logger(UsersRepository.name);\r\n\r\n  constructor(private readonly db: DatabaseService) {}\r\n\r\n  /**\r\n   * Findet User anhand der ID\r\n   *\r\n   * @param id - UUID des Users\r\n   * @returns User oder null wenn nicht gefunden\r\n   */\r\n  async findById(id: string): Promise<User | null> {\r\n    this.logger.debug(`Finding user by ID: ${id}`);\r\n\r\n    const result = await this.db.drizzle.query.users.findFirst({\r\n      where: eq(users.id, id),\r\n    });\r\n\r\n    return result ?? null;\r\n  }\r\n\r\n  /**\r\n   * Findet User anhand der Email\r\n   * Verwendet für Login und Email-Uniqueness-Check\r\n   *\r\n   * @param email - Email-Adresse (case-insensitive durch DB)\r\n   * @returns User oder null wenn nicht gefunden\r\n   */\r\n  async findByEmail(email: string): Promise<User | null> {\r\n    this.logger.debug(`Finding user by email: ${email}`);\r\n\r\n    const result = await this.db.drizzle.query.users.findFirst({\r\n      where: eq(users.email, email.toLowerCase()),\r\n    });\r\n\r\n    return result ?? null;\r\n  }\r\n\r\n  /**\r\n   * Findet User anhand des Usernamens\r\n   * Verwendet für Username-Uniqueness-Check\r\n   *\r\n   * @param username - Username (case-sensitive)\r\n   * @returns User oder null wenn nicht gefunden\r\n   */\r\n  async findByUsername(username: string): Promise<User | null> {\r\n    this.logger.debug(`Finding user by username: ${username}`);\r\n\r\n    const result = await this.db.drizzle.query.users.findFirst({\r\n      where: eq(users.username, username),\r\n    });\r\n\r\n    return result ?? null;\r\n  }\r\n\r\n  /**\r\n   * Prüft ob Email ODER Username bereits existieren\r\n   * Verwendet bei Registration um Duplikate zu verhindern\r\n   *\r\n   * @param email - Email zu prüfen\r\n   * @param username - Username zu prüfen\r\n   * @returns User wenn einer existiert, sonst null\r\n   */\r\n  async findByEmailOrUsername(\r\n    email: string,\r\n    username: string,\r\n  ): Promise<User | null> {\r\n    this.logger.debug(\r\n      `Checking if email or username exists: ${email}, ${username}`,\r\n    );\r\n\r\n    const result = await this.db.drizzle.query.users.findFirst({\r\n      where: or(\r\n        eq(users.email, email.toLowerCase()),\r\n        eq(users.username, username),\r\n      ),\r\n    });\r\n\r\n    return result ?? null;\r\n  }\r\n\r\n  /**\r\n   * Erstellt neuen User in der Datenbank\r\n   *\r\n   * WICHTIG:\r\n   * - data.passwordHash muss BEREITS gehasht sein!\r\n   * - Email wird automatisch lowercase gespeichert\r\n   *\r\n   * @param data - User-Daten (mit passwordHash, NICHT password!)\r\n   * @returns Erstellter User\r\n   * @throws Bei Constraint-Violation (Duplicate Email/Username)\r\n   */\r\n  async create(data: NewUser): Promise<User> {\r\n    this.logger.debug(`Creating new user: ${data.email}`);\r\n\r\n    const [newUser] = await this.db.drizzle\r\n      .insert(users)\r\n      .values({\r\n        ...data,\r\n        email: data.email.toLowerCase(), // Normalisierung\r\n      })\r\n      .returning();\r\n\r\n    this.logger.log(`User created successfully: ${newUser.id}`);\r\n    return newUser;\r\n  }\r\n\r\n  /**\r\n   * Aktualisiert User-Daten\r\n   *\r\n   * @param id - UUID des Users\r\n   * @param data - Zu aktualisierende Felder\r\n   * @returns Aktualisierter User oder null wenn nicht gefunden\r\n   */\r\n  async update(id: string, data: Partial<NewUser>): Promise<User | null> {\r\n    this.logger.debug(`Updating user: ${id}`);\r\n\r\n    const [updatedUser] = await this.db.drizzle\r\n      .update(users)\r\n      .set({\r\n        ...data,\r\n        updatedAt: new Date(), // Timestamp aktualisieren\r\n      })\r\n      .where(eq(users.id, id))\r\n      .returning();\r\n\r\n    if (!updatedUser) {\r\n      this.logger.warn(`User not found for update: ${id}`);\r\n      return null;\r\n    }\r\n\r\n    this.logger.log(`User updated successfully: ${id}`);\r\n    return updatedUser;\r\n  }\r\n\r\n  /**\r\n   * Aktualisiert nur das Passwort eines Users\r\n   * Separatiert von update() für Klarheit und Audit-Logging\r\n   *\r\n   * @param id - UUID des Users\r\n   * @param passwordHash - Neuer Password Hash (BEREITS gehasht!)\r\n   * @returns true wenn erfolgreich, false wenn User nicht gefunden\r\n   */\r\n  async updatePassword(id: string, passwordHash: string): Promise<boolean> {\r\n    this.logger.debug(`Updating password for user: ${id}`);\r\n\r\n    const result = await this.db.drizzle\r\n      .update(users)\r\n      .set({\r\n        passwordHash,\r\n        updatedAt: new Date(),\r\n      })\r\n      .where(eq(users.id, id))\r\n      .returning({ id: users.id });\r\n\r\n    if (result.length === 0) {\r\n      this.logger.warn(`User not found for password update: ${id}`);\r\n      return false;\r\n    }\r\n\r\n    this.logger.log(`Password updated successfully for user: ${id}`);\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Löscht User (Hard Delete)\r\n   *\r\n   * WARNUNG: In Production besser Soft Delete verwenden!\r\n   * (isDeleted Flag statt echtem Löschen)\r\n   *\r\n   * @param id - UUID des Users\r\n   * @returns true wenn gelöscht, false wenn nicht gefunden\r\n   */\r\n  async delete(id: string): Promise<boolean> {\r\n    this.logger.debug(`Deleting user: ${id}`);\r\n\r\n    const result = await this.db.drizzle\r\n      .delete(users)\r\n      .where(eq(users.id, id))\r\n      .returning({ id: users.id });\r\n\r\n    if (result.length === 0) {\r\n      this.logger.warn(`User not found for deletion: ${id}`);\r\n      return false;\r\n    }\r\n\r\n    this.logger.log(`User deleted successfully: ${id}`);\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Zählt alle User (für Admin-Dashboard)\r\n   *\r\n   * @returns Anzahl der User\r\n   */\r\n  async count(): Promise<number> {\r\n    const result = await this.db.drizzle\r\n      .select({ count: users.id })\r\n      .from(users);\r\n\r\n    // Drizzle gibt Array zurück, wir brauchen Länge\r\n    return result.length;\r\n  }\r\n}\r\n"],"version":3}