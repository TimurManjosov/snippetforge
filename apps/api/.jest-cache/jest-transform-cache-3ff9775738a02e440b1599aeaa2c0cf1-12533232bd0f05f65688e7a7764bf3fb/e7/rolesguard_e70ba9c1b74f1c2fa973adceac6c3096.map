{"file":"C:\\Users\\timur\\Programming\\Projects\\snippetforge\\apps\\api\\src\\modules\\auth\\guards\\roles.guard.ts","mappings":";AAAA,yCAAyC;;;;;;;;;;;;;;AAEzC,2CAMwB;AACxB,uCAAyC;AAGzC,mEAA0D;AAE1D;;;;;;;;;;;;;;;;;;;;;;;GAuBG;AAEI,IAAM,UAAU,kBAAhB,MAAM,UAAU;IAGD;IAFH,MAAM,GAAG,IAAI,eAAM,CAAC,YAAU,CAAC,IAAI,CAAC,CAAC;IAEtD,YAAoB,SAAoB;QAApB,cAAS,GAAT,SAAS,CAAW;IAAG,CAAC;IAE5C;;;;;;OAMG;IACH,WAAW,CAAC,OAAyB;QACnC,+CAA+C;QAC/C,MAAM,aAAa,GAAG,IAAI,CAAC,SAAS,CAAC,iBAAiB,CACpD,2BAAS,EACT,CAAC,OAAO,CAAC,UAAU,EAAE,EAAE,OAAO,CAAC,QAAQ,EAAE,CAAC,CAC3C,CAAC;QAEF,gDAAgD;QAChD,IAAI,CAAC,aAAa,IAAI,aAAa,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;YACjD,OAAO,IAAI,CAAC;QACd,CAAC;QAED,4DAA4D;QAC5D,MAAM,OAAO,GAAG,OAAO,CAAC,YAAY,EAAE,CAAC,UAAU,EAAW,CAAC;QAC7D,MAAM,IAAI,GAAG,OAAO,CAAC,IAA4B,CAAC;QAElD,wEAAwE;QACxE,IAAI,CAAC,IAAI,EAAE,CAAC;YACV,IAAI,CAAC,MAAM,CAAC,KAAK,CACf,6DAA6D,CAC9D,CAAC;YACF,MAAM,IAAI,2BAAkB,CAAC,yBAAyB,CAAC,CAAC;QAC1D,CAAC;QAED,iDAAiD;QACjD,MAAM,OAAO,GAAG,aAAa,CAAC,QAAQ,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAElD,IAAI,CAAC,OAAO,EAAE,CAAC;YACb,IAAI,CAAC,MAAM,CAAC,IAAI,CACd,uBAAuB,IAAI,CAAC,EAAE,cAAc,IAAI,CAAC,IAAI,GAAG;gBACtD,mCAAmC,aAAa,CAAC,IAAI,CAAC,MAAM,CAAC,EAAE,CAClE,CAAC;YACF,MAAM,IAAI,2BAAkB,CAC1B,iCAAiC,aAAa,CAAC,IAAI,CAAC,MAAM,CAAC,EAAE,CAC9D,CAAC;QACJ,CAAC;QAED,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,wBAAwB,IAAI,CAAC,EAAE,cAAc,IAAI,CAAC,IAAI,EAAE,CAAC,CAAC;QAC5E,OAAO,IAAI,CAAC;IACd,CAAC;CACF,CAAA;AApDY,gCAAU;qBAAV,UAAU;IADtB,IAAA,mBAAU,GAAE;yDAIoB,gBAAS,oBAAT,gBAAS;GAH7B,UAAU,CAoDtB","names":[],"sources":["C:\\Users\\timur\\Programming\\Projects\\snippetforge\\apps\\api\\src\\modules\\auth\\guards\\roles.guard.ts"],"sourcesContent":["// src/modules/auth/guards/roles.guard.ts\r\n\r\nimport {\r\n  CanActivate,\r\n  ExecutionContext,\r\n  ForbiddenException,\r\n  Injectable,\r\n  Logger,\r\n} from '@nestjs/common';\r\nimport { Reflector } from '@nestjs/core';\r\nimport { Request } from 'express';\r\nimport { type SafeUser } from '../../users';\r\nimport { ROLES_KEY } from '../decorators/roles.decorator';\r\n\r\n/**\r\n * RolesGuard - Role-Based Access Control (RBAC)\r\n *\r\n * WIE ES FUNKTIONIERT:\r\n * 1. Route ist mit @Roles('ADMIN', 'MODERATOR') dekoriert\r\n * 2. User ist bereits authentifiziert (JwtAuthGuard lief vorher)\r\n * 3. RolesGuard prüft ob user.role in erlaubten Rollen ist\r\n * 4. Wenn ja: Route wird ausgeführt\r\n * 5. Wenn nein: 403 Forbidden\r\n *\r\n * WICHTIG: RolesGuard muss NACH JwtAuthGuard kommen!\r\n * @UseGuards(JwtAuthGuard, RolesGuard) ← Richtige Reihenfolge\r\n *\r\n * VERWENDUNG:\r\n * @Roles('ADMIN')\r\n * @UseGuards(JwtAuthGuard, RolesGuard)\r\n * @Delete('users/:id')\r\n * deleteUser() {}\r\n *\r\n * @Roles('ADMIN', 'MODERATOR')  // Einer von beiden reicht\r\n * @UseGuards(JwtAuthGuard, RolesGuard)\r\n * @Put('posts/:id/moderate')\r\n * moderatePost() {}\r\n */\r\n@Injectable()\r\nexport class RolesGuard implements CanActivate {\r\n  private readonly logger = new Logger(RolesGuard.name);\r\n\r\n  constructor(private reflector: Reflector) {}\r\n\r\n  /**\r\n   * canActivate - Prüft ob User die erforderliche Rolle hat\r\n   *\r\n   * @param context - Execution Context\r\n   * @returns true wenn erlaubt\r\n   * @throws ForbiddenException wenn Rolle nicht ausreicht\r\n   */\r\n  canActivate(context: ExecutionContext): boolean {\r\n    // 1. Hole erlaubte Rollen von Route/Controller\r\n    const requiredRoles = this.reflector.getAllAndOverride<string[]>(\r\n      ROLES_KEY,\r\n      [context.getHandler(), context.getClass()],\r\n    );\r\n\r\n    // 2. Wenn keine Rollen definiert, alle erlauben\r\n    if (!requiredRoles || requiredRoles.length === 0) {\r\n      return true;\r\n    }\r\n\r\n    // 3. Hole User aus Request (wurde von JwtAuthGuard gesetzt)\r\n    const request = context.switchToHttp().getRequest<Request>();\r\n    const user = request.user as SafeUser | undefined;\r\n\r\n    // 4. Defensive Check: User sollte existieren (JwtAuthGuard lief vorher)\r\n    if (!user) {\r\n      this.logger.error(\r\n        'RolesGuard: No user found in request. JwtAuthGuard missing?',\r\n      );\r\n      throw new ForbiddenException('Authentication required');\r\n    }\r\n\r\n    // 5. Prüfe ob User-Rolle in erlaubten Rollen ist\r\n    const hasRole = requiredRoles.includes(user.role);\r\n\r\n    if (!hasRole) {\r\n      this.logger.warn(\r\n        `Access denied: User ${user.id} with role ${user.role} ` +\r\n          `tried to access route requiring ${requiredRoles.join(' or ')}`,\r\n      );\r\n      throw new ForbiddenException(\r\n        `Access denied. Required role: ${requiredRoles.join(' or ')}`,\r\n      );\r\n    }\r\n\r\n    this.logger.debug(`Access granted: User ${user.id} with role ${user.role}`);\r\n    return true;\r\n  }\r\n}\r\n"],"version":3}