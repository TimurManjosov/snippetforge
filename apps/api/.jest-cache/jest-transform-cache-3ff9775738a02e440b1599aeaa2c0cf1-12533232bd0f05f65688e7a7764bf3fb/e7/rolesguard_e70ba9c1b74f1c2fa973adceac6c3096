af80c0bc6d28e6f78c63a616498b93c2
"use strict";
// src/modules/auth/guards/roles.guard.ts
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var RolesGuard_1;
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.RolesGuard = void 0;
const common_1 = require("@nestjs/common");
const core_1 = require("@nestjs/core");
const roles_decorator_1 = require("../decorators/roles.decorator");
/**
 * RolesGuard - Role-Based Access Control (RBAC)
 *
 * WIE ES FUNKTIONIERT:
 * 1. Route ist mit @Roles('ADMIN', 'MODERATOR') dekoriert
 * 2. User ist bereits authentifiziert (JwtAuthGuard lief vorher)
 * 3. RolesGuard prüft ob user.role in erlaubten Rollen ist
 * 4. Wenn ja: Route wird ausgeführt
 * 5. Wenn nein: 403 Forbidden
 *
 * WICHTIG: RolesGuard muss NACH JwtAuthGuard kommen!
 * @UseGuards(JwtAuthGuard, RolesGuard) ← Richtige Reihenfolge
 *
 * VERWENDUNG:
 * @Roles('ADMIN')
 * @UseGuards(JwtAuthGuard, RolesGuard)
 * @Delete('users/:id')
 * deleteUser() {}
 *
 * @Roles('ADMIN', 'MODERATOR')  // Einer von beiden reicht
 * @UseGuards(JwtAuthGuard, RolesGuard)
 * @Put('posts/:id/moderate')
 * moderatePost() {}
 */
let RolesGuard = RolesGuard_1 = class RolesGuard {
    reflector;
    logger = new common_1.Logger(RolesGuard_1.name);
    constructor(reflector) {
        this.reflector = reflector;
    }
    /**
     * canActivate - Prüft ob User die erforderliche Rolle hat
     *
     * @param context - Execution Context
     * @returns true wenn erlaubt
     * @throws ForbiddenException wenn Rolle nicht ausreicht
     */
    canActivate(context) {
        // 1. Hole erlaubte Rollen von Route/Controller
        const requiredRoles = this.reflector.getAllAndOverride(roles_decorator_1.ROLES_KEY, [context.getHandler(), context.getClass()]);
        // 2. Wenn keine Rollen definiert, alle erlauben
        if (!requiredRoles || requiredRoles.length === 0) {
            return true;
        }
        // 3. Hole User aus Request (wurde von JwtAuthGuard gesetzt)
        const request = context.switchToHttp().getRequest();
        const user = request.user;
        // 4. Defensive Check: User sollte existieren (JwtAuthGuard lief vorher)
        if (!user) {
            this.logger.error('RolesGuard: No user found in request. JwtAuthGuard missing?');
            throw new common_1.ForbiddenException('Authentication required');
        }
        // 5. Prüfe ob User-Rolle in erlaubten Rollen ist
        const hasRole = requiredRoles.includes(user.role);
        if (!hasRole) {
            this.logger.warn(`Access denied: User ${user.id} with role ${user.role} ` +
                `tried to access route requiring ${requiredRoles.join(' or ')}`);
            throw new common_1.ForbiddenException(`Access denied. Required role: ${requiredRoles.join(' or ')}`);
        }
        this.logger.debug(`Access granted: User ${user.id} with role ${user.role}`);
        return true;
    }
};
exports.RolesGuard = RolesGuard;
exports.RolesGuard = RolesGuard = RolesGuard_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof core_1.Reflector !== "undefined" && core_1.Reflector) === "function" ? _a : Object])
], RolesGuard);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aW11clxcUHJvZ3JhbW1pbmdcXFByb2plY3RzXFxzbmlwcGV0Zm9yZ2VcXGFwcHNcXGFwaVxcc3JjXFxtb2R1bGVzXFxhdXRoXFxndWFyZHNcXHJvbGVzLmd1YXJkLnRzIiwibWFwcGluZ3MiOiI7QUFBQSx5Q0FBeUM7Ozs7Ozs7Ozs7Ozs7O0FBRXpDLDJDQU13QjtBQUN4Qix1Q0FBeUM7QUFHekMsbUVBQTBEO0FBRTFEOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQXVCRztBQUVJLElBQU0sVUFBVSxrQkFBaEIsTUFBTSxVQUFVO0lBR0Q7SUFGSCxNQUFNLEdBQUcsSUFBSSxlQUFNLENBQUMsWUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBRXRELFlBQW9CLFNBQW9CO1FBQXBCLGNBQVMsR0FBVCxTQUFTLENBQVc7SUFBRyxDQUFDO0lBRTVDOzs7Ozs7T0FNRztJQUNILFdBQVcsQ0FBQyxPQUF5QjtRQUNuQywrQ0FBK0M7UUFDL0MsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxpQkFBaUIsQ0FDcEQsMkJBQVMsRUFDVCxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsRUFBRSxPQUFPLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FDM0MsQ0FBQztRQUVGLGdEQUFnRDtRQUNoRCxJQUFJLENBQUMsYUFBYSxJQUFJLGFBQWEsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFLENBQUM7WUFDakQsT0FBTyxJQUFJLENBQUM7UUFDZCxDQUFDO1FBRUQsNERBQTREO1FBQzVELE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxZQUFZLEVBQUUsQ0FBQyxVQUFVLEVBQVcsQ0FBQztRQUM3RCxNQUFNLElBQUksR0FBRyxPQUFPLENBQUMsSUFBNEIsQ0FBQztRQUVsRCx3RUFBd0U7UUFDeEUsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ1YsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQ2YsNkRBQTZELENBQzlELENBQUM7WUFDRixNQUFNLElBQUksMkJBQWtCLENBQUMseUJBQXlCLENBQUMsQ0FBQztRQUMxRCxDQUFDO1FBRUQsaURBQWlEO1FBQ2pELE1BQU0sT0FBTyxHQUFHLGFBQWEsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRWxELElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUNiLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUNkLHVCQUF1QixJQUFJLENBQUMsRUFBRSxjQUFjLElBQUksQ0FBQyxJQUFJLEdBQUc7Z0JBQ3RELG1DQUFtQyxhQUFhLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQ2xFLENBQUM7WUFDRixNQUFNLElBQUksMkJBQWtCLENBQzFCLGlDQUFpQyxhQUFhLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQzlELENBQUM7UUFDSixDQUFDO1FBRUQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsd0JBQXdCLElBQUksQ0FBQyxFQUFFLGNBQWMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7UUFDNUUsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0NBQ0YsQ0FBQTtBQXBEWSxnQ0FBVTtxQkFBVixVQUFVO0lBRHRCLElBQUEsbUJBQVUsR0FBRTt5REFJb0IsZ0JBQVMsb0JBQVQsZ0JBQVM7R0FIN0IsVUFBVSxDQW9EdEIiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFx0aW11clxcUHJvZ3JhbW1pbmdcXFByb2plY3RzXFxzbmlwcGV0Zm9yZ2VcXGFwcHNcXGFwaVxcc3JjXFxtb2R1bGVzXFxhdXRoXFxndWFyZHNcXHJvbGVzLmd1YXJkLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIHNyYy9tb2R1bGVzL2F1dGgvZ3VhcmRzL3JvbGVzLmd1YXJkLnRzXHJcblxyXG5pbXBvcnQge1xyXG4gIENhbkFjdGl2YXRlLFxyXG4gIEV4ZWN1dGlvbkNvbnRleHQsXHJcbiAgRm9yYmlkZGVuRXhjZXB0aW9uLFxyXG4gIEluamVjdGFibGUsXHJcbiAgTG9nZ2VyLFxyXG59IGZyb20gJ0BuZXN0anMvY29tbW9uJztcclxuaW1wb3J0IHsgUmVmbGVjdG9yIH0gZnJvbSAnQG5lc3Rqcy9jb3JlJztcclxuaW1wb3J0IHsgUmVxdWVzdCB9IGZyb20gJ2V4cHJlc3MnO1xyXG5pbXBvcnQgeyB0eXBlIFNhZmVVc2VyIH0gZnJvbSAnLi4vLi4vdXNlcnMnO1xyXG5pbXBvcnQgeyBST0xFU19LRVkgfSBmcm9tICcuLi9kZWNvcmF0b3JzL3JvbGVzLmRlY29yYXRvcic7XHJcblxyXG4vKipcclxuICogUm9sZXNHdWFyZCAtIFJvbGUtQmFzZWQgQWNjZXNzIENvbnRyb2wgKFJCQUMpXHJcbiAqXHJcbiAqIFdJRSBFUyBGVU5LVElPTklFUlQ6XHJcbiAqIDEuIFJvdXRlIGlzdCBtaXQgQFJvbGVzKCdBRE1JTicsICdNT0RFUkFUT1InKSBkZWtvcmllcnRcclxuICogMi4gVXNlciBpc3QgYmVyZWl0cyBhdXRoZW50aWZpemllcnQgKEp3dEF1dGhHdWFyZCBsaWVmIHZvcmhlcilcclxuICogMy4gUm9sZXNHdWFyZCBwcsO8ZnQgb2IgdXNlci5yb2xlIGluIGVybGF1YnRlbiBSb2xsZW4gaXN0XHJcbiAqIDQuIFdlbm4gamE6IFJvdXRlIHdpcmQgYXVzZ2Vmw7xocnRcclxuICogNS4gV2VubiBuZWluOiA0MDMgRm9yYmlkZGVuXHJcbiAqXHJcbiAqIFdJQ0hUSUc6IFJvbGVzR3VhcmQgbXVzcyBOQUNIIEp3dEF1dGhHdWFyZCBrb21tZW4hXHJcbiAqIEBVc2VHdWFyZHMoSnd0QXV0aEd1YXJkLCBSb2xlc0d1YXJkKSDihpAgUmljaHRpZ2UgUmVpaGVuZm9sZ2VcclxuICpcclxuICogVkVSV0VORFVORzpcclxuICogQFJvbGVzKCdBRE1JTicpXHJcbiAqIEBVc2VHdWFyZHMoSnd0QXV0aEd1YXJkLCBSb2xlc0d1YXJkKVxyXG4gKiBARGVsZXRlKCd1c2Vycy86aWQnKVxyXG4gKiBkZWxldGVVc2VyKCkge31cclxuICpcclxuICogQFJvbGVzKCdBRE1JTicsICdNT0RFUkFUT1InKSAgLy8gRWluZXIgdm9uIGJlaWRlbiByZWljaHRcclxuICogQFVzZUd1YXJkcyhKd3RBdXRoR3VhcmQsIFJvbGVzR3VhcmQpXHJcbiAqIEBQdXQoJ3Bvc3RzLzppZC9tb2RlcmF0ZScpXHJcbiAqIG1vZGVyYXRlUG9zdCgpIHt9XHJcbiAqL1xyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBSb2xlc0d1YXJkIGltcGxlbWVudHMgQ2FuQWN0aXZhdGUge1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgbG9nZ2VyID0gbmV3IExvZ2dlcihSb2xlc0d1YXJkLm5hbWUpO1xyXG5cclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlZmxlY3RvcjogUmVmbGVjdG9yKSB7fVxyXG5cclxuICAvKipcclxuICAgKiBjYW5BY3RpdmF0ZSAtIFByw7xmdCBvYiBVc2VyIGRpZSBlcmZvcmRlcmxpY2hlIFJvbGxlIGhhdFxyXG4gICAqXHJcbiAgICogQHBhcmFtIGNvbnRleHQgLSBFeGVjdXRpb24gQ29udGV4dFxyXG4gICAqIEByZXR1cm5zIHRydWUgd2VubiBlcmxhdWJ0XHJcbiAgICogQHRocm93cyBGb3JiaWRkZW5FeGNlcHRpb24gd2VubiBSb2xsZSBuaWNodCBhdXNyZWljaHRcclxuICAgKi9cclxuICBjYW5BY3RpdmF0ZShjb250ZXh0OiBFeGVjdXRpb25Db250ZXh0KTogYm9vbGVhbiB7XHJcbiAgICAvLyAxLiBIb2xlIGVybGF1YnRlIFJvbGxlbiB2b24gUm91dGUvQ29udHJvbGxlclxyXG4gICAgY29uc3QgcmVxdWlyZWRSb2xlcyA9IHRoaXMucmVmbGVjdG9yLmdldEFsbEFuZE92ZXJyaWRlPHN0cmluZ1tdPihcclxuICAgICAgUk9MRVNfS0VZLFxyXG4gICAgICBbY29udGV4dC5nZXRIYW5kbGVyKCksIGNvbnRleHQuZ2V0Q2xhc3MoKV0sXHJcbiAgICApO1xyXG5cclxuICAgIC8vIDIuIFdlbm4ga2VpbmUgUm9sbGVuIGRlZmluaWVydCwgYWxsZSBlcmxhdWJlblxyXG4gICAgaWYgKCFyZXF1aXJlZFJvbGVzIHx8IHJlcXVpcmVkUm9sZXMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIDMuIEhvbGUgVXNlciBhdXMgUmVxdWVzdCAod3VyZGUgdm9uIEp3dEF1dGhHdWFyZCBnZXNldHp0KVxyXG4gICAgY29uc3QgcmVxdWVzdCA9IGNvbnRleHQuc3dpdGNoVG9IdHRwKCkuZ2V0UmVxdWVzdDxSZXF1ZXN0PigpO1xyXG4gICAgY29uc3QgdXNlciA9IHJlcXVlc3QudXNlciBhcyBTYWZlVXNlciB8IHVuZGVmaW5lZDtcclxuXHJcbiAgICAvLyA0LiBEZWZlbnNpdmUgQ2hlY2s6IFVzZXIgc29sbHRlIGV4aXN0aWVyZW4gKEp3dEF1dGhHdWFyZCBsaWVmIHZvcmhlcilcclxuICAgIGlmICghdXNlcikge1xyXG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcclxuICAgICAgICAnUm9sZXNHdWFyZDogTm8gdXNlciBmb3VuZCBpbiByZXF1ZXN0LiBKd3RBdXRoR3VhcmQgbWlzc2luZz8nLFxyXG4gICAgICApO1xyXG4gICAgICB0aHJvdyBuZXcgRm9yYmlkZGVuRXhjZXB0aW9uKCdBdXRoZW50aWNhdGlvbiByZXF1aXJlZCcpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIDUuIFByw7xmZSBvYiBVc2VyLVJvbGxlIGluIGVybGF1YnRlbiBSb2xsZW4gaXN0XHJcbiAgICBjb25zdCBoYXNSb2xlID0gcmVxdWlyZWRSb2xlcy5pbmNsdWRlcyh1c2VyLnJvbGUpO1xyXG5cclxuICAgIGlmICghaGFzUm9sZSkge1xyXG4gICAgICB0aGlzLmxvZ2dlci53YXJuKFxyXG4gICAgICAgIGBBY2Nlc3MgZGVuaWVkOiBVc2VyICR7dXNlci5pZH0gd2l0aCByb2xlICR7dXNlci5yb2xlfSBgICtcclxuICAgICAgICAgIGB0cmllZCB0byBhY2Nlc3Mgcm91dGUgcmVxdWlyaW5nICR7cmVxdWlyZWRSb2xlcy5qb2luKCcgb3IgJyl9YCxcclxuICAgICAgKTtcclxuICAgICAgdGhyb3cgbmV3IEZvcmJpZGRlbkV4Y2VwdGlvbihcclxuICAgICAgICBgQWNjZXNzIGRlbmllZC4gUmVxdWlyZWQgcm9sZTogJHtyZXF1aXJlZFJvbGVzLmpvaW4oJyBvciAnKX1gLFxyXG4gICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMubG9nZ2VyLmRlYnVnKGBBY2Nlc3MgZ3JhbnRlZDogVXNlciAke3VzZXIuaWR9IHdpdGggcm9sZSAke3VzZXIucm9sZX1gKTtcclxuICAgIHJldHVybiB0cnVlO1xyXG4gIH1cclxufVxyXG4iXSwidmVyc2lvbiI6M30=