02ea432762944628e2dd35b5bfdb6f08
"use strict";
// test/unit/strategies/jwt.strategy.spec.ts
Object.defineProperty(exports, "__esModule", { value: true });
const common_1 = require("@nestjs/common");
const config_1 = require("@nestjs/config");
const testing_1 = require("@nestjs/testing");
const jwt_strategy_1 = require("../../../src/modules/auth/strategies/jwt.strategy");
const users_service_1 = require("../../../src/modules/users/users.service");
describe('JwtStrategy', () => {
    let strategy;
    let mockUsersService;
    let mockConfigService;
    const mockUser = {
        id: 'test-user-id',
        email: 'test@example.com',
        username: 'testuser',
        role: 'USER',
        createdAt: new Date(),
        updatedAt: new Date(),
    };
    beforeEach(async () => {
        mockUsersService = {
            findById: jest.fn(),
        };
        mockConfigService = {
            get: jest.fn((key) => {
                if (key === 'JWT_SECRET')
                    return 'test-secret';
                return undefined;
            }),
        };
        const module = await testing_1.Test.createTestingModule({
            providers: [
                jwt_strategy_1.JwtStrategy,
                {
                    provide: users_service_1.UsersService,
                    useValue: mockUsersService,
                },
                {
                    provide: config_1.ConfigService,
                    useValue: mockConfigService,
                },
            ],
        }).compile();
        strategy = module.get(jwt_strategy_1.JwtStrategy);
    });
    describe('validate', () => {
        it('should return user when found', async () => {
            const payload = {
                sub: 'test-user-id',
                email: 'test@example.com',
                role: 'USER',
            };
            mockUsersService.findById.mockResolvedValue(mockUser);
            const result = await strategy.validate(payload);
            expect(result).toEqual(mockUser);
            expect(mockUsersService.findById).toHaveBeenCalledWith('test-user-id');
        });
        it('should throw UnauthorizedException when user not found', async () => {
            const payload = {
                sub: 'non-existent-id',
                email: 'test@example.com',
                role: 'USER',
            };
            mockUsersService.findById.mockRejectedValue(new Error('User not found'));
            await expect(strategy.validate(payload)).rejects.toThrow(common_1.UnauthorizedException);
            await expect(strategy.validate(payload)).rejects.toThrow('User not found or has been deleted');
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aW11clxcUHJvZ3JhbW1pbmdcXFByb2plY3RzXFxzbmlwcGV0Zm9yZ2VcXGFwcHNcXGFwaVxcdGVzdFxcdW5pdFxcc3RyYXRlZ2llc1xcand0LnN0cmF0ZWd5LnNwZWMudHMiLCJtYXBwaW5ncyI6IjtBQUFBLDRDQUE0Qzs7QUFFNUMsMkNBQXVEO0FBQ3ZELDJDQUErQztBQUMvQyw2Q0FBc0Q7QUFFdEQsb0ZBQWdGO0FBRWhGLDRFQUF3RTtBQUV4RSxRQUFRLENBQUMsYUFBYSxFQUFFLEdBQUcsRUFBRTtJQUMzQixJQUFJLFFBQXFCLENBQUM7SUFDMUIsSUFBSSxnQkFBdUMsQ0FBQztJQUM1QyxJQUFJLGlCQUF5QyxDQUFDO0lBRTlDLE1BQU0sUUFBUSxHQUFhO1FBQ3pCLEVBQUUsRUFBRSxjQUFjO1FBQ2xCLEtBQUssRUFBRSxrQkFBa0I7UUFDekIsUUFBUSxFQUFFLFVBQVU7UUFDcEIsSUFBSSxFQUFFLE1BQU07UUFDWixTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUU7UUFDckIsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFO0tBQ3RCLENBQUM7SUFFRixVQUFVLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDcEIsZ0JBQWdCLEdBQUc7WUFDakIsUUFBUSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7U0FDcEIsQ0FBQztRQUVGLGlCQUFpQixHQUFHO1lBQ2xCLEdBQUcsRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsR0FBVyxFQUFFLEVBQUU7Z0JBQzNCLElBQUksR0FBRyxLQUFLLFlBQVk7b0JBQUUsT0FBTyxhQUFhLENBQUM7Z0JBQy9DLE9BQU8sU0FBUyxDQUFDO1lBQ25CLENBQUMsQ0FBQztTQUNILENBQUM7UUFFRixNQUFNLE1BQU0sR0FBa0IsTUFBTSxjQUFJLENBQUMsbUJBQW1CLENBQUM7WUFDM0QsU0FBUyxFQUFFO2dCQUNULDBCQUFXO2dCQUNYO29CQUNFLE9BQU8sRUFBRSw0QkFBWTtvQkFDckIsUUFBUSxFQUFFLGdCQUFnQjtpQkFDM0I7Z0JBQ0Q7b0JBQ0UsT0FBTyxFQUFFLHNCQUFhO29CQUN0QixRQUFRLEVBQUUsaUJBQWlCO2lCQUM1QjthQUNGO1NBQ0YsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBRWIsUUFBUSxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQWMsMEJBQVcsQ0FBQyxDQUFDO0lBQ2xELENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLFVBQVUsRUFBRSxHQUFHLEVBQUU7UUFDeEIsRUFBRSxDQUFDLCtCQUErQixFQUFFLEtBQUssSUFBSSxFQUFFO1lBQzdDLE1BQU0sT0FBTyxHQUFlO2dCQUMxQixHQUFHLEVBQUUsY0FBYztnQkFDbkIsS0FBSyxFQUFFLGtCQUFrQjtnQkFDekIsSUFBSSxFQUFFLE1BQU07YUFDYixDQUFDO1lBRUQsZ0JBQWdCLENBQUMsUUFBc0IsQ0FBQyxpQkFBaUIsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUVyRSxNQUFNLE1BQU0sR0FBRyxNQUFNLFFBQVEsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7WUFFaEQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUNqQyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxDQUFDLENBQUMsb0JBQW9CLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDekUsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsd0RBQXdELEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDdEUsTUFBTSxPQUFPLEdBQWU7Z0JBQzFCLEdBQUcsRUFBRSxpQkFBaUI7Z0JBQ3RCLEtBQUssRUFBRSxrQkFBa0I7Z0JBQ3pCLElBQUksRUFBRSxNQUFNO2FBQ2IsQ0FBQztZQUVELGdCQUFnQixDQUFDLFFBQXNCLENBQUMsaUJBQWlCLENBQ3hELElBQUksS0FBSyxDQUFDLGdCQUFnQixDQUFDLENBQzVCLENBQUM7WUFFRixNQUFNLE1BQU0sQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FDdEQsOEJBQXFCLENBQ3RCLENBQUM7WUFDRixNQUFNLE1BQU0sQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FDdEQsb0NBQW9DLENBQ3JDLENBQUM7UUFDSixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFx0aW11clxcUHJvZ3JhbW1pbmdcXFByb2plY3RzXFxzbmlwcGV0Zm9yZ2VcXGFwcHNcXGFwaVxcdGVzdFxcdW5pdFxcc3RyYXRlZ2llc1xcand0LnN0cmF0ZWd5LnNwZWMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gdGVzdC91bml0L3N0cmF0ZWdpZXMvand0LnN0cmF0ZWd5LnNwZWMudHNcclxuXHJcbmltcG9ydCB7IFVuYXV0aG9yaXplZEV4Y2VwdGlvbiB9IGZyb20gJ0BuZXN0anMvY29tbW9uJztcclxuaW1wb3J0IHsgQ29uZmlnU2VydmljZSB9IGZyb20gJ0BuZXN0anMvY29uZmlnJztcclxuaW1wb3J0IHsgVGVzdCwgVGVzdGluZ01vZHVsZSB9IGZyb20gJ0BuZXN0anMvdGVzdGluZyc7XHJcbmltcG9ydCB0eXBlIHsgSnd0UGF5bG9hZCB9IGZyb20gJy4uLy4uLy4uL3NyYy9tb2R1bGVzL2F1dGgvYXV0aC50eXBlcyc7XHJcbmltcG9ydCB7IEp3dFN0cmF0ZWd5IH0gZnJvbSAnLi4vLi4vLi4vc3JjL21vZHVsZXMvYXV0aC9zdHJhdGVnaWVzL2p3dC5zdHJhdGVneSc7XHJcbmltcG9ydCB0eXBlIHsgU2FmZVVzZXIgfSBmcm9tICcuLi8uLi8uLi9zcmMvbW9kdWxlcy91c2Vycyc7XHJcbmltcG9ydCB7IFVzZXJzU2VydmljZSB9IGZyb20gJy4uLy4uLy4uL3NyYy9tb2R1bGVzL3VzZXJzL3VzZXJzLnNlcnZpY2UnO1xyXG5cclxuZGVzY3JpYmUoJ0p3dFN0cmF0ZWd5JywgKCkgPT4ge1xyXG4gIGxldCBzdHJhdGVneTogSnd0U3RyYXRlZ3k7XHJcbiAgbGV0IG1vY2tVc2Vyc1NlcnZpY2U6IFBhcnRpYWw8VXNlcnNTZXJ2aWNlPjtcclxuICBsZXQgbW9ja0NvbmZpZ1NlcnZpY2U6IFBhcnRpYWw8Q29uZmlnU2VydmljZT47XHJcblxyXG4gIGNvbnN0IG1vY2tVc2VyOiBTYWZlVXNlciA9IHtcclxuICAgIGlkOiAndGVzdC11c2VyLWlkJyxcclxuICAgIGVtYWlsOiAndGVzdEBleGFtcGxlLmNvbScsXHJcbiAgICB1c2VybmFtZTogJ3Rlc3R1c2VyJyxcclxuICAgIHJvbGU6ICdVU0VSJyxcclxuICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoKSxcclxuICAgIHVwZGF0ZWRBdDogbmV3IERhdGUoKSxcclxuICB9O1xyXG5cclxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcclxuICAgIG1vY2tVc2Vyc1NlcnZpY2UgPSB7XHJcbiAgICAgIGZpbmRCeUlkOiBqZXN0LmZuKCksXHJcbiAgICB9O1xyXG5cclxuICAgIG1vY2tDb25maWdTZXJ2aWNlID0ge1xyXG4gICAgICBnZXQ6IGplc3QuZm4oKGtleTogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgaWYgKGtleSA9PT0gJ0pXVF9TRUNSRVQnKSByZXR1cm4gJ3Rlc3Qtc2VjcmV0JztcclxuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gICAgICB9KSxcclxuICAgIH07XHJcblxyXG4gICAgY29uc3QgbW9kdWxlOiBUZXN0aW5nTW9kdWxlID0gYXdhaXQgVGVzdC5jcmVhdGVUZXN0aW5nTW9kdWxlKHtcclxuICAgICAgcHJvdmlkZXJzOiBbXHJcbiAgICAgICAgSnd0U3RyYXRlZ3ksXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgcHJvdmlkZTogVXNlcnNTZXJ2aWNlLFxyXG4gICAgICAgICAgdXNlVmFsdWU6IG1vY2tVc2Vyc1NlcnZpY2UsXHJcbiAgICAgICAgfSxcclxuICAgICAgICB7XHJcbiAgICAgICAgICBwcm92aWRlOiBDb25maWdTZXJ2aWNlLFxyXG4gICAgICAgICAgdXNlVmFsdWU6IG1vY2tDb25maWdTZXJ2aWNlLFxyXG4gICAgICAgIH0sXHJcbiAgICAgIF0sXHJcbiAgICB9KS5jb21waWxlKCk7XHJcblxyXG4gICAgc3RyYXRlZ3kgPSBtb2R1bGUuZ2V0PEp3dFN0cmF0ZWd5PihKd3RTdHJhdGVneSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCd2YWxpZGF0ZScsICgpID0+IHtcclxuICAgIGl0KCdzaG91bGQgcmV0dXJuIHVzZXIgd2hlbiBmb3VuZCcsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgcGF5bG9hZDogSnd0UGF5bG9hZCA9IHtcclxuICAgICAgICBzdWI6ICd0ZXN0LXVzZXItaWQnLFxyXG4gICAgICAgIGVtYWlsOiAndGVzdEBleGFtcGxlLmNvbScsXHJcbiAgICAgICAgcm9sZTogJ1VTRVInLFxyXG4gICAgICB9O1xyXG5cclxuICAgICAgKG1vY2tVc2Vyc1NlcnZpY2UuZmluZEJ5SWQgYXMgamVzdC5Nb2NrKS5tb2NrUmVzb2x2ZWRWYWx1ZShtb2NrVXNlcik7XHJcblxyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzdHJhdGVneS52YWxpZGF0ZShwYXlsb2FkKTtcclxuXHJcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvRXF1YWwobW9ja1VzZXIpO1xyXG4gICAgICBleHBlY3QobW9ja1VzZXJzU2VydmljZS5maW5kQnlJZCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ3Rlc3QtdXNlci1pZCcpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ3Nob3VsZCB0aHJvdyBVbmF1dGhvcml6ZWRFeGNlcHRpb24gd2hlbiB1c2VyIG5vdCBmb3VuZCcsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgcGF5bG9hZDogSnd0UGF5bG9hZCA9IHtcclxuICAgICAgICBzdWI6ICdub24tZXhpc3RlbnQtaWQnLFxyXG4gICAgICAgIGVtYWlsOiAndGVzdEBleGFtcGxlLmNvbScsXHJcbiAgICAgICAgcm9sZTogJ1VTRVInLFxyXG4gICAgICB9O1xyXG5cclxuICAgICAgKG1vY2tVc2Vyc1NlcnZpY2UuZmluZEJ5SWQgYXMgamVzdC5Nb2NrKS5tb2NrUmVqZWN0ZWRWYWx1ZShcclxuICAgICAgICBuZXcgRXJyb3IoJ1VzZXIgbm90IGZvdW5kJyksXHJcbiAgICAgICk7XHJcblxyXG4gICAgICBhd2FpdCBleHBlY3Qoc3RyYXRlZ3kudmFsaWRhdGUocGF5bG9hZCkpLnJlamVjdHMudG9UaHJvdyhcclxuICAgICAgICBVbmF1dGhvcml6ZWRFeGNlcHRpb24sXHJcbiAgICAgICk7XHJcbiAgICAgIGF3YWl0IGV4cGVjdChzdHJhdGVneS52YWxpZGF0ZShwYXlsb2FkKSkucmVqZWN0cy50b1Rocm93KFxyXG4gICAgICAgICdVc2VyIG5vdCBmb3VuZCBvciBoYXMgYmVlbiBkZWxldGVkJyxcclxuICAgICAgKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG59KTtcclxuIl0sInZlcnNpb24iOjN9