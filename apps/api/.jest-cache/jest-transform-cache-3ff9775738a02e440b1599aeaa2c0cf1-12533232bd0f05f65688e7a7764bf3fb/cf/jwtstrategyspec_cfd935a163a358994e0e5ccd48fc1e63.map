{"file":"C:\\Users\\timur\\Programming\\Projects\\snippetforge\\apps\\api\\test\\unit\\strategies\\jwt.strategy.spec.ts","mappings":";AAAA,4CAA4C;;AAE5C,2CAAuD;AACvD,2CAA+C;AAC/C,6CAAsD;AAEtD,oFAAgF;AAEhF,4EAAwE;AAExE,QAAQ,CAAC,aAAa,EAAE,GAAG,EAAE;IAC3B,IAAI,QAAqB,CAAC;IAC1B,IAAI,gBAAuC,CAAC;IAC5C,IAAI,iBAAyC,CAAC;IAE9C,MAAM,QAAQ,GAAa;QACzB,EAAE,EAAE,cAAc;QAClB,KAAK,EAAE,kBAAkB;QACzB,QAAQ,EAAE,UAAU;QACpB,IAAI,EAAE,MAAM;QACZ,SAAS,EAAE,IAAI,IAAI,EAAE;QACrB,SAAS,EAAE,IAAI,IAAI,EAAE;KACtB,CAAC;IAEF,UAAU,CAAC,KAAK,IAAI,EAAE;QACpB,gBAAgB,GAAG;YACjB,QAAQ,EAAE,IAAI,CAAC,EAAE,EAAE;SACpB,CAAC;QAEF,iBAAiB,GAAG;YAClB,GAAG,EAAE,IAAI,CAAC,EAAE,CAAC,CAAC,GAAW,EAAE,EAAE;gBAC3B,IAAI,GAAG,KAAK,YAAY;oBAAE,OAAO,aAAa,CAAC;gBAC/C,OAAO,SAAS,CAAC;YACnB,CAAC,CAAC;SACH,CAAC;QAEF,MAAM,MAAM,GAAkB,MAAM,cAAI,CAAC,mBAAmB,CAAC;YAC3D,SAAS,EAAE;gBACT,0BAAW;gBACX;oBACE,OAAO,EAAE,4BAAY;oBACrB,QAAQ,EAAE,gBAAgB;iBAC3B;gBACD;oBACE,OAAO,EAAE,sBAAa;oBACtB,QAAQ,EAAE,iBAAiB;iBAC5B;aACF;SACF,CAAC,CAAC,OAAO,EAAE,CAAC;QAEb,QAAQ,GAAG,MAAM,CAAC,GAAG,CAAc,0BAAW,CAAC,CAAC;IAClD,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,UAAU,EAAE,GAAG,EAAE;QACxB,EAAE,CAAC,+BAA+B,EAAE,KAAK,IAAI,EAAE;YAC7C,MAAM,OAAO,GAAe;gBAC1B,GAAG,EAAE,cAAc;gBACnB,KAAK,EAAE,kBAAkB;gBACzB,IAAI,EAAE,MAAM;aACb,CAAC;YAED,gBAAgB,CAAC,QAAsB,CAAC,iBAAiB,CAAC,QAAQ,CAAC,CAAC;YAErE,MAAM,MAAM,GAAG,MAAM,QAAQ,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC;YAEhD,MAAM,CAAC,MAAM,CAAC,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAC;YACjC,MAAM,CAAC,gBAAgB,CAAC,QAAQ,CAAC,CAAC,oBAAoB,CAAC,cAAc,CAAC,CAAC;QACzE,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,wDAAwD,EAAE,KAAK,IAAI,EAAE;YACtE,MAAM,OAAO,GAAe;gBAC1B,GAAG,EAAE,iBAAiB;gBACtB,KAAK,EAAE,kBAAkB;gBACzB,IAAI,EAAE,MAAM;aACb,CAAC;YAED,gBAAgB,CAAC,QAAsB,CAAC,iBAAiB,CACxD,IAAI,KAAK,CAAC,gBAAgB,CAAC,CAC5B,CAAC;YAEF,MAAM,MAAM,CAAC,QAAQ,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC,CAAC,OAAO,CAAC,OAAO,CACtD,8BAAqB,CACtB,CAAC;YACF,MAAM,MAAM,CAAC,QAAQ,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC,CAAC,OAAO,CAAC,OAAO,CACtD,oCAAoC,CACrC,CAAC;QACJ,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;AACL,CAAC,CAAC,CAAC","names":[],"sources":["C:\\Users\\timur\\Programming\\Projects\\snippetforge\\apps\\api\\test\\unit\\strategies\\jwt.strategy.spec.ts"],"sourcesContent":["// test/unit/strategies/jwt.strategy.spec.ts\r\n\r\nimport { UnauthorizedException } from '@nestjs/common';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport { Test, TestingModule } from '@nestjs/testing';\r\nimport type { JwtPayload } from '../../../src/modules/auth/auth.types';\r\nimport { JwtStrategy } from '../../../src/modules/auth/strategies/jwt.strategy';\r\nimport type { SafeUser } from '../../../src/modules/users';\r\nimport { UsersService } from '../../../src/modules/users/users.service';\r\n\r\ndescribe('JwtStrategy', () => {\r\n  let strategy: JwtStrategy;\r\n  let mockUsersService: Partial<UsersService>;\r\n  let mockConfigService: Partial<ConfigService>;\r\n\r\n  const mockUser: SafeUser = {\r\n    id: 'test-user-id',\r\n    email: 'test@example.com',\r\n    username: 'testuser',\r\n    role: 'USER',\r\n    createdAt: new Date(),\r\n    updatedAt: new Date(),\r\n  };\r\n\r\n  beforeEach(async () => {\r\n    mockUsersService = {\r\n      findById: jest.fn(),\r\n    };\r\n\r\n    mockConfigService = {\r\n      get: jest.fn((key: string) => {\r\n        if (key === 'JWT_SECRET') return 'test-secret';\r\n        return undefined;\r\n      }),\r\n    };\r\n\r\n    const module: TestingModule = await Test.createTestingModule({\r\n      providers: [\r\n        JwtStrategy,\r\n        {\r\n          provide: UsersService,\r\n          useValue: mockUsersService,\r\n        },\r\n        {\r\n          provide: ConfigService,\r\n          useValue: mockConfigService,\r\n        },\r\n      ],\r\n    }).compile();\r\n\r\n    strategy = module.get<JwtStrategy>(JwtStrategy);\r\n  });\r\n\r\n  describe('validate', () => {\r\n    it('should return user when found', async () => {\r\n      const payload: JwtPayload = {\r\n        sub: 'test-user-id',\r\n        email: 'test@example.com',\r\n        role: 'USER',\r\n      };\r\n\r\n      (mockUsersService.findById as jest.Mock).mockResolvedValue(mockUser);\r\n\r\n      const result = await strategy.validate(payload);\r\n\r\n      expect(result).toEqual(mockUser);\r\n      expect(mockUsersService.findById).toHaveBeenCalledWith('test-user-id');\r\n    });\r\n\r\n    it('should throw UnauthorizedException when user not found', async () => {\r\n      const payload: JwtPayload = {\r\n        sub: 'non-existent-id',\r\n        email: 'test@example.com',\r\n        role: 'USER',\r\n      };\r\n\r\n      (mockUsersService.findById as jest.Mock).mockRejectedValue(\r\n        new Error('User not found'),\r\n      );\r\n\r\n      await expect(strategy.validate(payload)).rejects.toThrow(\r\n        UnauthorizedException,\r\n      );\r\n      await expect(strategy.validate(payload)).rejects.toThrow(\r\n        'User not found or has been deleted',\r\n      );\r\n    });\r\n  });\r\n});\r\n"],"version":3}