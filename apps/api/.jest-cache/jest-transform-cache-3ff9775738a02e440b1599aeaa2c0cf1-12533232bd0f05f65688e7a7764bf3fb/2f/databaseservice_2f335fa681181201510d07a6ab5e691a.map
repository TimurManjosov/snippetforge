{"file":"C:\\Users\\timur\\Programming\\Projects\\snippetforge\\apps\\api\\src\\shared\\database\\database.service.ts","mappings":"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","names":[],"sources":["C:\\Users\\timur\\Programming\\Projects\\snippetforge\\apps\\api\\src\\shared\\database\\database.service.ts"],"sourcesContent":["// src/shared/database/database. service.ts\r\n\r\nimport {\r\n  Injectable,\r\n  Logger,\r\n  OnModuleDestroy,\r\n  OnModuleInit,\r\n} from '@nestjs/common';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport { drizzle, PostgresJsDatabase } from 'drizzle-orm/postgres-js';\r\nimport postgres from 'postgres';\r\nimport * as schema from '../../lib/db/schema';\r\n\r\n/**\r\n * DatabaseService - Zentrale Datenbankverbindung f√ºr die gesamte Anwendung\r\n *\r\n * Verantwortlichkeiten:\r\n * - Connection Pool Management\r\n * - Lifecycle (Connect on Start, Disconnect on Shutdown)\r\n * - Health Checks\r\n * - Drizzle Client Bereitstellung\r\n *\r\n * Warum als Service und nicht als Modul-Export?\r\n * - Dependency Injection erm√∂glicht einfaches Mocking in Tests\r\n * - Lifecycle Hooks f√ºr sauberes Cleanup\r\n * - Zentrale Konfiguration an einer Stelle\r\n */\r\n@Injectable()\r\nexport class DatabaseService implements OnModuleInit, OnModuleDestroy {\r\n  private readonly logger = new Logger(DatabaseService.name);\r\n  private client: postgres.Sql;\r\n  private _drizzle: PostgresJsDatabase<typeof schema>;\r\n\r\n  constructor(private readonly configService: ConfigService) {}\r\n\r\n  /**\r\n   * Getter f√ºr den Drizzle Client\r\n   * Wird von Repositories verwendet f√ºr Type-Safe Queries\r\n   */\r\n  get drizzle(): PostgresJsDatabase<typeof schema> {\r\n    if (!this._drizzle) {\r\n      throw new Error('Database not initialized.  Call onModuleInit first.');\r\n    }\r\n    return this._drizzle;\r\n  }\r\n\r\n  /**\r\n   * Lifecycle Hook:  Wird automatisch beim App-Start aufgerufen\r\n   * Etabliert Datenbankverbindung mit Connection Pool\r\n   */\r\n  async onModuleInit(): Promise<void> {\r\n    const databaseUrl = this.configService.get<string>('DATABASE_URL');\r\n\r\n    if (!databaseUrl) {\r\n      this.logger.error('DATABASE_URL is not defined in environment variables');\r\n      throw new Error('DATABASE_URL is required');\r\n    }\r\n\r\n    this.logger.log('üîå Initializing database connection...');\r\n\r\n    try {\r\n      // PostgreSQL Client mit Connection Pool\r\n      // Warum diese Einstellungen?\r\n      // - max:  10 = Maximal 10 gleichzeitige Verbindungen (verhindert DB-√úberlastung)\r\n      // - idle_timeout: 20 = Ungenutzte Verbindungen nach 20s schlie√üen (Resource-Freigabe)\r\n      // - connect_timeout: 10 = Max 10s warten auf Connection (Fail Fast)\r\n      this.client = postgres(databaseUrl, {\r\n        max: 10,\r\n        idle_timeout: 20,\r\n        connect_timeout: 10,\r\n        // SSL f√ºr Production (auskommentiert f√ºr lokale Entwicklung)\r\n        // ssl: process.env.NODE_ENV === 'production' ? 'require' : false,\r\n      });\r\n\r\n      // Drizzle ORM Wrapper\r\n      // Schema wird mitgegeben f√ºr Type-Safe Queries\r\n      this._drizzle = drizzle(this.client, {\r\n        schema,\r\n        logger: this.configService.get('NODE_ENV') === 'development',\r\n      });\r\n\r\n      // Connection Test\r\n      await this.healthCheck();\r\n      this.logger.log('‚úÖ Database connection established successfully');\r\n    } catch (error) {\r\n      this.logger.error('‚ùå Failed to connect to database', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Lifecycle Hook: Wird automatisch beim App-Shutdown aufgerufen\r\n   * Schlie√üt alle Datenbankverbindungen sauber\r\n   */\r\n  async onModuleDestroy(): Promise<void> {\r\n    this.logger.log('üîå Closing database connection...');\r\n\r\n    if (this.client) {\r\n      await this.client.end();\r\n      this.logger.log('‚úÖ Database connection closed');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Health Check f√ºr Monitoring/Readiness Probes\r\n   * Wird auch beim Startup verwendet um Connection zu verifizieren\r\n   *\r\n   * @returns true wenn DB erreichbar, wirft Error wenn nicht\r\n   */\r\n  async healthCheck(): Promise<boolean> {\r\n    try {\r\n      // Simple Query um Connection zu testen\r\n      await this.client`SELECT 1 as health_check`;\r\n      return true;\r\n    } catch (error) {\r\n      this.logger.error('Database health check failed', error);\r\n      throw new Error('Database is not reachable');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * F√ºhrt Raw SQL aus (f√ºr komplexe Queries, Migrations)\r\n   * ACHTUNG: Nur verwenden wenn Drizzle Query Builder nicht ausreicht\r\n   *\r\n   * @param sql - Raw SQL String\r\n   * @returns Query Result\r\n   */\r\n  async executeRaw<T>(sql: string): Promise<T[]> {\r\n    return this.client.unsafe(sql) as Promise<T[]>;\r\n  }\r\n}\r\n"],"version":3}