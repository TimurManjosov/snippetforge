{"file":"C:\\Users\\timur\\Programming\\Projects\\snippetforge\\apps\\api\\test\\unit\\guards\\roles.guard.spec.ts","mappings":";AAAA,uCAAuC;;AAEvC,2CAAsE;AAEtE,8EAA0E;AAC1E,uCAAsE;AACtE,uDAAoE;AAEpE;;;;;;;GAOG;AACH,QAAQ,CAAC,YAAY,EAAE,GAAG,EAAE;IAC1B,IAAI,KAAiB,CAAC;IACtB,IAAI,SAAiD,CAAC;IAEtD,UAAU,CAAC,GAAG,EAAE;QACd,SAAS,GAAG,IAAA,2BAAmB,GAAE,CAAC;QAClC,KAAK,GAAG,IAAI,wBAAU,CAAC,SAAiC,CAAC,CAAC;IAC5D,CAAC,CAAC,CAAC;IAEH,SAAS,CAAC,GAAG,EAAE;QACb,IAAI,CAAC,aAAa,EAAE,CAAC;IACvB,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,aAAa,EAAE,GAAG,EAAE;QAC3B,QAAQ,CAAC,4BAA4B,EAAE,GAAG,EAAE;YAC1C,EAAE,CAAC,iCAAiC,EAAE,GAAG,EAAE;gBACzC,UAAU;gBACV,SAAS,CAAC,iBAAiB,CAAC,eAAe,CAAC,SAAS,CAAC,CAAC;gBACvD,MAAM,IAAI,GAAG,IAAA,0BAAkB,EAAC,EAAE,IAAI,EAAE,MAAM,EAAE,CAAC,CAAC;gBAClD,MAAM,OAAO,GAAG,IAAA,uCAA0B,EAAC;oBACzC,OAAO,EAAE,EAAE,IAAI,EAAE;iBAClB,CAAgC,CAAC;gBAElC,MAAM;gBACN,MAAM,MAAM,GAAG,KAAK,CAAC,WAAW,CAAC,OAAO,CAAC,CAAC;gBAE1C,SAAS;gBACT,MAAM,CAAC,MAAM,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YAC5B,CAAC,CAAC,CAAC;YAEH,EAAE,CAAC,8CAA8C,EAAE,GAAG,EAAE;gBACtD,UAAU;gBACV,SAAS,CAAC,iBAAiB,CAAC,eAAe,CAAC,EAAE,CAAC,CAAC;gBAChD,MAAM,IAAI,GAAG,IAAA,0BAAkB,EAAC,EAAE,IAAI,EAAE,MAAM,EAAE,CAAC,CAAC;gBAClD,MAAM,OAAO,GAAG,IAAA,uCAA0B,EAAC;oBACzC,OAAO,EAAE,EAAE,IAAI,EAAE;iBAClB,CAAgC,CAAC;gBAElC,MAAM;gBACN,MAAM,MAAM,GAAG,KAAK,CAAC,WAAW,CAAC,OAAO,CAAC,CAAC;gBAE1C,SAAS;gBACT,MAAM,CAAC,MAAM,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YAC5B,CAAC,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;QAEH,QAAQ,CAAC,yBAAyB,EAAE,GAAG,EAAE;YACvC,EAAE,CAAC,gDAAgD,EAAE,GAAG,EAAE;gBACxD,UAAU;gBACV,SAAS,CAAC,iBAAiB,CAAC,eAAe,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC;gBACvD,MAAM,IAAI,GAAG,IAAA,0BAAkB,EAAC,EAAE,IAAI,EAAE,OAAO,EAAE,CAAC,CAAC;gBACnD,MAAM,OAAO,GAAG,IAAA,uCAA0B,EAAC;oBACzC,OAAO,EAAE,EAAE,IAAI,EAAE;iBAClB,CAAgC,CAAC;gBAElC,MAAM;gBACN,MAAM,MAAM,GAAG,KAAK,CAAC,WAAW,CAAC,OAAO,CAAC,CAAC;gBAE1C,SAAS;gBACT,MAAM,CAAC,MAAM,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YAC5B,CAAC,CAAC,CAAC;YAEH,EAAE,CAAC,gEAAgE,EAAE,GAAG,EAAE;gBACxE,UAAU;gBACV,SAAS,CAAC,iBAAiB,CAAC,eAAe,CAAC,CAAC,OAAO,EAAE,WAAW,CAAC,CAAC,CAAC;gBACpE,MAAM,IAAI,GAAG,IAAA,0BAAkB,EAAC,EAAE,IAAI,EAAE,WAAW,EAAE,CAAC,CAAC;gBACvD,MAAM,OAAO,GAAG,IAAA,uCAA0B,EAAC;oBACzC,OAAO,EAAE,EAAE,IAAI,EAAE;iBAClB,CAAgC,CAAC;gBAElC,MAAM;gBACN,MAAM,MAAM,GAAG,KAAK,CAAC,WAAW,CAAC,OAAO,CAAC,CAAC;gBAE1C,SAAS;gBACT,MAAM,CAAC,MAAM,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YAC5B,CAAC,CAAC,CAAC;YAEH,EAAE,CAAC,+DAA+D,EAAE,GAAG,EAAE;gBACvE,UAAU;gBACV,SAAS,CAAC,iBAAiB,CAAC,eAAe,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC;gBACvD,MAAM,IAAI,GAAG,IAAA,0BAAkB,EAAC,EAAE,IAAI,EAAE,MAAM,EAAE,CAAC,CAAC;gBAClD,MAAM,OAAO,GAAG,IAAA,uCAA0B,EAAC;oBACzC,OAAO,EAAE,EAAE,IAAI,EAAE;iBAClB,CAAgC,CAAC;gBAElC,eAAe;gBACf,MAAM,CAAC,GAAG,EAAE,CAAC,KAAK,CAAC,WAAW,CAAC,OAAO,CAAC,CAAC,CAAC,OAAO,CAAC,2BAAkB,CAAC,CAAC;YACvE,CAAC,CAAC,CAAC;YAEH,EAAE,CAAC,yDAAyD,EAAE,GAAG,EAAE;gBACjE,UAAU;gBACV,SAAS,CAAC,iBAAiB,CAAC,eAAe,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC;gBACvD,MAAM,OAAO,GAAG,IAAA,uCAA0B,EAAC;oBACzC,OAAO,EAAE,EAAE,IAAI,EAAE,SAAS,EAAE;iBAC7B,CAAgC,CAAC;gBAElC,eAAe;gBACf,MAAM,CAAC,GAAG,EAAE,CAAC,KAAK,CAAC,WAAW,CAAC,OAAO,CAAC,CAAC,CAAC,OAAO,CAAC,2BAAkB,CAAC,CAAC;YACvE,CAAC,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;AACL,CAAC,CAAC,CAAC","names":[],"sources":["C:\\Users\\timur\\Programming\\Projects\\snippetforge\\apps\\api\\test\\unit\\guards\\roles.guard.spec.ts"],"sourcesContent":["// test/unit/guards/roles.guard.spec.ts\r\n\r\nimport { ExecutionContext, ForbiddenException } from '@nestjs/common';\r\nimport { Reflector } from '@nestjs/core';\r\nimport { RolesGuard } from '../../../src/modules/auth/guards/roles.guard';\r\nimport { createMockReflector, createMockSafeUser } from '../../mocks';\r\nimport { createMockExecutionContext } from '../../setup/test-utils';\r\n\r\n/**\r\n * RolesGuard Unit Tests\r\n *\r\n * Testet:\r\n * - Routes ohne @Roles() sind für alle erlaubt\r\n * - Routes mit @Roles() erfordern passende Rolle\r\n * - Fehlende Rolle führt zu ForbiddenException\r\n */\r\ndescribe('RolesGuard', () => {\r\n  let guard: RolesGuard;\r\n  let reflector: ReturnType<typeof createMockReflector>;\r\n\r\n  beforeEach(() => {\r\n    reflector = createMockReflector();\r\n    guard = new RolesGuard(reflector as unknown as Reflector);\r\n  });\r\n\r\n  afterEach(() => {\r\n    jest.clearAllMocks();\r\n  });\r\n\r\n  describe('canActivate', () => {\r\n    describe('when no roles are required', () => {\r\n      it('should return true for any user', () => {\r\n        // Arrange\r\n        reflector.getAllAndOverride.mockReturnValue(undefined);\r\n        const user = createMockSafeUser({ role: 'USER' });\r\n        const context = createMockExecutionContext({\r\n          request: { user },\r\n        }) as unknown as ExecutionContext;\r\n\r\n        // Act\r\n        const result = guard.canActivate(context);\r\n\r\n        // Assert\r\n        expect(result).toBe(true);\r\n      });\r\n\r\n      it('should return true when roles array is empty', () => {\r\n        // Arrange\r\n        reflector.getAllAndOverride.mockReturnValue([]);\r\n        const user = createMockSafeUser({ role: 'USER' });\r\n        const context = createMockExecutionContext({\r\n          request: { user },\r\n        }) as unknown as ExecutionContext;\r\n\r\n        // Act\r\n        const result = guard.canActivate(context);\r\n\r\n        // Assert\r\n        expect(result).toBe(true);\r\n      });\r\n    });\r\n\r\n    describe('when roles are required', () => {\r\n      it('should return true when user has required role', () => {\r\n        // Arrange\r\n        reflector.getAllAndOverride.mockReturnValue(['ADMIN']);\r\n        const user = createMockSafeUser({ role: 'ADMIN' });\r\n        const context = createMockExecutionContext({\r\n          request: { user },\r\n        }) as unknown as ExecutionContext;\r\n\r\n        // Act\r\n        const result = guard.canActivate(context);\r\n\r\n        // Assert\r\n        expect(result).toBe(true);\r\n      });\r\n\r\n      it('should return true when user has one of multiple allowed roles', () => {\r\n        // Arrange\r\n        reflector.getAllAndOverride.mockReturnValue(['ADMIN', 'MODERATOR']);\r\n        const user = createMockSafeUser({ role: 'MODERATOR' });\r\n        const context = createMockExecutionContext({\r\n          request: { user },\r\n        }) as unknown as ExecutionContext;\r\n\r\n        // Act\r\n        const result = guard.canActivate(context);\r\n\r\n        // Assert\r\n        expect(result).toBe(true);\r\n      });\r\n\r\n      it('should throw ForbiddenException when user lacks required role', () => {\r\n        // Arrange\r\n        reflector.getAllAndOverride.mockReturnValue(['ADMIN']);\r\n        const user = createMockSafeUser({ role: 'USER' });\r\n        const context = createMockExecutionContext({\r\n          request: { user },\r\n        }) as unknown as ExecutionContext;\r\n\r\n        // Act & Assert\r\n        expect(() => guard.canActivate(context)).toThrow(ForbiddenException);\r\n      });\r\n\r\n      it('should throw ForbiddenException when no user in request', () => {\r\n        // Arrange\r\n        reflector.getAllAndOverride.mockReturnValue(['ADMIN']);\r\n        const context = createMockExecutionContext({\r\n          request: { user: undefined },\r\n        }) as unknown as ExecutionContext;\r\n\r\n        // Act & Assert\r\n        expect(() => guard.canActivate(context)).toThrow(ForbiddenException);\r\n      });\r\n    });\r\n  });\r\n});\r\n"],"version":3}