{"file":"C:\\Users\\timur\\Programming\\Projects\\snippetforge\\apps\\api\\src\\shared\\filters\\http-exception.filter.ts","mappings":"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","names":[],"sources":["C:\\Users\\timur\\Programming\\Projects\\snippetforge\\apps\\api\\src\\shared\\filters\\http-exception.filter.ts"],"sourcesContent":["// src/shared/filters/http-exception.filter.ts\r\n\r\nimport {\r\n  ArgumentsHost,\r\n  Catch,\r\n  ExceptionFilter,\r\n  HttpException,\r\n  HttpStatus,\r\n  Logger,\r\n} from '@nestjs/common';\r\nimport { Request, Response } from 'express';\r\nimport {\r\n  ErrorCodes,\r\n  HttpStatusToErrorCode,\r\n  type ErrorCode,\r\n} from '../constants';\r\nimport { createErrorResponse, type ErrorDetails } from '../types';\r\n\r\n/**\r\n * HttpExceptionFilter - Fängt alle HttpExceptions und formatiert sie einheitlich\r\n *\r\n * WAS ES FÄNGT:\r\n * - BadRequestException (400)\r\n * - UnauthorizedException (401)\r\n * - ForbiddenException (403)\r\n * - NotFoundException (404)\r\n * - ConflictException (409)\r\n * - Alle anderen HttpExceptions\r\n *\r\n * WAS ES NICHT FÄNGT:\r\n * - TypeError, ReferenceError, etc. (→ AllExceptionsFilter)\r\n * - Errors die keine HttpException sind\r\n *\r\n * PERFORMANCE OPTIMIERUNGEN:\r\n * - Minimale Object-Erstellung\r\n * - Keine synchronen Operationen blockieren\r\n * - Logging ist non-blocking\r\n *\r\n * SECURITY:\r\n * - Keine Stack Traces in Response\r\n * - Sensitive Daten werden gefiltert\r\n * - Einheitliche Error Messages (keine Information Leakage)\r\n */\r\n@Catch(HttpException)\r\nexport class HttpExceptionFilter implements ExceptionFilter {\r\n  private readonly logger = new Logger(HttpExceptionFilter.name);\r\n\r\n  /**\r\n   * Catch - Hauptmethode die von NestJS aufgerufen wird\r\n   *\r\n   * @param exception - Die gefangene HttpException\r\n   * @param host - ArgumentsHost für Zugriff auf Request/Response\r\n   */\r\n  catch(exception: HttpException, host: ArgumentsHost): void {\r\n    const ctx = host.switchToHttp();\r\n    const response = ctx.getResponse<Response>();\r\n    const request = ctx.getRequest<Request>();\r\n\r\n    const status = exception.getStatus();\r\n    const exceptionResponse = exception.getResponse();\r\n\r\n    // Error Details extrahieren\r\n    const { message, code, details } = this.extractErrorInfo(\r\n      exceptionResponse,\r\n      status,\r\n    );\r\n\r\n    // Error Response erstellen\r\n    const errorResponse = createErrorResponse({\r\n      code,\r\n      message,\r\n      statusCode: status,\r\n      path: request.url,\r\n      method: request.method,\r\n      details,\r\n      requestId: this.extractRequestId(request),\r\n    });\r\n\r\n    // Logging\r\n    this.logError(exception, request, status, code);\r\n\r\n    // Response senden\r\n    response.status(status).json(errorResponse);\r\n  }\r\n\r\n  /**\r\n   * Extrahiert Error-Informationen aus der Exception Response\r\n   *\r\n   * NestJS Exceptions können verschiedene Formate haben:\r\n   * - String: \"Not found\"\r\n   * - Object: { message: \"Not found\", error: \"Not Found\" }\r\n   * - Object mit Array: { message: [\"error1\", \"error2\"] }\r\n   * - Custom Object: { message: \"...\", code: \"CUSTOM_CODE\", errors: {...} }\r\n   *\r\n   * Diese Methode normalisiert alle Formate.\r\n   */\r\n  private extractErrorInfo(\r\n    response: string | object,\r\n    status: number,\r\n  ): { message: string; code: ErrorCode; details?: ErrorDetails } {\r\n    // Default Values\r\n    let message = 'An error occurred';\r\n    let code: ErrorCode =\r\n      HttpStatusToErrorCode[status] || ErrorCodes.SERVER_ERROR;\r\n    let details: ErrorDetails | undefined;\r\n\r\n    // String Response\r\n    if (typeof response === 'string') {\r\n      message = response;\r\n      return { message, code, details };\r\n    }\r\n\r\n    // Object Response\r\n    if (typeof response === 'object' && response !== null) {\r\n      const res = response as Record<string, unknown>;\r\n\r\n      // Message extrahieren\r\n      if (typeof res.message === 'string') {\r\n        message = res.message;\r\n      } else if (Array.isArray(res.message)) {\r\n        // Array von Messages (z.B. class-validator)\r\n        message = (res.message[0] as string) || 'Validation failed';\r\n\r\n        // Alle Messages als Details speichern\r\n        if (res.message.length > 1) {\r\n          details = { context: { messages: res.message } };\r\n        }\r\n      }\r\n\r\n      // Custom Error Code\r\n      if (typeof res.code === 'string') {\r\n        code = res.code as ErrorCode;\r\n      }\r\n\r\n      // Zod Validation Errors (von ZodValidationPipe)\r\n      if (res.errors && typeof res.errors === 'object') {\r\n        details = { fields: res.errors as Record<string, string[]> };\r\n      }\r\n\r\n      // Spezifische Codes basierend auf Message\r\n      code = this.inferErrorCode(message, status, code);\r\n    }\r\n\r\n    return { message, code, details };\r\n  }\r\n\r\n  /**\r\n   * Inferiert spezifischen Error Code basierend auf Message\r\n   *\r\n   * WARUM?\r\n   * - Viele NestJS Exceptions haben keinen Code\r\n   * - Wir wollen spezifische Codes für Frontend\r\n   * - Ermöglicht besseres Error Handling\r\n   */\r\n  private inferErrorCode(\r\n    message: string,\r\n    status: number,\r\n    defaultCode: ErrorCode,\r\n  ): ErrorCode {\r\n    const lowerMessage = message.toLowerCase();\r\n\r\n    // Authentication Errors\r\n    if (status === HttpStatus.UNAUTHORIZED) {\r\n      if (lowerMessage.includes('expired')) {\r\n        return ErrorCodes.AUTH_TOKEN_EXPIRED;\r\n      }\r\n      if (\r\n        lowerMessage.includes('missing') ||\r\n        lowerMessage.includes('no token')\r\n      ) {\r\n        return ErrorCodes.AUTH_TOKEN_MISSING;\r\n      }\r\n      if (\r\n        lowerMessage.includes('invalid credentials') ||\r\n        lowerMessage.includes('email or password')\r\n      ) {\r\n        return ErrorCodes.AUTH_INVALID_CREDENTIALS;\r\n      }\r\n      return ErrorCodes.AUTH_TOKEN_INVALID;\r\n    }\r\n\r\n    // Authorization Errors\r\n    if (status === HttpStatus.FORBIDDEN) {\r\n      if (lowerMessage.includes('role')) {\r\n        return ErrorCodes.AUTH_INSUFFICIENT_ROLE;\r\n      }\r\n      return ErrorCodes.AUTH_ACCESS_DENIED;\r\n    }\r\n\r\n    // Conflict Errors\r\n    if (status === HttpStatus.CONFLICT) {\r\n      if (lowerMessage.includes('email')) {\r\n        return ErrorCodes.USER_EMAIL_EXISTS;\r\n      }\r\n      if (lowerMessage.includes('username')) {\r\n        return ErrorCodes.USER_USERNAME_EXISTS;\r\n      }\r\n    }\r\n\r\n    // Not Found Errors\r\n    if (status === HttpStatus.NOT_FOUND) {\r\n      if (lowerMessage.includes('user')) {\r\n        return ErrorCodes.USER_NOT_FOUND;\r\n      }\r\n    }\r\n\r\n    return defaultCode;\r\n  }\r\n\r\n  /**\r\n   * Extrahiert Request ID für Tracing\r\n   *\r\n   * Request ID kann kommen von:\r\n   * - X-Request-ID Header (gesetzt von Load Balancer/Gateway)\r\n   * - Custom Middleware\r\n   */\r\n  private extractRequestId(request: Request): string | undefined {\r\n    return (\r\n      (request.headers['x-request-id'] as string) ||\r\n      (request.headers['x-correlation-id'] as string) ||\r\n      undefined\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Logging mit unterschiedlichen Levels je nach Error-Typ\r\n   *\r\n   * LOGGING STRATEGY:\r\n   * - 4xx (Client Errors): warn Level (User-Fehler)\r\n   * - 5xx (Server Errors): error Level (Unsere Fehler)\r\n   *\r\n   * FORMAT:\r\n   * [METHOD] /path - STATUS CODE: message\r\n   */\r\n  private logError(\r\n    exception: HttpException,\r\n    request: Request,\r\n    status: number,\r\n    code: string,\r\n  ): void {\r\n    const { method, url, ip } = request;\r\n    const message = exception.message;\r\n    const userAgent = request.headers['user-agent'] || 'unknown';\r\n\r\n    // Log Context für strukturiertes Logging\r\n    const logContext = {\r\n      method,\r\n      url,\r\n      status,\r\n      code,\r\n      ip,\r\n      userAgent: userAgent.substring(0, 100), // Truncate für Performance\r\n    };\r\n\r\n    // Log Level basierend auf Status\r\n    if (status >= 500) {\r\n      // Server Errors: Immer mit Stack Trace loggen\r\n      this.logger.error(\r\n        `[${method}] ${url} - ${status} ${code}: ${message}`,\r\n        exception.stack,\r\n        JSON.stringify(logContext),\r\n      );\r\n    } else if (status === 401 || status === 403) {\r\n      // Auth Errors: Security-relevant, warn Level\r\n      this.logger.warn(\r\n        `[${method}] ${url} - ${status} ${code}: ${message}`,\r\n        JSON.stringify(logContext),\r\n      );\r\n    } else if (status >= 400) {\r\n      // Client Errors: Debug Level (zu viel Noise bei warn)\r\n      this.logger.debug(\r\n        `[${method}] ${url} - ${status} ${code}: ${message}`,\r\n        JSON.stringify(logContext),\r\n      );\r\n    }\r\n  }\r\n}\r\n"],"version":3}