6be7510f5a52662efa3bd77bbfb6cbff
"use strict";
/* eslint-disable @typescript-eslint/no-unsafe-argument */
/* eslint-disable @typescript-eslint/no-unsafe-assignment */
// test/unit/filters/http-exception.filter.spec.ts
Object.defineProperty(exports, "__esModule", { value: true });
const common_1 = require("@nestjs/common");
const constants_1 = require("../../../src/shared/constants");
const http_exception_filter_1 = require("../../../src/shared/filters/http-exception.filter");
const test_utils_1 = require("../../setup/test-utils");
/**
 * HttpExceptionFilter Unit Tests
 *
 * Testet:
 * - Verschiedene HTTP Status Codes
 * - Error Code Inferenz
 * - Response Format
 */
describe('HttpExceptionFilter', () => {
    let filter;
    let mockResponse;
    let mockRequest;
    beforeEach(() => {
        filter = new http_exception_filter_1.HttpExceptionFilter();
        mockResponse = (0, test_utils_1.createMockResponse)();
        mockRequest = (0, test_utils_1.createMockRequest)();
    });
    afterEach(() => {
        jest.clearAllMocks();
    });
    describe('catch', () => {
        describe('response format', () => {
            it('should return standardized error response format', () => {
                // Arrange
                const exception = new common_1.BadRequestException('Test error');
                const host = (0, test_utils_1.createMockArgumentsHost)(mockRequest, mockResponse);
                // Act
                filter.catch(exception, host);
                // Assert
                expect(mockResponse.status).toHaveBeenCalledWith(common_1.HttpStatus.BAD_REQUEST);
                expect(mockResponse.json).toHaveBeenCalledWith(expect.objectContaining({
                    success: false,
                    error: expect.objectContaining({
                        message: 'Test error',
                        statusCode: 400,
                    }),
                    meta: expect.objectContaining({
                        path: mockRequest.url,
                        method: mockRequest.method,
                        timestamp: expect.any(String),
                    }),
                }));
            });
            it('should include request id from headers', () => {
                // Arrange
                const requestWithId = (0, test_utils_1.createMockRequest)({
                    headers: { 'x-request-id': 'trace-123' },
                });
                const exception = new common_1.BadRequestException('With request id');
                const host = (0, test_utils_1.createMockArgumentsHost)(requestWithId, mockResponse);
                // Act
                filter.catch(exception, host);
                // Assert
                // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access
                const jsonCall = mockResponse.json.mock.calls[0][0];
                // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access
                expect(jsonCall.meta.requestId).toBe('trace-123');
            });
        });
        describe('error code inference', () => {
            it('should infer AUTH_TOKEN_MISSING for "missing token" message', () => {
                // Arrange
                const exception = new common_1.UnauthorizedException('Missing authentication token');
                const host = (0, test_utils_1.createMockArgumentsHost)(mockRequest, mockResponse);
                // Act
                filter.catch(exception, host);
                // Assert
                expect(mockResponse.json).toHaveBeenCalledWith(expect.objectContaining({
                    error: expect.objectContaining({
                        code: constants_1.ErrorCodes.AUTH_TOKEN_MISSING,
                    }),
                }));
            });
            it('should infer AUTH_TOKEN_EXPIRED for "expired" message', () => {
                // Arrange
                const exception = new common_1.UnauthorizedException('Token has expired');
                const host = (0, test_utils_1.createMockArgumentsHost)(mockRequest, mockResponse);
                // Act
                filter.catch(exception, host);
                // Assert
                expect(mockResponse.json).toHaveBeenCalledWith(expect.objectContaining({
                    error: expect.objectContaining({
                        code: constants_1.ErrorCodes.AUTH_TOKEN_EXPIRED,
                    }),
                }));
            });
            it('should infer AUTH_INVALID_CREDENTIALS for login failure', () => {
                // Arrange
                const exception = new common_1.UnauthorizedException('Invalid email or password');
                const host = (0, test_utils_1.createMockArgumentsHost)(mockRequest, mockResponse);
                // Act
                filter.catch(exception, host);
                // Assert
                expect(mockResponse.json).toHaveBeenCalledWith(expect.objectContaining({
                    error: expect.objectContaining({
                        code: constants_1.ErrorCodes.AUTH_INVALID_CREDENTIALS,
                    }),
                }));
            });
            it('should infer USER_EMAIL_EXISTS for email conflict', () => {
                // Arrange
                const exception = new common_1.ConflictException('Email is already registered');
                const host = (0, test_utils_1.createMockArgumentsHost)(mockRequest, mockResponse);
                // Act
                filter.catch(exception, host);
                // Assert
                expect(mockResponse.json).toHaveBeenCalledWith(expect.objectContaining({
                    error: expect.objectContaining({
                        code: constants_1.ErrorCodes.USER_EMAIL_EXISTS,
                    }),
                }));
            });
            it('should infer USER_USERNAME_EXISTS for username conflicts', () => {
                // Arrange
                const exception = new common_1.ConflictException('Username already taken');
                const host = (0, test_utils_1.createMockArgumentsHost)(mockRequest, mockResponse);
                // Act
                filter.catch(exception, host);
                // Assert
                expect(mockResponse.json).toHaveBeenCalledWith(expect.objectContaining({
                    error: expect.objectContaining({
                        code: constants_1.ErrorCodes.USER_USERNAME_EXISTS,
                    }),
                }));
            });
            it('should infer AUTH_INSUFFICIENT_ROLE for role-based forbiddance', () => {
                // Arrange
                const exception = new common_1.HttpException('role required', common_1.HttpStatus.FORBIDDEN);
                const host = (0, test_utils_1.createMockArgumentsHost)(mockRequest, mockResponse);
                // Act
                filter.catch(exception, host);
                // Assert
                expect(mockResponse.json).toHaveBeenCalledWith(expect.objectContaining({
                    error: expect.objectContaining({
                        code: constants_1.ErrorCodes.AUTH_INSUFFICIENT_ROLE,
                    }),
                }));
            });
            it('should infer USER_NOT_FOUND for user not found', () => {
                // Arrange
                const exception = new common_1.NotFoundException('User not found');
                const host = (0, test_utils_1.createMockArgumentsHost)(mockRequest, mockResponse);
                // Act
                filter.catch(exception, host);
                // Assert
                expect(mockResponse.json).toHaveBeenCalledWith(expect.objectContaining({
                    error: expect.objectContaining({
                        code: constants_1.ErrorCodes.USER_NOT_FOUND,
                    }),
                }));
            });
        });
        describe('validation error handling', () => {
            it('should include validation details in response', () => {
                // Arrange
                const exception = new common_1.BadRequestException({
                    message: 'Validation failed',
                    code: 'VALIDATION_ERROR',
                    errors: {
                        email: ['Invalid email format'],
                        password: ['Too short'],
                    },
                });
                const host = (0, test_utils_1.createMockArgumentsHost)(mockRequest, mockResponse);
                // Act
                filter.catch(exception, host);
                // Assert
                expect(mockResponse.json).toHaveBeenCalledWith(expect.objectContaining({
                    error: expect.objectContaining({
                        details: expect.objectContaining({
                            fields: expect.objectContaining({
                                email: ['Invalid email format'],
                                password: ['Too short'],
                            }),
                        }),
                    }),
                }));
            });
            it('should normalize array messages and expose them as context', () => {
                // Arrange
                const exception = new common_1.BadRequestException({
                    message: ['first error', 'second error'],
                });
                const host = (0, test_utils_1.createMockArgumentsHost)(mockRequest, mockResponse);
                // Act
                filter.catch(exception, host);
                // Assert
                expect(mockResponse.json).toHaveBeenCalledWith(expect.objectContaining({
                    error: expect.objectContaining({
                        message: 'first error',
                        details: {
                            context: { messages: ['first error', 'second error'] },
                        },
                    }),
                }));
            });
        });
        describe('HTTP status codes', () => {
            const statusCases = [
                { status: common_1.HttpStatus.BAD_REQUEST, name: 'Bad Request' },
                { status: common_1.HttpStatus.UNAUTHORIZED, name: 'Unauthorized' },
                { status: common_1.HttpStatus.FORBIDDEN, name: 'Forbidden' },
                { status: common_1.HttpStatus.NOT_FOUND, name: 'Not Found' },
                { status: common_1.HttpStatus.CONFLICT, name: 'Conflict' },
                {
                    status: common_1.HttpStatus.INTERNAL_SERVER_ERROR,
                    name: 'Internal Server Error',
                },
            ];
            statusCases.forEach(({ status, name }) => {
                it(`should handle ${status} (${name})`, () => {
                    // Arrange
                    const exception = new common_1.HttpException('Test', status);
                    const host = (0, test_utils_1.createMockArgumentsHost)(mockRequest, mockResponse);
                    // Act
                    filter.catch(exception, host);
                    // Assert
                    expect(mockResponse.status).toHaveBeenCalledWith(status);
                    expect(mockResponse.json).toHaveBeenCalledWith(expect.objectContaining({
                        error: expect.objectContaining({
                            statusCode: status,
                        }),
                    }));
                });
            });
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aW11clxcUHJvZ3JhbW1pbmdcXFByb2plY3RzXFxzbmlwcGV0Zm9yZ2VcXGFwcHNcXGFwaVxcdGVzdFxcdW5pdFxcZmlsdGVyc1xcaHR0cC1leGNlcHRpb24uZmlsdGVyLnNwZWMudHMiLCJtYXBwaW5ncyI6IjtBQUFBLDBEQUEwRDtBQUMxRCw0REFBNEQ7QUFDNUQsa0RBQWtEOztBQUVsRCwyQ0FPd0I7QUFDeEIsNkRBQTJEO0FBQzNELDZGQUF3RjtBQUN4Rix1REFJZ0M7QUFFaEM7Ozs7Ozs7R0FPRztBQUNILFFBQVEsQ0FBQyxxQkFBcUIsRUFBRSxHQUFHLEVBQUU7SUFDbkMsSUFBSSxNQUEyQixDQUFDO0lBQ2hDLElBQUksWUFBbUQsQ0FBQztJQUN4RCxJQUFJLFdBQWlELENBQUM7SUFFdEQsVUFBVSxDQUFDLEdBQUcsRUFBRTtRQUNkLE1BQU0sR0FBRyxJQUFJLDJDQUFtQixFQUFFLENBQUM7UUFDbkMsWUFBWSxHQUFHLElBQUEsK0JBQWtCLEdBQUUsQ0FBQztRQUNwQyxXQUFXLEdBQUcsSUFBQSw4QkFBaUIsR0FBRSxDQUFDO0lBQ3BDLENBQUMsQ0FBQyxDQUFDO0lBRUgsU0FBUyxDQUFDLEdBQUcsRUFBRTtRQUNiLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUN2QixDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFO1FBQ3JCLFFBQVEsQ0FBQyxpQkFBaUIsRUFBRSxHQUFHLEVBQUU7WUFDL0IsRUFBRSxDQUFDLGtEQUFrRCxFQUFFLEdBQUcsRUFBRTtnQkFDMUQsVUFBVTtnQkFDVixNQUFNLFNBQVMsR0FBRyxJQUFJLDRCQUFtQixDQUFDLFlBQVksQ0FBQyxDQUFDO2dCQUN4RCxNQUFNLElBQUksR0FBRyxJQUFBLG9DQUF1QixFQUFDLFdBQVcsRUFBRSxZQUFZLENBQUMsQ0FBQztnQkFFaEUsTUFBTTtnQkFDTixNQUFNLENBQUMsS0FBSyxDQUFDLFNBQVMsRUFBRSxJQUFXLENBQUMsQ0FBQztnQkFFckMsU0FB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QUVoRSxNQUFNO29CQUNOLE1BQU0sQ0FBQyxLQUFLLENBQUMsU0FBUyxFQUFFLElBQVcsQ0FBQyxDQUFDO29CQUVyQyxTQUFTO29CQUNULE1BQU0sQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUMsb0JBQW9CLENBQUMsTUFBTSxDQUFDLENBQUM7b0JBQ3pELE1BQU0sQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUMsb0JBQW9CLENBQzVDLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQzt3QkFDdEIsS0FBSyxFQUFFLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQzs0QkFDN0IsVUFBVSxFQUFFLE1BQU07eUJBQ25CLENBQUM7cUJBQ0gsQ0FBQyxDQUNILENBQUM7Z0JBQ0osQ0FBQyxDQUFDLENBQUM7WUFDTCxDQUFDLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXHRpbXVyXFxQcm9ncmFtbWluZ1xcUHJvamVjdHNcXHNuaXBwZXRmb3JnZVxcYXBwc1xcYXBpXFx0ZXN0XFx1bml0XFxmaWx0ZXJzXFxodHRwLWV4Y2VwdGlvbi5maWx0ZXIuc3BlYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdW5zYWZlLWFyZ3VtZW50ICovXHJcbi8qIGVzbGludC1kaXNhYmxlIEB0eXBlc2NyaXB0LWVzbGludC9uby11bnNhZmUtYXNzaWdubWVudCAqL1xyXG4vLyB0ZXN0L3VuaXQvZmlsdGVycy9odHRwLWV4Y2VwdGlvbi5maWx0ZXIuc3BlYy50c1xyXG5cclxuaW1wb3J0IHtcclxuICBCYWRSZXF1ZXN0RXhjZXB0aW9uLFxyXG4gIENvbmZsaWN0RXhjZXB0aW9uLFxyXG4gIEh0dHBFeGNlcHRpb24sXHJcbiAgSHR0cFN0YXR1cyxcclxuICBOb3RGb3VuZEV4Y2VwdGlvbixcclxuICBVbmF1dGhvcml6ZWRFeGNlcHRpb24sXHJcbn0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xyXG5pbXBvcnQgeyBFcnJvckNvZGVzIH0gZnJvbSAnLi4vLi4vLi4vc3JjL3NoYXJlZC9jb25zdGFudHMnO1xyXG5pbXBvcnQgeyBIdHRwRXhjZXB0aW9uRmlsdGVyIH0gZnJvbSAnLi4vLi4vLi4vc3JjL3NoYXJlZC9maWx0ZXJzL2h0dHAtZXhjZXB0aW9uLmZpbHRlcic7XHJcbmltcG9ydCB7XHJcbiAgY3JlYXRlTW9ja0FyZ3VtZW50c0hvc3QsXHJcbiAgY3JlYXRlTW9ja1JlcXVlc3QsXHJcbiAgY3JlYXRlTW9ja1Jlc3BvbnNlLFxyXG59IGZyb20gJy4uLy4uL3NldHVwL3Rlc3QtdXRpbHMnO1xyXG5cclxuLyoqXHJcbiAqIEh0dHBFeGNlcHRpb25GaWx0ZXIgVW5pdCBUZXN0c1xyXG4gKlxyXG4gKiBUZXN0ZXQ6XHJcbiAqIC0gVmVyc2NoaWVkZW5lIEhUVFAgU3RhdHVzIENvZGVzXHJcbiAqIC0gRXJyb3IgQ29kZSBJbmZlcmVuelxyXG4gKiAtIFJlc3BvbnNlIEZvcm1hdFxyXG4gKi9cclxuZGVzY3JpYmUoJ0h0dHBFeGNlcHRpb25GaWx0ZXInLCAoKSA9PiB7XHJcbiAgbGV0IGZpbHRlcjogSHR0cEV4Y2VwdGlvbkZpbHRlcjtcclxuICBsZXQgbW9ja1Jlc3BvbnNlOiBSZXR1cm5UeXBlPHR5cGVvZiBjcmVhdGVNb2NrUmVzcG9uc2U+O1xyXG4gIGxldCBtb2NrUmVxdWVzdDogUmV0dXJuVHlwZTx0eXBlb2YgY3JlYXRlTW9ja1JlcXVlc3Q+O1xyXG5cclxuICBiZWZvcmVFYWNoKCgpID0+IHtcclxuICAgIGZpbHRlciA9IG5ldyBIdHRwRXhjZXB0aW9uRmlsdGVyKCk7XHJcbiAgICBtb2NrUmVzcG9uc2UgPSBjcmVhdGVNb2NrUmVzcG9uc2UoKTtcclxuICAgIG1vY2tSZXF1ZXN0ID0gY3JlYXRlTW9ja1JlcXVlc3QoKTtcclxuICB9KTtcclxuXHJcbiAgYWZ0ZXJFYWNoKCgpID0+IHtcclxuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnY2F0Y2gnLCAoKSA9PiB7XHJcbiAgICBkZXNjcmliZSgncmVzcG9uc2UgZm9ybWF0JywgKCkgPT4ge1xyXG4gICAgICBpdCgnc2hvdWxkIHJldHVybiBzdGFuZGFyZGl6ZWQgZXJyb3IgcmVzcG9uc2UgZm9ybWF0JywgKCkgPT4ge1xyXG4gICAgICAgIC8vIEFycmFuZ2VcclxuICAgICAgICBjb25zdCBleGNlcHRpb24gPSBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignVGVzdCBlcnJvcicpO1xyXG4gICAgICAgIGNvbnN0IGhvc3QgPSBjcmVhdGVNb2NrQXJndW1lbnRzSG9zdChtb2NrUmVxdWVzdCwgbW9ja1Jlc3BvbnNlKTtcclxuXHJcbiAgICAgICAgLy8gQWN0XHJcbiAgICAgICAgZmlsdGVyLmNhdGNoKGV4Y2VwdGlvbiwgaG9zdCBhcyBhbnkpO1xyXG5cclxuICAgICAgICAvLyBBc3NlcnRcclxuICAgICAgICBleHBlY3QobW9ja1Jlc3BvbnNlLnN0YXR1cykudG9IYXZlQmVlbkNhbGxlZFdpdGgoXHJcbiAgICAgICAgICBIdHRwU3RhdHVzLkJBRF9SRVFVRVNULFxyXG4gICAgICAgICk7XHJcbiAgICAgICAgZXhwZWN0KG1vY2tSZXNwb25zZS5qc29uKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcclxuICAgICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcclxuICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsXHJcbiAgICAgICAgICAgIGVycm9yOiBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XHJcbiAgICAgICAgICAgICAgbWVzc2FnZTogJ1Rlc3QgZXJyb3InLFxyXG4gICAgICAgICAgICAgIHN0YXR1c0NvZGU6IDQwMCxcclxuICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgIG1ldGE6IGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcclxuICAgICAgICAgICAgICBwYXRoOiBtb2NrUmVxdWVzdC51cmwsXHJcbiAgICAgICAgICAgICAgbWV0aG9kOiBtb2NrUmVxdWVzdC5tZXRob2QsXHJcbiAgICAgICAgICAgICAgdGltZXN0YW1wOiBleHBlY3QuYW55KFN0cmluZyksXHJcbiAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgfSksXHJcbiAgICAgICAgKTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBpdCgnc2hvdWxkIGluY2x1ZGUgcmVxdWVzdCBpZCBmcm9tIGhlYWRlcnMnLCAoKSA9PiB7XHJcbiAgICAgICAgLy8gQXJyYW5nZVxyXG4gICAgICAgIGNvbnN0IHJlcXVlc3RXaXRoSWQgPSBjcmVhdGVNb2NrUmVxdWVzdCh7XHJcbiAgICAgICAgICBoZWFkZXJzOiB7ICd4LXJlcXVlc3QtaWQnOiAndHJhY2UtMTIzJyB9LFxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGNvbnN0IGV4Y2VwdGlvbiA9IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdXaXRoIHJlcXVlc3QgaWQnKTtcclxuICAgICAgICBjb25zdCBob3N0ID0gY3JlYXRlTW9ja0FyZ3VtZW50c0hvc3QocmVxdWVzdFdpdGhJZCwgbW9ja1Jlc3BvbnNlKTtcclxuXHJcbiAgICAgICAgLy8gQWN0XHJcbiAgICAgICAgZmlsdGVyLmNhdGNoKGV4Y2VwdGlvbiwgaG9zdCBhcyBhbnkpO1xyXG5cclxuICAgICAgICAvLyBBc3NlcnRcclxuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXVuc2FmZS1tZW1iZXItYWNjZXNzXHJcbiAgICAgICAgY29uc3QganNvbkNhbGwgPSBtb2NrUmVzcG9uc2UuanNvbi5tb2NrLmNhbGxzWzBdWzBdO1xyXG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdW5zYWZlLW1lbWJlci1hY2Nlc3NcclxuICAgICAgICBleHBlY3QoanNvbkNhbGwubWV0YS5yZXF1ZXN0SWQpLnRvQmUoJ3RyYWNlLTEyMycpO1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG5cclxuICAgIGRlc2NyaWJlKCdlcnJvciBjb2RlIGluZmVyZW5jZScsICgpID0+IHtcclxuICAgICAgaXQoJ3Nob3VsZCBpbmZlciBBVVRIX1RPS0VOX01JU1NJTkcgZm9yIFwibWlzc2luZyB0b2tlblwiIG1lc3NhZ2UnLCAoKSA9PiB7XHJcbiAgICAgICAgLy8gQXJyYW5nZVxyXG4gICAgICAgIGNvbnN0IGV4Y2VwdGlvbiA9IG5ldyBVbmF1dGhvcml6ZWRFeGNlcHRpb24oXHJcbiAgICAgICAgICAnTWlzc2luZyBhdXRoZW50aWNhdGlvbiB0b2tlbicsXHJcbiAgICAgICAgKTtcclxuICAgICAgICBjb25zdCBob3N0ID0gY3JlYXRlTW9ja0FyZ3VtZW50c0hvc3QobW9ja1JlcXVlc3QsIG1vY2tSZXNwb25zZSk7XHJcblxyXG4gICAgICAgIC8vIEFjdFxyXG4gICAgICAgIGZpbHRlci5jYXRjaChleGNlcHRpb24sIGhvc3QgYXMgYW55KTtcclxuXHJcbiAgICAgICAgLy8gQXNzZXJ0XHJcbiAgICAgICAgZXhwZWN0KG1vY2tSZXNwb25zZS5qc29uKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcclxuICAgICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcclxuICAgICAgICAgICAgZXJyb3I6IGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcclxuICAgICAgICAgICAgICBjb2RlOiBFcnJvckNvZGVzLkFVVEhfVE9LRU5fTUlTU0lORyxcclxuICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICB9KSxcclxuICAgICAgICApO1xyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGl0KCdzaG91bGQgaW5mZXIgQVVUSF9UT0tFTl9FWFBJUkVEIGZvciBcImV4cGlyZWRcIiBtZXNzYWdlJywgKCkgPT4ge1xyXG4gICAgICAgIC8vIEFycmFuZ2VcclxuICAgICAgICBjb25zdCBleGNlcHRpb24gPSBuZXcgVW5hdXRob3JpemVkRXhjZXB0aW9uKCdUb2tlbiBoYXMgZXhwaXJlZCcpO1xyXG4gICAgICAgIGNvbnN0IGhvc3QgPSBjcmVhdGVNb2NrQXJndW1lbnRzSG9zdChtb2NrUmVxdWVzdCwgbW9ja1Jlc3BvbnNlKTtcclxuXHJcbiAgICAgICAgLy8gQWN0XHJcbiAgICAgICAgZmlsdGVyLmNhdGNoKGV4Y2VwdGlvbiwgaG9zdCBhcyBhbnkpO1xyXG5cclxuICAgICAgICAvLyBBc3NlcnRcclxuICAgICAgICBleHBlY3QobW9ja1Jlc3BvbnNlLmpzb24pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxyXG4gICAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xyXG4gICAgICAgICAgICBlcnJvcjogZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xyXG4gICAgICAgICAgICAgIGNvZGU6IEVycm9yQ29kZXMuQVVUSF9UT0tFTl9FWFBJUkVELFxyXG4gICAgICAgICAgICB9KSxcclxuICAgICAgICAgIH0pLFxyXG4gICAgICAgICk7XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgaXQoJ3Nob3VsZCBpbmZlciBBVVRIX0lOVkFMSURfQ1JFREVOVElBTFMgZm9yIGxvZ2luIGZhaWx1cmUnLCAoKSA9PiB7XHJcbiAgICAgICAgLy8gQXJyYW5nZVxyXG4gICAgICAgIGNvbnN0IGV4Y2VwdGlvbiA9IG5ldyBVbmF1dGhvcml6ZWRFeGNlcHRpb24oXHJcbiAgICAgICAgICAnSW52YWxpZCBlbWFpbCBvciBwYXNzd29yZCcsXHJcbiAgICAgICAgKTtcclxuICAgICAgICBjb25zdCBob3N0ID0gY3JlYXRlTW9ja0FyZ3VtZW50c0hvc3QobW9ja1JlcXVlc3QsIG1vY2tSZXNwb25zZSk7XHJcblxyXG4gICAgICAgIC8vIEFjdFxyXG4gICAgICAgIGZpbHRlci5jYXRjaChleGNlcHRpb24sIGhvc3QgYXMgYW55KTtcclxuXHJcbiAgICAgICAgLy8gQXNzZXJ0XHJcbiAgICAgICAgZXhwZWN0KG1vY2tSZXNwb25zZS5qc29uKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcclxuICAgICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcclxuICAgICAgICAgICAgZXJyb3I6IGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcclxuICAgICAgICAgICAgICBjb2RlOiBFcnJvckNvZGVzLkFVVEhfSU5WQUxJRF9DUkVERU5USUFMUyxcclxuICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICB9KSxcclxuICAgICAgICApO1xyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGl0KCdzaG91bGQgaW5mZXIgVVNFUl9FTUFJTF9FWElTVFMgZm9yIGVtYWlsIGNvbmZsaWN0JywgKCkgPT4ge1xyXG4gICAgICAgIC8vIEFycmFuZ2VcclxuICAgICAgICBjb25zdCBleGNlcHRpb24gPSBuZXcgQ29uZmxpY3RFeGNlcHRpb24oJ0VtYWlsIGlzIGFscmVhZHkgcmVnaXN0ZXJlZCcpO1xyXG4gICAgICAgIGNvbnN0IGhvc3QgPSBjcmVhdGVNb2NrQXJndW1lbnRzSG9zdChtb2NrUmVxdWVzdCwgbW9ja1Jlc3BvbnNlKTtcclxuXHJcbiAgICAgICAgLy8gQWN0XHJcbiAgICAgICAgZmlsdGVyLmNhdGNoKGV4Y2VwdGlvbiwgaG9zdCBhcyBhbnkpO1xyXG5cclxuICAgICAgICAvLyBBc3NlcnRcclxuICAgICAgICBleHBlY3QobW9ja1Jlc3BvbnNlLmpzb24pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxyXG4gICAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xyXG4gICAgICAgICAgICBlcnJvcjogZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xyXG4gICAgICAgICAgICAgIGNvZGU6IEVycm9yQ29kZXMuVVNFUl9FTUFJTF9FWElTVFMsXHJcbiAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgfSksXHJcbiAgICAgICAgKTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBpdCgnc2hvdWxkIGluZmVyIFVTRVJfVVNFUk5BTUVfRVhJU1RTIGZvciB1c2VybmFtZSBjb25mbGljdHMnLCAoKSA9PiB7XHJcbiAgICAgICAgLy8gQXJyYW5nZVxyXG4gICAgICAgIGNvbnN0IGV4Y2VwdGlvbiA9IG5ldyBDb25mbGljdEV4Y2VwdGlvbignVXNlcm5hbWUgYWxyZWFkeSB0YWtlbicpO1xyXG4gICAgICAgIGNvbnN0IGhvc3QgPSBjcmVhdGVNb2NrQXJndW1lbnRzSG9zdChtb2NrUmVxdWVzdCwgbW9ja1Jlc3BvbnNlKTtcclxuXHJcbiAgICAgICAgLy8gQWN0XHJcbiAgICAgICAgZmlsdGVyLmNhdGNoKGV4Y2VwdGlvbiwgaG9zdCBhcyBhbnkpO1xyXG5cclxuICAgICAgICAvLyBBc3NlcnRcclxuICAgICAgICBleHBlY3QobW9ja1Jlc3BvbnNlLmpzb24pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxyXG4gICAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xyXG4gICAgICAgICAgICBlcnJvcjogZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xyXG4gICAgICAgICAgICAgIGNvZGU6IEVycm9yQ29kZXMuVVNFUl9VU0VSTkFNRV9FWElTVFMsXHJcbiAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgfSksXHJcbiAgICAgICAgKTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBpdCgnc2hvdWxkIGluZmVyIEFVVEhfSU5TVUZGSUNJRU5UX1JPTEUgZm9yIHJvbGUtYmFzZWQgZm9yYmlkZGFuY2UnLCAoKSA9PiB7XHJcbiAgICAgICAgLy8gQXJyYW5nZVxyXG4gICAgICAgIGNvbnN0IGV4Y2VwdGlvbiA9IG5ldyBIdHRwRXhjZXB0aW9uKFxyXG4gICAgICAgICAgJ3JvbGUgcmVxdWlyZWQnLFxyXG4gICAgICAgICAgSHR0cFN0YXR1cy5GT1JCSURERU4sXHJcbiAgICAgICAgKTtcclxuICAgICAgICBjb25zdCBob3N0ID0gY3JlYXRlTW9ja0FyZ3VtZW50c0hvc3QobW9ja1JlcXVlc3QsIG1vY2tSZXNwb25zZSk7XHJcblxyXG4gICAgICAgIC8vIEFjdFxyXG4gICAgICAgIGZpbHRlci5jYXRjaChleGNlcHRpb24sIGhvc3QgYXMgYW55KTtcclxuXHJcbiAgICAgICAgLy8gQXNzZXJ0XHJcbiAgICAgICAgZXhwZWN0KG1vY2tSZXNwb25zZS5qc29uKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcclxuICAgICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcclxuICAgICAgICAgICAgZXJyb3I6IGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcclxuICAgICAgICAgICAgICBjb2RlOiBFcnJvckNvZGVzLkFVVEhfSU5TVUZGSUNJRU5UX1JPTEUsXHJcbiAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgfSksXHJcbiAgICAgICAgKTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBpdCgnc2hvdWxkIGluZmVyIFVTRVJfTk9UX0ZPVU5EIGZvciB1c2VyIG5vdCBmb3VuZCcsICgpID0+IHtcclxuICAgICAgICAvLyBBcnJhbmdlXHJcbiAgICAgICAgY29uc3QgZXhjZXB0aW9uID0gbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdVc2VyIG5vdCBmb3VuZCcpO1xyXG4gICAgICAgIGNvbnN0IGhvc3QgPSBjcmVhdGVNb2NrQXJndW1lbnRzSG9zdChtb2NrUmVxdWVzdCwgbW9ja1Jlc3BvbnNlKTtcclxuXHJcbiAgICAgICAgLy8gQWN0XHJcbiAgICAgICAgZmlsdGVyLmNhdGNoKGV4Y2VwdGlvbiwgaG9zdCBhcyBhbnkpO1xyXG5cclxuICAgICAgICAvLyBBc3NlcnRcclxuICAgICAgICBleHBlY3QobW9ja1Jlc3BvbnNlLmpzb24pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxyXG4gICAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xyXG4gICAgICAgICAgICBlcnJvcjogZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xyXG4gICAgICAgICAgICAgIGNvZGU6IEVycm9yQ29kZXMuVVNFUl9OT1RfRk9VTkQsXHJcbiAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgfSksXHJcbiAgICAgICAgKTtcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBkZXNjcmliZSgndmFsaWRhdGlvbiBlcnJvciBoYW5kbGluZycsICgpID0+IHtcclxuICAgICAgaXQoJ3Nob3VsZCBpbmNsdWRlIHZhbGlkYXRpb24gZGV0YWlscyBpbiByZXNwb25zZScsICgpID0+IHtcclxuICAgICAgICAvLyBBcnJhbmdlXHJcbiAgICAgICAgY29uc3QgZXhjZXB0aW9uID0gbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oe1xyXG4gICAgICAgICAgbWVzc2FnZTogJ1ZhbGlkYXRpb24gZmFpbGVkJyxcclxuICAgICAgICAgIGNvZGU6ICdWQUxJREFUSU9OX0VSUk9SJyxcclxuICAgICAgICAgIGVycm9yczoge1xyXG4gICAgICAgICAgICBlbWFpbDogWydJbnZhbGlkIGVtYWlsIGZvcm1hdCddLFxyXG4gICAgICAgICAgICBwYXNzd29yZDogWydUb28gc2hvcnQnXSxcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgY29uc3QgaG9zdCA9IGNyZWF0ZU1vY2tBcmd1bWVudHNIb3N0KG1vY2tSZXF1ZXN0LCBtb2NrUmVzcG9uc2UpO1xyXG5cclxuICAgICAgICAvLyBBY3RcclxuICAgICAgICBmaWx0ZXIuY2F0Y2goZXhjZXB0aW9uLCBob3N0IGFzIGFueSk7XHJcblxyXG4gICAgICAgIC8vIEFzc2VydFxyXG4gICAgICAgIGV4cGVjdChtb2NrUmVzcG9uc2UuanNvbikudG9IYXZlQmVlbkNhbGxlZFdpdGgoXHJcbiAgICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XHJcbiAgICAgICAgICAgIGVycm9yOiBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XHJcbiAgICAgICAgICAgICAgZGV0YWlsczogZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xyXG4gICAgICAgICAgICAgICAgZmllbGRzOiBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XHJcbiAgICAgICAgICAgICAgICAgIGVtYWlsOiBbJ0ludmFsaWQgZW1haWwgZm9ybWF0J10sXHJcbiAgICAgICAgICAgICAgICAgIHBhc3N3b3JkOiBbJ1RvbyBzaG9ydCddLFxyXG4gICAgICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgfSksXHJcbiAgICAgICAgKTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBpdCgnc2hvdWxkIG5vcm1hbGl6ZSBhcnJheSBtZXNzYWdlcyBhbmQgZXhwb3NlIHRoZW0gYXMgY29udGV4dCcsICgpID0+IHtcclxuICAgICAgICAvLyBBcnJhbmdlXHJcbiAgICAgICAgY29uc3QgZXhjZXB0aW9uID0gbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oe1xyXG4gICAgICAgICAgbWVzc2FnZTogWydmaXJzdCBlcnJvcicsICdzZWNvbmQgZXJyb3InXSxcclxuICAgICAgICB9KTtcclxuICAgICAgICBjb25zdCBob3N0ID0gY3JlYXRlTW9ja0FyZ3VtZW50c0hvc3QobW9ja1JlcXVlc3QsIG1vY2tSZXNwb25zZSk7XHJcblxyXG4gICAgICAgIC8vIEFjdFxyXG4gICAgICAgIGZpbHRlci5jYXRjaChleGNlcHRpb24sIGhvc3QgYXMgYW55KTtcclxuXHJcbiAgICAgICAgLy8gQXNzZXJ0XHJcbiAgICAgICAgZXhwZWN0KG1vY2tSZXNwb25zZS5qc29uKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcclxuICAgICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcclxuICAgICAgICAgICAgZXJyb3I6IGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcclxuICAgICAgICAgICAgICBtZXNzYWdlOiAnZmlyc3QgZXJyb3InLFxyXG4gICAgICAgICAgICAgIGRldGFpbHM6IHtcclxuICAgICAgICAgICAgICAgIGNvbnRleHQ6IHsgbWVzc2FnZXM6IFsnZmlyc3QgZXJyb3InLCAnc2Vjb25kIGVycm9yJ10gfSxcclxuICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICB9KSxcclxuICAgICAgICAgIH0pLFxyXG4gICAgICAgICk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgZGVzY3JpYmUoJ0hUVFAgc3RhdHVzIGNvZGVzJywgKCkgPT4ge1xyXG4gICAgICBjb25zdCBzdGF0dXNDYXNlcyA9IFtcclxuICAgICAgICB7IHN0YXR1czogSHR0cFN0YXR1cy5CQURfUkVRVUVTVCwgbmFtZTogJ0JhZCBSZXF1ZXN0JyB9LFxyXG4gICAgICAgIHsgc3RhdHVzOiBIdHRwU3RhdHVzLlVOQVVUSE9SSVpFRCwgbmFtZTogJ1VuYXV0aG9yaXplZCcgfSxcclxuICAgICAgICB7IHN0YXR1czogSHR0cFN0YXR1cy5GT1JCSURERU4sIG5hbWU6ICdGb3JiaWRkZW4nIH0sXHJcbiAgICAgICAgeyBzdGF0dXM6IEh0dHBTdGF0dXMuTk9UX0ZPVU5ELCBuYW1lOiAnTm90IEZvdW5kJyB9LFxyXG4gICAgICAgIHsgc3RhdHVzOiBIdHRwU3RhdHVzLkNPTkZMSUNULCBuYW1lOiAnQ29uZmxpY3QnIH0sXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgc3RhdHVzOiBIdHRwU3RhdHVzLklOVEVSTkFMX1NFUlZFUl9FUlJPUixcclxuICAgICAgICAgIG5hbWU6ICdJbnRlcm5hbCBTZXJ2ZXIgRXJyb3InLFxyXG4gICAgICAgIH0sXHJcbiAgICAgIF07XHJcblxyXG4gICAgICBzdGF0dXNDYXNlcy5mb3JFYWNoKCh7IHN0YXR1cywgbmFtZSB9KSA9PiB7XHJcbiAgICAgICAgaXQoYHNob3VsZCBoYW5kbGUgJHtzdGF0dXN9ICgke25hbWV9KWAsICgpID0+IHtcclxuICAgICAgICAgIC8vIEFycmFuZ2VcclxuICAgICAgICAgIGNvbnN0IGV4Y2VwdGlvbiA9IG5ldyBIdHRwRXhjZXB0aW9uKCdUZXN0Jywgc3RhdHVzKTtcclxuICAgICAgICAgIGNvbnN0IGhvc3QgPSBjcmVhdGVNb2NrQXJndW1lbnRzSG9zdChtb2NrUmVxdWVzdCwgbW9ja1Jlc3BvbnNlKTtcclxuXHJcbiAgICAgICAgICAvLyBBY3RcclxuICAgICAgICAgIGZpbHRlci5jYXRjaChleGNlcHRpb24sIGhvc3QgYXMgYW55KTtcclxuXHJcbiAgICAgICAgICAvLyBBc3NlcnRcclxuICAgICAgICAgIGV4cGVjdChtb2NrUmVzcG9uc2Uuc3RhdHVzKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChzdGF0dXMpO1xyXG4gICAgICAgICAgZXhwZWN0KG1vY2tSZXNwb25zZS5qc29uKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcclxuICAgICAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xyXG4gICAgICAgICAgICAgIGVycm9yOiBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XHJcbiAgICAgICAgICAgICAgICBzdGF0dXNDb2RlOiBzdGF0dXMsXHJcbiAgICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgKTtcclxuICAgICAgICB9KTtcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9KTtcclxufSk7XHJcbiJdLCJ2ZXJzaW9uIjozfQ==