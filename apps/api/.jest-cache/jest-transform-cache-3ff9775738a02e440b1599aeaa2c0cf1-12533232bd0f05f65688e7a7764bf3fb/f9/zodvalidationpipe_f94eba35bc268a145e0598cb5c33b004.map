{"file":"C:\\Users\\timur\\Programming\\Projects\\snippetforge\\apps\\api\\src\\shared\\pipes\\zod-validation.pipe.ts","mappings":";AAAA,0CAA0C;;;;;;;;;;;;AAE1C,2CAAgF;AAChF,6BAA+C;AAC/C,4CAA0C;AAE1C;;;;;;;;;;;;;;;;;;;GAmBG;AAEI,IAAM,iBAAiB,GAAvB,MAAM,iBAAiB;IACR;IAApB,YAAoB,MAAoB;QAApB,WAAM,GAAN,MAAM,CAAc;IAAG,CAAC;IAE5C;;OAEG;IACH,SAAS,CAAC,KAAc;QACtB,IAAI,CAAC;YACH,yDAAyD;YACzD,OAAO,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC;QAClC,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,IAAI,KAAK,YAAY,cAAQ,EAAE,CAAC;gBAC9B,wBAAwB;gBACxB,MAAM,eAAe,GAAG,IAAI,CAAC,eAAe,CAAC,KAAK,CAAC,CAAC;gBAEpD,wCAAwC;gBACxC,gDAAgD;gBAChD,MAAM,IAAI,4BAAmB,CAAC;oBAC5B,OAAO,EAAE,mBAAmB;oBAC5B,IAAI,EAAE,sBAAU,CAAC,gBAAgB;oBACjC,MAAM,EAAE,eAAe;iBACxB,CAAC,CAAC;YACL,CAAC;YAED,mCAAmC;YACnC,MAAM,KAAK,CAAC;QACd,CAAC;IACH,CAAC;IAED;;;;;;;;;;;;;;OAcG;IACK,eAAe,CAAC,KAAe;QACrC,MAAM,eAAe,GAA6B,EAAE,CAAC;QAErD,KAAK,MAAM,KAAK,IAAI,KAAK,CAAC,MAAM,EAAE,CAAC;YACjC,0DAA0D;YAC1D,MAAM,IAAI,GAAG,KAAK,CAAC,IAAI,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,wBAAwB;YAE7F,IAAI,CAAC,eAAe,CAAC,IAAI,CAAC,EAAE,CAAC;gBAC3B,eAAe,CAAC,IAAI,CAAC,GAAG,EAAE,CAAC;YAC7B,CAAC;YAED,eAAe,CAAC,IAAI,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC;QAC5C,CAAC;QAED,OAAO,eAAe,CAAC;IACzB,CAAC;CACF,CAAA;AA5DY,8CAAiB;4BAAjB,iBAAiB;IAD7B,IAAA,mBAAU,GAAE;;GACA,iBAAiB,CA4D7B","names":[],"sources":["C:\\Users\\timur\\Programming\\Projects\\snippetforge\\apps\\api\\src\\shared\\pipes\\zod-validation.pipe.ts"],"sourcesContent":["// src/shared/pipes/zod-validation.pipe.ts\r\n\r\nimport { BadRequestException, Injectable, PipeTransform } from '@nestjs/common';\r\nimport { ZodError, type ZodSchema } from 'zod';\r\nimport { ErrorCodes } from '../constants';\r\n\r\n/**\r\n * ZodValidationPipe - Validiert Input mit Zod Schemas\r\n *\r\n * VERWENDUNG:\r\n * @Post('register')\r\n * async register(\r\n *   @Body(new ZodValidationPipe(RegisterSchema)) dto: RegisterDto\r\n * ) {\r\n *   // dto ist GARANTIERT valide\r\n * }\r\n *\r\n * ERROR FORMAT:\r\n * Wirft BadRequestException mit speziellem Format,\r\n * das von HttpExceptionFilter erkannt wird.\r\n *\r\n * PERFORMANCE:\r\n * - Zod ist schnell (native JS, kein Reflection)\r\n * - Parse + Transform in einem Schritt\r\n * - Fehler werden früh erkannt (Fail Fast)\r\n */\r\n@Injectable()\r\nexport class ZodValidationPipe<T> implements PipeTransform<unknown, T> {\r\n  constructor(private schema: ZodSchema<T>) {}\r\n\r\n  /**\r\n   * Transform - Validiert und transformiert Input\r\n   */\r\n  transform(value: unknown): T {\r\n    try {\r\n      // Zod validiert UND transformiert (z.B. email lowercase)\r\n      return this.schema.parse(value);\r\n    } catch (error) {\r\n      if (error instanceof ZodError) {\r\n        // Formatiere Zod Errors\r\n        const formattedErrors = this.formatZodErrors(error);\r\n\r\n        // BadRequestException mit Custom Format\r\n        // HttpExceptionFilter erkennt 'errors' Property\r\n        throw new BadRequestException({\r\n          message: 'Validation failed',\r\n          code: ErrorCodes.VALIDATION_ERROR,\r\n          errors: formattedErrors,\r\n        });\r\n      }\r\n\r\n      // Unbekannter Error - weiterwerfen\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Formatiert Zod Errors in Frontend-freundliches Format\r\n   *\r\n   * INPUT (Zod Format):\r\n   * [\r\n   *   { path: ['email'], message: 'Invalid email' },\r\n   *   { path: ['password'], message: 'Too short' }\r\n   * ]\r\n   *\r\n   * OUTPUT:\r\n   * {\r\n   *   email: ['Invalid email'],\r\n   *   password: ['Too short']\r\n   * }\r\n   */\r\n  private formatZodErrors(error: ZodError): Record<string, string[]> {\r\n    const formattedErrors: Record<string, string[]> = {};\r\n\r\n    for (const issue of error.issues) {\r\n      // Path kann nested sein: ['user', 'email'] → 'user.email'\r\n      const path = issue.path.length > 0 ? issue.path.join('.') : '_root'; // Für root-level Errors\r\n\r\n      if (!formattedErrors[path]) {\r\n        formattedErrors[path] = [];\r\n      }\r\n\r\n      formattedErrors[path].push(issue.message);\r\n    }\r\n\r\n    return formattedErrors;\r\n  }\r\n}\r\n"],"version":3}