920f6471b5db2b67b70a3745531fa2f8
"use strict";
// src/shared/pipes/zod-validation.pipe.ts
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.ZodValidationPipe = void 0;
const common_1 = require("@nestjs/common");
const zod_1 = require("zod");
const constants_1 = require("../constants");
/**
 * ZodValidationPipe - Validiert Input mit Zod Schemas
 *
 * VERWENDUNG:
 * @Post('register')
 * async register(
 *   @Body(new ZodValidationPipe(RegisterSchema)) dto: RegisterDto
 * ) {
 *   // dto ist GARANTIERT valide
 * }
 *
 * ERROR FORMAT:
 * Wirft BadRequestException mit speziellem Format,
 * das von HttpExceptionFilter erkannt wird.
 *
 * PERFORMANCE:
 * - Zod ist schnell (native JS, kein Reflection)
 * - Parse + Transform in einem Schritt
 * - Fehler werden früh erkannt (Fail Fast)
 */
let ZodValidationPipe = class ZodValidationPipe {
    schema;
    constructor(schema) {
        this.schema = schema;
    }
    /**
     * Transform - Validiert und transformiert Input
     */
    transform(value) {
        try {
            // Zod validiert UND transformiert (z.B. email lowercase)
            return this.schema.parse(value);
        }
        catch (error) {
            if (error instanceof zod_1.ZodError) {
                // Formatiere Zod Errors
                const formattedErrors = this.formatZodErrors(error);
                // BadRequestException mit Custom Format
                // HttpExceptionFilter erkennt 'errors' Property
                throw new common_1.BadRequestException({
                    message: 'Validation failed',
                    code: constants_1.ErrorCodes.VALIDATION_ERROR,
                    errors: formattedErrors,
                });
            }
            // Unbekannter Error - weiterwerfen
            throw error;
        }
    }
    /**
     * Formatiert Zod Errors in Frontend-freundliches Format
     *
     * INPUT (Zod Format):
     * [
     *   { path: ['email'], message: 'Invalid email' },
     *   { path: ['password'], message: 'Too short' }
     * ]
     *
     * OUTPUT:
     * {
     *   email: ['Invalid email'],
     *   password: ['Too short']
     * }
     */
    formatZodErrors(error) {
        const formattedErrors = {};
        for (const issue of error.issues) {
            // Path kann nested sein: ['user', 'email'] → 'user.email'
            const path = issue.path.length > 0 ? issue.path.join('.') : '_root'; // Für root-level Errors
            if (!formattedErrors[path]) {
                formattedErrors[path] = [];
            }
            formattedErrors[path].push(issue.message);
        }
        return formattedErrors;
    }
};
exports.ZodValidationPipe = ZodValidationPipe;
exports.ZodValidationPipe = ZodValidationPipe = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [Object])
], ZodValidationPipe);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aW11clxcUHJvZ3JhbW1pbmdcXFByb2plY3RzXFxzbmlwcGV0Zm9yZ2VcXGFwcHNcXGFwaVxcc3JjXFxzaGFyZWRcXHBpcGVzXFx6b2QtdmFsaWRhdGlvbi5waXBlLnRzIiwibWFwcGluZ3MiOiI7QUFBQSwwQ0FBMEM7Ozs7Ozs7Ozs7OztBQUUxQywyQ0FBZ0Y7QUFDaEYsNkJBQStDO0FBQy9DLDRDQUEwQztBQUUxQzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQW1CRztBQUVJLElBQU0saUJBQWlCLEdBQXZCLE1BQU0saUJBQWlCO0lBQ1I7SUFBcEIsWUFBb0IsTUFBb0I7UUFBcEIsV0FBTSxHQUFOLE1BQU0sQ0FBYztJQUFHLENBQUM7SUFFNUM7O09BRUc7SUFDSCxTQUFTLENBQUMsS0FBYztRQUN0QixJQUFJLENBQUM7WUFDSCx5REFBeUQ7WUFDekQsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNsQyxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLElBQUksS0FBSyxZQUFZLGNBQVEsRUFBRSxDQUFDO2dCQUM5Qix3QkFBd0I7Z0JBQ3hCLE1BQU0sZUFBZSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBRXBELHdDQUF3QztnQkFDeEMsZ0RBQWdEO2dCQUNoRCxNQUFNLElBQUksNEJBQW1CLENBQUM7b0JBQzVCLE9BQU8sRUFBRSxtQkFBbUI7b0JBQzVCLElBQUksRUFBRSxzQkFBVSxDQUFDLGdCQUFnQjtvQkFDakMsTUFBTSxFQUFFLGVBQWU7aUJBQ3hCLENBQUMsQ0FBQztZQUNMLENBQUM7WUFFRCxtQ0FBbUM7WUFDbkMsTUFBTSxLQUFLLENBQUM7UUFDZCxDQUFDO0lBQ0gsQ0FBQztJQUVEOzs7Ozs7Ozs7Ozs7OztPQWNHO0lBQ0ssZUFBZSxDQUFDLEtBQWU7UUFDckMsTUFBTSxlQUFlLEdBQTZCLEVBQUUsQ0FBQztRQUVyRCxLQUFLLE1BQU0sS0FBSyxJQUFJLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUNqQywwREFBMEQ7WUFDMUQsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsd0JBQXdCO1lBRTdGLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztnQkFDM0IsZUFBZSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUM3QixDQUFDO1lBRUQsZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDNUMsQ0FBQztRQUVELE9BQU8sZUFBZSxDQUFDO0lBQ3pCLENBQUM7Q0FDRixDQUFBO0FBNURZLDhDQUFpQjs0QkFBakIsaUJBQWlCO0lBRDdCLElBQUEsbUJBQVUsR0FBRTs7R0FDQSxpQkFBaUIsQ0E0RDdCIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcdGltdXJcXFByb2dyYW1taW5nXFxQcm9qZWN0c1xcc25pcHBldGZvcmdlXFxhcHBzXFxhcGlcXHNyY1xcc2hhcmVkXFxwaXBlc1xcem9kLXZhbGlkYXRpb24ucGlwZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBzcmMvc2hhcmVkL3BpcGVzL3pvZC12YWxpZGF0aW9uLnBpcGUudHNcclxuXHJcbmltcG9ydCB7IEJhZFJlcXVlc3RFeGNlcHRpb24sIEluamVjdGFibGUsIFBpcGVUcmFuc2Zvcm0gfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XHJcbmltcG9ydCB7IFpvZEVycm9yLCB0eXBlIFpvZFNjaGVtYSB9IGZyb20gJ3pvZCc7XHJcbmltcG9ydCB7IEVycm9yQ29kZXMgfSBmcm9tICcuLi9jb25zdGFudHMnO1xyXG5cclxuLyoqXHJcbiAqIFpvZFZhbGlkYXRpb25QaXBlIC0gVmFsaWRpZXJ0IElucHV0IG1pdCBab2QgU2NoZW1hc1xyXG4gKlxyXG4gKiBWRVJXRU5EVU5HOlxyXG4gKiBAUG9zdCgncmVnaXN0ZXInKVxyXG4gKiBhc3luYyByZWdpc3RlcihcclxuICogICBAQm9keShuZXcgWm9kVmFsaWRhdGlvblBpcGUoUmVnaXN0ZXJTY2hlbWEpKSBkdG86IFJlZ2lzdGVyRHRvXHJcbiAqICkge1xyXG4gKiAgIC8vIGR0byBpc3QgR0FSQU5USUVSVCB2YWxpZGVcclxuICogfVxyXG4gKlxyXG4gKiBFUlJPUiBGT1JNQVQ6XHJcbiAqIFdpcmZ0IEJhZFJlcXVlc3RFeGNlcHRpb24gbWl0IHNwZXppZWxsZW0gRm9ybWF0LFxyXG4gKiBkYXMgdm9uIEh0dHBFeGNlcHRpb25GaWx0ZXIgZXJrYW5udCB3aXJkLlxyXG4gKlxyXG4gKiBQRVJGT1JNQU5DRTpcclxuICogLSBab2QgaXN0IHNjaG5lbGwgKG5hdGl2ZSBKUywga2VpbiBSZWZsZWN0aW9uKVxyXG4gKiAtIFBhcnNlICsgVHJhbnNmb3JtIGluIGVpbmVtIFNjaHJpdHRcclxuICogLSBGZWhsZXIgd2VyZGVuIGZyw7xoIGVya2FubnQgKEZhaWwgRmFzdClcclxuICovXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIFpvZFZhbGlkYXRpb25QaXBlPFQ+IGltcGxlbWVudHMgUGlwZVRyYW5zZm9ybTx1bmtub3duLCBUPiB7XHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBzY2hlbWE6IFpvZFNjaGVtYTxUPikge31cclxuXHJcbiAgLyoqXHJcbiAgICogVHJhbnNmb3JtIC0gVmFsaWRpZXJ0IHVuZCB0cmFuc2Zvcm1pZXJ0IElucHV0XHJcbiAgICovXHJcbiAgdHJhbnNmb3JtKHZhbHVlOiB1bmtub3duKTogVCB7XHJcbiAgICB0cnkge1xyXG4gICAgICAvLyBab2QgdmFsaWRpZXJ0IFVORCB0cmFuc2Zvcm1pZXJ0ICh6LkIuIGVtYWlsIGxvd2VyY2FzZSlcclxuICAgICAgcmV0dXJuIHRoaXMuc2NoZW1hLnBhcnNlKHZhbHVlKTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIFpvZEVycm9yKSB7XHJcbiAgICAgICAgLy8gRm9ybWF0aWVyZSBab2QgRXJyb3JzXHJcbiAgICAgICAgY29uc3QgZm9ybWF0dGVkRXJyb3JzID0gdGhpcy5mb3JtYXRab2RFcnJvcnMoZXJyb3IpO1xyXG5cclxuICAgICAgICAvLyBCYWRSZXF1ZXN0RXhjZXB0aW9uIG1pdCBDdXN0b20gRm9ybWF0XHJcbiAgICAgICAgLy8gSHR0cEV4Y2VwdGlvbkZpbHRlciBlcmtlbm50ICdlcnJvcnMnIFByb3BlcnR5XHJcbiAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oe1xyXG4gICAgICAgICAgbWVzc2FnZTogJ1ZhbGlkYXRpb24gZmFpbGVkJyxcclxuICAgICAgICAgIGNvZGU6IEVycm9yQ29kZXMuVkFMSURBVElPTl9FUlJPUixcclxuICAgICAgICAgIGVycm9yczogZm9ybWF0dGVkRXJyb3JzLFxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBVbmJla2FubnRlciBFcnJvciAtIHdlaXRlcndlcmZlblxyXG4gICAgICB0aHJvdyBlcnJvcjtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEZvcm1hdGllcnQgWm9kIEVycm9ycyBpbiBGcm9udGVuZC1mcmV1bmRsaWNoZXMgRm9ybWF0XHJcbiAgICpcclxuICAgKiBJTlBVVCAoWm9kIEZvcm1hdCk6XHJcbiAgICogW1xyXG4gICAqICAgeyBwYXRoOiBbJ2VtYWlsJ10sIG1lc3NhZ2U6ICdJbnZhbGlkIGVtYWlsJyB9LFxyXG4gICAqICAgeyBwYXRoOiBbJ3Bhc3N3b3JkJ10sIG1lc3NhZ2U6ICdUb28gc2hvcnQnIH1cclxuICAgKiBdXHJcbiAgICpcclxuICAgKiBPVVRQVVQ6XHJcbiAgICoge1xyXG4gICAqICAgZW1haWw6IFsnSW52YWxpZCBlbWFpbCddLFxyXG4gICAqICAgcGFzc3dvcmQ6IFsnVG9vIHNob3J0J11cclxuICAgKiB9XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBmb3JtYXRab2RFcnJvcnMoZXJyb3I6IFpvZEVycm9yKTogUmVjb3JkPHN0cmluZywgc3RyaW5nW10+IHtcclxuICAgIGNvbnN0IGZvcm1hdHRlZEVycm9yczogUmVjb3JkPHN0cmluZywgc3RyaW5nW10+ID0ge307XHJcblxyXG4gICAgZm9yIChjb25zdCBpc3N1ZSBvZiBlcnJvci5pc3N1ZXMpIHtcclxuICAgICAgLy8gUGF0aCBrYW5uIG5lc3RlZCBzZWluOiBbJ3VzZXInLCAnZW1haWwnXSDihpIgJ3VzZXIuZW1haWwnXHJcbiAgICAgIGNvbnN0IHBhdGggPSBpc3N1ZS5wYXRoLmxlbmd0aCA+IDAgPyBpc3N1ZS5wYXRoLmpvaW4oJy4nKSA6ICdfcm9vdCc7IC8vIEbDvHIgcm9vdC1sZXZlbCBFcnJvcnNcclxuXHJcbiAgICAgIGlmICghZm9ybWF0dGVkRXJyb3JzW3BhdGhdKSB7XHJcbiAgICAgICAgZm9ybWF0dGVkRXJyb3JzW3BhdGhdID0gW107XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGZvcm1hdHRlZEVycm9yc1twYXRoXS5wdXNoKGlzc3VlLm1lc3NhZ2UpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBmb3JtYXR0ZWRFcnJvcnM7XHJcbiAgfVxyXG59XHJcbiJdLCJ2ZXJzaW9uIjozfQ==