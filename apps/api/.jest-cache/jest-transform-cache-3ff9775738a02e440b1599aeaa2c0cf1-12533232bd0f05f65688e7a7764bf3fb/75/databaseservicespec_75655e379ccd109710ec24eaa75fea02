076ca7a72accc5d0d1b278710e15aad1
"use strict";
/* eslint-disable @typescript-eslint/no-unsafe-call */
/* eslint-disable @typescript-eslint/no-unsafe-assignment */
/* eslint-disable @typescript-eslint/no-unsafe-member-access */
/* eslint-disable @typescript-eslint/no-unsafe-return */
// test/unit/services/database.service.spec.ts
Object.defineProperty(exports, "__esModule", { value: true });
const config_1 = require("@nestjs/config");
const testing_1 = require("@nestjs/testing");
const database_service_1 = require("../../../src/shared/database/database.service");
describe('DatabaseService', () => {
    let service;
    let mockConfigService;
    let mockClient;
    beforeEach(async () => {
        // Mock postgres constructor
        jest.mock('postgres', () => {
            return jest.fn(() => mockClient);
        });
        mockClient = {
            end: jest.fn().mockResolvedValue(undefined),
            unsafe: jest.fn().mockResolvedValue([]),
        };
        mockConfigService = {
            get: jest.fn((key) => {
                if (key === 'DATABASE_URL')
                    return 'postgresql://test:test@localhost:5432/test';
                if (key === 'NODE_ENV')
                    return 'test';
                return undefined;
            }),
        };
        const module = await testing_1.Test.createTestingModule({
            providers: [
                database_service_1.DatabaseService,
                {
                    provide: config_1.ConfigService,
                    useValue: mockConfigService,
                },
            ],
        }).compile();
        service = module.get(database_service_1.DatabaseService);
    });
    describe('onModuleDestroy', () => {
        it('should close database connection', async () => {
            // Set up client
            service.client = mockClient;
            await service.onModuleDestroy();
            expect(mockClient.end).toHaveBeenCalled();
        });
        it('should handle missing client gracefully', async () => {
            service.client = null;
            await expect(service.onModuleDestroy()).resolves.not.toThrow();
        });
    });
    describe('drizzle getter', () => {
        it('should throw error when database not initialized', () => {
            expect(() => service.drizzle).toThrow('Database not initialized');
        });
    });
    describe('executeRaw', () => {
        it('should execute raw SQL', async () => {
            service.client = mockClient;
            mockClient.unsafe.mockResolvedValue([{ result: 'success' }]);
            const result = await service.executeRaw('SELECT 1');
            expect(result).toEqual([{ result: 'success' }]);
            expect(mockClient.unsafe).toHaveBeenCalledWith('SELECT 1');
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aW11clxcUHJvZ3JhbW1pbmdcXFByb2plY3RzXFxzbmlwcGV0Zm9yZ2VcXGFwcHNcXGFwaVxcdGVzdFxcdW5pdFxcc2VydmljZXNcXGRhdGFiYXNlLnNlcnZpY2Uuc3BlYy50cyIsIm1hcHBpbmdzIjoiO0FBQUEsc0RBQXNEO0FBQ3RELDREQUE0RDtBQUM1RCwrREFBK0Q7QUFDL0Qsd0RBQXdEO0FBQ3hELDhDQUE4Qzs7QUFFOUMsMkNBQStDO0FBQy9DLDZDQUFzRDtBQUN0RCxvRkFBZ0Y7QUFFaEYsUUFBUSxDQUFDLGlCQUFpQixFQUFFLEdBQUcsRUFBRTtJQUMvQixJQUFJLE9BQXdCLENBQUM7SUFDN0IsSUFBSSxpQkFBeUMsQ0FBQztJQUM5QyxJQUFJLFVBQWUsQ0FBQztJQUVwQixVQUFVLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFNcEIsNEJBQTRCO1FBQzVCLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLEdBQUcsRUFBRTtZQUN6QixPQUFPLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDbkMsQ0FBQyxDQUFDLENBQUM7UUFSSCxVQUFVLEdBQUc7WUFDWCxHQUFHLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGlCQUFpQixDQUFDLFNBQVMsQ0FBQztZQUMzQyxNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGlCQUFpQixDQUFDLEVBQUUsQ0FBQztTQUN4QyxDQUFDO1FBT0YsaUJBQWlCLEdBQUc7WUFDbEIsR0FBRyxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxHQUFXLEVBQUUsRUFBRTtnQkFDM0IsSUFBSSxHQUFHLEtBQUssY0FBYztvQkFDeEIsT0FBTyw0Q0FBNEMsQ0FBQztnQkFDdEQsSUFBSSxHQUFHLEtBQUssVUFBVTtvQkFBRSxPQUFPLE1BQU0sQ0FBQztnQkFDdEMsT0FBTyxTQUFTLENBQUM7WUFDbkIsQ0FBQyxDQUFDO1NBQ0gsQ0FBQztRQUVGLE1BQU0sTUFBTSxHQUFrQixNQUFNLGNBQUksQ0FBQyxtQkFBbUIsQ0FBQztZQUMzRCxTQUFTLEVBQUU7Z0JBQ1Qsa0NBQWU7Z0JBQ2Y7b0JBQ0UsT0FBTyxFQUFFLHNCQUFhO29CQUN0QixRQUFRLEVBQUUsaUJBQWlCO2lCQUM1QjthQUNGO1NBQ0YsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBRWIsT0FBTyxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQWtCLGtDQUFlLENBQUMsQ0FBQztJQUN6RCxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxpQkFBaUIsRUFBRSxHQUFHLEVBQUU7UUFDL0IsRUFBRSxDQUFDLGtDQUFrQyxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQ2hELGdCQUFnQjtZQUNmLE9BQWUsQ0FBQyxNQUFNLEdBQUcsVUFBVSxDQUFDO1lBRXJDLE1BQU0sT0FBTyxDQUFDLGVBQWUsRUFBRSxDQUFDO1lBRWhDLE1BQU0sQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUM1QyxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyx5Q0FBeUMsRUFBRSxLQUFLLElBQUksRUFBRTtZQUN0RCxPQUFlLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQztZQUUvQixNQUFNLE1BQU0sQ0FBQyxPQUFPLENBQUMsZUFBZSxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ2pFLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsZ0JBQWdCLEVBQUUsR0FBRyxFQUFFO1FBQzlCLEVBQUUsQ0FBQyxrREFBa0QsRUFBRSxHQUFHLEVBQUU7WUFDMUQsTUFBTSxDQUFDLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxPQUFPLENBQUMsMEJBQTBCLENBQUMsQ0FBQztRQUNwRSxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLFlBQVksRUFBRSxHQUFHLEVBQUU7UUFDMUIsRUFBRSxDQUFDLHdCQUF3QixFQUFFLEtBQUssSUFBSSxFQUFFO1lBQ3JDLE9BQWUsQ0FBQyxNQUFNLEdBQUcsVUFBVSxDQUFDO1lBQ3JDLFVBQVUsQ0FBQyxNQUFNLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFFN0QsTUFBTSxNQUFNLEdBQUcsTUFBTSxPQUFPLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBRXBELE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDaEQsTUFBTSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUM3RCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFx0aW11clxcUHJvZ3JhbW1pbmdcXFByb2plY3RzXFxzbmlwcGV0Zm9yZ2VcXGFwcHNcXGFwaVxcdGVzdFxcdW5pdFxcc2VydmljZXNcXGRhdGFiYXNlLnNlcnZpY2Uuc3BlYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdW5zYWZlLWNhbGwgKi9cclxuLyogZXNsaW50LWRpc2FibGUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXVuc2FmZS1hc3NpZ25tZW50ICovXHJcbi8qIGVzbGludC1kaXNhYmxlIEB0eXBlc2NyaXB0LWVzbGludC9uby11bnNhZmUtbWVtYmVyLWFjY2VzcyAqL1xyXG4vKiBlc2xpbnQtZGlzYWJsZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdW5zYWZlLXJldHVybiAqL1xyXG4vLyB0ZXN0L3VuaXQvc2VydmljZXMvZGF0YWJhc2Uuc2VydmljZS5zcGVjLnRzXHJcblxyXG5pbXBvcnQgeyBDb25maWdTZXJ2aWNlIH0gZnJvbSAnQG5lc3Rqcy9jb25maWcnO1xyXG5pbXBvcnQgeyBUZXN0LCBUZXN0aW5nTW9kdWxlIH0gZnJvbSAnQG5lc3Rqcy90ZXN0aW5nJztcclxuaW1wb3J0IHsgRGF0YWJhc2VTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vLi4vc3JjL3NoYXJlZC9kYXRhYmFzZS9kYXRhYmFzZS5zZXJ2aWNlJztcclxuXHJcbmRlc2NyaWJlKCdEYXRhYmFzZVNlcnZpY2UnLCAoKSA9PiB7XHJcbiAgbGV0IHNlcnZpY2U6IERhdGFiYXNlU2VydmljZTtcclxuICBsZXQgbW9ja0NvbmZpZ1NlcnZpY2U6IFBhcnRpYWw8Q29uZmlnU2VydmljZT47XHJcbiAgbGV0IG1vY2tDbGllbnQ6IGFueTtcclxuXHJcbiAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiB7XHJcbiAgICBtb2NrQ2xpZW50ID0ge1xyXG4gICAgICBlbmQ6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh1bmRlZmluZWQpLFxyXG4gICAgICB1bnNhZmU6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZShbXSksXHJcbiAgICB9O1xyXG5cclxuICAgIC8vIE1vY2sgcG9zdGdyZXMgY29uc3RydWN0b3JcclxuICAgIGplc3QubW9jaygncG9zdGdyZXMnLCAoKSA9PiB7XHJcbiAgICAgIHJldHVybiBqZXN0LmZuKCgpID0+IG1vY2tDbGllbnQpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgbW9ja0NvbmZpZ1NlcnZpY2UgPSB7XHJcbiAgICAgIGdldDogamVzdC5mbigoa2V5OiBzdHJpbmcpID0+IHtcclxuICAgICAgICBpZiAoa2V5ID09PSAnREFUQUJBU0VfVVJMJylcclxuICAgICAgICAgIHJldHVybiAncG9zdGdyZXNxbDovL3Rlc3Q6dGVzdEBsb2NhbGhvc3Q6NTQzMi90ZXN0JztcclxuICAgICAgICBpZiAoa2V5ID09PSAnTk9ERV9FTlYnKSByZXR1cm4gJ3Rlc3QnO1xyXG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgICAgIH0pLFxyXG4gICAgfTtcclxuXHJcbiAgICBjb25zdCBtb2R1bGU6IFRlc3RpbmdNb2R1bGUgPSBhd2FpdCBUZXN0LmNyZWF0ZVRlc3RpbmdNb2R1bGUoe1xyXG4gICAgICBwcm92aWRlcnM6IFtcclxuICAgICAgICBEYXRhYmFzZVNlcnZpY2UsXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgcHJvdmlkZTogQ29uZmlnU2VydmljZSxcclxuICAgICAgICAgIHVzZVZhbHVlOiBtb2NrQ29uZmlnU2VydmljZSxcclxuICAgICAgICB9LFxyXG4gICAgICBdLFxyXG4gICAgfSkuY29tcGlsZSgpO1xyXG5cclxuICAgIHNlcnZpY2UgPSBtb2R1bGUuZ2V0PERhdGFiYXNlU2VydmljZT4oRGF0YWJhc2VTZXJ2aWNlKTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ29uTW9kdWxlRGVzdHJveScsICgpID0+IHtcclxuICAgIGl0KCdzaG91bGQgY2xvc2UgZGF0YWJhc2UgY29ubmVjdGlvbicsIGFzeW5jICgpID0+IHtcclxuICAgICAgLy8gU2V0IHVwIGNsaWVudFxyXG4gICAgICAoc2VydmljZSBhcyBhbnkpLmNsaWVudCA9IG1vY2tDbGllbnQ7XHJcblxyXG4gICAgICBhd2FpdCBzZXJ2aWNlLm9uTW9kdWxlRGVzdHJveSgpO1xyXG5cclxuICAgICAgZXhwZWN0KG1vY2tDbGllbnQuZW5kKS50b0hhdmVCZWVuQ2FsbGVkKCk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBtaXNzaW5nIGNsaWVudCBncmFjZWZ1bGx5JywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAoc2VydmljZSBhcyBhbnkpLmNsaWVudCA9IG51bGw7XHJcblxyXG4gICAgICBhd2FpdCBleHBlY3Qoc2VydmljZS5vbk1vZHVsZURlc3Ryb3koKSkucmVzb2x2ZXMubm90LnRvVGhyb3coKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnZHJpenpsZSBnZXR0ZXInLCAoKSA9PiB7XHJcbiAgICBpdCgnc2hvdWxkIHRocm93IGVycm9yIHdoZW4gZGF0YWJhc2Ugbm90IGluaXRpYWxpemVkJywgKCkgPT4ge1xyXG4gICAgICBleHBlY3QoKCkgPT4gc2VydmljZS5kcml6emxlKS50b1Rocm93KCdEYXRhYmFzZSBub3QgaW5pdGlhbGl6ZWQnKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnZXhlY3V0ZVJhdycsICgpID0+IHtcclxuICAgIGl0KCdzaG91bGQgZXhlY3V0ZSByYXcgU1FMJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAoc2VydmljZSBhcyBhbnkpLmNsaWVudCA9IG1vY2tDbGllbnQ7XHJcbiAgICAgIG1vY2tDbGllbnQudW5zYWZlLm1vY2tSZXNvbHZlZFZhbHVlKFt7IHJlc3VsdDogJ3N1Y2Nlc3MnIH1dKTtcclxuXHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHNlcnZpY2UuZXhlY3V0ZVJhdygnU0VMRUNUIDEnKTtcclxuXHJcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvRXF1YWwoW3sgcmVzdWx0OiAnc3VjY2VzcycgfV0pO1xyXG4gICAgICBleHBlY3QobW9ja0NsaWVudC51bnNhZmUpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCdTRUxFQ1QgMScpO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcbn0pO1xyXG4iXSwidmVyc2lvbiI6M30=