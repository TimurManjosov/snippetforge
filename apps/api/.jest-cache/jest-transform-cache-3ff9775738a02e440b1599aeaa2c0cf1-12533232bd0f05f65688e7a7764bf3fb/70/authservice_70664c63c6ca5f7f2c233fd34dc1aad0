cb7e2a9115b6f4bd8ca538fcec319fad
"use strict";
// src/modules/auth/auth.service.ts
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var AuthService_1;
var _a, _b, _c;
Object.defineProperty(exports, "__esModule", { value: true });
exports.AuthService = void 0;
const common_1 = require("@nestjs/common");
const config_1 = require("@nestjs/config");
const jwt_1 = require("@nestjs/jwt");
const users_1 = require("../users");
/**
 * AuthService - Zentrale Authentifizierungs-Logik
 *
 * VERANTWORTLICHKEITEN:
 * - User Registration (delegiert an UsersService)
 * - User Login (Credential-Validierung + Token-Generierung)
 * - Token-Generierung (JWT)
 *
 * WAS HIER NICHT PASSIERT:
 * - Password Hashing (→ UsersService)
 * - User CRUD (→ UsersService)
 * - Token-Validierung (→ JwtStrategy)
 * - HTTP Concerns (→ AuthController)
 *
 * SECURITY CONSIDERATIONS:
 * - Keine User Enumeration bei Login
 * - Timing-Safe Password Comparison (in UsersService)
 * - Minimaler JWT Payload
 */
let AuthService = AuthService_1 = class AuthService {
    usersService;
    jwtService;
    configService;
    logger = new common_1.Logger(AuthService_1.name);
    // Token Expiration in Sekunden (aus Config oder Default 15 Minuten)
    accessTokenExpiresIn;
    constructor(usersService, jwtService, configService) {
        this.usersService = usersService;
        this.jwtService = jwtService;
        this.configService = configService;
        // Parse JWT_EXPIRES_IN (z.B. "15m", "1h", "7d")
        const expiresInString = this.configService.get('JWT_EXPIRES_IN') || '15m';
        this.accessTokenExpiresIn = this.parseExpiresIn(expiresInString);
    }
    // ============================================================
    // PUBLIC METHODS
    // ============================================================
    /**
     * Register - Erstellt neuen User und gibt Tokens zurück
     *
     * @param dto - RegisterDto (email, username, password)
     * @returns AuthResponse (user + tokens)
     * @throws ConflictException wenn Email/Username existiert (von UsersService)
     */
    async register(dto) {
        this.logger.debug(`Registering new user: ${dto.email}`);
        // 1. User erstellen (UsersService handled Hashing + Duplicate Check)
        const user = await this.usersService.create({
            email: dto.email,
            username: dto.username,
            password: dto.password,
        });
        // 2. Tokens generieren
        const tokens = await this.generateTokens(user);
        this.logger.log(`User registered successfully: ${user.id}`);
        return {
            user,
            tokens,
        };
    }
    /**
     * Login - Validiert Credentials und gibt Tokens zurück
     *
     * SECURITY:
     * - Gleiche Fehlermeldung bei "Email nicht gefunden" und "Passwort falsch"
     * - Verhindert User Enumeration
     *
     * @param dto - LoginDto (email, password)
     * @returns AuthResponse (user + tokens)
     * @throws UnauthorizedException bei ungültigen Credentials
     */
    async login(dto) {
        this.logger.debug(`Login attempt for: ${dto.email}`);
        // 1. Credentials validieren (UsersService macht Timing-Safe Comparison)
        const user = await this.usersService.validateCredentials(dto.email, dto.password);
        // 2. Wenn null → Credentials ungültig
        if (!user) {
            this.logger.warn(`Failed login attempt for: ${dto.email}`);
            // SECURITY: Gleiche Message für alle Fehler!
            throw new common_1.UnauthorizedException('Invalid email or password');
        }
        // 3. Tokens generieren
        const tokens = await this.generateTokens(user);
        this.logger.log(`User logged in successfully: ${user.id}`);
        return {
            user,
            tokens,
        };
    }
    /**
     * ValidateUserById - Lädt User für Token-Refresh
     *
     * @param userId - UUID des Users
     * @returns SafeUser
     * @throws NotFoundException wenn User nicht existiert
     */
    async validateUserById(userId) {
        return this.usersService.findById(userId);
    }
    /**
     * GetCurrentUser - Alias für findById (für Controller-Klarheit)
     */
    async getCurrentUser(userId) {
        return this.usersService.findById(userId);
    }
    // ============================================================
    // PRIVATE METHODS
    // ============================================================
    /**
     * Generiert JWT Access Token
     *
     * @param user - SafeUser für Payload
     * @returns TokenResponse
     */
    async generateTokens(user) {
        // JWT Payload (minimale Daten!)
        const payload = {
            sub: user.id, // Standard JWT Claim für Subject (User ID)
            email: user.email, // Für schnellen Lookup
            role: user.role, // Für Authorization ohne DB-Query
        };
        // Token signieren
        const accessToken = await this.jwtService.signAsync(payload);
        return {
            accessToken,
            tokenType: 'Bearer',
            expiresIn: this.accessTokenExpiresIn,
        };
    }
    /**
     * Parsed JWT_EXPIRES_IN String zu Sekunden
     *
     * Unterstützte Formate:
     * - "15m" → 900 (15 Minuten)
     * - "1h" → 3600 (1 Stunde)
     * - "7d" → 604800 (7 Tage)
     * - "3600" → 3600 (direkt Sekunden)
     */
    parseExpiresIn(value) {
        const match = value.match(/^(\d+)(s|m|h|d)?$/);
        if (!match) {
            this.logger.warn(`Invalid JWT_EXPIRES_IN format: ${value}, using default 15m`);
            return 900; // Default:  15 Minuten
        }
        const num = parseInt(match[1], 10);
        const unit = match[2] || 's';
        switch (unit) {
            case 's':
                return num;
            case 'm':
                return num * 60;
            case 'h':
                return num * 60 * 60;
            case 'd':
                return num * 60 * 60 * 24;
            default:
                return num;
        }
    }
};
exports.AuthService = AuthService;
exports.AuthService = AuthService = AuthService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof users_1.UsersService !== "undefined" && users_1.UsersService) === "function" ? _a : Object, typeof (_b = typeof jwt_1.JwtService !== "undefined" && jwt_1.JwtService) === "function" ? _b : Object, typeof (_c = typeof config_1.ConfigService !== "undefined" && config_1.ConfigService) === "function" ? _c : Object])
], AuthService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aW11clxcUHJvZ3JhbW1pbmdcXFByb2plY3RzXFxzbmlwcGV0Zm9yZ2VcXGFwcHNcXGFwaVxcc3JjXFxtb2R1bGVzXFxhdXRoXFxhdXRoLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6IjtBQUFBLG1DQUFtQzs7Ozs7Ozs7Ozs7Ozs7QUFFbkMsMkNBQTJFO0FBQzNFLDJDQUErQztBQUMvQyxxQ0FBeUM7QUFDekMsb0NBQXVEO0FBU3ZEOzs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FrQkc7QUFFSSxJQUFNLFdBQVcsbUJBQWpCLE1BQU0sV0FBVztJQU9IO0lBQ0E7SUFDQTtJQVJGLE1BQU0sR0FBRyxJQUFJLGVBQU0sQ0FBQyxhQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7SUFFdkQsb0VBQW9FO0lBQ25ELG9CQUFvQixDQUFTO0lBRTlDLFlBQ21CLFlBQTBCLEVBQzFCLFVBQXNCLEVBQ3RCLGFBQTRCO1FBRjVCLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQzFCLGVBQVUsR0FBVixVQUFVLENBQVk7UUFDdEIsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFFN0MsZ0RBQWdEO1FBQ2hELE1BQU0sZUFBZSxHQUNuQixJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBUyxnQkFBZ0IsQ0FBQyxJQUFJLEtBQUssQ0FBQztRQUM1RCxJQUFJLENBQUMsb0JBQW9CLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxlQUFlLENBQUMsQ0FBQztJQUNuRSxDQUFDO0lBRUQsK0RBQStEO0lBQy9ELGlCQUFpQjtJQUNqQiwrREFBK0Q7SUFFL0Q7Ozs7OztPQU1HO0lBQ0gsS0FBSyxDQUFDLFFBQVEsQ0FBQyxHQUFnQjtRQUM3QixJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyx5QkFBeUIsR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUM7UUFFeEQscUVBQXFFO1FBQ3JFLE1BQU0sSUFBSSxHQUFHLE1BQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUM7WUFDMUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxLQUFLO1lBQ2hCLFFBQVEsRUFBRSxHQUFHLENBQUMsUUFBUTtZQUN0QixRQUFRLEVBQUUsR0FBRyxDQUFDLFFBQVE7U0FDdkIsQ0FBQyxDQUFDO1FBRUgsdUJBQXVCO1FBQ3ZCLE1BQU0sTUFBTSxHQUFHLE1BQU0sSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUUvQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxpQ0FBaUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFNUQsT0FBTztZQUNMLElBQUk7WUFDSixNQUFNO1NBQ1AsQ0FBQztJQUNKLENBQUM7SUFFRDs7Ozs7Ozs7OztPQVVHO0lBQ0gsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFhO1FBQ3ZCLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLHNCQUFzQixHQUFHLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQztRQUVyRCx3RUFBd0U7UUFDeEUsTUFBTSxJQUFJLEdBQUcsTUFBTSxJQUFJLENBQUMsWUFBWSxDQUFDLG1CQUFtQixDQUN0RCxHQUFHLENBQUMsS0FBSyxFQUNULEdBQUcsQ0FBQyxRQUFRLENBQ2IsQ0FBQztRQUVGLHNDQUFzQztRQUN0QyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDVixJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyw2QkFBNkIsR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUM7WUFDM0QsNkNBQTZDO1lBQzdDLE1BQU0sSUFBSSw4QkFBcUIsQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO1FBQy9ELENBQUM7UUFFRCx1QkFBdUI7UUFDdkIsTUFBTSxNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRS9DLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLGdDQUFnQyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUUzRCxPQUFPO1lBQ0wsSUFBSTtZQUNKLE1BQU07U0FDUCxDQUFDO0lBQ0osQ0FBQztJQUVEOzs7Ozs7T0FNRztJQUNILEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFjO1FBQ25DLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDNUMsQ0FBQztJQUVEOztPQUVHO0lBQ0gsS0FBSyxDQUFDLGNBQWMsQ0FBQyxNQUFjO1FBQ2pDLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDNUMsQ0FBQztJQUVELCtEQUErRDtJQUMvRCxrQkFBa0I7SUFDbEIsK0RBQStEO0lBRS9EOzs7OztPQUtHO0lBQ0ssS0FBSyxDQUFDLGNBQWMsQ0FBQyxJQUFjO1FBQ3pDLGdDQUFnQztRQUNoQyxNQUFNLE9BQU8sR0FBZTtZQUMxQixHQUFHLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSwyQ0FBMkM7WUFDekQsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLLEVBQUUsdUJBQXVCO1lBQzFDLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxFQUFFLGtDQUFrQztTQUNwRCxDQUFDO1FBRUYsa0JBQWtCO1FBQ2xCLE1BQU0sV0FBVyxHQUFHLE1BQU0sSUFBSSxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFN0QsT0FBTztZQUNMLFdBQVc7WUFDWCxTQUFTLEVBQUUsUUFBUTtZQUNuQixTQUFTLEVBQUUsSUFBSSxDQUFDLG9CQUFvQjtTQUNyQyxDQUFDO0lBQ0osQ0FBQztJQUVEOzs7Ozs7OztPQVFHO0lBQ0ssY0FBYyxDQUFDLEtBQWE7UUFDbEMsTUFBTSxLQUFLLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO1FBRS9DLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUNYLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUNkLGtDQUFrQyxLQUFLLHFCQUFxQixDQUM3RCxDQUFDO1lBQ0YsT0FBTyxHQUFHLENBQUMsQ0FBQyx1QkFBdUI7UUFDckMsQ0FBQztRQUVELE1BQU0sR0FBRyxHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDbkMsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJLEdBQUcsQ0FBQztRQUU3QixRQUFRLElBQUksRUFBRSxDQUFDO1lBQ2IsS0FBSyxHQUFHO2dCQUNOLE9BQU8sR0FBRyxDQUFDO1lBQ2IsS0FBSyxHQUFHO2dCQUNOLE9BQU8sR0FBRyxHQUFHLEVBQUUsQ0FBQztZQUNsQixLQUFLLEdBQUc7Z0JBQ04sT0FBTyxHQUFHLEdBQUcsRUFBRSxHQUFHLEVBQUUsQ0FBQztZQUN2QixLQUFLLEdBQUc7Z0JBQ04sT0FBTyxHQUFHLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLENBQUM7WUFDNUI7Z0JBQ0UsT0FBTyxHQUFHLENBQUM7UUFDZixDQUFDO0lBQ0gsQ0FBQztDQUNGLENBQUE7QUF4S1ksa0NBQVc7c0JBQVgsV0FBVztJQUR2QixJQUFBLG1CQUFVLEdBQUU7eURBUXNCLG9CQUFZLG9CQUFaLG9CQUFZLG9EQUNkLGdCQUFVLG9CQUFWLGdCQUFVLG9EQUNQLHNCQUFhLG9CQUFiLHNCQUFhO0dBVHBDLFdBQVcsQ0F3S3ZCIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcdGltdXJcXFByb2dyYW1taW5nXFxQcm9qZWN0c1xcc25pcHBldGZvcmdlXFxhcHBzXFxhcGlcXHNyY1xcbW9kdWxlc1xcYXV0aFxcYXV0aC5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIHNyYy9tb2R1bGVzL2F1dGgvYXV0aC5zZXJ2aWNlLnRzXHJcblxyXG5pbXBvcnQgeyBJbmplY3RhYmxlLCBMb2dnZXIsIFVuYXV0aG9yaXplZEV4Y2VwdGlvbiB9IGZyb20gJ0BuZXN0anMvY29tbW9uJztcclxuaW1wb3J0IHsgQ29uZmlnU2VydmljZSB9IGZyb20gJ0BuZXN0anMvY29uZmlnJztcclxuaW1wb3J0IHsgSnd0U2VydmljZSB9IGZyb20gJ0BuZXN0anMvand0JztcclxuaW1wb3J0IHsgVXNlcnNTZXJ2aWNlLCB0eXBlIFNhZmVVc2VyIH0gZnJvbSAnLi4vdXNlcnMnO1xyXG5pbXBvcnQge1xyXG4gIHR5cGUgQXV0aFJlc3BvbnNlLFxyXG4gIHR5cGUgSnd0UGF5bG9hZCxcclxuICB0eXBlIFRva2VuUmVzcG9uc2UsXHJcbn0gZnJvbSAnLi9hdXRoLnR5cGVzJztcclxuaW1wb3J0IHsgdHlwZSBMb2dpbkR0byB9IGZyb20gJy4vZHRvL2xvZ2luLmR0byc7XHJcbmltcG9ydCB7IHR5cGUgUmVnaXN0ZXJEdG8gfSBmcm9tICcuL2R0by9yZWdpc3Rlci5kdG8nO1xyXG5cclxuLyoqXHJcbiAqIEF1dGhTZXJ2aWNlIC0gWmVudHJhbGUgQXV0aGVudGlmaXppZXJ1bmdzLUxvZ2lrXHJcbiAqXHJcbiAqIFZFUkFOVFdPUlRMSUNIS0VJVEVOOlxyXG4gKiAtIFVzZXIgUmVnaXN0cmF0aW9uIChkZWxlZ2llcnQgYW4gVXNlcnNTZXJ2aWNlKVxyXG4gKiAtIFVzZXIgTG9naW4gKENyZWRlbnRpYWwtVmFsaWRpZXJ1bmcgKyBUb2tlbi1HZW5lcmllcnVuZylcclxuICogLSBUb2tlbi1HZW5lcmllcnVuZyAoSldUKVxyXG4gKlxyXG4gKiBXQVMgSElFUiBOSUNIVCBQQVNTSUVSVDpcclxuICogLSBQYXNzd29yZCBIYXNoaW5nICjihpIgVXNlcnNTZXJ2aWNlKVxyXG4gKiAtIFVzZXIgQ1JVRCAo4oaSIFVzZXJzU2VydmljZSlcclxuICogLSBUb2tlbi1WYWxpZGllcnVuZyAo4oaSIEp3dFN0cmF0ZWd5KVxyXG4gKiAtIEhUVFAgQ29uY2VybnMgKOKGkiBBdXRoQ29udHJvbGxlcilcclxuICpcclxuICogU0VDVVJJVFkgQ09OU0lERVJBVElPTlM6XHJcbiAqIC0gS2VpbmUgVXNlciBFbnVtZXJhdGlvbiBiZWkgTG9naW5cclxuICogLSBUaW1pbmctU2FmZSBQYXNzd29yZCBDb21wYXJpc29uIChpbiBVc2Vyc1NlcnZpY2UpXHJcbiAqIC0gTWluaW1hbGVyIEpXVCBQYXlsb2FkXHJcbiAqL1xyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBBdXRoU2VydmljZSB7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXIgPSBuZXcgTG9nZ2VyKEF1dGhTZXJ2aWNlLm5hbWUpO1xyXG5cclxuICAvLyBUb2tlbiBFeHBpcmF0aW9uIGluIFNla3VuZGVuIChhdXMgQ29uZmlnIG9kZXIgRGVmYXVsdCAxNSBNaW51dGVuKVxyXG4gIHByaXZhdGUgcmVhZG9ubHkgYWNjZXNzVG9rZW5FeHBpcmVzSW46IG51bWJlcjtcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IHVzZXJzU2VydmljZTogVXNlcnNTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSByZWFkb25seSBqd3RTZXJ2aWNlOiBKd3RTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSByZWFkb25seSBjb25maWdTZXJ2aWNlOiBDb25maWdTZXJ2aWNlLFxyXG4gICkge1xyXG4gICAgLy8gUGFyc2UgSldUX0VYUElSRVNfSU4gKHouQi4gXCIxNW1cIiwgXCIxaFwiLCBcIjdkXCIpXHJcbiAgICBjb25zdCBleHBpcmVzSW5TdHJpbmcgPVxyXG4gICAgICB0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0PHN0cmluZz4oJ0pXVF9FWFBJUkVTX0lOJykgfHwgJzE1bSc7XHJcbiAgICB0aGlzLmFjY2Vzc1Rva2VuRXhwaXJlc0luID0gdGhpcy5wYXJzZUV4cGlyZXNJbihleHBpcmVzSW5TdHJpbmcpO1xyXG4gIH1cclxuXHJcbiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XHJcbiAgLy8gUFVCTElDIE1FVEhPRFNcclxuICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cclxuXHJcbiAgLyoqXHJcbiAgICogUmVnaXN0ZXIgLSBFcnN0ZWxsdCBuZXVlbiBVc2VyIHVuZCBnaWJ0IFRva2VucyB6dXLDvGNrXHJcbiAgICpcclxuICAgKiBAcGFyYW0gZHRvIC0gUmVnaXN0ZXJEdG8gKGVtYWlsLCB1c2VybmFtZSwgcGFzc3dvcmQpXHJcbiAgICogQHJldHVybnMgQXV0aFJlc3BvbnNlICh1c2VyICsgdG9rZW5zKVxyXG4gICAqIEB0aHJvd3MgQ29uZmxpY3RFeGNlcHRpb24gd2VubiBFbWFpbC9Vc2VybmFtZSBleGlzdGllcnQgKHZvbiBVc2Vyc1NlcnZpY2UpXHJcbiAgICovXHJcbiAgYXN5bmMgcmVnaXN0ZXIoZHRvOiBSZWdpc3RlckR0byk6IFByb21pc2U8QXV0aFJlc3BvbnNlPiB7XHJcbiAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhgUmVnaXN0ZXJpbmcgbmV3IHVzZXI6ICR7ZHRvLmVtYWlsfWApO1xyXG5cclxuICAgIC8vIDEuIFVzZXIgZXJzdGVsbGVuIChVc2Vyc1NlcnZpY2UgaGFuZGxlZCBIYXNoaW5nICsgRHVwbGljYXRlIENoZWNrKVxyXG4gICAgY29uc3QgdXNlciA9IGF3YWl0IHRoaXMudXNlcnNTZXJ2aWNlLmNyZWF0ZSh7XHJcbiAgICAgIGVtYWlsOiBkdG8uZW1haWwsXHJcbiAgICAgIHVzZXJuYW1lOiBkdG8udXNlcm5hbWUsXHJcbiAgICAgIHBhc3N3b3JkOiBkdG8ucGFzc3dvcmQsXHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyAyLiBUb2tlbnMgZ2VuZXJpZXJlblxyXG4gICAgY29uc3QgdG9rZW5zID0gYXdhaXQgdGhpcy5nZW5lcmF0ZVRva2Vucyh1c2VyKTtcclxuXHJcbiAgICB0aGlzLmxvZ2dlci5sb2coYFVzZXIgcmVnaXN0ZXJlZCBzdWNjZXNzZnVsbHk6ICR7dXNlci5pZH1gKTtcclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICB1c2VyLFxyXG4gICAgICB0b2tlbnMsXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogTG9naW4gLSBWYWxpZGllcnQgQ3JlZGVudGlhbHMgdW5kIGdpYnQgVG9rZW5zIHp1csO8Y2tcclxuICAgKlxyXG4gICAqIFNFQ1VSSVRZOlxyXG4gICAqIC0gR2xlaWNoZSBGZWhsZXJtZWxkdW5nIGJlaSBcIkVtYWlsIG5pY2h0IGdlZnVuZGVuXCIgdW5kIFwiUGFzc3dvcnQgZmFsc2NoXCJcclxuICAgKiAtIFZlcmhpbmRlcnQgVXNlciBFbnVtZXJhdGlvblxyXG4gICAqXHJcbiAgICogQHBhcmFtIGR0byAtIExvZ2luRHRvIChlbWFpbCwgcGFzc3dvcmQpXHJcbiAgICogQHJldHVybnMgQXV0aFJlc3BvbnNlICh1c2VyICsgdG9rZW5zKVxyXG4gICAqIEB0aHJvd3MgVW5hdXRob3JpemVkRXhjZXB0aW9uIGJlaSB1bmfDvGx0aWdlbiBDcmVkZW50aWFsc1xyXG4gICAqL1xyXG4gIGFzeW5jIGxvZ2luKGR0bzogTG9naW5EdG8pOiBQcm9taXNlPEF1dGhSZXNwb25zZT4ge1xyXG4gICAgdGhpcy5sb2dnZXIuZGVidWcoYExvZ2luIGF0dGVtcHQgZm9yOiAke2R0by5lbWFpbH1gKTtcclxuXHJcbiAgICAvLyAxLiBDcmVkZW50aWFscyB2YWxpZGllcmVuIChVc2Vyc1NlcnZpY2UgbWFjaHQgVGltaW5nLVNhZmUgQ29tcGFyaXNvbilcclxuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCB0aGlzLnVzZXJzU2VydmljZS52YWxpZGF0ZUNyZWRlbnRpYWxzKFxyXG4gICAgICBkdG8uZW1haWwsXHJcbiAgICAgIGR0by5wYXNzd29yZCxcclxuICAgICk7XHJcblxyXG4gICAgLy8gMi4gV2VubiBudWxsIOKGkiBDcmVkZW50aWFscyB1bmfDvGx0aWdcclxuICAgIGlmICghdXNlcikge1xyXG4gICAgICB0aGlzLmxvZ2dlci53YXJuKGBGYWlsZWQgbG9naW4gYXR0ZW1wdCBmb3I6ICR7ZHRvLmVtYWlsfWApO1xyXG4gICAgICAvLyBTRUNVUklUWTogR2xlaWNoZSBNZXNzYWdlIGbDvHIgYWxsZSBGZWhsZXIhXHJcbiAgICAgIHRocm93IG5ldyBVbmF1dGhvcml6ZWRFeGNlcHRpb24oJ0ludmFsaWQgZW1haWwgb3IgcGFzc3dvcmQnKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyAzLiBUb2tlbnMgZ2VuZXJpZXJlblxyXG4gICAgY29uc3QgdG9rZW5zID0gYXdhaXQgdGhpcy5nZW5lcmF0ZVRva2Vucyh1c2VyKTtcclxuXHJcbiAgICB0aGlzLmxvZ2dlci5sb2coYFVzZXIgbG9nZ2VkIGluIHN1Y2Nlc3NmdWxseTogJHt1c2VyLmlkfWApO1xyXG5cclxuICAgIHJldHVybiB7XHJcbiAgICAgIHVzZXIsXHJcbiAgICAgIHRva2VucyxcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBWYWxpZGF0ZVVzZXJCeUlkIC0gTMOkZHQgVXNlciBmw7xyIFRva2VuLVJlZnJlc2hcclxuICAgKlxyXG4gICAqIEBwYXJhbSB1c2VySWQgLSBVVUlEIGRlcyBVc2Vyc1xyXG4gICAqIEByZXR1cm5zIFNhZmVVc2VyXHJcbiAgICogQHRocm93cyBOb3RGb3VuZEV4Y2VwdGlvbiB3ZW5uIFVzZXIgbmljaHQgZXhpc3RpZXJ0XHJcbiAgICovXHJcbiAgYXN5bmMgdmFsaWRhdGVVc2VyQnlJZCh1c2VySWQ6IHN0cmluZyk6IFByb21pc2U8U2FmZVVzZXI+IHtcclxuICAgIHJldHVybiB0aGlzLnVzZXJzU2VydmljZS5maW5kQnlJZCh1c2VySWQpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogR2V0Q3VycmVudFVzZXIgLSBBbGlhcyBmw7xyIGZpbmRCeUlkIChmw7xyIENvbnRyb2xsZXItS2xhcmhlaXQpXHJcbiAgICovXHJcbiAgYXN5bmMgZ2V0Q3VycmVudFVzZXIodXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPFNhZmVVc2VyPiB7XHJcbiAgICByZXR1cm4gdGhpcy51c2Vyc1NlcnZpY2UuZmluZEJ5SWQodXNlcklkKTtcclxuICB9XHJcblxyXG4gIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxyXG4gIC8vIFBSSVZBVEUgTUVUSE9EU1xyXG4gIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxyXG5cclxuICAvKipcclxuICAgKiBHZW5lcmllcnQgSldUIEFjY2VzcyBUb2tlblxyXG4gICAqXHJcbiAgICogQHBhcmFtIHVzZXIgLSBTYWZlVXNlciBmw7xyIFBheWxvYWRcclxuICAgKiBAcmV0dXJucyBUb2tlblJlc3BvbnNlXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBhc3luYyBnZW5lcmF0ZVRva2Vucyh1c2VyOiBTYWZlVXNlcik6IFByb21pc2U8VG9rZW5SZXNwb25zZT4ge1xyXG4gICAgLy8gSldUIFBheWxvYWQgKG1pbmltYWxlIERhdGVuISlcclxuICAgIGNvbnN0IHBheWxvYWQ6IEp3dFBheWxvYWQgPSB7XHJcbiAgICAgIHN1YjogdXNlci5pZCwgLy8gU3RhbmRhcmQgSldUIENsYWltIGbDvHIgU3ViamVjdCAoVXNlciBJRClcclxuICAgICAgZW1haWw6IHVzZXIuZW1haWwsIC8vIEbDvHIgc2NobmVsbGVuIExvb2t1cFxyXG4gICAgICByb2xlOiB1c2VyLnJvbGUsIC8vIEbDvHIgQXV0aG9yaXphdGlvbiBvaG5lIERCLVF1ZXJ5XHJcbiAgICB9O1xyXG5cclxuICAgIC8vIFRva2VuIHNpZ25pZXJlblxyXG4gICAgY29uc3QgYWNjZXNzVG9rZW4gPSBhd2FpdCB0aGlzLmp3dFNlcnZpY2Uuc2lnbkFzeW5jKHBheWxvYWQpO1xyXG5cclxuICAgIHJldHVybiB7XHJcbiAgICAgIGFjY2Vzc1Rva2VuLFxyXG4gICAgICB0b2tlblR5cGU6ICdCZWFyZXInLFxyXG4gICAgICBleHBpcmVzSW46IHRoaXMuYWNjZXNzVG9rZW5FeHBpcmVzSW4sXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUGFyc2VkIEpXVF9FWFBJUkVTX0lOIFN0cmluZyB6dSBTZWt1bmRlblxyXG4gICAqXHJcbiAgICogVW50ZXJzdMO8dHp0ZSBGb3JtYXRlOlxyXG4gICAqIC0gXCIxNW1cIiDihpIgOTAwICgxNSBNaW51dGVuKVxyXG4gICAqIC0gXCIxaFwiIOKGkiAzNjAwICgxIFN0dW5kZSlcclxuICAgKiAtIFwiN2RcIiDihpIgNjA0ODAwICg3IFRhZ2UpXHJcbiAgICogLSBcIjM2MDBcIiDihpIgMzYwMCAoZGlyZWt0IFNla3VuZGVuKVxyXG4gICAqL1xyXG4gIHByaXZhdGUgcGFyc2VFeHBpcmVzSW4odmFsdWU6IHN0cmluZyk6IG51bWJlciB7XHJcbiAgICBjb25zdCBtYXRjaCA9IHZhbHVlLm1hdGNoKC9eKFxcZCspKHN8bXxofGQpPyQvKTtcclxuXHJcbiAgICBpZiAoIW1hdGNoKSB7XHJcbiAgICAgIHRoaXMubG9nZ2VyLndhcm4oXHJcbiAgICAgICAgYEludmFsaWQgSldUX0VYUElSRVNfSU4gZm9ybWF0OiAke3ZhbHVlfSwgdXNpbmcgZGVmYXVsdCAxNW1gLFxyXG4gICAgICApO1xyXG4gICAgICByZXR1cm4gOTAwOyAvLyBEZWZhdWx0OiAgMTUgTWludXRlblxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IG51bSA9IHBhcnNlSW50KG1hdGNoWzFdLCAxMCk7XHJcbiAgICBjb25zdCB1bml0ID0gbWF0Y2hbMl0gfHwgJ3MnO1xyXG5cclxuICAgIHN3aXRjaCAodW5pdCkge1xyXG4gICAgICBjYXNlICdzJzpcclxuICAgICAgICByZXR1cm4gbnVtO1xyXG4gICAgICBjYXNlICdtJzpcclxuICAgICAgICByZXR1cm4gbnVtICogNjA7XHJcbiAgICAgIGNhc2UgJ2gnOlxyXG4gICAgICAgIHJldHVybiBudW0gKiA2MCAqIDYwO1xyXG4gICAgICBjYXNlICdkJzpcclxuICAgICAgICByZXR1cm4gbnVtICogNjAgKiA2MCAqIDI0O1xyXG4gICAgICBkZWZhdWx0OlxyXG4gICAgICAgIHJldHVybiBudW07XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcbiJdLCJ2ZXJzaW9uIjozfQ==