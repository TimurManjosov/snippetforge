{"file":"C:\\Users\\timur\\Programming\\Projects\\snippetforge\\apps\\api\\src\\shared\\filters\\all-exceptions.filter.ts","mappings":"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","names":[],"sources":["C:\\Users\\timur\\Programming\\Projects\\snippetforge\\apps\\api\\src\\shared\\filters\\all-exceptions.filter.ts"],"sourcesContent":["// src/shared/filters/all-exceptions.filter.ts\r\n\r\nimport {\r\n  ArgumentsHost,\r\n  Catch,\r\n  ExceptionFilter,\r\n  HttpException,\r\n  HttpStatus,\r\n  Logger,\r\n} from '@nestjs/common';\r\nimport { Request, Response } from 'express';\r\nimport { ErrorCodes, type ErrorCode } from '../constants';\r\nimport { createErrorResponse } from '../types';\r\n\r\n/**\r\n * AllExceptionsFilter - Fängt ALLE Exceptions (Catch-All)\r\n *\r\n * WAS ES FÄNGT:\r\n * - TypeError, ReferenceError (Programming Errors)\r\n * - Database Connection Errors\r\n * - JSON Parse Errors\r\n * - Alle Errors die NICHT HttpException sind\r\n *\r\n * WARUM BRAUCHEN WIR DAS?\r\n * - HttpExceptionFilter fängt nur HttpExceptions\r\n * - Ohne diesen Filter würden unbekannte Errors als\r\n *   500 mit Stack Trace an Client gehen → Security Risk!\r\n *\r\n * REIHENFOLGE IN main.ts:\r\n * app.useGlobalFilters(\r\n *   new AllExceptionsFilter(),    // Catch-All (niedrigste Priorität)\r\n *   new HttpExceptionFilter(),    // Spezifisch (höhere Priorität)\r\n * )\r\n * NestJS führt Filter in UMGEKEHRTER Reihenfolge aus:\r\n * 1. HttpExceptionFilter versucht zu catchen\r\n * 2. Falls nicht HttpException → AllExceptionsFilter catcht\r\n *\r\n * SECURITY:\r\n * - NIEMALS Stack Traces an Client senden\r\n * - NIEMALS interne Error Messages an Client senden\r\n * - In Production: Generische \"Internal Server Error\" Message\r\n * - In Development: Detailliertere Messages für Debugging\r\n */\r\n@Catch()\r\nexport class AllExceptionsFilter implements ExceptionFilter {\r\n  private readonly logger = new Logger(AllExceptionsFilter.name);\r\n\r\n  /** Ist Production Environment? */\r\n  private readonly isProduction = process.env.NODE_ENV === 'production';\r\n\r\n  /**\r\n   * Catch - Hauptmethode für alle nicht-HTTP Exceptions\r\n   */\r\n  catch(exception: unknown, host: ArgumentsHost): void {\r\n    const ctx = host.switchToHttp();\r\n    const response = ctx.getResponse<Response>();\r\n    const request = ctx.getRequest<Request>();\r\n\r\n    // Falls doch eine HttpException durchkommt (sollte nicht passieren)\r\n    if (exception instanceof HttpException) {\r\n      // Delegiere an HttpExceptionFilter\r\n      // Dies sollte normalerweise nicht vorkommen\r\n      this.logger.warn(\r\n        'HttpException caught by AllExceptionsFilter - this should not happen',\r\n      );\r\n      const status = exception.getStatus();\r\n      response.status(status).json(\r\n        createErrorResponse({\r\n          code: ErrorCodes.SERVER_ERROR,\r\n          message: exception.message,\r\n          statusCode: status,\r\n          path: request.url,\r\n          method: request.method,\r\n        }),\r\n      );\r\n      return;\r\n    }\r\n\r\n    // Alle anderen Exceptions als 500 behandeln\r\n    const status = HttpStatus.INTERNAL_SERVER_ERROR;\r\n    const { code, message } = this.processException(exception);\r\n\r\n    // Error Response erstellen\r\n    const errorResponse = createErrorResponse({\r\n      code,\r\n      message,\r\n      statusCode: status,\r\n      path: request.url,\r\n      method: request.method,\r\n      requestId: this.extractRequestId(request),\r\n    });\r\n\r\n    // IMMER loggen bei unbekannten Errors (mit Stack Trace)\r\n    this.logError(exception, request);\r\n\r\n    // Response senden\r\n    response.status(status).json(errorResponse);\r\n  }\r\n\r\n  /**\r\n   * Verarbeitet die Exception und extrahiert Code + Message\r\n   *\r\n   * SECURITY-REGEL:\r\n   * In Production: NIEMALS echte Error Message zurückgeben\r\n   * - Könnte interne Pfade verraten\r\n   * - Könnte DB-Schema verraten\r\n   * - Könnte verwendete Libraries verraten\r\n   */\r\n  private processException(exception: unknown): {\r\n    code: ErrorCode;\r\n    message: string;\r\n  } {\r\n    // Default für Production\r\n    let code: ErrorCode = ErrorCodes.SERVER_ERROR;\r\n    let message = 'An unexpected error occurred. Please try again later.';\r\n\r\n    // In Development:  Mehr Details für Debugging\r\n    if (!this.isProduction && exception instanceof Error) {\r\n      // Spezifische Error-Typen erkennen\r\n      const errorInfo = this.identifyErrorType(exception);\r\n      code = errorInfo.code;\r\n\r\n      // In Development: Echte Error Message (aber sanitized)\r\n      message = this.sanitizeErrorMessage(exception.message);\r\n    }\r\n\r\n    return { code, message };\r\n  }\r\n\r\n  /**\r\n   * Identifiziert den Error-Typ und gibt passenden Code zurück\r\n   *\r\n   * Erkennt:\r\n   * - JWT Errors (von passport-jwt)\r\n   * - Database Errors (von postgres/drizzle)\r\n   * - JSON Parse Errors\r\n   * - Type Errors\r\n   */\r\n  private identifyErrorType(error: Error): { code: ErrorCode } {\r\n    const errorName = error.name;\r\n    const errorMessage = error.message.toLowerCase();\r\n\r\n    // JWT Errors (von passport-jwt / jsonwebtoken)\r\n    if (errorName === 'JsonWebTokenError') {\r\n      return { code: ErrorCodes.AUTH_TOKEN_INVALID };\r\n    }\r\n    if (errorName === 'TokenExpiredError') {\r\n      return { code: ErrorCodes.AUTH_TOKEN_EXPIRED };\r\n    }\r\n    if (errorName === 'NotBeforeError') {\r\n      return { code: ErrorCodes.AUTH_TOKEN_INVALID };\r\n    }\r\n\r\n    // Database Errors\r\n    if (\r\n      errorMessage.includes('database') ||\r\n      errorMessage.includes('connection') ||\r\n      errorMessage.includes('postgres') ||\r\n      errorMessage.includes('econnrefused')\r\n    ) {\r\n      return { code: ErrorCodes.SERVER_DATABASE_ERROR };\r\n    }\r\n\r\n    // Unique Constraint Violation (PostgreSQL)\r\n    if (\r\n      errorMessage.includes('unique constraint') ||\r\n      errorMessage.includes('duplicate key')\r\n    ) {\r\n      return { code: ErrorCodes.RESOURCE_ALREADY_EXISTS };\r\n    }\r\n\r\n    // JSON Parse Error\r\n    if (errorName === 'SyntaxError' && errorMessage.includes('json')) {\r\n      return { code: ErrorCodes.VALIDATION_ERROR };\r\n    }\r\n\r\n    // Default\r\n    return { code: ErrorCodes.SERVER_ERROR };\r\n  }\r\n\r\n  /**\r\n   * Sanitized Error Messages\r\n   *\r\n   * Entfernt potenziell sensitive Informationen:\r\n   * - Dateipfade\r\n   * - Connection Strings\r\n   * - Interne Methodennamen\r\n   */\r\n  private sanitizeErrorMessage(message: string): string {\r\n    // Maximale Länge\r\n    let sanitized = message.substring(0, 500);\r\n\r\n    // Patterns die entfernt werden sollen\r\n    const sensitivePatterns = [\r\n      // Dateipfade (Windows und Unix)\r\n      /[A-Za-z]:\\\\[^\\s]+/g,\r\n      /(?:\\/[\\w.-]+){2,}/g,\r\n\r\n      // Connection Strings\r\n      /postgresql:\\/\\/[^\\s]+/gi,\r\n      /postgres:\\/\\/[^\\s]+/gi,\r\n      /mongodb:\\/\\/[^\\s]+/gi,\r\n\r\n      // Stack Trace Teile\r\n      /at\\s+[^\\n]+/g,\r\n\r\n      // Node.js Interna\r\n      /node:internal[^\\n]+/g,\r\n    ];\r\n\r\n    for (const pattern of sensitivePatterns) {\r\n      sanitized = sanitized.replace(pattern, '[REDACTED]');\r\n    }\r\n\r\n    return sanitized;\r\n  }\r\n\r\n  /**\r\n   * Extrahiert Request ID für Tracing\r\n   */\r\n  private extractRequestId(request: Request): string | undefined {\r\n    return (\r\n      (request.headers['x-request-id'] as string) ||\r\n      (request.headers['x-correlation-id'] as string) ||\r\n      undefined\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Logging für unbekannte Errors\r\n   *\r\n   * IMMER mit vollem Stack Trace loggen:\r\n   * - Diese Errors sind unerwartet\r\n   * - Wir brauchen alle Infos für Debugging\r\n   * - Stack Trace geht NUR ins Log, NICHT an Client\r\n   */\r\n  private logError(exception: unknown, request: Request): void {\r\n    const { method, url, ip } = request;\r\n    const userAgent = request.headers['user-agent'] || 'unknown';\r\n\r\n    const logContext = {\r\n      method,\r\n      url,\r\n      ip,\r\n      userAgent: userAgent.substring(0, 100),\r\n      timestamp: new Date().toISOString(),\r\n    };\r\n\r\n    if (exception instanceof Error) {\r\n      this.logger.error(\r\n        `[UNHANDLED] [${method}] ${url} - ${exception.name}: ${exception.message}`,\r\n        exception.stack,\r\n        JSON.stringify(logContext),\r\n      );\r\n    } else {\r\n      // Für non-Error throws (z.B. throw \"string\")\r\n      this.logger.error(\r\n        `[UNHANDLED] [${method}] ${url} - Unknown exception type`,\r\n        String(exception),\r\n        JSON.stringify(logContext),\r\n      );\r\n    }\r\n  }\r\n}\r\n"],"version":3}