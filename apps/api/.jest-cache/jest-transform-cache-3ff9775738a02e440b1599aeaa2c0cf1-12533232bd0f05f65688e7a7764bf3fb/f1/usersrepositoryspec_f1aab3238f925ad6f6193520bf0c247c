20f3187645b400c0a230fea809d144e6
"use strict";
// test/unit/repositories/users.repository.spec.ts
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const users_repository_1 = require("../../../src/modules/users/users.repository");
const database_1 = require("../../../src/shared/database");
describe('UsersRepository', () => {
    let repository;
    let mockDbService;
    const mockUser = {
        id: 'test-id-123',
        email: 'test@example.com',
        username: 'testuser',
        passwordHash: 'hashed-password',
        role: 'USER',
        createdAt: new Date(),
        updatedAt: new Date(),
    };
    beforeEach(async () => {
        mockDbService = {
            drizzle: {
                query: {
                    users: {
                        findFirst: jest.fn(),
                    },
                },
                insert: jest.fn().mockReturnValue({
                    values: jest.fn().mockReturnValue({
                        returning: jest.fn(),
                    }),
                }),
                update: jest.fn().mockReturnValue({
                    set: jest.fn().mockReturnValue({
                        where: jest.fn().mockReturnValue({
                            returning: jest.fn(),
                        }),
                    }),
                }),
                delete: jest.fn().mockReturnValue({
                    where: jest.fn().mockReturnValue({
                        returning: jest.fn(),
                    }),
                }),
                select: jest.fn().mockReturnValue({
                    from: jest.fn(),
                }),
            },
        };
        const module = await testing_1.Test.createTestingModule({
            providers: [
                users_repository_1.UsersRepository,
                {
                    provide: database_1.DatabaseService,
                    useValue: mockDbService,
                },
            ],
        }).compile();
        repository = module.get(users_repository_1.UsersRepository);
    });
    describe('findById', () => {
        it('should find user by ID', async () => {
            mockDbService.drizzle.query.users.findFirst.mockResolvedValue(mockUser);
            const result = await repository.findById('test-id-123');
            expect(result).toEqual(mockUser);
        });
        it('should return null when user not found', async () => {
            mockDbService.drizzle.query.users.findFirst.mockResolvedValue(undefined);
            const result = await repository.findById('non-existent-id');
            expect(result).toBeNull();
        });
    });
    describe('findByEmail', () => {
        it('should find user by email', async () => {
            mockDbService.drizzle.query.users.findFirst.mockResolvedValue(mockUser);
            const result = await repository.findByEmail('test@example.com');
            expect(result).toEqual(mockUser);
        });
        it('should return null when email not found', async () => {
            mockDbService.drizzle.query.users.findFirst.mockResolvedValue(undefined);
            const result = await repository.findByEmail('nonexistent@example.com');
            expect(result).toBeNull();
        });
    });
    describe('findByUsername', () => {
        it('should find user by username', async () => {
            mockDbService.drizzle.query.users.findFirst.mockResolvedValue(mockUser);
            const result = await repository.findByUsername('testuser');
            expect(result).toEqual(mockUser);
        });
        it('should return null when username not found', async () => {
            mockDbService.drizzle.query.users.findFirst.mockResolvedValue(undefined);
            const result = await repository.findByUsername('nonexistent');
            expect(result).toBeNull();
        });
    });
    describe('findByEmailOrUsername', () => {
        it('should find user by email or username', async () => {
            mockDbService.drizzle.query.users.findFirst.mockResolvedValue(mockUser);
            const result = await repository.findByEmailOrUsername('test@example.com', 'testuser');
            expect(result).toEqual(mockUser);
        });
        it('should return null when neither exists', async () => {
            mockDbService.drizzle.query.users.findFirst.mockResolvedValue(undefined);
            const result = await repository.findByEmailOrUsername('new@example.com', 'newuser');
            expect(result).toBeNull();
        });
    });
    describe('create', () => {
        it('should create new user', async () => {
            const newUserData = {
                email: 'new@example.com',
                username: 'newuser',
                passwordHash: 'hashed',
                role: 'USER',
            };
            const insertMock = mockDbService.drizzle.insert;
            const valuesMock = jest.fn().mockReturnValue({
                returning: jest.fn().mockResolvedValue([mockUser]),
            });
            insertMock.mockReturnValue({
                values: valuesMock,
            });
            const result = await repository.create(newUserData);
            expect(result).toEqual(mockUser);
            expect(valuesMock).toHaveBeenCalledWith(expect.objectContaining({
                email: 'new@example.com',
            }));
        });
    });
    describe('update', () => {
        it('should update user successfully', async () => {
            const updateData = { username: 'updateduser' };
            const updateMock = mockDbService.drizzle.update;
            const setMock = jest.fn().mockReturnValue({
                where: jest.fn().mockReturnValue({
                    returning: jest
                        .fn()
                        .mockResolvedValue([{ ...mockUser, ...updateData }]),
                }),
            });
            updateMock.mockReturnValue({
                set: setMock,
            });
            const result = await repository.update('test-id-123', updateData);
            expect(result).toBeDefined();
            expect(result?.username).toBe('updateduser');
        });
        it('should return null when user not found', async () => {
            const updateMock = mockDbService.drizzle.update;
            const setMock = jest.fn().mockReturnValue({
                where: jest.fn().mockReturnValue({
                    returning: jest.fn().mockResolvedValue([]),
                }),
            });
            updateMock.mockReturnValue({
                set: setMock,
            });
            const result = await repository.update('non-existent-id', {
                username: 'test',
            });
            expect(result).toBeNull();
        });
    });
    describe('updatePassword', () => {
        it('should update password successfully', async () => {
            const updateMock = mockDbService.drizzle.update;
            const setMock = jest.fn().mockReturnValue({
                where: jest.fn().mockReturnValue({
                    returning: jest.fn().mockResolvedValue([{ id: 'test-id-123' }]),
                }),
            });
            updateMock.mockReturnValue({
                set: setMock,
            });
            const result = await repository.updatePassword('test-id-123', 'new-hash');
            expect(result).toBe(true);
        });
        it('should return false when user not found', async () => {
            const updateMock = mockDbService.drizzle.update;
            const setMock = jest.fn().mockReturnValue({
                where: jest.fn().mockReturnValue({
                    returning: jest.fn().mockResolvedValue([]),
                }),
            });
            updateMock.mockReturnValue({
                set: setMock,
            });
            const result = await repository.updatePassword('non-existent-id', 'new-hash');
            expect(result).toBe(false);
        });
    });
    describe('delete', () => {
        it('should delete user successfully', async () => {
            const deleteMock = mockDbService.drizzle.delete;
            deleteMock.mockReturnValue({
                where: jest.fn().mockReturnValue({
                    returning: jest.fn().mockResolvedValue([{ id: 'test-id-123' }]),
                }),
            });
            const result = await repository.delete('test-id-123');
            expect(result).toBe(true);
        });
        it('should return false when user not found', async () => {
            const deleteMock = mockDbService.drizzle.delete;
            deleteMock.mockReturnValue({
                where: jest.fn().mockReturnValue({
                    returning: jest.fn().mockResolvedValue([]),
                }),
            });
            const result = await repository.delete('non-existent-id');
            expect(result).toBe(false);
        });
    });
    describe('count', () => {
        it('should return count of users', async () => {
            const selectMock = mockDbService.drizzle.select;
            selectMock.mockReturnValue({
                from: jest
                    .fn()
                    .mockResolvedValue([
                    { count: 'user1' },
                    { count: 'user2' },
                    { count: 'user3' },
                ]),
            });
            const result = await repository.count();
            expect(result).toBe(3);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aW11clxcUHJvZ3JhbW1pbmdcXFByb2plY3RzXFxzbmlwcGV0Zm9yZ2VcXGFwcHNcXGFwaVxcdGVzdFxcdW5pdFxccmVwb3NpdG9yaWVzXFx1c2Vycy5yZXBvc2l0b3J5LnNwZWMudHMiLCJtYXBwaW5ncyI6IjtBQUFBLGtEQUFrRDs7QUFFbEQsNkNBQXNEO0FBRXRELGtGQUE4RTtBQUM5RSwyREFBK0Q7QUFFL0QsUUFBUSxDQUFDLGlCQUFpQixFQUFFLEdBQUcsRUFBRTtJQUMvQixJQUFJLFVBQTJCLENBQUM7SUFDaEMsSUFBSSxhQUF1QyxDQUFDO0lBRTVDLE1BQU0sUUFBUSxHQUFTO1FBQ3JCLEVBQUUsRUFBRSxhQUFhO1FBQ2pCLEtBQUssRUFBRSxrQkFBa0I7UUFDekIsUUFBUSxFQUFFLFVBQVU7UUFDcEIsWUFBWSxFQUFFLGlCQUFpQjtRQUMvQixJQUFJLEVBQUUsTUFBTTtRQUNaLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRTtRQUNyQixTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUU7S0FDdEIsQ0FBQztJQUVGLFVBQVUsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNwQixhQUFhLEdBQUc7WUFDZCxPQUFPLEVBQUU7Z0JBQ1AsS0FBSyxFQUFFO29CQUNMLEtBQUssRUFBRTt3QkFDTCxTQUFTLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtxQkFDckI7aUJBQ0Y7Z0JBQ0QsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxlQUFlLENBQUM7b0JBQ2hDLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsZUFBZSxDQUFDO3dCQUNoQyxTQUFTLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtxQkFDckIsQ0FBQztpQkFDSCxDQUFDO2dCQUNGLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsZUFBZSxDQUFDO29CQUNoQyxHQUFHLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGVBQWUsQ0FBQzt3QkFDN0IsS0FBSyxFQUFF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RTtpQkFDbkIsQ0FBQzthQUNMLENBQUMsQ0FBQztZQUVILE1BQU0sTUFBTSxHQUFHLE1BQU0sVUFBVSxDQUFDLEtBQUssRUFBRSxDQUFDO1lBRXhDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDekIsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcdGltdXJcXFByb2dyYW1taW5nXFxQcm9qZWN0c1xcc25pcHBldGZvcmdlXFxhcHBzXFxhcGlcXHRlc3RcXHVuaXRcXHJlcG9zaXRvcmllc1xcdXNlcnMucmVwb3NpdG9yeS5zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIHRlc3QvdW5pdC9yZXBvc2l0b3JpZXMvdXNlcnMucmVwb3NpdG9yeS5zcGVjLnRzXHJcblxyXG5pbXBvcnQgeyBUZXN0LCBUZXN0aW5nTW9kdWxlIH0gZnJvbSAnQG5lc3Rqcy90ZXN0aW5nJztcclxuaW1wb3J0IHR5cGUgeyBOZXdVc2VyLCBVc2VyIH0gZnJvbSAnLi4vLi4vLi4vc3JjL2xpYi9kYi9zY2hlbWEnO1xyXG5pbXBvcnQgeyBVc2Vyc1JlcG9zaXRvcnkgfSBmcm9tICcuLi8uLi8uLi9zcmMvbW9kdWxlcy91c2Vycy91c2Vycy5yZXBvc2l0b3J5JztcclxuaW1wb3J0IHsgRGF0YWJhc2VTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vLi4vc3JjL3NoYXJlZC9kYXRhYmFzZSc7XHJcblxyXG5kZXNjcmliZSgnVXNlcnNSZXBvc2l0b3J5JywgKCkgPT4ge1xyXG4gIGxldCByZXBvc2l0b3J5OiBVc2Vyc1JlcG9zaXRvcnk7XHJcbiAgbGV0IG1vY2tEYlNlcnZpY2U6IFBhcnRpYWw8RGF0YWJhc2VTZXJ2aWNlPjtcclxuXHJcbiAgY29uc3QgbW9ja1VzZXI6IFVzZXIgPSB7XHJcbiAgICBpZDogJ3Rlc3QtaWQtMTIzJyxcclxuICAgIGVtYWlsOiAndGVzdEBleGFtcGxlLmNvbScsXHJcbiAgICB1c2VybmFtZTogJ3Rlc3R1c2VyJyxcclxuICAgIHBhc3N3b3JkSGFzaDogJ2hhc2hlZC1wYXNzd29yZCcsXHJcbiAgICByb2xlOiAnVVNFUicsXHJcbiAgICBjcmVhdGVkQXQ6IG5ldyBEYXRlKCksXHJcbiAgICB1cGRhdGVkQXQ6IG5ldyBEYXRlKCksXHJcbiAgfTtcclxuXHJcbiAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiB7XHJcbiAgICBtb2NrRGJTZXJ2aWNlID0ge1xyXG4gICAgICBkcml6emxlOiB7XHJcbiAgICAgICAgcXVlcnk6IHtcclxuICAgICAgICAgIHVzZXJzOiB7XHJcbiAgICAgICAgICAgIGZpbmRGaXJzdDogamVzdC5mbigpLFxyXG4gICAgICAgICAgfSxcclxuICAgICAgICB9LFxyXG4gICAgICAgIGluc2VydDogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7XHJcbiAgICAgICAgICB2YWx1ZXM6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoe1xyXG4gICAgICAgICAgICByZXR1cm5pbmc6IGplc3QuZm4oKSxcclxuICAgICAgICAgIH0pLFxyXG4gICAgICAgIH0pLFxyXG4gICAgICAgIHVwZGF0ZTogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7XHJcbiAgICAgICAgICBzZXQ6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoe1xyXG4gICAgICAgICAgICB3aGVyZTogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7XHJcbiAgICAgICAgICAgICAgcmV0dXJuaW5nOiBqZXN0LmZuKCksXHJcbiAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgfSksXHJcbiAgICAgICAgfSksXHJcbiAgICAgICAgZGVsZXRlOiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHtcclxuICAgICAgICAgIHdoZXJlOiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHtcclxuICAgICAgICAgICAgcmV0dXJuaW5nOiBqZXN0LmZuKCksXHJcbiAgICAgICAgICB9KSxcclxuICAgICAgICB9KSxcclxuICAgICAgICBzZWxlY3Q6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoe1xyXG4gICAgICAgICAgZnJvbTogamVzdC5mbigpLFxyXG4gICAgICAgIH0pLFxyXG4gICAgICB9IGFzIGFueSxcclxuICAgIH07XHJcblxyXG4gICAgY29uc3QgbW9kdWxlOiBUZXN0aW5nTW9kdWxlID0gYXdhaXQgVGVzdC5jcmVhdGVUZXN0aW5nTW9kdWxlKHtcclxuICAgICAgcHJvdmlkZXJzOiBbXHJcbiAgICAgICAgVXNlcnNSZXBvc2l0b3J5LFxyXG4gICAgICAgIHtcclxuICAgICAgICAgIHByb3ZpZGU6IERhdGFiYXNlU2VydmljZSxcclxuICAgICAgICAgIHVzZVZhbHVlOiBtb2NrRGJTZXJ2aWNlLFxyXG4gICAgICAgIH0sXHJcbiAgICAgIF0sXHJcbiAgICB9KS5jb21waWxlKCk7XHJcblxyXG4gICAgcmVwb3NpdG9yeSA9IG1vZHVsZS5nZXQ8VXNlcnNSZXBvc2l0b3J5PihVc2Vyc1JlcG9zaXRvcnkpO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnZmluZEJ5SWQnLCAoKSA9PiB7XHJcbiAgICBpdCgnc2hvdWxkIGZpbmQgdXNlciBieSBJRCcsIGFzeW5jICgpID0+IHtcclxuICAgICAgKFxyXG4gICAgICAgIG1vY2tEYlNlcnZpY2UuZHJpenpsZSEucXVlcnkudXNlcnMuZmluZEZpcnN0IGFzIGplc3QuTW9ja1xyXG4gICAgICApLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tVc2VyKTtcclxuXHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJlcG9zaXRvcnkuZmluZEJ5SWQoJ3Rlc3QtaWQtMTIzJyk7XHJcblxyXG4gICAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKG1vY2tVc2VyKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdzaG91bGQgcmV0dXJuIG51bGwgd2hlbiB1c2VyIG5vdCBmb3VuZCcsIGFzeW5jICgpID0+IHtcclxuICAgICAgKFxyXG4gICAgICAgIG1vY2tEYlNlcnZpY2UuZHJpenpsZSEucXVlcnkudXNlcnMuZmluZEZpcnN0IGFzIGplc3QuTW9ja1xyXG4gICAgICApLm1vY2tSZXNvbHZlZFZhbHVlKHVuZGVmaW5lZCk7XHJcblxyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCByZXBvc2l0b3J5LmZpbmRCeUlkKCdub24tZXhpc3RlbnQtaWQnKTtcclxuXHJcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmVOdWxsKCk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ2ZpbmRCeUVtYWlsJywgKCkgPT4ge1xyXG4gICAgaXQoJ3Nob3VsZCBmaW5kIHVzZXIgYnkgZW1haWwnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIChcclxuICAgICAgICBtb2NrRGJTZXJ2aWNlLmRyaXp6bGUhLnF1ZXJ5LnVzZXJzLmZpbmRGaXJzdCBhcyBqZXN0Lk1vY2tcclxuICAgICAgKS5tb2NrUmVzb2x2ZWRWYWx1ZShtb2NrVXNlcik7XHJcblxyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCByZXBvc2l0b3J5LmZpbmRCeUVtYWlsKCd0ZXN0QGV4YW1wbGUuY29tJyk7XHJcblxyXG4gICAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKG1vY2tVc2VyKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdzaG91bGQgcmV0dXJuIG51bGwgd2hlbiBlbWFpbCBub3QgZm91bmQnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIChcclxuICAgICAgICBtb2NrRGJTZXJ2aWNlLmRyaXp6bGUhLnF1ZXJ5LnVzZXJzLmZpbmRGaXJzdCBhcyBqZXN0Lk1vY2tcclxuICAgICAgKS5tb2NrUmVzb2x2ZWRWYWx1ZSh1bmRlZmluZWQpO1xyXG5cclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcmVwb3NpdG9yeS5maW5kQnlFbWFpbCgnbm9uZXhpc3RlbnRAZXhhbXBsZS5jb20nKTtcclxuXHJcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmVOdWxsKCk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ2ZpbmRCeVVzZXJuYW1lJywgKCkgPT4ge1xyXG4gICAgaXQoJ3Nob3VsZCBmaW5kIHVzZXIgYnkgdXNlcm5hbWUnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIChcclxuICAgICAgICBtb2NrRGJTZXJ2aWNlLmRyaXp6bGUhLnF1ZXJ5LnVzZXJzLmZpbmRGaXJzdCBhcyBqZXN0Lk1vY2tcclxuICAgICAgKS5tb2NrUmVzb2x2ZWRWYWx1ZShtb2NrVXNlcik7XHJcblxyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCByZXBvc2l0b3J5LmZpbmRCeVVzZXJuYW1lKCd0ZXN0dXNlcicpO1xyXG5cclxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbChtb2NrVXNlcik7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIHJldHVybiBudWxsIHdoZW4gdXNlcm5hbWUgbm90IGZvdW5kJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAoXHJcbiAgICAgICAgbW9ja0RiU2VydmljZS5kcml6emxlIS5xdWVyeS51c2Vycy5maW5kRmlyc3QgYXMgamVzdC5Nb2NrXHJcbiAgICAgICkubW9ja1Jlc29sdmVkVmFsdWUodW5kZWZpbmVkKTtcclxuXHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJlcG9zaXRvcnkuZmluZEJ5VXNlcm5hbWUoJ25vbmV4aXN0ZW50Jyk7XHJcblxyXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlTnVsbCgpO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdmaW5kQnlFbWFpbE9yVXNlcm5hbWUnLCAoKSA9PiB7XHJcbiAgICBpdCgnc2hvdWxkIGZpbmQgdXNlciBieSBlbWFpbCBvciB1c2VybmFtZScsIGFzeW5jICgpID0+IHtcclxuICAgICAgKFxyXG4gICAgICAgIG1vY2tEYlNlcnZpY2UuZHJpenpsZSEucXVlcnkudXNlcnMuZmluZEZpcnN0IGFzIGplc3QuTW9ja1xyXG4gICAgICApLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tVc2VyKTtcclxuXHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJlcG9zaXRvcnkuZmluZEJ5RW1haWxPclVzZXJuYW1lKFxyXG4gICAgICAgICd0ZXN0QGV4YW1wbGUuY29tJyxcclxuICAgICAgICAndGVzdHVzZXInLFxyXG4gICAgICApO1xyXG5cclxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbChtb2NrVXNlcik7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIHJldHVybiBudWxsIHdoZW4gbmVpdGhlciBleGlzdHMnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIChcclxuICAgICAgICBtb2NrRGJTZXJ2aWNlLmRyaXp6bGUhLnF1ZXJ5LnVzZXJzLmZpbmRGaXJzdCBhcyBqZXN0Lk1vY2tcclxuICAgICAgKS5tb2NrUmVzb2x2ZWRWYWx1ZSh1bmRlZmluZWQpO1xyXG5cclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcmVwb3NpdG9yeS5maW5kQnlFbWFpbE9yVXNlcm5hbWUoXHJcbiAgICAgICAgJ25ld0BleGFtcGxlLmNvbScsXHJcbiAgICAgICAgJ25ld3VzZXInLFxyXG4gICAgICApO1xyXG5cclxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZU51bGwoKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnY3JlYXRlJywgKCkgPT4ge1xyXG4gICAgaXQoJ3Nob3VsZCBjcmVhdGUgbmV3IHVzZXInLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IG5ld1VzZXJEYXRhOiBOZXdVc2VyID0ge1xyXG4gICAgICAgIGVtYWlsOiAnbmV3QGV4YW1wbGUuY29tJyxcclxuICAgICAgICB1c2VybmFtZTogJ25ld3VzZXInLFxyXG4gICAgICAgIHBhc3N3b3JkSGFzaDogJ2hhc2hlZCcsXHJcbiAgICAgICAgcm9sZTogJ1VTRVInLFxyXG4gICAgICB9O1xyXG5cclxuICAgICAgY29uc3QgaW5zZXJ0TW9jayA9IG1vY2tEYlNlcnZpY2UuZHJpenpsZSEuaW5zZXJ0IGFzIGplc3QuTW9jaztcclxuICAgICAgY29uc3QgdmFsdWVzTW9jayA9IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoe1xyXG4gICAgICAgIHJldHVybmluZzogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKFttb2NrVXNlcl0pLFxyXG4gICAgICB9KTtcclxuICAgICAgaW5zZXJ0TW9jay5tb2NrUmV0dXJuVmFsdWUoe1xyXG4gICAgICAgIHZhbHVlczogdmFsdWVzTW9jayxcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCByZXBvc2l0b3J5LmNyZWF0ZShuZXdVc2VyRGF0YSk7XHJcblxyXG4gICAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKG1vY2tVc2VyKTtcclxuICAgICAgZXhwZWN0KHZhbHVlc01vY2spLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxyXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcclxuICAgICAgICAgIGVtYWlsOiAnbmV3QGV4YW1wbGUuY29tJyxcclxuICAgICAgICB9KSxcclxuICAgICAgKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgndXBkYXRlJywgKCkgPT4ge1xyXG4gICAgaXQoJ3Nob3VsZCB1cGRhdGUgdXNlciBzdWNjZXNzZnVsbHknLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHVwZGF0ZURhdGEgPSB7IHVzZXJuYW1lOiAndXBkYXRlZHVzZXInIH07XHJcblxyXG4gICAgICBjb25zdCB1cGRhdGVNb2NrID0gbW9ja0RiU2VydmljZS5kcml6emxlIS51cGRhdGUgYXMgamVzdC5Nb2NrO1xyXG4gICAgICBjb25zdCBzZXRNb2NrID0gamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7XHJcbiAgICAgICAgd2hlcmU6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoe1xyXG4gICAgICAgICAgcmV0dXJuaW5nOiBqZXN0XHJcbiAgICAgICAgICAgIC5mbigpXHJcbiAgICAgICAgICAgIC5tb2NrUmVzb2x2ZWRWYWx1ZShbeyAuLi5tb2NrVXNlciwgLi4udXBkYXRlRGF0YSB9XSksXHJcbiAgICAgICAgfSksXHJcbiAgICAgIH0pO1xyXG4gICAgICB1cGRhdGVNb2NrLm1vY2tSZXR1cm5WYWx1ZSh7XHJcbiAgICAgICAgc2V0OiBzZXRNb2NrLFxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJlcG9zaXRvcnkudXBkYXRlKCd0ZXN0LWlkLTEyMycsIHVwZGF0ZURhdGEpO1xyXG5cclxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZURlZmluZWQoKTtcclxuICAgICAgZXhwZWN0KHJlc3VsdD8udXNlcm5hbWUpLnRvQmUoJ3VwZGF0ZWR1c2VyJyk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIHJldHVybiBudWxsIHdoZW4gdXNlciBub3QgZm91bmQnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHVwZGF0ZU1vY2sgPSBtb2NrRGJTZXJ2aWNlLmRyaXp6bGUhLnVwZGF0ZSBhcyBqZXN0Lk1vY2s7XHJcbiAgICAgIGNvbnN0IHNldE1vY2sgPSBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHtcclxuICAgICAgICB3aGVyZTogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7XHJcbiAgICAgICAgICByZXR1cm5pbmc6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZShbXSksXHJcbiAgICAgICAgfSksXHJcbiAgICAgIH0pO1xyXG4gICAgICB1cGRhdGVNb2NrLm1vY2tSZXR1cm5WYWx1ZSh7XHJcbiAgICAgICAgc2V0OiBzZXRNb2NrLFxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJlcG9zaXRvcnkudXBkYXRlKCdub24tZXhpc3RlbnQtaWQnLCB7XHJcbiAgICAgICAgdXNlcm5hbWU6ICd0ZXN0JyxcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlTnVsbCgpO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCd1cGRhdGVQYXNzd29yZCcsICgpID0+IHtcclxuICAgIGl0KCdzaG91bGQgdXBkYXRlIHBhc3N3b3JkIHN1Y2Nlc3NmdWxseScsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgdXBkYXRlTW9jayA9IG1vY2tEYlNlcnZpY2UuZHJpenpsZSEudXBkYXRlIGFzIGplc3QuTW9jaztcclxuICAgICAgY29uc3Qgc2V0TW9jayA9IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoe1xyXG4gICAgICAgIHdoZXJlOiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHtcclxuICAgICAgICAgIHJldHVybmluZzogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKFt7IGlkOiAndGVzdC1pZC0xMjMnIH1dKSxcclxuICAgICAgICB9KSxcclxuICAgICAgfSk7XHJcbiAgICAgIHVwZGF0ZU1vY2subW9ja1JldHVyblZhbHVlKHtcclxuICAgICAgICBzZXQ6IHNldE1vY2ssXHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcmVwb3NpdG9yeS51cGRhdGVQYXNzd29yZCgndGVzdC1pZC0xMjMnLCAnbmV3LWhhc2gnKTtcclxuXHJcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmUodHJ1ZSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIHJldHVybiBmYWxzZSB3aGVuIHVzZXIgbm90IGZvdW5kJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCB1cGRhdGVNb2NrID0gbW9ja0RiU2VydmljZS5kcml6emxlIS51cGRhdGUgYXMgamVzdC5Nb2NrO1xyXG4gICAgICBjb25zdCBzZXRNb2NrID0gamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7XHJcbiAgICAgICAgd2hlcmU6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoe1xyXG4gICAgICAgICAgcmV0dXJuaW5nOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoW10pLFxyXG4gICAgICAgIH0pLFxyXG4gICAgICB9KTtcclxuICAgICAgdXBkYXRlTW9jay5tb2NrUmV0dXJuVmFsdWUoe1xyXG4gICAgICAgIHNldDogc2V0TW9jayxcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCByZXBvc2l0b3J5LnVwZGF0ZVBhc3N3b3JkKFxyXG4gICAgICAgICdub24tZXhpc3RlbnQtaWQnLFxyXG4gICAgICAgICduZXctaGFzaCcsXHJcbiAgICAgICk7XHJcblxyXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlKGZhbHNlKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnZGVsZXRlJywgKCkgPT4ge1xyXG4gICAgaXQoJ3Nob3VsZCBkZWxldGUgdXNlciBzdWNjZXNzZnVsbHknLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IGRlbGV0ZU1vY2sgPSBtb2NrRGJTZXJ2aWNlLmRyaXp6bGUhLmRlbGV0ZSBhcyBqZXN0Lk1vY2s7XHJcbiAgICAgIGRlbGV0ZU1vY2subW9ja1JldHVyblZhbHVlKHtcclxuICAgICAgICB3aGVyZTogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7XHJcbiAgICAgICAgICByZXR1cm5pbmc6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZShbeyBpZDogJ3Rlc3QtaWQtMTIzJyB9XSksXHJcbiAgICAgICAgfSksXHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcmVwb3NpdG9yeS5kZWxldGUoJ3Rlc3QtaWQtMTIzJyk7XHJcblxyXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlKHRydWUpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gZmFsc2Ugd2hlbiB1c2VyIG5vdCBmb3VuZCcsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgZGVsZXRlTW9jayA9IG1vY2tEYlNlcnZpY2UuZHJpenpsZSEuZGVsZXRlIGFzIGplc3QuTW9jaztcclxuICAgICAgZGVsZXRlTW9jay5tb2NrUmV0dXJuVmFsdWUoe1xyXG4gICAgICAgIHdoZXJlOiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHtcclxuICAgICAgICAgIHJldHVybmluZzogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKFtdKSxcclxuICAgICAgICB9KSxcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCByZXBvc2l0b3J5LmRlbGV0ZSgnbm9uLWV4aXN0ZW50LWlkJyk7XHJcblxyXG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlKGZhbHNlKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnY291bnQnLCAoKSA9PiB7XHJcbiAgICBpdCgnc2hvdWxkIHJldHVybiBjb3VudCBvZiB1c2VycycsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3Qgc2VsZWN0TW9jayA9IG1vY2tEYlNlcnZpY2UuZHJpenpsZSEuc2VsZWN0IGFzIGplc3QuTW9jaztcclxuICAgICAgc2VsZWN0TW9jay5tb2NrUmV0dXJuVmFsdWUoe1xyXG4gICAgICAgIGZyb206IGplc3RcclxuICAgICAgICAgIC5mbigpXHJcbiAgICAgICAgICAubW9ja1Jlc29sdmVkVmFsdWUoW1xyXG4gICAgICAgICAgICB7IGNvdW50OiAndXNlcjEnIH0sXHJcbiAgICAgICAgICAgIHsgY291bnQ6ICd1c2VyMicgfSxcclxuICAgICAgICAgICAgeyBjb3VudDogJ3VzZXIzJyB9LFxyXG4gICAgICAgICAgXSksXHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcmVwb3NpdG9yeS5jb3VudCgpO1xyXG5cclxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZSgzKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG59KTtcclxuIl0sInZlcnNpb24iOjN9