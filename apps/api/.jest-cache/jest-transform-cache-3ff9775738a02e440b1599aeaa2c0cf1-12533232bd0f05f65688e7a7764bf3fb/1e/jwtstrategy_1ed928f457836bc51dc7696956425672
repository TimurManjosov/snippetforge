b9d46aae4a22e47fe39d430935248780
"use strict";
// src/modules/auth/strategies/jwt.strategy.ts
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var JwtStrategy_1;
var _a, _b;
Object.defineProperty(exports, "__esModule", { value: true });
exports.JwtStrategy = void 0;
const common_1 = require("@nestjs/common");
const config_1 = require("@nestjs/config");
const passport_1 = require("@nestjs/passport");
const passport_jwt_1 = require("passport-jwt");
const users_1 = require("../../users");
/**
 * JwtStrategy - Validiert JWT Tokens bei geschützten Routes
 *
 * WIE ES FUNKTIONIERT:
 * 1. Request kommt rein mit Authorization:  Bearer <token>
 * 2. JwtAuthGuard aktiviert diese Strategy
 * 3. passport-jwt extrahiert Token aus Header
 * 4. passport-jwt verifiziert Signatur mit Secret
 * 5. validate() wird mit decoded Payload aufgerufen
 * 6. validate() lädt User aus DB und gibt ihn zurück
 * 7. User wird an request.user angehängt
 *
 * WARUM User aus DB laden statt nur Payload nutzen?
 * - User könnte gelöscht/deaktiviert worden sein
 * - User-Rolle könnte sich geändert haben
 * - Wir brauchen aktuelle User-Daten
 *
 * ALTERNATIVE:  Nur Payload nutzen (ohne DB-Query)
 * Pro: Schneller (kein DB-Roundtrip)
 * Contra: Veraltete Daten möglich
 * Entscheidung: DB-Query für Sicherheit (bei jedem Request)
 */
let JwtStrategy = JwtStrategy_1 = class JwtStrategy extends (0, passport_1.PassportStrategy)(passport_jwt_1.Strategy) {
    configService;
    usersService;
    logger = new common_1.Logger(JwtStrategy_1.name);
    constructor(configService, usersService) {
        // Passport Strategy Konfiguration
        super({
            // Wo ist der Token?  → Authorization Header als Bearer Token
            jwtFromRequest: passport_jwt_1.ExtractJwt.fromAuthHeaderAsBearerToken(),
            // Abgelaufene Tokens ablehnen?
            ignoreExpiration: false,
            // Secret für Signatur-Validierung
            secretOrKey: configService.get('JWT_SECRET') || '',
            // Algorithms die akzeptiert werden
            algorithms: ['HS256'],
        });
        this.configService = configService;
        this.usersService = usersService;
    }
    /**
     * Validate - Wird nach erfolgreicher Token-Verifikation aufgerufen
     *
     * WICHTIG: Wenn diese Methode einen Wert zurückgibt,
     * wird dieser an request.user angehängt.
     * Wenn sie eine Exception wirft, wird 401 zurückgegeben.
     *
     * @param payload - Decoded JWT Payload (bereits verifiziert!)
     * @returns SafeUser für request.user
     * @throws UnauthorizedException wenn User nicht existiert
     */
    async validate(payload) {
        this.logger.debug(`Validating JWT for user: ${payload.sub}`);
        // User aus DB laden (aktuelle Daten!)
        // Wir nutzen try-catch weil findById eine Exception wirft wenn nicht gefunden
        try {
            const user = await this.usersService.findById(payload.sub);
            this.logger.debug(`JWT validated for user: ${user.email}`);
            return user;
            // eslint-disable-next-line @typescript-eslint/no-unused-vars
        }
        catch (error) {
            // User nicht gefunden (gelöscht?)
            this.logger.warn(`JWT validation failed: User ${payload.sub} not found`);
            throw new common_1.UnauthorizedException('User not found or has been deleted');
        }
    }
};
exports.JwtStrategy = JwtStrategy;
exports.JwtStrategy = JwtStrategy = JwtStrategy_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [typeof (_a = typeof config_1.ConfigService !== "undefined" && config_1.ConfigService) === "function" ? _a : Object, typeof (_b = typeof users_1.UsersService !== "undefined" && users_1.UsersService) === "function" ? _b : Object])
], JwtStrategy);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aW11clxcUHJvZ3JhbW1pbmdcXFByb2plY3RzXFxzbmlwcGV0Zm9yZ2VcXGFwcHNcXGFwaVxcc3JjXFxtb2R1bGVzXFxhdXRoXFxzdHJhdGVnaWVzXFxqd3Quc3RyYXRlZ3kudHMiLCJtYXBwaW5ncyI6IjtBQUFBLDhDQUE4Qzs7Ozs7Ozs7Ozs7Ozs7QUFFOUMsMkNBQTJFO0FBQzNFLDJDQUErQztBQUMvQywrQ0FBb0Q7QUFDcEQsK0NBQW9EO0FBQ3BELHVDQUEwRDtBQUcxRDs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBcUJHO0FBRUksSUFBTSxXQUFXLG1CQUFqQixNQUFNLFdBQVksU0FBUSxJQUFBLDJCQUFnQixFQUFDLHVCQUFRLENBQUM7SUFJdEM7SUFDQTtJQUpGLE1BQU0sR0FBRyxJQUFJLGVBQU0sQ0FBQyxhQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7SUFFdkQsWUFDbUIsYUFBNEIsRUFDNUIsWUFBMEI7UUFFM0Msa0NBQWtDO1FBQ2xDLEtBQUssQ0FBQztZQUNKLDZEQUE2RDtZQUM3RCxjQUFjLEVBQUUseUJBQVUsQ0FBQywyQkFBMkIsRUFBRTtZQUV4RCwrQkFBK0I7WUFDL0IsZ0JBQWdCLEVBQUUsS0FBSztZQUV2QixrQ0FBa0M7WUFDbEMsV0FBVyxFQUFFLGFBQWEsQ0FBQyxHQUFHLENBQVMsWUFBWSxDQUFDLElBQUksRUFBRTtZQUUxRCxtQ0FBbUM7WUFDbkMsVUFBVSxFQUFFLENBQUMsT0FBTyxDQUFDO1NBQ3RCLENBQUMsQ0FBQztRQWhCYyxrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUM1QixpQkFBWSxHQUFaLFlBQVksQ0FBYztJQWdCN0MsQ0FBQztJQUVEOzs7Ozs7Ozs7O09BVUc7SUFDSCxLQUFLLENBQUMsUUFBUSxDQUFDLE9BQW1CO1FBQ2hDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLDRCQUE0QixPQUFPLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztRQUU3RCxzQ0FBc0M7UUFDdEMsOEVBQThFO1FBQzlFLElBQUksQ0FBQztZQUNILE1BQU0sSUFBSSxHQUFHLE1BQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBRTNELElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLDJCQUEyQixJQUFJLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQztZQUMzRCxPQUFPLElBQUksQ0FBQztZQUNaLDZEQUE2RDtRQUMvRCxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLGtDQUFrQztZQUNsQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQywrQkFBK0IsT0FBTyxDQUFDLEdBQUcsWUFBWSxDQUFDLENBQUM7WUFDekUsTUFBTSxJQUFJLDhCQUFxQixDQUFDLG9DQUFvQyxDQUFDLENBQUM7UUFDeEUsQ0FBQztJQUNILENBQUM7Q0FDRixDQUFBO0FBbkRZLGtDQUFXO3NCQUFYLFdBQVc7SUFEdkIsSUFBQSxtQkFBVSxHQUFFO3lEQUt1QixzQkFBYSxvQkFBYixzQkFBYSxvREFDZCxvQkFBWSxvQkFBWixvQkFBWTtHQUxsQyxXQUFXLENBbUR2QiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXHRpbXVyXFxQcm9ncmFtbWluZ1xcUHJvamVjdHNcXHNuaXBwZXRmb3JnZVxcYXBwc1xcYXBpXFxzcmNcXG1vZHVsZXNcXGF1dGhcXHN0cmF0ZWdpZXNcXGp3dC5zdHJhdGVneS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBzcmMvbW9kdWxlcy9hdXRoL3N0cmF0ZWdpZXMvand0LnN0cmF0ZWd5LnRzXHJcblxyXG5pbXBvcnQgeyBJbmplY3RhYmxlLCBMb2dnZXIsIFVuYXV0aG9yaXplZEV4Y2VwdGlvbiB9IGZyb20gJ0BuZXN0anMvY29tbW9uJztcclxuaW1wb3J0IHsgQ29uZmlnU2VydmljZSB9IGZyb20gJ0BuZXN0anMvY29uZmlnJztcclxuaW1wb3J0IHsgUGFzc3BvcnRTdHJhdGVneSB9IGZyb20gJ0BuZXN0anMvcGFzc3BvcnQnO1xyXG5pbXBvcnQgeyBFeHRyYWN0Snd0LCBTdHJhdGVneSB9IGZyb20gJ3Bhc3Nwb3J0LWp3dCc7XHJcbmltcG9ydCB7IFVzZXJzU2VydmljZSwgdHlwZSBTYWZlVXNlciB9IGZyb20gJy4uLy4uL3VzZXJzJztcclxuaW1wb3J0IHsgdHlwZSBKd3RQYXlsb2FkIH0gZnJvbSAnLi4vYXV0aC50eXBlcyc7XHJcblxyXG4vKipcclxuICogSnd0U3RyYXRlZ3kgLSBWYWxpZGllcnQgSldUIFRva2VucyBiZWkgZ2VzY2jDvHR6dGVuIFJvdXRlc1xyXG4gKlxyXG4gKiBXSUUgRVMgRlVOS1RJT05JRVJUOlxyXG4gKiAxLiBSZXF1ZXN0IGtvbW10IHJlaW4gbWl0IEF1dGhvcml6YXRpb246ICBCZWFyZXIgPHRva2VuPlxyXG4gKiAyLiBKd3RBdXRoR3VhcmQgYWt0aXZpZXJ0IGRpZXNlIFN0cmF0ZWd5XHJcbiAqIDMuIHBhc3Nwb3J0LWp3dCBleHRyYWhpZXJ0IFRva2VuIGF1cyBIZWFkZXJcclxuICogNC4gcGFzc3BvcnQtand0IHZlcmlmaXppZXJ0IFNpZ25hdHVyIG1pdCBTZWNyZXRcclxuICogNS4gdmFsaWRhdGUoKSB3aXJkIG1pdCBkZWNvZGVkIFBheWxvYWQgYXVmZ2VydWZlblxyXG4gKiA2LiB2YWxpZGF0ZSgpIGzDpGR0IFVzZXIgYXVzIERCIHVuZCBnaWJ0IGlobiB6dXLDvGNrXHJcbiAqIDcuIFVzZXIgd2lyZCBhbiByZXF1ZXN0LnVzZXIgYW5nZWjDpG5ndFxyXG4gKlxyXG4gKiBXQVJVTSBVc2VyIGF1cyBEQiBsYWRlbiBzdGF0dCBudXIgUGF5bG9hZCBudXR6ZW4/XHJcbiAqIC0gVXNlciBrw7ZubnRlIGdlbMO2c2NodC9kZWFrdGl2aWVydCB3b3JkZW4gc2VpblxyXG4gKiAtIFVzZXItUm9sbGUga8O2bm50ZSBzaWNoIGdlw6RuZGVydCBoYWJlblxyXG4gKiAtIFdpciBicmF1Y2hlbiBha3R1ZWxsZSBVc2VyLURhdGVuXHJcbiAqXHJcbiAqIEFMVEVSTkFUSVZFOiAgTnVyIFBheWxvYWQgbnV0emVuIChvaG5lIERCLVF1ZXJ5KVxyXG4gKiBQcm86IFNjaG5lbGxlciAoa2VpbiBEQi1Sb3VuZHRyaXApXHJcbiAqIENvbnRyYTogVmVyYWx0ZXRlIERhdGVuIG3DtmdsaWNoXHJcbiAqIEVudHNjaGVpZHVuZzogREItUXVlcnkgZsO8ciBTaWNoZXJoZWl0IChiZWkgamVkZW0gUmVxdWVzdClcclxuICovXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIEp3dFN0cmF0ZWd5IGV4dGVuZHMgUGFzc3BvcnRTdHJhdGVneShTdHJhdGVneSkge1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgbG9nZ2VyID0gbmV3IExvZ2dlcihKd3RTdHJhdGVneS5uYW1lKTtcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNvbmZpZ1NlcnZpY2U6IENvbmZpZ1NlcnZpY2UsXHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IHVzZXJzU2VydmljZTogVXNlcnNTZXJ2aWNlLFxyXG4gICkge1xyXG4gICAgLy8gUGFzc3BvcnQgU3RyYXRlZ3kgS29uZmlndXJhdGlvblxyXG4gICAgc3VwZXIoe1xyXG4gICAgICAvLyBXbyBpc3QgZGVyIFRva2VuPyAg4oaSIEF1dGhvcml6YXRpb24gSGVhZGVyIGFscyBCZWFyZXIgVG9rZW5cclxuICAgICAgand0RnJvbVJlcXVlc3Q6IEV4dHJhY3RKd3QuZnJvbUF1dGhIZWFkZXJBc0JlYXJlclRva2VuKCksXHJcblxyXG4gICAgICAvLyBBYmdlbGF1ZmVuZSBUb2tlbnMgYWJsZWhuZW4/XHJcbiAgICAgIGlnbm9yZUV4cGlyYXRpb246IGZhbHNlLFxyXG5cclxuICAgICAgLy8gU2VjcmV0IGbDvHIgU2lnbmF0dXItVmFsaWRpZXJ1bmdcclxuICAgICAgc2VjcmV0T3JLZXk6IGNvbmZpZ1NlcnZpY2UuZ2V0PHN0cmluZz4oJ0pXVF9TRUNSRVQnKSB8fCAnJyxcclxuXHJcbiAgICAgIC8vIEFsZ29yaXRobXMgZGllIGFremVwdGllcnQgd2VyZGVuXHJcbiAgICAgIGFsZ29yaXRobXM6IFsnSFMyNTYnXSxcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogVmFsaWRhdGUgLSBXaXJkIG5hY2ggZXJmb2xncmVpY2hlciBUb2tlbi1WZXJpZmlrYXRpb24gYXVmZ2VydWZlblxyXG4gICAqXHJcbiAgICogV0lDSFRJRzogV2VubiBkaWVzZSBNZXRob2RlIGVpbmVuIFdlcnQgenVyw7xja2dpYnQsXHJcbiAgICogd2lyZCBkaWVzZXIgYW4gcmVxdWVzdC51c2VyIGFuZ2Vow6RuZ3QuXHJcbiAgICogV2VubiBzaWUgZWluZSBFeGNlcHRpb24gd2lyZnQsIHdpcmQgNDAxIHp1csO8Y2tnZWdlYmVuLlxyXG4gICAqXHJcbiAgICogQHBhcmFtIHBheWxvYWQgLSBEZWNvZGVkIEpXVCBQYXlsb2FkIChiZXJlaXRzIHZlcmlmaXppZXJ0ISlcclxuICAgKiBAcmV0dXJucyBTYWZlVXNlciBmw7xyIHJlcXVlc3QudXNlclxyXG4gICAqIEB0aHJvd3MgVW5hdXRob3JpemVkRXhjZXB0aW9uIHdlbm4gVXNlciBuaWNodCBleGlzdGllcnRcclxuICAgKi9cclxuICBhc3luYyB2YWxpZGF0ZShwYXlsb2FkOiBKd3RQYXlsb2FkKTogUHJvbWlzZTxTYWZlVXNlcj4ge1xyXG4gICAgdGhpcy5sb2dnZXIuZGVidWcoYFZhbGlkYXRpbmcgSldUIGZvciB1c2VyOiAke3BheWxvYWQuc3VifWApO1xyXG5cclxuICAgIC8vIFVzZXIgYXVzIERCIGxhZGVuIChha3R1ZWxsZSBEYXRlbiEpXHJcbiAgICAvLyBXaXIgbnV0emVuIHRyeS1jYXRjaCB3ZWlsIGZpbmRCeUlkIGVpbmUgRXhjZXB0aW9uIHdpcmZ0IHdlbm4gbmljaHQgZ2VmdW5kZW5cclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCB0aGlzLnVzZXJzU2VydmljZS5maW5kQnlJZChwYXlsb2FkLnN1Yik7XHJcblxyXG4gICAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhgSldUIHZhbGlkYXRlZCBmb3IgdXNlcjogJHt1c2VyLmVtYWlsfWApO1xyXG4gICAgICByZXR1cm4gdXNlcjtcclxuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby11bnVzZWQtdmFyc1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgLy8gVXNlciBuaWNodCBnZWZ1bmRlbiAoZ2Vsw7ZzY2h0PylcclxuICAgICAgdGhpcy5sb2dnZXIud2FybihgSldUIHZhbGlkYXRpb24gZmFpbGVkOiBVc2VyICR7cGF5bG9hZC5zdWJ9IG5vdCBmb3VuZGApO1xyXG4gICAgICB0aHJvdyBuZXcgVW5hdXRob3JpemVkRXhjZXB0aW9uKCdVc2VyIG5vdCBmb3VuZCBvciBoYXMgYmVlbiBkZWxldGVkJyk7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcbiJdLCJ2ZXJzaW9uIjozfQ==