b9aad51a4850633882c1a64f6ae1440e
"use strict";
// test/unit/pipes/zod-validation.pipe.spec.ts
Object.defineProperty(exports, "__esModule", { value: true });
const common_1 = require("@nestjs/common");
const zod_1 = require("zod");
const zod_validation_pipe_1 = require("../../../src/shared/pipes/zod-validation.pipe");
/**
 * ZodValidationPipe Unit Tests
 *
 * Testet:
 * - Valide Daten werden transformiert
 * - Invalide Daten werfen BadRequestException
 * - Error-Format ist korrekt
 */
describe('ZodValidationPipe', () => {
    // Test Schema
    const TestSchema = zod_1.z.object({
        email: zod_1.z.string().email('Invalid email format'),
        name: zod_1.z.string().min(2, 'Name must be at least 2 characters'),
        age: zod_1.z.number().min(0, 'Age must be positive').optional(),
    });
    let pipe;
    beforeEach(() => {
        pipe = new zod_validation_pipe_1.ZodValidationPipe(TestSchema);
    });
    describe('transform', () => {
        describe('with valid data', () => {
            it('should return parsed data when all fields are valid', () => {
                // Arrange
                const input = {
                    email: 'test@example.com',
                    name: 'John',
                    age: 25,
                };
                // Act
                const result = pipe.transform(input);
                // Assert
                expect(result).toEqual(input);
            });
            it('should return parsed data with optional fields omitted', () => {
                // Arrange
                const input = {
                    email: 'test@example.com',
                    name: 'John',
                };
                // Act
                const result = pipe.transform(input);
                // Assert
                expect(result).toEqual(input);
                expect(result).not.toHaveProperty('age');
            });
            it('should transform data (e.g., trim strings) if schema defines transformations', () => {
                // Arrange
                const schemaWithTransform = zod_1.z.object({
                    email: zod_1.z
                        .string()
                        .email()
                        .transform((v) => v.toLowerCase()),
                });
                const pipeWithTransform = new zod_validation_pipe_1.ZodValidationPipe(schemaWithTransform);
                const input = { email: 'TEST@EXAMPLE.COM' };
                // Act
                const result = pipeWithTransform.transform(input);
                // Assert
                expect(result.email).toBe('test@example.com');
            });
        });
        describe('with invalid data', () => {
            it('should throw BadRequestException for invalid email', () => {
                // Arrange
                const input = {
                    email: 'not-an-email',
                    name: 'John',
                };
                // Act & Assert
                expect(() => pipe.transform(input)).toThrow(common_1.BadRequestException);
            });
            it('should throw BadRequestException for too short name', () => {
                // Arrange
                const input = {
                    email: 'test@example.com',
                    name: 'J', // too short
                };
                // Act & Assert
                expect(() => pipe.transform(input)).toThrow(common_1.BadRequestException);
            });
            it('should include field-specific errors in exception', () => {
                // Arrange
                const input = {
                    email: 'invalid',
                    name: 'J',
                };
                // Act & Assert
                try {
                    pipe.transform(input);
                    fail('Should have thrown');
                }
                catch (error) {
                    expect(error).toBeInstanceOf(common_1.BadRequestException);
                    const response = error.getResponse();
                    expect(response.errors).toHaveProperty('email');
                    expect(response.errors).toHaveProperty('name');
                }
            });
            it('should include error code in exception', () => {
                // Arrange
                const input = { email: 'invalid', name: 'J' };
                // Act & Assert
                try {
                    pipe.transform(input);
                    fail('Should have thrown');
                }
                catch (error) {
                    const response = error.getResponse();
                    expect(response.code).toBe('VALIDATION_ERROR');
                }
            });
            it('should handle missing required fields', () => {
                // Arrange
                const input = {}; // missing email and name
                // Act & Assert
                expect(() => pipe.transform(input)).toThrow(common_1.BadRequestException);
            });
            it('should handle wrong types', () => {
                // Arrange
                const input = {
                    email: 123, // should be string
                    name: 'John',
                };
                // Act & Assert
                expect(() => pipe.transform(input)).toThrow(common_1.BadRequestException);
            });
        });
        describe('error message formatting', () => {
            it('should format nested path errors correctly', () => {
                // Arrange
                const nestedSchema = zod_1.z.object({
                    user: zod_1.z.object({
                        email: zod_1.z.string().email(),
                    }),
                });
                const nestedPipe = new zod_validation_pipe_1.ZodValidationPipe(nestedSchema);
                const input = { user: { email: 'invalid' } };
                // Act & Assert
                try {
                    nestedPipe.transform(input);
                    fail('Should have thrown');
                }
                catch (error) {
                    const response = error.getResponse();
                    expect(response.errors['user.email']).toBeDefined();
                    expect(response.errors['user.email']).toContain('Invalid email address');
                }
            });
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aW11clxcUHJvZ3JhbW1pbmdcXFByb2plY3RzXFxzbmlwcGV0Zm9yZ2VcXGFwcHNcXGFwaVxcdGVzdFxcdW5pdFxccGlwZXNcXHpvZC12YWxpZGF0aW9uLnBpcGUuc3BlYy50cyIsIm1hcHBpbmdzIjoiO0FBQUEsOENBQThDOztBQUU5QywyQ0FBcUQ7QUFDckQsNkJBQXdCO0FBQ3hCLHVGQUFrRjtBQUVsRjs7Ozs7OztHQU9HO0FBQ0gsUUFBUSxDQUFDLG1CQUFtQixFQUFFLEdBQUcsRUFBRTtJQUNqQyxjQUFjO0lBQ2QsTUFBTSxVQUFVLEdBQUcsT0FBQyxDQUFDLE1BQU0sQ0FBQztRQUMxQixLQUFLLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEtBQUssQ0FBQyxzQkFBc0IsQ0FBQztRQUMvQyxJQUFJLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsb0NBQW9DLENBQUM7UUFDN0QsR0FBRyxFQUFFLE9BQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLHNCQUFzQixDQUFDLENBQUMsUUFBUSxFQUFFO0tBQzFELENBQUMsQ0FBQztJQUVILElBQUksSUFBbUQsQ0FBQztJQUV4RCxVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2QsSUFBSSxHQUFHLElBQUksdUNBQWlCLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDM0MsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsV0FBVyxFQUFFLEdBQUcsRUFBRTtRQUN6QixRQUFRLENBQUMsaUJBQWlCLEVBQUUsR0FBRyxFQUFFO1lBQy9CLEVBQUUsQ0FBQyxxREFBcUQsRUFBRSxHQUFHLEVBQUU7Z0JBQzdELFVBQVU7Z0JBQ1YsTUFBTSxLQUFLLEdBQUc7b0JBQ1osS0FBSyxFQUFFLGtCQUFrQjtvQkFDekIsSUFBSSxFQUFFLE1BQU07b0JBQ1osR0FBRyxFQUFFLEVBQUU7aUJBQ1IsQ0FBQztnQkFFRixNQUFNO2dCQUNOLE1BQU0sTUFBTSxHQUFH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QyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztvQkFDcEQsTUFBTSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQzdDLHVCQUF1QixDQUN4QixDQUFDO2dCQUNKLENBQUM7WUFDSCxDQUFDLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXHRpbXVyXFxQcm9ncmFtbWluZ1xcUHJvamVjdHNcXHNuaXBwZXRmb3JnZVxcYXBwc1xcYXBpXFx0ZXN0XFx1bml0XFxwaXBlc1xcem9kLXZhbGlkYXRpb24ucGlwZS5zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIHRlc3QvdW5pdC9waXBlcy96b2QtdmFsaWRhdGlvbi5waXBlLnNwZWMudHNcclxuXHJcbmltcG9ydCB7IEJhZFJlcXVlc3RFeGNlcHRpb24gfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XHJcbmltcG9ydCB7IHogfSBmcm9tICd6b2QnO1xyXG5pbXBvcnQgeyBab2RWYWxpZGF0aW9uUGlwZSB9IGZyb20gJy4uLy4uLy4uL3NyYy9zaGFyZWQvcGlwZXMvem9kLXZhbGlkYXRpb24ucGlwZSc7XHJcblxyXG4vKipcclxuICogWm9kVmFsaWRhdGlvblBpcGUgVW5pdCBUZXN0c1xyXG4gKlxyXG4gKiBUZXN0ZXQ6XHJcbiAqIC0gVmFsaWRlIERhdGVuIHdlcmRlbiB0cmFuc2Zvcm1pZXJ0XHJcbiAqIC0gSW52YWxpZGUgRGF0ZW4gd2VyZmVuIEJhZFJlcXVlc3RFeGNlcHRpb25cclxuICogLSBFcnJvci1Gb3JtYXQgaXN0IGtvcnJla3RcclxuICovXHJcbmRlc2NyaWJlKCdab2RWYWxpZGF0aW9uUGlwZScsICgpID0+IHtcclxuICAvLyBUZXN0IFNjaGVtYVxyXG4gIGNvbnN0IFRlc3RTY2hlbWEgPSB6Lm9iamVjdCh7XHJcbiAgICBlbWFpbDogei5zdHJpbmcoKS5lbWFpbCgnSW52YWxpZCBlbWFpbCBmb3JtYXQnKSxcclxuICAgIG5hbWU6IHouc3RyaW5nKCkubWluKDIsICdOYW1lIG11c3QgYmUgYXQgbGVhc3QgMiBjaGFyYWN0ZXJzJyksXHJcbiAgICBhZ2U6IHoubnVtYmVyKCkubWluKDAsICdBZ2UgbXVzdCBiZSBwb3NpdGl2ZScpLm9wdGlvbmFsKCksXHJcbiAgfSk7XHJcblxyXG4gIGxldCBwaXBlOiBab2RWYWxpZGF0aW9uUGlwZTx6LmluZmVyPHR5cGVvZiBUZXN0U2NoZW1hPj47XHJcblxyXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xyXG4gICAgcGlwZSA9IG5ldyBab2RWYWxpZGF0aW9uUGlwZShUZXN0U2NoZW1hKTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ3RyYW5zZm9ybScsICgpID0+IHtcclxuICAgIGRlc2NyaWJlKCd3aXRoIHZhbGlkIGRhdGEnLCAoKSA9PiB7XHJcbiAgICAgIGl0KCdzaG91bGQgcmV0dXJuIHBhcnNlZCBkYXRhIHdoZW4gYWxsIGZpZWxkcyBhcmUgdmFsaWQnLCAoKSA9PiB7XHJcbiAgICAgICAgLy8gQXJyYW5nZVxyXG4gICAgICAgIGNvbnN0IGlucHV0ID0ge1xyXG4gICAgICAgICAgZW1haWw6ICd0ZXN0QGV4YW1wbGUuY29tJyxcclxuICAgICAgICAgIG5hbWU6ICdKb2huJyxcclxuICAgICAgICAgIGFnZTogMjUsXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgLy8gQWN0XHJcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gcGlwZS50cmFuc2Zvcm0oaW5wdXQpO1xyXG5cclxuICAgICAgICAvLyBBc3NlcnRcclxuICAgICAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKGlucHV0KTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBpdCgnc2hvdWxkIHJldHVybiBwYXJzZWQgZGF0YSB3aXRoIG9wdGlvbmFsIGZpZWxkcyBvbWl0dGVkJywgKCkgPT4ge1xyXG4gICAgICAgIC8vIEFycmFuZ2VcclxuICAgICAgICBjb25zdCBpbnB1dCA9IHtcclxuICAgICAgICAgIGVtYWlsOiAndGVzdEBleGFtcGxlLmNvbScsXHJcbiAgICAgICAgICBuYW1lOiAnSm9obicsXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgLy8gQWN0XHJcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gcGlwZS50cmFuc2Zvcm0oaW5wdXQpO1xyXG5cclxuICAgICAgICAvLyBBc3NlcnRcclxuICAgICAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKGlucHV0KTtcclxuICAgICAgICBleHBlY3QocmVzdWx0KS5ub3QudG9IYXZlUHJvcGVydHkoJ2FnZScpO1xyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGl0KCdzaG91bGQgdHJhbnNmb3JtIGRhdGEgKGUuZy4sIHRyaW0gc3RyaW5ncykgaWYgc2NoZW1hIGRlZmluZXMgdHJhbnNmb3JtYXRpb25zJywgKCkgPT4ge1xyXG4gICAgICAgIC8vIEFycmFuZ2VcclxuICAgICAgICBjb25zdCBzY2hlbWFXaXRoVHJhbnNmb3JtID0gei5vYmplY3Qoe1xyXG4gICAgICAgICAgZW1haWw6IHpcclxuICAgICAgICAgICAgLnN0cmluZygpXHJcbiAgICAgICAgICAgIC5lbWFpbCgpXHJcbiAgICAgICAgICAgIC50cmFuc2Zvcm0oKHYpID0+IHYudG9Mb3dlckNhc2UoKSksXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgY29uc3QgcGlwZVdpdGhUcmFuc2Zvcm0gPSBuZXcgWm9kVmFsaWRhdGlvblBpcGUoc2NoZW1hV2l0aFRyYW5zZm9ybSk7XHJcbiAgICAgICAgY29uc3QgaW5wdXQgPSB7IGVtYWlsOiAnVEVTVEBFWEFNUExFLkNPTScgfTtcclxuXHJcbiAgICAgICAgLy8gQWN0XHJcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gcGlwZVdpdGhUcmFuc2Zvcm0udHJhbnNmb3JtKGlucHV0KTtcclxuXHJcbiAgICAgICAgLy8gQXNzZXJ0XHJcbiAgICAgICAgZXhwZWN0KHJlc3VsdC5lbWFpbCkudG9CZSgndGVzdEBleGFtcGxlLmNvbScpO1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG5cclxuICAgIGRlc2NyaWJlKCd3aXRoIGludmFsaWQgZGF0YScsICgpID0+IHtcclxuICAgICAgaXQoJ3Nob3VsZCB0aHJvdyBCYWRSZXF1ZXN0RXhjZXB0aW9uIGZvciBpbnZhbGlkIGVtYWlsJywgKCkgPT4ge1xyXG4gICAgICAgIC8vIEFycmFuZ2VcclxuICAgICAgICBjb25zdCBpbnB1dCA9IHtcclxuICAgICAgICAgIGVtYWlsOiAnbm90LWFuLWVtYWlsJyxcclxuICAgICAgICAgIG5hbWU6ICdKb2huJyxcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAvLyBBY3QgJiBBc3NlcnRcclxuICAgICAgICBleHBlY3QoKCkgPT4gcGlwZS50cmFuc2Zvcm0oaW5wdXQpKS50b1Rocm93KEJhZFJlcXVlc3RFeGNlcHRpb24pO1xyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGl0KCdzaG91bGQgdGhyb3cgQmFkUmVxdWVzdEV4Y2VwdGlvbiBmb3IgdG9vIHNob3J0IG5hbWUnLCAoKSA9PiB7XHJcbiAgICAgICAgLy8gQXJyYW5nZVxyXG4gICAgICAgIGNvbnN0IGlucHV0ID0ge1xyXG4gICAgICAgICAgZW1haWw6ICd0ZXN0QGV4YW1wbGUuY29tJyxcclxuICAgICAgICAgIG5hbWU6ICdKJywgLy8gdG9vIHNob3J0XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgLy8gQWN0ICYgQXNzZXJ0XHJcbiAgICAgICAgZXhwZWN0KCgpID0+IHBpcGUudHJhbnNmb3JtKGlucHV0KSkudG9UaHJvdyhCYWRSZXF1ZXN0RXhjZXB0aW9uKTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBpdCgnc2hvdWxkIGluY2x1ZGUgZmllbGQtc3BlY2lmaWMgZXJyb3JzIGluIGV4Y2VwdGlvbicsICgpID0+IHtcclxuICAgICAgICAvLyBBcnJhbmdlXHJcbiAgICAgICAgY29uc3QgaW5wdXQgPSB7XHJcbiAgICAgICAgICBlbWFpbDogJ2ludmFsaWQnLFxyXG4gICAgICAgICAgbmFtZTogJ0onLFxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIC8vIEFjdCAmIEFzc2VydFxyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICBwaXBlLnRyYW5zZm9ybShpbnB1dCk7XHJcbiAgICAgICAgICBmYWlsKCdTaG91bGQgaGF2ZSB0aHJvd24nKTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgZXhwZWN0KGVycm9yKS50b0JlSW5zdGFuY2VPZihCYWRSZXF1ZXN0RXhjZXB0aW9uKTtcclxuICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gKGVycm9yIGFzIEJhZFJlcXVlc3RFeGNlcHRpb24pLmdldFJlc3BvbnNlKCkgYXMge1xyXG4gICAgICAgICAgICBlcnJvcnM6IFJlY29yZDxzdHJpbmcsIHN0cmluZ1tdPjtcclxuICAgICAgICAgIH07XHJcbiAgICAgICAgICBleHBlY3QocmVzcG9uc2UuZXJyb3JzKS50b0hhdmVQcm9wZXJ0eSgnZW1haWwnKTtcclxuICAgICAgICAgIGV4cGVjdChyZXNwb25zZS5lcnJvcnMpLnRvSGF2ZVByb3BlcnR5KCduYW1lJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGl0KCdzaG91bGQgaW5jbHVkZSBlcnJvciBjb2RlIGluIGV4Y2VwdGlvbicsICgpID0+IHtcclxuICAgICAgICAvLyBBcnJhbmdlXHJcbiAgICAgICAgY29uc3QgaW5wdXQgPSB7IGVtYWlsOiAnaW52YWxpZCcsIG5hbWU6ICdKJyB9O1xyXG5cclxuICAgICAgICAvLyBBY3QgJiBBc3NlcnRcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgcGlwZS50cmFuc2Zvcm0oaW5wdXQpO1xyXG4gICAgICAgICAgZmFpbCgnU2hvdWxkIGhhdmUgdGhyb3duJyk7XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gKGVycm9yIGFzIEJhZFJlcXVlc3RFeGNlcHRpb24pLmdldFJlc3BvbnNlKCkgYXMge1xyXG4gICAgICAgICAgICBjb2RlOiBzdHJpbmc7XHJcbiAgICAgICAgICB9O1xyXG4gICAgICAgICAgZXhwZWN0KHJlc3BvbnNlLmNvZGUpLnRvQmUoJ1ZBTElEQVRJT05fRVJST1InKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgaXQoJ3Nob3VsZCBoYW5kbGUgbWlzc2luZyByZXF1aXJlZCBmaWVsZHMnLCAoKSA9PiB7XHJcbiAgICAgICAgLy8gQXJyYW5nZVxyXG4gICAgICAgIGNvbnN0IGlucHV0ID0ge307IC8vIG1pc3NpbmcgZW1haWwgYW5kIG5hbWVcclxuXHJcbiAgICAgICAgLy8gQWN0ICYgQXNzZXJ0XHJcbiAgICAgICAgZXhwZWN0KCgpID0+IHBpcGUudHJhbnNmb3JtKGlucHV0KSkudG9UaHJvdyhCYWRSZXF1ZXN0RXhjZXB0aW9uKTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBpdCgnc2hvdWxkIGhhbmRsZSB3cm9uZyB0eXBlcycsICgpID0+IHtcclxuICAgICAgICAvLyBBcnJhbmdlXHJcbiAgICAgICAgY29uc3QgaW5wdXQgPSB7XHJcbiAgICAgICAgICBlbWFpbDogMTIzLCAvLyBzaG91bGQgYmUgc3RyaW5nXHJcbiAgICAgICAgICBuYW1lOiAnSm9obicsXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgLy8gQWN0ICYgQXNzZXJ0XHJcbiAgICAgICAgZXhwZWN0KCgpID0+IHBpcGUudHJhbnNmb3JtKGlucHV0KSkudG9UaHJvdyhCYWRSZXF1ZXN0RXhjZXB0aW9uKTtcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBkZXNjcmliZSgnZXJyb3IgbWVzc2FnZSBmb3JtYXR0aW5nJywgKCkgPT4ge1xyXG4gICAgICBpdCgnc2hvdWxkIGZvcm1hdCBuZXN0ZWQgcGF0aCBlcnJvcnMgY29ycmVjdGx5JywgKCkgPT4ge1xyXG4gICAgICAgIC8vIEFycmFuZ2VcclxuICAgICAgICBjb25zdCBuZXN0ZWRTY2hlbWEgPSB6Lm9iamVjdCh7XHJcbiAgICAgICAgICB1c2VyOiB6Lm9iamVjdCh7XHJcbiAgICAgICAgICAgIGVtYWlsOiB6LnN0cmluZygpLmVtYWlsKCksXHJcbiAgICAgICAgICB9KSxcclxuICAgICAgICB9KTtcclxuICAgICAgICBjb25zdCBuZXN0ZWRQaXBlID0gbmV3IFpvZFZhbGlkYXRpb25QaXBlKG5lc3RlZFNjaGVtYSk7XHJcbiAgICAgICAgY29uc3QgaW5wdXQgPSB7IHVzZXI6IHsgZW1haWw6ICdpbnZhbGlkJyB9IH07XHJcblxyXG4gICAgICAgIC8vIEFjdCAmIEFzc2VydFxyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICBuZXN0ZWRQaXBlLnRyYW5zZm9ybShpbnB1dCk7XHJcbiAgICAgICAgICBmYWlsKCdTaG91bGQgaGF2ZSB0aHJvd24nKTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSAoZXJyb3IgYXMgQmFkUmVxdWVzdEV4Y2VwdGlvbikuZ2V0UmVzcG9uc2UoKSBhcyB7XHJcbiAgICAgICAgICAgIGVycm9yczogUmVjb3JkPHN0cmluZywgc3RyaW5nW10+O1xyXG4gICAgICAgICAgfTtcclxuICAgICAgICAgIGV4cGVjdChyZXNwb25zZS5lcnJvcnNbJ3VzZXIuZW1haWwnXSkudG9CZURlZmluZWQoKTtcclxuICAgICAgICAgIGV4cGVjdChyZXNwb25zZS5lcnJvcnNbJ3VzZXIuZW1haWwnXSkudG9Db250YWluKFxyXG4gICAgICAgICAgICAnSW52YWxpZCBlbWFpbCBhZGRyZXNzJyxcclxuICAgICAgICAgICk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG59KTtcclxuIl0sInZlcnNpb24iOjN9