{"file":"C:\\Users\\timur\\Programming\\Projects\\snippetforge\\apps\\api\\test\\unit\\pipes\\zod-validation.pipe.spec.ts","mappings":"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","names":[],"sources":["C:\\Users\\timur\\Programming\\Projects\\snippetforge\\apps\\api\\test\\unit\\pipes\\zod-validation.pipe.spec.ts"],"sourcesContent":["// test/unit/pipes/zod-validation.pipe.spec.ts\r\n\r\nimport { BadRequestException } from '@nestjs/common';\r\nimport { z } from 'zod';\r\nimport { ZodValidationPipe } from '../../../src/shared/pipes/zod-validation.pipe';\r\n\r\n/**\r\n * ZodValidationPipe Unit Tests\r\n *\r\n * Testet:\r\n * - Valide Daten werden transformiert\r\n * - Invalide Daten werfen BadRequestException\r\n * - Error-Format ist korrekt\r\n */\r\ndescribe('ZodValidationPipe', () => {\r\n  // Test Schema\r\n  const TestSchema = z.object({\r\n    email: z.string().email('Invalid email format'),\r\n    name: z.string().min(2, 'Name must be at least 2 characters'),\r\n    age: z.number().min(0, 'Age must be positive').optional(),\r\n  });\r\n\r\n  let pipe: ZodValidationPipe<z.infer<typeof TestSchema>>;\r\n\r\n  beforeEach(() => {\r\n    pipe = new ZodValidationPipe(TestSchema);\r\n  });\r\n\r\n  describe('transform', () => {\r\n    describe('with valid data', () => {\r\n      it('should return parsed data when all fields are valid', () => {\r\n        // Arrange\r\n        const input = {\r\n          email: 'test@example.com',\r\n          name: 'John',\r\n          age: 25,\r\n        };\r\n\r\n        // Act\r\n        const result = pipe.transform(input);\r\n\r\n        // Assert\r\n        expect(result).toEqual(input);\r\n      });\r\n\r\n      it('should return parsed data with optional fields omitted', () => {\r\n        // Arrange\r\n        const input = {\r\n          email: 'test@example.com',\r\n          name: 'John',\r\n        };\r\n\r\n        // Act\r\n        const result = pipe.transform(input);\r\n\r\n        // Assert\r\n        expect(result).toEqual(input);\r\n        expect(result).not.toHaveProperty('age');\r\n      });\r\n\r\n      it('should transform data (e.g., trim strings) if schema defines transformations', () => {\r\n        // Arrange\r\n        const schemaWithTransform = z.object({\r\n          email: z\r\n            .string()\r\n            .email()\r\n            .transform((v) => v.toLowerCase()),\r\n        });\r\n        const pipeWithTransform = new ZodValidationPipe(schemaWithTransform);\r\n        const input = { email: 'TEST@EXAMPLE.COM' };\r\n\r\n        // Act\r\n        const result = pipeWithTransform.transform(input);\r\n\r\n        // Assert\r\n        expect(result.email).toBe('test@example.com');\r\n      });\r\n    });\r\n\r\n    describe('with invalid data', () => {\r\n      it('should throw BadRequestException for invalid email', () => {\r\n        // Arrange\r\n        const input = {\r\n          email: 'not-an-email',\r\n          name: 'John',\r\n        };\r\n\r\n        // Act & Assert\r\n        expect(() => pipe.transform(input)).toThrow(BadRequestException);\r\n      });\r\n\r\n      it('should throw BadRequestException for too short name', () => {\r\n        // Arrange\r\n        const input = {\r\n          email: 'test@example.com',\r\n          name: 'J', // too short\r\n        };\r\n\r\n        // Act & Assert\r\n        expect(() => pipe.transform(input)).toThrow(BadRequestException);\r\n      });\r\n\r\n      it('should include field-specific errors in exception', () => {\r\n        // Arrange\r\n        const input = {\r\n          email: 'invalid',\r\n          name: 'J',\r\n        };\r\n\r\n        // Act & Assert\r\n        try {\r\n          pipe.transform(input);\r\n          fail('Should have thrown');\r\n        } catch (error) {\r\n          expect(error).toBeInstanceOf(BadRequestException);\r\n          const response = (error as BadRequestException).getResponse() as {\r\n            errors: Record<string, string[]>;\r\n          };\r\n          expect(response.errors).toHaveProperty('email');\r\n          expect(response.errors).toHaveProperty('name');\r\n        }\r\n      });\r\n\r\n      it('should include error code in exception', () => {\r\n        // Arrange\r\n        const input = { email: 'invalid', name: 'J' };\r\n\r\n        // Act & Assert\r\n        try {\r\n          pipe.transform(input);\r\n          fail('Should have thrown');\r\n        } catch (error) {\r\n          const response = (error as BadRequestException).getResponse() as {\r\n            code: string;\r\n          };\r\n          expect(response.code).toBe('VALIDATION_ERROR');\r\n        }\r\n      });\r\n\r\n      it('should handle missing required fields', () => {\r\n        // Arrange\r\n        const input = {}; // missing email and name\r\n\r\n        // Act & Assert\r\n        expect(() => pipe.transform(input)).toThrow(BadRequestException);\r\n      });\r\n\r\n      it('should handle wrong types', () => {\r\n        // Arrange\r\n        const input = {\r\n          email: 123, // should be string\r\n          name: 'John',\r\n        };\r\n\r\n        // Act & Assert\r\n        expect(() => pipe.transform(input)).toThrow(BadRequestException);\r\n      });\r\n    });\r\n\r\n    describe('error message formatting', () => {\r\n      it('should format nested path errors correctly', () => {\r\n        // Arrange\r\n        const nestedSchema = z.object({\r\n          user: z.object({\r\n            email: z.string().email(),\r\n          }),\r\n        });\r\n        const nestedPipe = new ZodValidationPipe(nestedSchema);\r\n        const input = { user: { email: 'invalid' } };\r\n\r\n        // Act & Assert\r\n        try {\r\n          nestedPipe.transform(input);\r\n          fail('Should have thrown');\r\n        } catch (error) {\r\n          const response = (error as BadRequestException).getResponse() as {\r\n            errors: Record<string, string[]>;\r\n          };\r\n          expect(response.errors['user.email']).toBeDefined();\r\n          expect(response.errors['user.email']).toContain(\r\n            'Invalid email address',\r\n          );\r\n        }\r\n      });\r\n\r\n      it('should rethrow non-ZodError errors', () => {\r\n        // Arrange - Create a schema that throws a non-ZodError\r\n        const errorSchema = z.string().transform(() => {\r\n          throw new Error('Custom transform error');\r\n        });\r\n        const errorPipe = new ZodValidationPipe(errorSchema);\r\n\r\n        // Act & Assert\r\n        expect(() => errorPipe.transform('test')).toThrow(\r\n          'Custom transform error',\r\n        );\r\n      });\r\n\r\n      it('should map root-level issues to _root path', () => {\r\n        // Arrange\r\n        const rootSchema = z.object({}).superRefine((_, ctx) => {\r\n          ctx.addIssue({\r\n            code: z.ZodIssueCode.custom,\r\n            message: 'Root level error',\r\n            path: [],\r\n          });\r\n        });\r\n        const rootPipe = new ZodValidationPipe(rootSchema);\r\n\r\n        // Act & Assert\r\n        try {\r\n          rootPipe.transform({});\r\n          fail('Should have thrown');\r\n        } catch (error) {\r\n          const response = (error as BadRequestException).getResponse() as {\r\n            errors: Record<string, string[]>;\r\n          };\r\n          expect(response.errors._root).toContain('Root level error');\r\n        }\r\n      });\r\n\r\n      it('should aggregate multiple issues for the same field', () => {\r\n        // Arrange\r\n        const multiIssueSchema = z.object({\r\n          code: z.string().superRefine((_, ctx) => {\r\n            ctx.addIssue({\r\n              code: z.ZodIssueCode.custom,\r\n              message: 'First issue',\r\n              path: ['code'],\r\n            });\r\n            ctx.addIssue({\r\n              code: z.ZodIssueCode.custom,\r\n              message: 'Second issue',\r\n              path: ['code'],\r\n            });\r\n          }),\r\n        });\r\n        const multiIssuePipe = new ZodValidationPipe(multiIssueSchema);\r\n\r\n        // Act & Assert\r\n        try {\r\n          multiIssuePipe.transform({ code: 'ABC' });\r\n          fail('Should have thrown');\r\n        } catch (error) {\r\n          const response = (error as BadRequestException).getResponse() as {\r\n            errors: Record<string, string[]>;\r\n          };\r\n          expect(response.errors.code).toEqual(['First issue', 'Second issue']);\r\n        }\r\n      });\r\n    });\r\n  });\r\n});\r\n"],"version":3}