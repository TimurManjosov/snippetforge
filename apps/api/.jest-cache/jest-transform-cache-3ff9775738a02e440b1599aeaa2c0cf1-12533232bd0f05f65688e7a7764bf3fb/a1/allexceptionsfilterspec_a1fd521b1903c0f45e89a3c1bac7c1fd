6daf63122012fe119a357a4312789b13
"use strict";
/* eslint-disable @typescript-eslint/no-unsafe-member-access */
/* eslint-disable @typescript-eslint/no-unsafe-assignment */
// test/unit/filters/all-exceptions. filter.spec.ts
Object.defineProperty(exports, "__esModule", { value: true });
const common_1 = require("@nestjs/common");
const constants_1 = require("../../../src/shared/constants");
const all_exceptions_filter_1 = require("../../../src/shared/filters/all-exceptions.filter");
const test_utils_1 = require("../../setup/test-utils");
/**
 * AllExceptionsFilter Unit Tests
 *
 * Testet:
 * - Unbekannte Errors werden gefangen
 * - Sensitive Daten werden gefiltert
 * - Response Format ist korrekt
 */
describe('AllExceptionsFilter', () => {
    let filter;
    let mockResponse;
    let mockRequest;
    const originalEnv = process.env.NODE_ENV;
    beforeEach(() => {
        filter = new all_exceptions_filter_1.AllExceptionsFilter();
        mockResponse = (0, test_utils_1.createMockResponse)();
        mockRequest = (0, test_utils_1.createMockRequest)();
    });
    afterEach(() => {
        jest.clearAllMocks();
        process.env.NODE_ENV = originalEnv;
    });
    describe('catch', () => {
        describe('response format', () => {
            it('should return 500 for unknown errors', () => {
                // Arrange
                const exception = new Error('Something went wrong');
                const host = (0, test_utils_1.createMockArgumentsHost)(mockRequest, mockResponse);
                // Act
                filter.catch(exception, host);
                // Assert
                expect(mockResponse.status).toHaveBeenCalledWith(common_1.HttpStatus.INTERNAL_SERVER_ERROR);
            });
            it('should return standardized error response', () => {
                // Arrange
                const exception = new Error('Database connection failed');
                const host = (0, test_utils_1.createMockArgumentsHost)(mockRequest, mockResponse);
                // Act
                filter.catch(exception, host);
                // Assert
                expect(mockResponse.json).toHaveBeenCalledWith(expect.objectContaining({
                    success: false,
                    error: expect.objectContaining({
                        code: expect.any(String),
                        message: expect.any(String),
                        statusCode: 500,
                    }),
                    meta: expect.objectContaining({
                        path: mockRequest.url,
                        method: mockRequest.method,
                        timestamp: expect.any(String),
                    }),
                }));
            });
            it('should handle HttpExceptions with matching status', () => {
                // Arrange
                const exception = new common_1.HttpException('Http path', common_1.HttpStatus.BAD_REQUEST);
                const host = (0, test_utils_1.createMockArgumentsHost)(mockRequest, mockResponse);
                // Act
                filter.catch(exception, host);
                // Assert
                expect(mockResponse.status).toHaveBeenCalledWith(common_1.HttpStatus.BAD_REQUEST);
                expect(mockResponse.json).toHaveBeenCalledWith(expect.objectContaining({
                    error: expect.objectContaining({
                        code: constants_1.ErrorCodes.SERVER_ERROR,
                        message: 'Http path',
                        statusCode: common_1.HttpStatus.BAD_REQUEST,
                    }),
                }));
            });
            it('should propagate correlation ids into the meta block', () => {
                // Arrange
                const requestWithCorrelation = (0, test_utils_1.createMockRequest)({
                    headers: { 'x-correlation-id': 'corr-123' },
                });
                const exception = new Error('Correlation test');
                const host = (0, test_utils_1.createMockArgumentsHost)(requestWithCorrelation, mockResponse);
                // Act
                filter.catch(exception, host);
                // Assert
                const jsonCall = mockResponse.json.mock.calls[0][0];
                expect(jsonCall.meta.requestId).toBe('corr-123');
            });
        });
        describe('error type identification', () => {
            it('should identify JWT errors as AUTH_TOKEN_INVALID', () => {
                // Arrange
                const exception = new Error('invalid signature');
                exception.name = 'JsonWebTokenError';
                const host = (0, test_utils_1.createMockArgumentsHost)(mockRequest, mockResponse);
                // Act
                filter.catch(exception, host);
                // Assert
                expect(mockResponse.json).toHaveBeenCalledWith(expect.objectContaining({
                    error: expect.objectContaining({
                        code: constants_1.ErrorCodes.AUTH_TOKEN_INVALID,
                    }),
                }));
            });
            it('should identify expired JWT as AUTH_TOKEN_EXPIRED', () => {
                // Arrange
                const exception = new Error('jwt expired');
                exception.name = 'TokenExpiredError';
                const host = (0, test_utils_1.createMockArgumentsHost)(mockRequest, mockResponse);
                // Act
                filter.catch(exception, host);
                // Assert
                expect(mockResponse.json).toHaveBeenCalledWith(expect.objectContaining({
                    error: expect.objectContaining({
                        code: constants_1.ErrorCodes.AUTH_TOKEN_EXPIRED,
                    }),
                }));
            });
            it('should identify database errors', () => {
                // Arrange
                const exception = new Error('ECONNREFUSED database connection');
                const host = (0, test_utils_1.createMockArgumentsHost)(mockRequest, mockResponse);
                // Act
                filter.catch(exception, host);
                // Assert
                expect(mockResponse.json).toHaveBeenCalledWith(expect.objectContaining({
                    error: expect.objectContaining({
                        code: constants_1.ErrorCodes.SERVER_DATABASE_ERROR,
                    }),
                }));
            });
        });
        describe('message sanitization', () => {
            describe('in production', () => {
                beforeEach(() => {
                    process.env.NODE_ENV = 'production';
                    // Filter neu erstellen mit production env
                    filter = new all_exceptions_filter_1.AllExceptionsFilter();
                });
                it('should not expose internal error messages', () => {
                    // Arrange
                    const exception = new Error('Database password:  secret123');
                    const host = (0, test_utils_1.createMockArgumentsHost)(mockRequest, mockResponse);
                    // Act
                    filter.catch(exception, host);
                    // Assert
                    expect(mockResponse.json).toHaveBeenCalledWith(expect.objectContaining({
                        error: expect.objectContaining({
                            message: expect.not.stringContaining('secret123'),
                        }),
                    }));
                });
                it('should return generic message in production', () => {
                    // Arrange
                    const exception = new Error('Internal implementation details');
                    const host = (0, test_utils_1.createMockArgumentsHost)(mockRequest, mockResponse);
                    // Act
                    filter.catch(exception, host);
                    // Assert
                    expect(mockResponse.json).toHaveBeenCalledWith(expect.objectContaining({
                        error: expect.objectContaining({
                            message: 'An unexpected error occurred. Please try again later.',
                        }),
                    }));
                });
            });
            describe('in development', () => {
                beforeEach(() => {
                    process.env.NODE_ENV = 'development';
                    filter = new all_exceptions_filter_1.AllExceptionsFilter();
                });
                it('should include sanitized error message', () => {
                    // Arrange
                    const exception = new Error('Something went wrong');
                    const host = (0, test_utils_1.createMockArgumentsHost)(mockRequest, mockResponse);
                    // Act
                    filter.catch(exception, host);
                    // Assert
                    expect(mockResponse.json).toHaveBeenCalledWith(expect.objectContaining({
                        error: expect.objectContaining({
                            message: expect.any(String),
                        }),
                    }));
                });
                it('should redact file paths from error message', () => {
                    // Arrange
                    const exception = new Error('Error at C:\\Users\\dev\\project\\src\\file.ts: 123');
                    const host = (0, test_utils_1.createMockArgumentsHost)(mockRequest, mockResponse);
                    // Act
                    filter.catch(exception, host);
                    // Assert
                    const jsonCall = mockResponse.json.mock.calls[0][0];
                    expect(jsonCall.error.message).not.toContain('C:\\Users');
                });
            });
        });
        describe('non-Error exceptions', () => {
            it('should handle string throws', () => {
                // Arrange
                const exception = 'Something went wrong';
                const host = (0, test_utils_1.createMockArgumentsHost)(mockRequest, mockResponse);
                // Act
                filter.catch(exception, host);
                // Assert
                expect(mockResponse.status).toHaveBeenCalledWith(500);
                expect(mockResponse.json).toHaveBeenCalled();
            });
            it('should handle object throws', () => {
                // Arrange
                const exception = { error: 'Custom error object' };
                const host = (0, test_utils_1.createMockArgumentsHost)(mockRequest, mockResponse);
                // Act
                filter.catch(exception, host);
                // Assert
                expect(mockResponse.status).toHaveBeenCalledWith(500);
            });
            it('should handle null/undefined throws', () => {
                // Arrange
                const host = (0, test_utils_1.createMockArgumentsHost)(mockRequest, mockResponse);
                // Act
                filter.catch(null, host);
                // Assert
                expect(mockResponse.status).toHaveBeenCalledWith(500);
            });
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFx0aW11clxcUHJvZ3JhbW1pbmdcXFByb2plY3RzXFxzbmlwcGV0Zm9yZ2VcXGFwcHNcXGFwaVxcdGVzdFxcdW5pdFxcZmlsdGVyc1xcYWxsLWV4Y2VwdGlvbnMuZmlsdGVyLnNwZWMudHMiLCJtYXBwaW5ncyI6IjtBQUFBLCtEQUErRDtBQUMvRCw0REFBNEQ7QUFDNUQsbURBQW1EOztBQUVuRCwyQ0FBMkQ7QUFDM0QsNkRBQTJEO0FBQzNELDZGQUF3RjtBQUN4Rix1REFJZ0M7QUFFaEM7Ozs7Ozs7R0FPRztBQUNILFFBQVEsQ0FBQyxxQkFBcUIsRUFBRSxHQUFHLEVBQUU7SUFDbkMsSUFBSSxNQUEyQixDQUFDO0lBQ2hDLElBQUksWUFBbUQsQ0FBQztJQUN4RCxJQUFJLFdBQWlELENBQUM7SUFDdEQsTUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUM7SUFFekMsVUFBVSxDQUFDLEdBQUcsRUFBRTtRQUNkLE1BQU0sR0FBRyxJQUFJLDJDQUFtQixFQUFFLENBQUM7UUFDbkMsWUFBWSxHQUFHLElBQUEsK0JBQWtCLEdBQUUsQ0FBQztRQUNwQyxXQUFXLEdBQUcsSUFBQSw4QkFBaUIsR0FBRSxDQUFDO0lBQ3BDLENBQUMsQ0FBQyxDQUFDO0lBRUgsU0FBUyxDQUFDLEdBQUcsRUFBRTtRQUNiLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUNyQixPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsR0FBRyxXQUFXLENBQUM7SUFDckMsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsT0FBTyxFQUFFLEdBQUcsRUFBRTtRQUNyQixRQUFRLENBQUMsaUJBQWlCLEVBQUUsR0FBRyxFQUFFO1lBQy9CLEVBQUUsQ0FBQyxzQ0FBc0MsRUFBRSxHQUFHLEVBQUU7Z0JBQzlDLFVBQVU7Z0JBQ1YsTUFBTSxTQUFTLEdBQUcsSUFBSSxLQUFLLENBQUMsc0JBQXNCLENBQUMsQ0FBQztnQkFDcEQsTUFBTSxJQUFJLEdBQUcsSUFBQSxvQ0FBdUIsRUFBQyxX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RCxNQUFNLElBQUksR0FBRyxJQUFBLG9DQUF1QixFQUFDLFdBQVcsRUFBRSxZQUFZLENBQUMsQ0FBQztnQkFFaEUsTUFBTTtnQkFDTixNQUFNLENBQUMsS0FBSyxDQUFDLFNBQVMsRUFBRSxJQUFXLENBQUMsQ0FBQztnQkFFckMsU0FBUztnQkFDVCxNQUFNLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDLG9CQUFvQixDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3hELENBQUMsQ0FBQyxDQUFDO1lBRUgsRUFBRSxDQUFDLHFDQUFxQyxFQUFFLEdBQUcsRUFBRTtnQkFDN0MsVUFBVTtnQkFDVixNQUFNLElBQUksR0FBRyxJQUFBLG9DQUF1QixFQUFDLFdBQVcsRUFBRSxZQUFZLENBQUMsQ0FBQztnQkFFaEUsTUFBTTtnQkFDTixNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxJQUFXLENBQUMsQ0FBQztnQkFFaEMsU0FBUztnQkFDVCxNQUFNLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDLG9CQUFvQixDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3hELENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcdGltdXJcXFByb2dyYW1taW5nXFxQcm9qZWN0c1xcc25pcHBldGZvcmdlXFxhcHBzXFxhcGlcXHRlc3RcXHVuaXRcXGZpbHRlcnNcXGFsbC1leGNlcHRpb25zLmZpbHRlci5zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIEB0eXBlc2NyaXB0LWVzbGludC9uby11bnNhZmUtbWVtYmVyLWFjY2VzcyAqL1xyXG4vKiBlc2xpbnQtZGlzYWJsZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdW5zYWZlLWFzc2lnbm1lbnQgKi9cclxuLy8gdGVzdC91bml0L2ZpbHRlcnMvYWxsLWV4Y2VwdGlvbnMuIGZpbHRlci5zcGVjLnRzXHJcblxyXG5pbXBvcnQgeyBIdHRwRXhjZXB0aW9uLCBIdHRwU3RhdHVzIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xyXG5pbXBvcnQgeyBFcnJvckNvZGVzIH0gZnJvbSAnLi4vLi4vLi4vc3JjL3NoYXJlZC9jb25zdGFudHMnO1xyXG5pbXBvcnQgeyBBbGxFeGNlcHRpb25zRmlsdGVyIH0gZnJvbSAnLi4vLi4vLi4vc3JjL3NoYXJlZC9maWx0ZXJzL2FsbC1leGNlcHRpb25zLmZpbHRlcic7XHJcbmltcG9ydCB7XHJcbiAgY3JlYXRlTW9ja0FyZ3VtZW50c0hvc3QsXHJcbiAgY3JlYXRlTW9ja1JlcXVlc3QsXHJcbiAgY3JlYXRlTW9ja1Jlc3BvbnNlLFxyXG59IGZyb20gJy4uLy4uL3NldHVwL3Rlc3QtdXRpbHMnO1xyXG5cclxuLyoqXHJcbiAqIEFsbEV4Y2VwdGlvbnNGaWx0ZXIgVW5pdCBUZXN0c1xyXG4gKlxyXG4gKiBUZXN0ZXQ6XHJcbiAqIC0gVW5iZWthbm50ZSBFcnJvcnMgd2VyZGVuIGdlZmFuZ2VuXHJcbiAqIC0gU2Vuc2l0aXZlIERhdGVuIHdlcmRlbiBnZWZpbHRlcnRcclxuICogLSBSZXNwb25zZSBGb3JtYXQgaXN0IGtvcnJla3RcclxuICovXHJcbmRlc2NyaWJlKCdBbGxFeGNlcHRpb25zRmlsdGVyJywgKCkgPT4ge1xyXG4gIGxldCBmaWx0ZXI6IEFsbEV4Y2VwdGlvbnNGaWx0ZXI7XHJcbiAgbGV0IG1vY2tSZXNwb25zZTogUmV0dXJuVHlwZTx0eXBlb2YgY3JlYXRlTW9ja1Jlc3BvbnNlPjtcclxuICBsZXQgbW9ja1JlcXVlc3Q6IFJldHVyblR5cGU8dHlwZW9mIGNyZWF0ZU1vY2tSZXF1ZXN0PjtcclxuICBjb25zdCBvcmlnaW5hbEVudiA9IHByb2Nlc3MuZW52Lk5PREVfRU5WO1xyXG5cclxuICBiZWZvcmVFYWNoKCgpID0+IHtcclxuICAgIGZpbHRlciA9IG5ldyBBbGxFeGNlcHRpb25zRmlsdGVyKCk7XHJcbiAgICBtb2NrUmVzcG9uc2UgPSBjcmVhdGVNb2NrUmVzcG9uc2UoKTtcclxuICAgIG1vY2tSZXF1ZXN0ID0gY3JlYXRlTW9ja1JlcXVlc3QoKTtcclxuICB9KTtcclxuXHJcbiAgYWZ0ZXJFYWNoKCgpID0+IHtcclxuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpO1xyXG4gICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgPSBvcmlnaW5hbEVudjtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ2NhdGNoJywgKCkgPT4ge1xyXG4gICAgZGVzY3JpYmUoJ3Jlc3BvbnNlIGZvcm1hdCcsICgpID0+IHtcclxuICAgICAgaXQoJ3Nob3VsZCByZXR1cm4gNTAwIGZvciB1bmtub3duIGVycm9ycycsICgpID0+IHtcclxuICAgICAgICAvLyBBcnJhbmdlXHJcbiAgICAgICAgY29uc3QgZXhjZXB0aW9uID0gbmV3IEVycm9yKCdTb21ldGhpbmcgd2VudCB3cm9uZycpO1xyXG4gICAgICAgIGNvbnN0IGhvc3QgPSBjcmVhdGVNb2NrQXJndW1lbnRzSG9zdChtb2NrUmVxdWVzdCwgbW9ja1Jlc3BvbnNlKTtcclxuXHJcbiAgICAgICAgLy8gQWN0XHJcbiAgICAgICAgZmlsdGVyLmNhdGNoKGV4Y2VwdGlvbiwgaG9zdCBhcyBhbnkpO1xyXG5cclxuICAgICAgICAvLyBBc3NlcnRcclxuICAgICAgICBleHBlY3QobW9ja1Jlc3BvbnNlLnN0YXR1cykudG9IYXZlQmVlbkNhbGxlZFdpdGgoXHJcbiAgICAgICAgICBIdHRwU3RhdHVzLklOVEVSTkFMX1NFUlZFUl9FUlJPUixcclxuICAgICAgICApO1xyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGl0KCdzaG91bGQgcmV0dXJuIHN0YW5kYXJkaXplZCBlcnJvciByZXNwb25zZScsICgpID0+IHtcclxuICAgICAgICAvLyBBcnJhbmdlXHJcbiAgICAgICAgY29uc3QgZXhjZXB0aW9uID0gbmV3IEVycm9yKCdEYXRhYmFzZSBjb25uZWN0aW9uIGZhaWxlZCcpO1xyXG4gICAgICAgIGNvbnN0IGhvc3QgPSBjcmVhdGVNb2NrQXJndW1lbnRzSG9zdChtb2NrUmVxdWVzdCwgbW9ja1Jlc3BvbnNlKTtcclxuXHJcbiAgICAgICAgLy8gQWN0XHJcbiAgICAgICAgZmlsdGVyLmNhdGNoKGV4Y2VwdGlvbiwgaG9zdCBhcyBhbnkpO1xyXG5cclxuICAgICAgICAvLyBBc3NlcnRcclxuICAgICAgICBleHBlY3QobW9ja1Jlc3BvbnNlLmpzb24pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxyXG4gICAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xyXG4gICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgICAgICAgZXJyb3I6IGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcclxuICAgICAgICAgICAgICBjb2RlOiBleHBlY3QuYW55KFN0cmluZyksXHJcbiAgICAgICAgICAgICAgbWVzc2FnZTogZXhwZWN0LmFueShTdHJpbmcpLFxyXG4gICAgICAgICAgICAgIHN0YXR1c0NvZGU6IDUwMCxcclxuICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgIG1ldGE6IGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcclxuICAgICAgICAgICAgICBwYXRoOiBtb2NrUmVxdWVzdC51cmwsXHJcbiAgICAgICAgICAgICAgbWV0aG9kOiBtb2NrUmVxdWVzdC5tZXRob2QsXHJcbiAgICAgICAgICAgICAgdGltZXN0YW1wOiBleHBlY3QuYW55KFN0cmluZyksXHJcbiAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgfSksXHJcbiAgICAgICAgKTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBpdCgnc2hvdWxkIGhhbmRsZSBIdHRwRXhjZXB0aW9ucyB3aXRoIG1hdGNoaW5nIHN0YXR1cycsICgpID0+IHtcclxuICAgICAgICAvLyBBcnJhbmdlXHJcbiAgICAgICAgY29uc3QgZXhjZXB0aW9uID0gbmV3IEh0dHBFeGNlcHRpb24oXHJcbiAgICAgICAgICAnSHR0cCBwYXRoJyxcclxuICAgICAgICAgIEh0dHBTdGF0dXMuQkFEX1JFUVVFU1QsXHJcbiAgICAgICAgKTtcclxuICAgICAgICBjb25zdCBob3N0ID0gY3JlYXRlTW9ja0FyZ3VtZW50c0hvc3QobW9ja1JlcXVlc3QsIG1vY2tSZXNwb25zZSk7XHJcblxyXG4gICAgICAgIC8vIEFjdFxyXG4gICAgICAgIGZpbHRlci5jYXRjaChleGNlcHRpb24sIGhvc3QgYXMgYW55KTtcclxuXHJcbiAgICAgICAgLy8gQXNzZXJ0XHJcbiAgICAgICAgZXhwZWN0KG1vY2tSZXNwb25zZS5zdGF0dXMpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxyXG4gICAgICAgICAgSHR0cFN0YXR1cy5CQURfUkVRVUVTVCxcclxuICAgICAgICApO1xyXG4gICAgICAgIGV4cGVjdChtb2NrUmVzcG9uc2UuanNvbikudG9IYXZlQmVlbkNhbGxlZFdpdGgoXHJcbiAgICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XHJcbiAgICAgICAgICAgIGVycm9yOiBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XHJcbiAgICAgICAgICAgICAgY29kZTogRXJyb3JDb2Rlcy5TRVJWRVJfRVJST1IsXHJcbiAgICAgICAgICAgICAgbWVzc2FnZTogJ0h0dHAgcGF0aCcsXHJcbiAgICAgICAgICAgICAgc3RhdHVzQ29kZTogSHR0cFN0YXR1cy5CQURfUkVRVUVTVCxcclxuICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICB9KSxcclxuICAgICAgICApO1xyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGl0KCdzaG91bGQgcHJvcGFnYXRlIGNvcnJlbGF0aW9uIGlkcyBpbnRvIHRoZSBtZXRhIGJsb2NrJywgKCkgPT4ge1xyXG4gICAgICAgIC8vIEFycmFuZ2VcclxuICAgICAgICBjb25zdCByZXF1ZXN0V2l0aENvcnJlbGF0aW9uID0gY3JlYXRlTW9ja1JlcXVlc3Qoe1xyXG4gICAgICAgICAgaGVhZGVyczogeyAneC1jb3JyZWxhdGlvbi1pZCc6ICdjb3JyLTEyMycgfSxcclxuICAgICAgICB9KTtcclxuICAgICAgICBjb25zdCBleGNlcHRpb24gPSBuZXcgRXJyb3IoJ0NvcnJlbGF0aW9uIHRlc3QnKTtcclxuICAgICAgICBjb25zdCBob3N0ID0gY3JlYXRlTW9ja0FyZ3VtZW50c0hvc3QoXHJcbiAgICAgICAgICByZXF1ZXN0V2l0aENvcnJlbGF0aW9uLFxyXG4gICAgICAgICAgbW9ja1Jlc3BvbnNlLFxyXG4gICAgICAgICk7XHJcblxyXG4gICAgICAgIC8vIEFjdFxyXG4gICAgICAgIGZpbHRlci5jYXRjaChleGNlcHRpb24sIGhvc3QgYXMgYW55KTtcclxuXHJcbiAgICAgICAgLy8gQXNzZXJ0XHJcbiAgICAgICAgY29uc3QganNvbkNhbGwgPSBtb2NrUmVzcG9uc2UuanNvbi5tb2NrLmNhbGxzWzBdWzBdO1xyXG4gICAgICAgIGV4cGVjdChqc29uQ2FsbC5tZXRhLnJlcXVlc3RJZCkudG9CZSgnY29yci0xMjMnKTtcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBkZXNjcmliZSgnZXJyb3IgdHlwZSBpZGVudGlmaWNhdGlvbicsICgpID0+IHtcclxuICAgICAgaXQoJ3Nob3VsZCBpZGVudGlmeSBKV1QgZXJyb3JzIGFzIEFVVEhfVE9LRU5fSU5WQUxJRCcsICgpID0+IHtcclxuICAgICAgICAvLyBBcnJhbmdlXHJcbiAgICAgICAgY29uc3QgZXhjZXB0aW9uID0gbmV3IEVycm9yKCdpbnZhbGlkIHNpZ25hdHVyZScpO1xyXG4gICAgICAgIGV4Y2VwdGlvbi5uYW1lID0gJ0pzb25XZWJUb2tlbkVycm9yJztcclxuICAgICAgICBjb25zdCBob3N0ID0gY3JlYXRlTW9ja0FyZ3VtZW50c0hvc3QobW9ja1JlcXVlc3QsIG1vY2tSZXNwb25zZSk7XHJcblxyXG4gICAgICAgIC8vIEFjdFxyXG4gICAgICAgIGZpbHRlci5jYXRjaChleGNlcHRpb24sIGhvc3QgYXMgYW55KTtcclxuXHJcbiAgICAgICAgLy8gQXNzZXJ0XHJcbiAgICAgICAgZXhwZWN0KG1vY2tSZXNwb25zZS5qc29uKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcclxuICAgICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcclxuICAgICAgICAgICAgZXJyb3I6IGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcclxuICAgICAgICAgICAgICBjb2RlOiBFcnJvckNvZGVzLkFVVEhfVE9LRU5fSU5WQUxJRCxcclxuICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICB9KSxcclxuICAgICAgICApO1xyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGl0KCdzaG91bGQgaWRlbnRpZnkgZXhwaXJlZCBKV1QgYXMgQVVUSF9UT0tFTl9FWFBJUkVEJywgKCkgPT4ge1xyXG4gICAgICAgIC8vIEFycmFuZ2VcclxuICAgICAgICBjb25zdCBleGNlcHRpb24gPSBuZXcgRXJyb3IoJ2p3dCBleHBpcmVkJyk7XHJcbiAgICAgICAgZXhjZXB0aW9uLm5hbWUgPSAnVG9rZW5FeHBpcmVkRXJyb3InO1xyXG4gICAgICAgIGNvbnN0IGhvc3QgPSBjcmVhdGVNb2NrQXJndW1lbnRzSG9zdChtb2NrUmVxdWVzdCwgbW9ja1Jlc3BvbnNlKTtcclxuXHJcbiAgICAgICAgLy8gQWN0XHJcbiAgICAgICAgZmlsdGVyLmNhdGNoKGV4Y2VwdGlvbiwgaG9zdCBhcyBhbnkpO1xyXG5cclxuICAgICAgICAvLyBBc3NlcnRcclxuICAgICAgICBleHBlY3QobW9ja1Jlc3BvbnNlLmpzb24pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxyXG4gICAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xyXG4gICAgICAgICAgICBlcnJvcjogZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xyXG4gICAgICAgICAgICAgIGNvZGU6IEVycm9yQ29kZXMuQVVUSF9UT0tFTl9FWFBJUkVELFxyXG4gICAgICAgICAgICB9KSxcclxuICAgICAgICAgIH0pLFxyXG4gICAgICAgICk7XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgaXQoJ3Nob3VsZCBpZGVudGlmeSBkYXRhYmFzZSBlcnJvcnMnLCAoKSA9PiB7XHJcbiAgICAgICAgLy8gQXJyYW5nZVxyXG4gICAgICAgIGNvbnN0IGV4Y2VwdGlvbiA9IG5ldyBFcnJvcignRUNPTk5SRUZVU0VEIGRhdGFiYXNlIGNvbm5lY3Rpb24nKTtcclxuICAgICAgICBjb25zdCBob3N0ID0gY3JlYXRlTW9ja0FyZ3VtZW50c0hvc3QobW9ja1JlcXVlc3QsIG1vY2tSZXNwb25zZSk7XHJcblxyXG4gICAgICAgIC8vIEFjdFxyXG4gICAgICAgIGZpbHRlci5jYXRjaChleGNlcHRpb24sIGhvc3QgYXMgYW55KTtcclxuXHJcbiAgICAgICAgLy8gQXNzZXJ0XHJcbiAgICAgICAgZXhwZWN0KG1vY2tSZXNwb25zZS5qc29uKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcclxuICAgICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcclxuICAgICAgICAgICAgZXJyb3I6IGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcclxuICAgICAgICAgICAgICBjb2RlOiBFcnJvckNvZGVzLlNFUlZFUl9EQVRBQkFTRV9FUlJPUixcclxuICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICB9KSxcclxuICAgICAgICApO1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG5cclxuICAgIGRlc2NyaWJlKCdtZXNzYWdlIHNhbml0aXphdGlvbicsICgpID0+IHtcclxuICAgICAgZGVzY3JpYmUoJ2luIHByb2R1Y3Rpb24nLCAoKSA9PiB7XHJcbiAgICAgICAgYmVmb3JlRWFjaCgoKSA9PiB7XHJcbiAgICAgICAgICBwcm9jZXNzLmVudi5OT0RFX0VOViA9ICdwcm9kdWN0aW9uJztcclxuICAgICAgICAgIC8vIEZpbHRlciBuZXUgZXJzdGVsbGVuIG1pdCBwcm9kdWN0aW9uIGVudlxyXG4gICAgICAgICAgZmlsdGVyID0gbmV3IEFsbEV4Y2VwdGlvbnNGaWx0ZXIoKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgaXQoJ3Nob3VsZCBub3QgZXhwb3NlIGludGVybmFsIGVycm9yIG1lc3NhZ2VzJywgKCkgPT4ge1xyXG4gICAgICAgICAgLy8gQXJyYW5nZVxyXG4gICAgICAgICAgY29uc3QgZXhjZXB0aW9uID0gbmV3IEVycm9yKCdEYXRhYmFzZSBwYXNzd29yZDogIHNlY3JldDEyMycpO1xyXG4gICAgICAgICAgY29uc3QgaG9zdCA9IGNyZWF0ZU1vY2tBcmd1bWVudHNIb3N0KG1vY2tSZXF1ZXN0LCBtb2NrUmVzcG9uc2UpO1xyXG5cclxuICAgICAgICAgIC8vIEFjdFxyXG4gICAgICAgICAgZmlsdGVyLmNhdGNoKGV4Y2VwdGlvbiwgaG9zdCBhcyBhbnkpO1xyXG5cclxuICAgICAgICAgIC8vIEFzc2VydFxyXG4gICAgICAgICAgZXhwZWN0KG1vY2tSZXNwb25zZS5qc29uKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcclxuICAgICAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xyXG4gICAgICAgICAgICAgIGVycm9yOiBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XHJcbiAgICAgICAgICAgICAgICBtZXNzYWdlOiBleHBlY3Qubm90LnN0cmluZ0NvbnRhaW5pbmcoJ3NlY3JldDEyMycpLFxyXG4gICAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICB9KSxcclxuICAgICAgICAgICk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGl0KCdzaG91bGQgcmV0dXJuIGdlbmVyaWMgbWVzc2FnZSBpbiBwcm9kdWN0aW9uJywgKCkgPT4ge1xyXG4gICAgICAgICAgLy8gQXJyYW5nZVxyXG4gICAgICAgICAgY29uc3QgZXhjZXB0aW9uID0gbmV3IEVycm9yKCdJbnRlcm5hbCBpbXBsZW1lbnRhdGlvbiBkZXRhaWxzJyk7XHJcbiAgICAgICAgICBjb25zdCBob3N0ID0gY3JlYXRlTW9ja0FyZ3VtZW50c0hvc3QobW9ja1JlcXVlc3QsIG1vY2tSZXNwb25zZSk7XHJcblxyXG4gICAgICAgICAgLy8gQWN0XHJcbiAgICAgICAgICBmaWx0ZXIuY2F0Y2goZXhjZXB0aW9uLCBob3N0IGFzIGFueSk7XHJcblxyXG4gICAgICAgICAgLy8gQXNzZXJ0XHJcbiAgICAgICAgICBleHBlY3QobW9ja1Jlc3BvbnNlLmpzb24pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxyXG4gICAgICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XHJcbiAgICAgICAgICAgICAgZXJyb3I6IGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcclxuICAgICAgICAgICAgICAgIG1lc3NhZ2U6XHJcbiAgICAgICAgICAgICAgICAgICdBbiB1bmV4cGVjdGVkIGVycm9yIG9jY3VycmVkLiBQbGVhc2UgdHJ5IGFnYWluIGxhdGVyLicsXHJcbiAgICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgKTtcclxuICAgICAgICB9KTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBkZXNjcmliZSgnaW4gZGV2ZWxvcG1lbnQnLCAoKSA9PiB7XHJcbiAgICAgICAgYmVmb3JlRWFjaCgoKSA9PiB7XHJcbiAgICAgICAgICBwcm9jZXNzLmVudi5OT0RFX0VOViA9ICdkZXZlbG9wbWVudCc7XHJcbiAgICAgICAgICBmaWx0ZXIgPSBuZXcgQWxsRXhjZXB0aW9uc0ZpbHRlcigpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpdCgnc2hvdWxkIGluY2x1ZGUgc2FuaXRpemVkIGVycm9yIG1lc3NhZ2UnLCAoKSA9PiB7XHJcbiAgICAgICAgICAvLyBBcnJhbmdlXHJcbiAgICAgICAgICBjb25zdCBleGNlcHRpb24gPSBuZXcgRXJyb3IoJ1NvbWV0aGluZyB3ZW50IHdyb25nJyk7XHJcbiAgICAgICAgICBjb25zdCBob3N0ID0gY3JlYXRlTW9ja0FyZ3VtZW50c0hvc3QobW9ja1JlcXVlc3QsIG1vY2tSZXNwb25zZSk7XHJcblxyXG4gICAgICAgICAgLy8gQWN0XHJcbiAgICAgICAgICBmaWx0ZXIuY2F0Y2goZXhjZXB0aW9uLCBob3N0IGFzIGFueSk7XHJcblxyXG4gICAgICAgICAgLy8gQXNzZXJ0XHJcbiAgICAgICAgICBleHBlY3QobW9ja1Jlc3BvbnNlLmpzb24pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxyXG4gICAgICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XHJcbiAgICAgICAgICAgICAgZXJyb3I6IGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcclxuICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGV4cGVjdC5hbnkoU3RyaW5nKSxcclxuICAgICAgICAgICAgICB9KSxcclxuICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICApO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpdCgnc2hvdWxkIHJlZGFjdCBmaWxlIHBhdGhzIGZyb20gZXJyb3IgbWVzc2FnZScsICgpID0+IHtcclxuICAgICAgICAgIC8vIEFycmFuZ2VcclxuICAgICAgICAgIGNvbnN0IGV4Y2VwdGlvbiA9IG5ldyBFcnJvcihcclxuICAgICAgICAgICAgJ0Vycm9yIGF0IEM6XFxcXFVzZXJzXFxcXGRldlxcXFxwcm9qZWN0XFxcXHNyY1xcXFxmaWxlLnRzOiAxMjMnLFxyXG4gICAgICAgICAgKTtcclxuICAgICAgICAgIGNvbnN0IGhvc3QgPSBjcmVhdGVNb2NrQXJndW1lbnRzSG9zdChtb2NrUmVxdWVzdCwgbW9ja1Jlc3BvbnNlKTtcclxuXHJcbiAgICAgICAgICAvLyBBY3RcclxuICAgICAgICAgIGZpbHRlci5jYXRjaChleGNlcHRpb24sIGhvc3QgYXMgYW55KTtcclxuXHJcbiAgICAgICAgICAvLyBBc3NlcnRcclxuICAgICAgICAgIGNvbnN0IGpzb25DYWxsID0gbW9ja1Jlc3BvbnNlLmpzb24ubW9jay5jYWxsc1swXVswXTtcclxuICAgICAgICAgIGV4cGVjdChqc29uQ2FsbC5lcnJvci5tZXNzYWdlKS5ub3QudG9Db250YWluKCdDOlxcXFxVc2VycycpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG5cclxuICAgIGRlc2NyaWJlKCdub24tRXJyb3IgZXhjZXB0aW9ucycsICgpID0+IHtcclxuICAgICAgaXQoJ3Nob3VsZCBoYW5kbGUgc3RyaW5nIHRocm93cycsICgpID0+IHtcclxuICAgICAgICAvLyBBcnJhbmdlXHJcbiAgICAgICAgY29uc3QgZXhjZXB0aW9uID0gJ1NvbWV0aGluZyB3ZW50IHdyb25nJztcclxuICAgICAgICBjb25zdCBob3N0ID0gY3JlYXRlTW9ja0FyZ3VtZW50c0hvc3QobW9ja1JlcXVlc3QsIG1vY2tSZXNwb25zZSk7XHJcblxyXG4gICAgICAgIC8vIEFjdFxyXG4gICAgICAgIGZpbHRlci5jYXRjaChleGNlcHRpb24sIGhvc3QgYXMgYW55KTtcclxuXHJcbiAgICAgICAgLy8gQXNzZXJ0XHJcbiAgICAgICAgZXhwZWN0KG1vY2tSZXNwb25zZS5zdGF0dXMpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKDUwMCk7XHJcbiAgICAgICAgZXhwZWN0KG1vY2tSZXNwb25zZS5qc29uKS50b0hhdmVCZWVuQ2FsbGVkKCk7XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgaXQoJ3Nob3VsZCBoYW5kbGUgb2JqZWN0IHRocm93cycsICgpID0+IHtcclxuICAgICAgICAvLyBBcnJhbmdlXHJcbiAgICAgICAgY29uc3QgZXhjZXB0aW9uID0geyBlcnJvcjogJ0N1c3RvbSBlcnJvciBvYmplY3QnIH07XHJcbiAgICAgICAgY29uc3QgaG9zdCA9IGNyZWF0ZU1vY2tBcmd1bWVudHNIb3N0KG1vY2tSZXF1ZXN0LCBtb2NrUmVzcG9uc2UpO1xyXG5cclxuICAgICAgICAvLyBBY3RcclxuICAgICAgICBmaWx0ZXIuY2F0Y2goZXhjZXB0aW9uLCBob3N0IGFzIGFueSk7XHJcblxyXG4gICAgICAgIC8vIEFzc2VydFxyXG4gICAgICAgIGV4cGVjdChtb2NrUmVzcG9uc2Uuc3RhdHVzKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCg1MDApO1xyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGl0KCdzaG91bGQgaGFuZGxlIG51bGwvdW5kZWZpbmVkIHRocm93cycsICgpID0+IHtcclxuICAgICAgICAvLyBBcnJhbmdlXHJcbiAgICAgICAgY29uc3QgaG9zdCA9IGNyZWF0ZU1vY2tBcmd1bWVudHNIb3N0KG1vY2tSZXF1ZXN0LCBtb2NrUmVzcG9uc2UpO1xyXG5cclxuICAgICAgICAvLyBBY3RcclxuICAgICAgICBmaWx0ZXIuY2F0Y2gobnVsbCwgaG9zdCBhcyBhbnkpO1xyXG5cclxuICAgICAgICAvLyBBc3NlcnRcclxuICAgICAgICBleHBlY3QobW9ja1Jlc3BvbnNlLnN0YXR1cykudG9IYXZlQmVlbkNhbGxlZFdpdGgoNTAwKTtcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9KTtcclxufSk7XHJcbiJdLCJ2ZXJzaW9uIjozfQ==